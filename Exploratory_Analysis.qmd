---
title: "Data Download"
author: "Matthew Hoctor, PharmD"
date: "`r format(Sys.time(), '%d %B, %Y')`"

quarto::html_document:
  theme: cerulean
  highlight: github
  
toc: true
toc-depth: 2
toc-location: left
toc-title: Contents
  
code-fold: true
code-overflow: wrap
code-tools: true
code-link: true

editor: source
---

```{r setup, include = FALSE}
# load libraries:
library(tidyverse)
library(data.table)
library(lubridate)
# library(httr2)        #using bash curl instead
# library(curl)         #using bash curl instead
# library(jsonlite)     #fromJSON and other json functions
```

# Overview

We seek to understand the impact of the Comprehensive Addiction and Recovery Act (CARA) of 2016 on patterns of buprenorphine prescribing practices by examining medicare part D data. This exploratory analysis will download and compile medicare part D data before and after the legislation for years 2013-2021, and will examine variables of interest including buprenorphine Rx, methadone Rx, naltrexone Rx, prescriber type, cost to the patient, cost to Medicare, rural vs urban, and more.

# Downloading Medicare Part D Data

This analysis does not require individual-patient-level data, and thus does not require the Research Identifiable Files (RIFs) or Limited Data Set (LDS) files; non-identifiable files will be used instead. Datasets from 2013-2021 from the [Medicare Part D Prescribers - by Provider and Drug](https://data.cms.gov/provider-summary-by-type-of-service/medicare-part-d-prescribers/medicare-part-d-prescribers-by-provider-and-drug) dataset was downloaded and moved to the `data` folder of the project ([data dict](https://data.cms.gov/resources/medicare-part-d-prescribers-by-provider-and-drug-data-dictionary)). It may be necessary to add info from the [Medicare Part D Prescribers - by Provider](https://data.cms.gov/provider-summary-by-type-of-service/medicare-part-d-prescribers/medicare-part-d-prescribers-by-provider) dataset if more provider info is needed; it may be interesting to look at [Medicare Part D Prescribers - by Geography and Drug Data Dictionary](https://data.cms.gov/provider-summary-by-type-of-service/medicare-part-d-prescribers/medicare-part-d-prescribers-by-geography-and-drug) ([data dict](https://data.cms.gov/resources/medicare-part-d-prescribers-by-geography-and-drug-data-dictionary)) later.

See the [data download](https://matthew-hoctor.github.io/Buprenorphine_Rx/data_download.html) page for specifics.

# Data Cleaning

## Importing & Merging Data

NB manually downloading datasets from data.cms.gov only seems to work when the ancillary files are not downloaded as well.  We will begin with the 2021 data while the rest of the datasets download.

Test read of manually downloaded 2021 data:

```{r}
data_2021 <- read.csv("data/2021/MUP_DPR_RY23_P04_V10_DY21_NPIBN.csv")
```

Assign `year` variable to 2021 data and create the main dataset, `data`:

```{r}
data_2021$year <- 2021
data <- data_2021
```

Check:

```{r}
glimpse(data_2021)
head(data_2021)
```

This confirms that the data is in the correct format and that the data download was successful.  We can now create the variables of interest:

## MAT

The variable for medication assisted treatment (MAT) is `MAT`, which will be a polytomous variable with the following levels: 

```{r}
data$MAT <-
```

## Rural vs Urban





# Exploratory Analysis

## Missing Data

## Geographic MAT Prescribing Patterns

### Buprenorphine

### Methadone

### Naltrexone

# Session Info

```{r}
sessionInfo()
```
