<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Matthew Hoctor, PharmD">
<meta name="dcterms.date" content="2023-12-03">
<title>Dataset</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="dataset_files/libs/clipboard/clipboard.min.js"></script>
<script src="dataset_files/libs/quarto-html/quarto.js"></script>
<script src="dataset_files/libs/quarto-html/popper.min.js"></script>
<script src="dataset_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="dataset_files/libs/quarto-html/anchor.min.js"></script>
<link href="dataset_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="dataset_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="dataset_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="dataset_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="dataset_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
</head>
<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#downloading-medicare-part-d-data" id="toc-downloading-medicare-part-d-data" class="nav-link" data-scroll-target="#downloading-medicare-part-d-data">Downloading Medicare Part D Data</a></li>
  <li>
<a href="#importing-merging-data" id="toc-importing-merging-data" class="nav-link" data-scroll-target="#importing-merging-data">Importing &amp; Merging Data</a>
  <ul>
<li>
<a href="#test-run" id="toc-test-run" class="nav-link" data-scroll-target="#test-run">2021 Test Run</a>
  <ul class="collapse">
<li><a href="#dataset" id="toc-dataset" class="nav-link" data-scroll-target="#dataset">Dataset</a></li>
  <li><a href="#treatment-variables" id="toc-treatment-variables" class="nav-link" data-scroll-target="#treatment-variables">Treatment Variables</a></li>
  </ul>
</li>
  <li>
<a href="#treatment-variable" id="toc-treatment-variable" class="nav-link" data-scroll-target="#treatment-variable">Treatment Variable</a>
  <ul class="collapse">
<li><a href="#treatment-function" id="toc-treatment-function" class="nav-link" data-scroll-target="#treatment-function">Treatment Function</a></li>
  <li><a href="#validate" id="toc-validate" class="nav-link" data-scroll-target="#validate">Validate</a></li>
  </ul>
</li>
  <li>
<a href="#rural-vs-urban" id="toc-rural-vs-urban" class="nav-link" data-scroll-target="#rural-vs-urban">Rural vs Urban</a>
  <ul class="collapse">
<li>
<a href="#using-usgs-data" id="toc-using-usgs-data" class="nav-link" data-scroll-target="#using-usgs-data">Using USGS Data</a>
  <ul class="collapse">
<li><a href="#usgs-classification-overview" id="toc-usgs-classification-overview" class="nav-link" data-scroll-target="#usgs-classification-overview">USGS Classification Overview</a></li>
  <li><a href="#prepping-the-usgs-dataset" id="toc-prepping-the-usgs-dataset" class="nav-link" data-scroll-target="#prepping-the-usgs-dataset">Prepping the USGS Dataset</a></li>
  <li><a href="#searching-usgs-dataset-with-left_join" id="toc-searching-usgs-dataset-with-left_join" class="nav-link" data-scroll-target="#searching-usgs-dataset-with-left_join">Searching USGS dataset with left_join</a></li>
  <li><a href="#matching-to-nchsurc-dataset" id="toc-matching-to-nchsurc-dataset" class="nav-link" data-scroll-target="#matching-to-nchsurc-dataset">Matching to NCHSURC Dataset</a></li>
  </ul>
</li>
  <li><a href="#alternate-intensive-approach" id="toc-alternate-intensive-approach" class="nav-link" data-scroll-target="#alternate-intensive-approach">Alternate Intensive Approach</a></li>
  </ul>
</li>
  <li><a href="#provider-type" id="toc-provider-type" class="nav-link" data-scroll-target="#provider-type">Provider Type</a></li>
  </ul>
</li>
  <li><a href="#final-dataset" id="toc-final-dataset" class="nav-link" data-scroll-target="#final-dataset">Final dataset</a></li>
  <li><a href="#other-thoughts" id="toc-other-thoughts" class="nav-link" data-scroll-target="#other-thoughts">Other Thoughts</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session Info</a></li>
  </ul></nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Dataset</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Matthew Hoctor, PharmD </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 3, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header><section id="overview" class="level1"><h1>Overview</h1>
<p>We seek to understand the impact of the Comprehensive Addiction and Recovery Act (CARA) of 2016 on patterns of buprenorphine prescribing practices by examining medicare part D data. This exploratory analysis will download and compile medicare part D data before and after the legislation for years 2013-2021, and will examine variables of interest including buprenorphine Rx, methadone Rx, naltrexone Rx, prescriber type, cost to the patient, cost to Medicare, rural vs urban, and more.</p>
</section><section id="downloading-medicare-part-d-data" class="level1"><h1>Downloading Medicare Part D Data</h1>
<p>This analysis does not require individual-patient-level data, and thus does not require the Research Identifiable Files (RIFs) or Limited Data Set (LDS) files; non-identifiable files will be used instead. Datasets from 2013-2021 from the <a href="https://data.cms.gov/provider-summary-by-type-of-service/medicare-part-d-prescribers/medicare-part-d-prescribers-by-provider-and-drug">Medicare Part D Prescribers - by Provider and Drug</a> dataset was downloaded and moved to the <code>data</code> folder of the project (<a href="https://data.cms.gov/resources/medicare-part-d-prescribers-by-provider-and-drug-data-dictionary">data dict</a>). It may be necessary to add info from the <a href="https://data.cms.gov/provider-summary-by-type-of-service/medicare-part-d-prescribers/medicare-part-d-prescribers-by-provider">Medicare Part D Prescribers - by Provider</a> dataset if more provider info is needed; it may be interesting to look at <a href="https://data.cms.gov/provider-summary-by-type-of-service/medicare-part-d-prescribers/medicare-part-d-prescribers-by-geography-and-drug">Medicare Part D Prescribers - by Geography and Drug Data Dictionary</a> (<a href="https://data.cms.gov/resources/medicare-part-d-prescribers-by-geography-and-drug-data-dictionary">data dict</a>) later.</p>
<p>See the <a href="https://matthew-hoctor.github.io/Buprenorphine_Rx/data_download.html">data download</a> page for specifics.</p>
<p>NB manually downloading datasets from data.cms.gov only seems to work when the ancillary files are not downloaded as well.</p>
</section><section id="importing-merging-data" class="level1"><h1>Importing &amp; Merging Data</h1>
<p>We will begin with the 2021 data while the rest of the datasets download.</p>
<section id="test-run" class="level2"><h2 class="anchored" data-anchor-id="test-run">2021 Test Run</h2>
<section id="dataset" class="level3"><h3 class="anchored" data-anchor-id="dataset">Dataset</h3>
<p>Test read of manually downloaded 2021 data:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_2021</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"data/2021.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Check:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">glimpse</span><span class="op">(</span><span class="va">data_2021</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 25,231,862
Columns: 22
$ Prscrbr_NPI           &lt;int&gt; 1003000126, 1003000126, 1003000126, 1003000126, …
$ Prscrbr_Last_Org_Name &lt;chr&gt; "Enkeshafi", "Enkeshafi", "Enkeshafi", "Enkeshaf…
$ Prscrbr_First_Name    &lt;chr&gt; "Ardalan", "Ardalan", "Ardalan", "Ardalan", "Ard…
$ Prscrbr_City          &lt;chr&gt; "Bethesda", "Bethesda", "Bethesda", "Bethesda", …
$ Prscrbr_State_Abrvtn  &lt;chr&gt; "MD", "MD", "MD", "MD", "MD", "MD", "MD", "MD", …
$ Prscrbr_State_FIPS    &lt;chr&gt; "24", "24", "24", "24", "24", "24", "24", "24", …
$ Prscrbr_Type          &lt;chr&gt; "Internal Medicine", "Internal Medicine", "Inter…
$ Prscrbr_Type_Src      &lt;chr&gt; "S", "S", "S", "S", "S", "S", "S", "S", "S", "S"…
$ Brnd_Name             &lt;chr&gt; "Alendronate Sodium", "Amlodipine Besylate", "At…
$ Gnrc_Name             &lt;chr&gt; "Alendronate Sodium", "Amlodipine Besylate", "At…
$ Tot_Clms              &lt;int&gt; 11, 64, 12, 46, 11, 14, 15, 30, 19, 20, 13, 18, …
$ Tot_30day_Fills       &lt;dbl&gt; 31.0, 177.0, 36.0, 122.0, 11.0, 32.0, 15.0, 67.1…
$ Tot_Day_Suply         &lt;int&gt; 930, 5311, 1080, 3660, 89, 960, 422, 2013, 1710,…
$ Tot_Drug_Cst          &lt;dbl&gt; 125.28, 812.86, 220.84, 825.26, 175.50, 128.02, …
$ Tot_Benes             &lt;int&gt; NA, 48, NA, 38, 11, NA, NA, 16, 13, 17, 12, 13, …
$ GE65_Sprsn_Flag       &lt;chr&gt; "", "#", "", "#", "*", "", "", "", "", "#", "#",…
$ GE65_Tot_Clms         &lt;int&gt; 11, NA, 12, NA, NA, 14, 15, 30, 19, NA, NA, 18, …
$ GE65_Tot_30day_Fills  &lt;dbl&gt; 31.0, NA, 36.0, NA, NA, 32.0, 15.0, 67.1, 57.0, …
$ GE65_Tot_Drug_Cst     &lt;dbl&gt; 125.28, NA, 220.84, NA, NA, 128.02, 7150.87, 703…
$ GE65_Tot_Day_Suply    &lt;int&gt; 930, NA, 1080, NA, NA, 960, 422, 2013, 1710, NA,…
$ GE65_Bene_Sprsn_Flag  &lt;chr&gt; "*", "#", "*", "#", "*", "*", "*", "", "", "#", …
$ GE65_Tot_Benes        &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, 16, 13, NA, NA, 13, …</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>  Prscrbr_NPI Prscrbr_Last_Org_Name Prscrbr_First_Name Prscrbr_City
1  1003000126             Enkeshafi            Ardalan     Bethesda
2  1003000126             Enkeshafi            Ardalan     Bethesda
3  1003000126             Enkeshafi            Ardalan     Bethesda
4  1003000126             Enkeshafi            Ardalan     Bethesda
5  1003000126             Enkeshafi            Ardalan     Bethesda
6  1003000126             Enkeshafi            Ardalan     Bethesda
  Prscrbr_State_Abrvtn Prscrbr_State_FIPS      Prscrbr_Type Prscrbr_Type_Src
1                   MD                 24 Internal Medicine                S
2                   MD                 24 Internal Medicine                S
3                   MD                 24 Internal Medicine                S
4                   MD                 24 Internal Medicine                S
5                   MD                 24 Internal Medicine                S
6                   MD                 24 Internal Medicine                S
             Brnd_Name             Gnrc_Name Tot_Clms Tot_30day_Fills
1   Alendronate Sodium    Alendronate Sodium       11              31
2  Amlodipine Besylate   Amlodipine Besylate       64             177
3             Atenolol              Atenolol       12              36
4 Atorvastatin Calcium  Atorvastatin Calcium       46             122
5             Cefdinir              Cefdinir       11              11
6          Clopidogrel Clopidogrel Bisulfate       14              32
  Tot_Day_Suply Tot_Drug_Cst Tot_Benes GE65_Sprsn_Flag GE65_Tot_Clms
1           930       125.28        NA                            11
2          5311       812.86        48               #            NA
3          1080       220.84        NA                            12
4          3660       825.26        38               #            NA
5            89       175.50        11               *            NA
6           960       128.02        NA                            14
  GE65_Tot_30day_Fills GE65_Tot_Drug_Cst GE65_Tot_Day_Suply
1                   31            125.28                930
2                   NA                NA                 NA
3                   36            220.84               1080
4                   NA                NA                 NA
5                   NA                NA                 NA
6                   32            128.02                960
  GE65_Bene_Sprsn_Flag GE65_Tot_Benes
1                    *             NA
2                    #             NA
3                    *             NA
4                    #             NA
5                    *             NA
6                    *             NA</code></pre>
</div>
</div>
<p>This confirms that the data is in the correct format and that the data download was successful. We can now create the variables of interest. Assign <code>year</code> variable to 2021 data and create the main dataset, <code>data</code>:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_2021</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="fl">2021</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="treatment-variables" class="level3"><h3 class="anchored" data-anchor-id="treatment-variables">Treatment Variables</h3>
<p>The variable for medication assisted treatment (MAT) is <code>MAT</code>, which will be a polytomous variable with the following levels: <code>bup</code> for buprenorphine, <code>met</code> for methadone, and <code>nal</code> for naltrexone.</p>
<p>The following R code chunk uses the <code>stringr</code> package to find all values of the <code>Gnrc_Name</code> variable that contain the string “buprenorphine” and assigns the value <code>bup</code> to the <code>MAT_generic</code> variable for those rows:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>  <span class="fu">str_detect</span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Gnrc_Name</span>, <span class="fu">regex</span><span class="op">(</span><span class="st">"bupre"</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="st">"bup"</span>, </span>
<span>  <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="co"># to test the variable encoding we will table all of the values of `Gnrc_Name which were matched above:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Gnrc_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"bup"</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
                 Buprenorphine              Buprenorphine Hcl 
                          7689                           9806 
Buprenorphine Hcl/Naloxone Hcl 
                         26109 </code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"bup"</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
               Belbuca               Bunavail               Buprenex 
                  3806                      1                     14 
         Buprenorphine      Buprenorphine Hcl Buprenorphine-Naloxone 
                  6091                   5986                  17385 
               Butrans              Sublocade               Suboxone 
                  1404                    194                   6712 
               Zubsolv 
                  2011 </code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"bup"</span><span class="op">]</span>, <span class="va">data_2021</span><span class="op">$</span><span class="va">Gnrc_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"bup"</span><span class="op">]</span><span class="op">)</span><span class="op">|&gt;</span></span>
<span>  <span class="co"># add a row for totals</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/addmargins.html">addmargins</a></span><span class="op">(</span>margin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>                        
                         Buprenorphine Buprenorphine Hcl
  Belbuca                            0              3806
  Bunavail                           0                 0
  Buprenex                           0                14
  Buprenorphine                   6091                 0
  Buprenorphine Hcl                  0              5986
  Buprenorphine-Naloxone             0                 0
  Butrans                         1404                 0
  Sublocade                        194                 0
  Suboxone                           0                 0
  Zubsolv                            0                 0
  Sum                             7689              9806
                        
                         Buprenorphine Hcl/Naloxone Hcl
  Belbuca                                             0
  Bunavail                                            1
  Buprenex                                            0
  Buprenorphine                                       0
  Buprenorphine Hcl                                   0
  Buprenorphine-Naloxone                          17385
  Butrans                                             0
  Sublocade                                           0
  Suboxone                                         6712
  Zubsolv                                          2011
  Sum                                             26109</code></pre>
</div>
</div>
<p>We also want to search for brand names of buprenorphine products. The following R code chunk uses the <code>stringr</code> package to find all values of the <code>Brnd_Name</code> variable that contain the strings matching any of the brand names of buprenorphine products and assigns the value <code>bup</code> to the <code>MAT_brand</code> variable for those rows:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bup_brands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Belbuca"</span>, <span class="st">"Bunavail"</span>, <span class="st">"Buprenex"</span>, <span class="st">"Buprenorphine"</span>, <span class="st">"Butrans"</span>, <span class="st">"Probuphine"</span>, <span class="st">"Sublocade"</span>, <span class="st">"Suboxone"</span>, <span class="st">"Subutex"</span>, <span class="st">"Zubsolv"</span><span class="op">)</span></span>
<span><span class="co">#next we will need to concatinate the strings in the `bup_brands` vector into a single string separated by the `|` character, which is the regex "or" operator:</span></span>
<span><span class="va">bup_brands_pattern</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">bup_brands</span>, collapse <span class="op">=</span> <span class="st">"|"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_brand</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>  <span class="fu">str_detect</span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span>, <span class="fu">regex</span><span class="op">(</span><span class="va">bup_brands_pattern</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="st">"bup"</span>, </span>
<span>  <span class="cn">NA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To validate the encoding of the <code>MAT_brand</code> variable, we will table all of the values of <code>Brnd_Name</code> which were matched above, and table all of the entries where <code>MAT_brand</code> was matched vs entries where <code>MAT_generic</code> was matched:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_brand</span> <span class="op">==</span> <span class="st">"bup"</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
               Belbuca               Bunavail               Buprenex 
                  3806                      1                     14 
         Buprenorphine      Buprenorphine Hcl Buprenorphine-Naloxone 
                  6091                   5986                  17385 
               Butrans              Sublocade               Suboxone 
                  1404                    194                   6712 
               Zubsolv 
                  2011 </code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#this produces an identical table to the one above</span></span>
<span><span class="co">#as an extra precaution we will cross-tabulate the two variables:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_brand</span> <span class="op">==</span> <span class="st">"bup"</span><span class="op">]</span>, <span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"bup"</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>                        
                         Belbuca Bunavail Buprenex Buprenorphine
  Belbuca                   3806        0        0             0
  Bunavail                     0        1        0             0
  Buprenex                     0        0       14             0
  Buprenorphine                0        0        0          6091
  Buprenorphine Hcl            0        0        0             0
  Buprenorphine-Naloxone       0        0        0             0
  Butrans                      0        0        0             0
  Sublocade                    0        0        0             0
  Suboxone                     0        0        0             0
  Zubsolv                      0        0        0             0
                        
                         Buprenorphine Hcl Buprenorphine-Naloxone Butrans
  Belbuca                                0                      0       0
  Bunavail                               0                      0       0
  Buprenex                               0                      0       0
  Buprenorphine                          0                      0       0
  Buprenorphine Hcl                   5986                      0       0
  Buprenorphine-Naloxone                 0                  17385       0
  Butrans                                0                      0    1404
  Sublocade                              0                      0       0
  Suboxone                               0                      0       0
  Zubsolv                                0                      0       0
                        
                         Sublocade Suboxone Zubsolv
  Belbuca                        0        0       0
  Bunavail                       0        0       0
  Buprenex                       0        0       0
  Buprenorphine                  0        0       0
  Buprenorphine Hcl              0        0       0
  Buprenorphine-Naloxone         0        0       0
  Butrans                        0        0       0
  Sublocade                    194        0       0
  Suboxone                       0     6712       0
  Zubsolv                        0        0    2011</code></pre>
</div>
</div>
<p>We will now sort each observation according to treatment intention, and assign values to the <code>tx</code> variable. Entries in which buprenorphine was used to treat OUD will be assigned <code>bup_oud</code>, entries in which buprenorphine was used to treat pain will be assigned <code>bup_pain</code>. Products indicated for OUD include Sublocade, Brixadi (not available during the years studied), all forms of Buprenorphine Hcl/Naloxone Hcl (Suboxone, Zubsolv, Bunavail, Cassipa, and generic), and Buprenorphine HCl (sublingual, NB that that certain NDCs of this product are reported only as ‘Buprenorphine’ for the brand and generic names); whereas products indicated for pain include Belbuca (buprenorphine HCl buccal), Buprenex, Butrans, Probuphine (implant, discontinued), generic buprenorphine HCl (parenteral), and generic buprenorphine transdermal patches. Thus, in the <code>Brnd_Name</code> vs <code>Gnrc_Name</code> cross-tabulation above, we see that two entries are possibly ambiguous, those in which both variables have the value <code>Buprenorphine</code> (which could be generic buprenorphine transdermal patches [pain] or buprenorphine HCl sublingual tablets [OUD]), and those in which both variables have the variable <code>Buprenorphine HCl</code> (which could be parenteral buprenorphine HCl [pain], or buprenorphine HCl sublingual tablets [OUD]). Given that usage of buprenorphine for pain is not common practice in the U.S., we will assume that these ambiguous entries are for OUD, and will generate the <code>tx</code> variable by recoding the <code>Brnd_Name</code> variable:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># using the tidyverse standard function case_when:</span></span>
<span><span class="va">data_2021</span><span class="op">$</span><span class="va">tx</span> <span class="op">&lt;-</span> <span class="fu">case_match</span><span class="op">(</span></span>
<span>  <span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Bunavail"</span>, <span class="st">"Buprenorphine"</span>, <span class="st">"Buprenorphine Hcl"</span>, <span class="st">"Buprenorphine-Naloxone"</span>, <span class="st">"Sublocade"</span>, <span class="st">"Suboxone"</span>, <span class="st">"Subutex"</span>, <span class="st">"Zubsolv"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"bup_oud"</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Belbuca"</span>, <span class="st">"Buprenex"</span>, <span class="st">"Butrans"</span>, <span class="st">"Probuphine"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"bup_pain"</span>,</span>
<span>  .default <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># validate encoding by cross tabulating `tx` vs `Brnd_Name`:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_brand</span> <span class="op">==</span> <span class="st">"bup"</span><span class="op">]</span>, <span class="va">data_2021</span><span class="op">$</span><span class="va">tx</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_brand</span> <span class="op">==</span> <span class="st">"bup"</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># add a row for totals for bup_oud and bup_pain:</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/addmargins.html">addmargins</a></span><span class="op">(</span>margin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>                        
                         bup_oud bup_pain
  Belbuca                      0     3806
  Bunavail                     1        0
  Buprenex                     0       14
  Buprenorphine             6091        0
  Buprenorphine Hcl         5986        0
  Buprenorphine-Naloxone   17385        0
  Butrans                      0     1404
  Sublocade                  194        0
  Suboxone                  6712        0
  Zubsolv                   2011        0
  Sum                      38380     5224</code></pre>
</div>
</div>
<p>We can now repeat this process for methadone:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>  <span class="fu">str_detect</span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Gnrc_Name</span>, <span class="fu">regex</span><span class="op">(</span><span class="st">"methad"</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="st">"met"</span>, </span>
<span>  <span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span><span class="op">)</span></span>
<span><span class="co"># to test the variable encoding we will table all of the values of `Gnrc_Name which were matched above:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Gnrc_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"met"</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
Methadone Hcl 
        16808 </code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># table `Brnd_Name`:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"met"</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
     Methadone Hcl Methadone Intensol          Methadose 
             16784                 20                  4 </code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># as above with buprenorphine we will construct a vector of methadone brand names:</span></span>
<span><span class="va">met_brands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Dolophine"</span>, <span class="st">"Methadone"</span>, <span class="st">"Methadose"</span><span class="op">)</span>  <span class="co">#NB "Methadone Diskets", "Methadone Intensol" will match with "Methadone"</span></span>
<span><span class="co"># and construct a regex pattern:</span></span>
<span><span class="va">met_brands_pattern</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">met_brands</span>, collapse <span class="op">=</span> <span class="st">"|"</span><span class="op">)</span></span>
<span><span class="co"># and assign the `met` value to the `MAT_brand` variable:</span></span>
<span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_brand</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>  <span class="fu">str_detect</span><span class="op">(</span></span>
<span>    <span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span>, </span>
<span>    <span class="fu">regex</span><span class="op">(</span><span class="va">met_brands_pattern</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"met"</span>, </span>
<span>    <span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_brand</span><span class="op">)</span></span>
<span><span class="co"># validate:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_brand</span> <span class="op">==</span> <span class="st">"met"</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
     Methadone Hcl Methadone Intensol          Methadose 
             16784                 20                  4 </code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_brand</span> <span class="op">==</span> <span class="st">"met"</span><span class="op">]</span>, <span class="va">data_2021</span><span class="op">$</span><span class="va">Gnrc_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"met"</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>                    
                     Methadone Hcl
  Methadone Hcl              16784
  Methadone Intensol            20
  Methadose                      4</code></pre>
</div>
</div>
<p>We will now sort each observation according to treatment intention, and assign values to the <code>tx</code> variable. Entries in which methadone was used to treat OUD will be assigned <code>met_oud</code>, entries in which methadone was used to treat pain will be assigned <code>met_pain</code>. Products indicated for OUD include Dolophine (methadone HCl oral concentrate), Methadone HCl (oral concentrate, oral solution, oral tablet), Methadose (oral concentrate, oral solution, oral tablet), and generic methadone HCl (oral concentrate, oral solution, oral tablet); whereas products indicated for pain include generic methadone HCl (parenteral), Dolophine and Methadone Intensol. Thus, in the <code>Brnd_Name</code> vs <code>Gnrc_Name</code> cross-tabulation above, we see that two entries are possibly ambiguous, those in which both variables have the value <code>Methadone HCl</code> (which could be parenteral methadone HCl [pain], or methadone HCl oral concentrate, oral solution, Dolophine, or oral tablet [OUD]). Given that usage of methadone for pain is not common practice in the U.S., we will assume that these ambiguous entries are for OUD, and will generate the <code>tx</code> variable by recoding the <code>Brnd_Name</code> variable:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_2021</span><span class="op">$</span><span class="va">tx</span> <span class="op">&lt;-</span> <span class="fu">case_match</span><span class="op">(</span></span>
<span>  <span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Methadone Hcl"</span>, <span class="st">"Methadose"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"met_oud"</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Dolophine"</span>, <span class="st">"Methadone Diskets"</span>, <span class="st">"Methadone Intensol"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"met_pain"</span>,</span>
<span>  .default <span class="op">=</span> <span class="va">data_2021</span><span class="op">$</span><span class="va">tx</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># validate by tabling `tx` against `Brnd_Name` for entries where MAT_generic == "met":</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"met"</span><span class="op">]</span>, <span class="va">data_2021</span><span class="op">$</span><span class="va">tx</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"met"</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>                    
                     met_oud met_pain
  Methadone Hcl        16784        0
  Methadone Intensol       0       20
  Methadose                4        0</code></pre>
</div>
</div>
<p>Repeating for naltrexone:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>  <span class="fu">str_detect</span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Gnrc_Name</span>, <span class="fu">regex</span><span class="op">(</span><span class="st">"naltrex"</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> </span>
<span>  <span class="op">&amp;</span> <span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Gnrc_Name</span>, <span class="fu">regex</span><span class="op">(</span><span class="st">"Methylnaltrexone"</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>  <span class="co"># filter out methylnaltrexone</span></span>
<span>  <span class="op">&amp;</span> <span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Gnrc_Name</span>, <span class="fu">regex</span><span class="op">(</span><span class="st">"Bupropion"</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,        <span class="co"># filter out Contrave</span></span>
<span>  <span class="st">"nal"</span>, </span>
<span>  <span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Testing the above encoding:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># to test the variable encoding we will table all of the values of `Gnrc_Name which were matched above:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Gnrc_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"nal"</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
         Naltrexone Hcl Naltrexone Microspheres 
                   7283                     803 </code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># and table the brand names:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"nal"</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
Naltrexone Hcl       Vivitrol 
          7283            803 </code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># crosstabulate</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"nal"</span><span class="op">]</span>, <span class="va">data_2021</span><span class="op">$</span><span class="va">Gnrc_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"nal"</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>                
                 Naltrexone Hcl Naltrexone Microspheres
  Naltrexone Hcl           7283                       0
  Vivitrol                    0                     803</code></pre>
</div>
</div>
<p>Checking against brand names:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#as above with buprenorphine we will construct a vector of naltrexone brand names:</span></span>
<span><span class="va">nal_brands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Depade"</span>, <span class="st">"Naltrexone"</span>, <span class="st">"Revia"</span>, <span class="st">"Vivitrol"</span><span class="op">)</span></span>
<span><span class="co"># and construct a regex pattern:</span></span>
<span><span class="va">nal_brands_pattern</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">nal_brands</span>, collapse <span class="op">=</span> <span class="st">"|"</span><span class="op">)</span></span>
<span><span class="co"># and assign the `nal` value to the `MAT_brand` variable:</span></span>
<span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_brand</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>  <span class="fu">str_detect</span><span class="op">(</span></span>
<span>    <span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span>, </span>
<span>    <span class="fu">regex</span><span class="op">(</span><span class="va">nal_brands_pattern</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"nal"</span>, </span>
<span>    <span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_brand</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># validate:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_brand</span> <span class="op">==</span> <span class="st">"nal"</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
Naltrexone Hcl       Vivitrol 
          7283            803 </code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_brand</span> <span class="op">==</span> <span class="st">"nal"</span><span class="op">]</span>, <span class="va">data_2021</span><span class="op">$</span><span class="va">Gnrc_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_brand</span> <span class="op">==</span> <span class="st">"nal"</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>                
                 Naltrexone Hcl Naltrexone Microspheres
  Naltrexone Hcl           7283                       0
  Vivitrol                    0                     803</code></pre>
</div>
</div>
<p>Unfortunately there is no way to distinguish between naltrexone for OUD and naltrexone for alcohol use disorder (AUD) using the current dataset. We will assume that all naltrexone prescriptions are for OUD, and will generate the <code>tx</code> variable by recoding the <code>Brnd_Name</code> variable:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_2021</span><span class="op">$</span><span class="va">tx</span> <span class="op">&lt;-</span> <span class="fu">case_match</span><span class="op">(</span></span>
<span>  <span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Depade"</span>, <span class="st">"Naltrexone"</span>, <span class="st">"Revia"</span>, <span class="st">"Vivitrol"</span>, <span class="st">"Naltrexone Hcl"</span>, <span class="st">"Naltrexone Microspheres"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"nal_oud"</span>,</span>
<span>  .default <span class="op">=</span> <span class="va">data_2021</span><span class="op">$</span><span class="va">tx</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># validate by tabling `tx` against `Brnd_Name` for entries where MAT_generic == "nal":</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"nal"</span><span class="op">]</span>, <span class="va">data_2021</span><span class="op">$</span><span class="va">tx</span><span class="op">[</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">==</span> <span class="st">"nal"</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>                
                 nal_oud
  Naltrexone Hcl    7283
  Vivitrol           803</code></pre>
</div>
</div>
<p>As a summary of the <code>tx</code> variable, we will tabulate the number of entries for each treatment intention:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span><span class="op">)</span><span class="op">]</span>,</span>
<span>      <span class="va">data_2021</span><span class="op">$</span><span class="va">tx</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">MAT_generic</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/addmargins.html">addmargins</a></span><span class="op">(</span>margin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>                        
                         bup_oud bup_pain met_oud met_pain nal_oud
  Belbuca                      0     3806       0        0       0
  Bunavail                     1        0       0        0       0
  Buprenex                     0       14       0        0       0
  Buprenorphine             6091        0       0        0       0
  Buprenorphine Hcl         5986        0       0        0       0
  Buprenorphine-Naloxone   17385        0       0        0       0
  Butrans                      0     1404       0        0       0
  Methadone Hcl                0        0   16784        0       0
  Methadone Intensol           0        0       0       20       0
  Methadose                    0        0       4        0       0
  Naltrexone Hcl               0        0       0        0    7283
  Sublocade                  194        0       0        0       0
  Suboxone                  6712        0       0        0       0
  Vivitrol                     0        0       0        0     803
  Zubsolv                   2011        0       0        0       0
  Sum                      38380     5224   16788       20    8086</code></pre>
</div>
</div>
<p>Lastly we will create a new dataset to work with using only entries corresponding to the three MAT drugs:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_2021_tx</span> <span class="op">&lt;-</span> <span class="va">data_2021</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_2021</span><span class="op">$</span><span class="va">tx</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="co">#verify the new dataset by tabulating tx vs brand names as above:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_2021_tx</span><span class="op">$</span><span class="va">Brnd_Name</span>, <span class="va">data_2021_tx</span><span class="op">$</span><span class="va">tx</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/addmargins.html">addmargins</a></span><span class="op">(</span>margin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>                        
                         bup_oud bup_pain met_oud met_pain nal_oud
  Belbuca                      0     3806       0        0       0
  Bunavail                     1        0       0        0       0
  Buprenex                     0       14       0        0       0
  Buprenorphine             6091        0       0        0       0
  Buprenorphine Hcl         5986        0       0        0       0
  Buprenorphine-Naloxone   17385        0       0        0       0
  Butrans                      0     1404       0        0       0
  Methadone Hcl                0        0   16784        0       0
  Methadone Intensol           0        0       0       20       0
  Methadose                    0        0       4        0       0
  Naltrexone Hcl               0        0       0        0    7283
  Sublocade                  194        0       0        0       0
  Suboxone                  6712        0       0        0       0
  Vivitrol                     0        0       0        0     803
  Zubsolv                   2011        0       0        0       0
  Sum                      38380     5224   16788       20    8086</code></pre>
</div>
</div>
</section></section><section id="treatment-variable" class="level2"><h2 class="anchored" data-anchor-id="treatment-variable">Treatment Variable</h2>
<section id="treatment-function" class="level3"><h3 class="anchored" data-anchor-id="treatment-function">Treatment Function</h3>
<p>We will now create a function to generate the treatment variable, <code>tx</code> for each year of data. For this function we will use the <code>dataset</code> argument to refer to the dataset to be processed, and <code>data</code> to refer to the data to be returned. We will generate the <code>tx</code> variable, and will also generate <code>MAT_generic~ and</code>MAT_brand<code>to serve as a check on the</code>tx` variable. The dataset returned will only include entries for which any of these three variables are not NA:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create a function to process the data:</span></span>
<span><span class="va">treatment</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_year</span>, <span class="va">bup_brands_pattern</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">met_brands_pattern</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">nal_brands_pattern</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># create the MAT_generic variable for buprenorphine:</span></span>
<span>  <span class="va">data_year</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>    <span class="fu">str_detect</span><span class="op">(</span></span>
<span>      <span class="va">data_year</span><span class="op">$</span><span class="va">Gnrc_Name</span>, </span>
<span>      <span class="fu">regex</span><span class="op">(</span><span class="st">"bupre"</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"bup"</span>, </span>
<span>    <span class="cn">NA</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># create the MAT_brand variable for buprenorphine:</span></span>
<span>  <span class="co"># if `bup_brands_pattern` not supplied as an argument, starting by creating a vector of buprenorphine brand names and concatinating to regex:</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">bup_brands_pattern</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">bup_brands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Belbuca"</span>, <span class="st">"Bunavail"</span>, <span class="st">"Buprenex"</span>, <span class="st">"Buprenorphine"</span>, <span class="st">"Butrans"</span>, <span class="st">"Probuphine"</span>, <span class="st">"Sublocade"</span>, <span class="st">"Suboxone"</span>, <span class="st">"Subutex"</span>, <span class="st">"Zubsolv"</span><span class="op">)</span></span>
<span>    <span class="va">bup_brands_pattern</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">bup_brands</span>, collapse <span class="op">=</span> <span class="st">"|"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># assign the MAT_brand value based on the regex:</span></span>
<span>  <span class="va">data_year</span><span class="op">$</span><span class="va">MAT_brand</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>    <span class="fu">str_detect</span><span class="op">(</span></span>
<span>      <span class="va">data_year</span><span class="op">$</span><span class="va">Brnd_Name</span>, </span>
<span>      <span class="fu">regex</span><span class="op">(</span><span class="va">bup_brands_pattern</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"bup"</span>, </span>
<span>    <span class="cn">NA</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># create the MAT_generic variable for methadone:</span></span>
<span>  <span class="va">data_year</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>    <span class="fu">str_detect</span><span class="op">(</span></span>
<span>      <span class="va">data_year</span><span class="op">$</span><span class="va">Gnrc_Name</span>, </span>
<span>      <span class="fu">regex</span><span class="op">(</span><span class="st">"methad"</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"met"</span>, </span>
<span>    <span class="va">data_year</span><span class="op">$</span><span class="va">MAT_generic</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># create the MAT_brand variable for methadone:</span></span>
<span>  <span class="co"># if `met_brands_pattern` not supplied as an argument, starting by creating a vector of methadone brand names and concatinating to regex:</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">met_brands_pattern</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">met_brands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Dolophine"</span>, <span class="st">"Methadone"</span>, <span class="st">"Methadose"</span>, <span class="st">"Diskets"</span><span class="op">)</span></span>
<span>    <span class="va">met_brands_pattern</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">met_brands</span>, collapse <span class="op">=</span> <span class="st">"|"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># assign the MAT_brand value:</span></span>
<span>  <span class="va">data_year</span><span class="op">$</span><span class="va">MAT_brand</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>    <span class="fu">str_detect</span><span class="op">(</span></span>
<span>      <span class="va">data_year</span><span class="op">$</span><span class="va">Brnd_Name</span>, </span>
<span>      <span class="fu">regex</span><span class="op">(</span><span class="va">met_brands_pattern</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"met"</span>, </span>
<span>    <span class="va">data_year</span><span class="op">$</span><span class="va">MAT_brand</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># create the MAT_generic variable for naltrexone:</span></span>
<span>  <span class="va">data_year</span><span class="op">$</span><span class="va">MAT_generic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>    <span class="fu">str_detect</span><span class="op">(</span></span>
<span>      <span class="va">data_year</span><span class="op">$</span><span class="va">Gnrc_Name</span>, </span>
<span>      <span class="fu">regex</span><span class="op">(</span><span class="st">"naltrex"</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">&amp;</span> <span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">data_year</span><span class="op">$</span><span class="va">Gnrc_Name</span>, <span class="fu">regex</span><span class="op">(</span><span class="st">"Methylnaltrexone"</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>  <span class="co"># filter out methylnaltrexone</span></span>
<span>      <span class="op">&amp;</span> <span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">data_year</span><span class="op">$</span><span class="va">Gnrc_Name</span>, <span class="fu">regex</span><span class="op">(</span><span class="st">"Bupropion"</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>         <span class="co"># filter out Contrave</span></span>
<span>      <span class="op">&amp;</span> <span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">data_year</span><span class="op">$</span><span class="va">Brnd_Name</span>, <span class="fu">regex</span><span class="op">(</span><span class="st">"Embeda"</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,           <span class="co"># filter out Embeda</span></span>
<span>    <span class="st">"nal"</span>, </span>
<span>    <span class="va">data_year</span><span class="op">$</span><span class="va">MAT_generic</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># create the MAT_brand variable for naltrexone:</span></span>
<span>  <span class="co"># if `nal_brands_pattern` not supplied as an argument, starting by creating a vector of naltrexone brand names and concatinating to regex:</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">nal_brands_pattern</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">nal_brands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Depade"</span>, <span class="st">"Naltrexone"</span>, <span class="st">"Revia"</span>, <span class="st">"Vivitrol"</span><span class="op">)</span></span>
<span>    <span class="va">nal_brands_pattern</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">nal_brands</span>, collapse <span class="op">=</span> <span class="st">"|"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># assign the MAT_brand value:</span></span>
<span>  <span class="va">data_year</span><span class="op">$</span><span class="va">MAT_brand</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>    <span class="fu">str_detect</span><span class="op">(</span></span>
<span>      <span class="va">data_year</span><span class="op">$</span><span class="va">Brnd_Name</span>, </span>
<span>      <span class="fu">regex</span><span class="op">(</span><span class="va">nal_brands_pattern</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"nal"</span>, </span>
<span>    <span class="va">data_year</span><span class="op">$</span><span class="va">MAT_brand</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># create the tx variable using `case_match` as above:</span></span>
<span><span class="va">data_year</span><span class="op">$</span><span class="va">tx</span> <span class="op">&lt;-</span> <span class="fu">case_match</span><span class="op">(</span></span>
<span>  <span class="va">data_year</span><span class="op">$</span><span class="va">Brnd_Name</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Bunavail"</span>, <span class="st">"Buprenorphine"</span>, <span class="st">"Buprenorphine Hcl"</span>, <span class="st">"Buprenorphine-Naloxone"</span>, <span class="st">"Sublocade"</span>, <span class="st">"Suboxone"</span>, <span class="st">"Subutex"</span>, <span class="st">"Zubsolv"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"bup_oud"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Belbuca"</span>, <span class="st">"Buprenex"</span>, <span class="st">"Butrans"</span>, <span class="st">"Probuphine"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"bup_pain"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Methadone Hcl"</span>, <span class="st">"Methadose"</span>, <span class="st">"Dolophine Hcl"</span>, <span class="st">"Diskets"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"met_oud"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Methadone Diskets"</span>, <span class="st">"Methadone Intensol"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"met_pain"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Depade"</span>, <span class="st">"Naltrexone"</span>, <span class="st">"Revia"</span>, <span class="st">"Vivitrol"</span>, <span class="st">"Naltrexone Hcl"</span>, <span class="st">"Naltrexone Microspheres"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"nal_oud"</span>,</span>
<span>    .default <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span>
<span>  </span>
<span><span class="co"># return the dataset limited to observations with a value in at least one of the MAT variables or the tx variable:</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">data_year</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_year</span><span class="op">$</span><span class="va">MAT_generic</span><span class="op">)</span> <span class="op">|</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_year</span><span class="op">$</span><span class="va">MAT_brand</span><span class="op">)</span> <span class="op">|</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_year</span><span class="op">$</span><span class="va">tx</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To test the function we will use the 2013 data:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">##| cache: true</span></span>
<span><span class="co"># load the 2013 data:</span></span>
<span><span class="va">data_2013</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"data/2013.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Rows: 23645873 Columns: 22
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (11): Prscrbr_Last_Org_Name, Prscrbr_First_Name, Prscrbr_City, Prscrbr_S...
dbl (11): Prscrbr_NPI, Tot_Clms, Tot_30day_Fills, Tot_Day_Suply, Tot_Drug_Cs...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_tx</span> <span class="op">&lt;-</span> <span class="fu">treatment</span><span class="op">(</span><span class="va">data_2013</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#verify the new dataset by tabulating tx vs brand names as above:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_tx</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_tx</span><span class="op">$</span><span class="va">MAT_generic</span><span class="op">)</span><span class="op">]</span>, <span class="va">data_tx</span><span class="op">$</span><span class="va">tx</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_tx</span><span class="op">$</span><span class="va">MAT_generic</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>                        
                         bup_oud bup_pain met_oud met_pain nal_oud
  Buprenex                     0       26       0        0       0
  Buprenorphine Hcl         1603        0       0        0       0
  Buprenorphine-Naloxone    1746        0       0        0       0
  Butrans                      0     2670       0        0       0
  Dolophine Hcl                0        0       1        0       0
  Methadone Hcl                0        0   28974        0       0
  Methadone Intensol           0        0       0       61       0
  Methadose                    0        0      28        0       0
  Naltrexone Hcl               0        0       0        0    2100
  Suboxone                  6510        0       0        0       0
  Vivitrol                     0        0       0        0      84
  Zubsolv                      1        0       0        0       0</code></pre>
</div>
</div>
<p>We can now iteratively apply the function to each year of data:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create data_tx as an empty dataset:</span></span>
<span><span class="va">data_tx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># iterate over years 2013-2021:</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">year</span> <span class="kw">in</span> <span class="fl">2013</span><span class="op">:</span><span class="fl">2021</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># load the data:</span></span>
<span>  <span class="va">data_year</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"data/"</span>, <span class="va">year</span>, <span class="st">".csv"</span><span class="op">)</span>,</span>
<span>    show_col_types <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># apply the treatment function:</span></span>
<span>  <span class="va">data_year</span> <span class="op">&lt;-</span> <span class="fu">treatment</span><span class="op">(</span><span class="va">data_year</span><span class="op">)</span></span>
<span>  <span class="co"># set the `year` variable:</span></span>
<span>  <span class="va">data_year</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="va">year</span></span>
<span>  <span class="co"># append the data to the `data_tx` dataset:</span></span>
<span>  <span class="va">data_tx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">data_tx</span>, <span class="va">data_year</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># cleanup</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">data_year</span>, <span class="va">year</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="validate" class="level3"><h3 class="anchored" data-anchor-id="validate">Validate</h3>
<p>We can now validate the new dataset by tabulating <code>tx</code> vs <code>brand names</code> variables as above:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_tx</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_tx</span><span class="op">$</span><span class="va">MAT_generic</span><span class="op">)</span><span class="op">]</span>, <span class="va">data_tx</span><span class="op">$</span><span class="va">tx</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_tx</span><span class="op">$</span><span class="va">MAT_generic</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># add row for totals:</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/addmargins.html">addmargins</a></span><span class="op">(</span>margin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>                        
                         bup_oud bup_pain met_oud met_pain nal_oud
  Belbuca                      0    11783       0        0       0
  Bunavail                   394        0       0        0       0
  Buprenex                     0      182       0        0       0
  Buprenorphine            19215        0       0        0       0
  Buprenorphine Hcl        32215        0       0        0       0
  Buprenorphine-Naloxone   66641        0       0        0       0
  Butrans                      0    34716       0        0       0
  Diskets                      0        0       3        0       0
  Dolophine Hcl                0        0      16        0       0
  Methadone Hcl                0        0  213145        0       0
  Methadone Intensol           0        0       0      288       0
  Methadose                    0        0     147        0       0
  Naltrexone Hcl               0        0       0        0   39793
  Sublocade                  396        0       0        0       0
  Suboxone                 73728        0       0        0       0
  Vivitrol                     0        0       0        0    3584
  Zubsolv                   9835        0       0        0       0
  Sum                     202424    46681  213311      288   43377</code></pre>
</div>
</div>
<p>We can see that three lines correspond to null values for the MAT variables, “Diskets” (a methadone OUD product), “Dolophine Hcl” (a methadone product indicated for OUD or pain), and “Embeda” (a morphine/naltrexone product). We will now count the number of observations with NA values for one or more of the MAT variables or the tx variable:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># filter to observations with NA values for one or more of the MAT variables or the tx variable:</span></span>
<span><span class="va">data_tx</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">MAT_generic</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">MAT_brand</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">tx</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># filter to observations with NA values for generic:</span></span>
<span><span class="va">data_tx</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">MAT_generic</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># filter to observations with NA values for brand:</span></span>
<span><span class="va">data_tx</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">MAT_brand</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># filter to observations with NA values for tx:</span></span>
<span><span class="va">data_tx</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">tx</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
<p>A little bit of cleanup:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="rural-vs-urban" class="level2"><h2 class="anchored" data-anchor-id="rural-vs-urban">Rural vs Urban</h2>
<section id="using-usgs-data" class="level3"><h3 class="anchored" data-anchor-id="using-usgs-data">Using USGS Data</h3>
<section id="usgs-classification-overview" class="level4"><h4 class="anchored" data-anchor-id="usgs-classification-overview">USGS Classification Overview</h4>
<p>Using the USGS Populated Places dataset, we will attempt to convert the city/state data from the dataset into the CDC’s 2013 Urban-Rural Classification using the following steps:</p>
<ul>
<li>The USGS dataset (which can be found as a text file within their Geographic Names Information System (GNIS) <a href="https://www.usgs.gov/us-board-on-geographic-names/download-gnis-data">here</a>) contains several variables including the state name/FIPS, the ‘map name’ (which is often the city name), and the county name/FIPS. The first step will be to lookup the city/state in this dataset and retrieve the full FIPS.</li>
<li>Lookup rural-urban clssification: For this step we can use the FIPS code to lookup the CDC’s <a href="https://www.cdc.gov/nchs/data_access/urban_rural.htm">2013 Urban-Rural Classification Scheme for Counties</a>; specifically using the <a href="https://www.cdc.gov/nchs/data/data_acces_files/NCHSURCodes2013.xlsx">NCHSurbruralcodes Spreadsheet</a> which contains the FIPS codes and rural-urban classifications for each county in the US.</li>
</ul></section><section id="prepping-the-usgs-dataset" class="level4"><h4 class="anchored" data-anchor-id="prepping-the-usgs-dataset">Prepping the USGS Dataset</h4>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># load the USGS Populated Places dataset:</span></span>
<span><span class="va">usgs</span> <span class="op">&lt;-</span> <span class="fu">read_delim</span><span class="op">(</span></span>
<span>  <span class="st">"data/PopulatedPlaces_National.txt"</span>,</span>
<span>  delim <span class="op">=</span> <span class="st">"|"</span>, <span class="co"># the file is pipe-delimited</span></span>
<span>  col_names <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Rows: 187506 Columns: 17
── Column specification ────────────────────────────────────────────────────────
Delimiter: "|"
chr (14): feature_name, feature_class, state_name, state_numeric, county_nam...
dbl  (3): feature_id, prim_lat_dec, prim_long_dec

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p>Creating a ‘short’ dataset to hopefully speed up the lookup process:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">usgs_short</span> <span class="op">&lt;-</span> <span class="va">usgs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">state_numeric</span>, <span class="va">map_name</span>, <span class="va">county_numeric</span>, <span class="va">feature_name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># test</span></span>
<span><span class="fu">n_distinct</span><span class="op">(</span><span class="va">usgs_short</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 187290</code></pre>
</div>
</div>
<p>Creating a ‘lower’ dataset with capitalization may find some straggling entries:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">usgs_lower</span> <span class="op">&lt;-</span> <span class="va">usgs</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">state_numeric</span>, <span class="va">map_name</span>, <span class="va">county_numeric</span>, <span class="va">feature_name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>                                     <span class="co"># remove duplicate rows</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    map_name <span class="op">=</span> <span class="fu">str_to_lower</span><span class="op">(</span><span class="va">map_name</span><span class="op">)</span>,              <span class="co"># convert map_name to lower case</span></span>
<span>    feature_name <span class="op">=</span> <span class="fu">str_to_lower</span><span class="op">(</span><span class="va">feature_name</span><span class="op">)</span>       <span class="co"># convert feature_name to lower case</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># test</span></span>
<span><span class="fu">n_distinct</span><span class="op">(</span><span class="va">usgs_lower</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 187290</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># cleanup</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">usgs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="searching-usgs-dataset-with-left_join" class="level4"><h4 class="anchored" data-anchor-id="searching-usgs-dataset-with-left_join">Searching USGS dataset with left_join</h4>
<p>The following code will find the county FIPS code from the USGS dataset; NB entries from Puerto Rico, Virgin Islands, and Guam are filtered out in this step, as are any entries with a military mail code or a missing address:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># `left_join` the USGS dataset into the `data_tx` to add `Prscrbr_County_FIPS`; matching on state and city:</span></span>
<span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="va">data_tx</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># filter out Puerto Rico, Virgin Islands, and Guam; these are not in NCHSUR  (codes 66, 72, 78):</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Prscrbr_State_FIPS</span> <span class="op">!=</span> <span class="st">"66"</span> <span class="op">&amp;</span> <span class="va">Prscrbr_State_FIPS</span> <span class="op">!=</span> <span class="st">"72"</span> <span class="op">&amp;</span> <span class="va">Prscrbr_State_FIPS</span> <span class="op">!=</span> <span class="st">"78"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># filter out military mail codes (codes AA, AE, AP); other codes (ZZ, XX):</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">Prscrbr_State_Abrvtn</span>, <span class="st">"AA"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">Prscrbr_State_Abrvtn</span>, <span class="st">"AE"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">Prscrbr_State_Abrvtn</span>, <span class="st">"AP"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">Prscrbr_State_Abrvtn</span>, <span class="st">"ZZ"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">Prscrbr_State_Abrvtn</span>, <span class="st">"XX"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># filter out missing state fips:</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Prscrbr_State_FIPS</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span></span>
<span>      <span class="va">usgs_short</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span>,                              <span class="co"># the 'right' dataset; [-c(4)] removes variable with index 4, feature_name</span></span>
<span>      by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span></span>
<span>        <span class="va">Prscrbr_State_FIPS</span> <span class="op">==</span> <span class="va">state_numeric</span>,</span>
<span>        <span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="va">map_name</span></span>
<span>      <span class="op">)</span>,</span>
<span>      relationship <span class="op">=</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span>      multiple <span class="op">=</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Verification:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 505396</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_tx</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 685</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># how many missing lines</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 265408</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># how many unique combinations of city/state are missing:</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_FIPS</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 4675</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># store county FIPS in new variable for next merge:</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span> <span class="op">&lt;-</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">county_numeric</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can try matching the <code>Prscrbr_City</code> to the <code>feature_name</code> variable in the USGS dataset:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">|&gt;</span>                        <span class="co"># remove county_numeric to prevent naming collision</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">usgs_short</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>,                              <span class="co"># the 'right' dataset; [-c(2)] removes variable with index 2, map_name</span></span>
<span>    by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span></span>
<span>        <span class="va">Prscrbr_State_FIPS</span> <span class="op">==</span> <span class="va">state_numeric</span>,</span>
<span>        <span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="va">feature_name</span></span>
<span>    <span class="op">)</span>,</span>
<span>    relationship <span class="op">=</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span>    multiple <span class="op">=</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># number of missing:</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 16326</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># number missing for both:</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_FIPS</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 14397</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># county number of distinct city/state pairs produce missing values</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_FIPS</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 810</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># view some missing entries to get some idea of what's going on:</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">Prscrbr_NPI</span>, <span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_Abrvtn</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 100 × 3
   Prscrbr_NPI Prscrbr_City    Prscrbr_State_Abrvtn
         &lt;dbl&gt; &lt;chr&gt;           &lt;chr&gt;               
 1  1003109216 Shelby Township MI                  
 2  1003169947 Coeur D Alene   ID                  
 3  1003801713 St Petersburg   FL                  
 4  1003804485 Fleming Island  FL                  
 5  1003809450 Plains          PA                  
 6  1003809450 Plains          PA                  
 7  1003840034 Coeur D Alene   ID                  
 8  1003857178 Berlin          VT                  
 9  1003873662 Deltaville      VA                  
10  1003889544 St. Paul        MN                  
# ℹ 90 more rows</code></pre>
</div>
</div>
<p>The above output shows common issues with place names between the datasets:</p>
<ul>
<li>apostrophes are missing in the CDC dataset, but not USGS</li>
<li>‘saint’, ‘Mt’, ‘N’, ‘Ft.’ are all abbreviated in CDC, but not USGS; similarly ‘Phila.’ is ‘Philadelphia’ in USGS</li>
<li>‘plains’ PA corresponds to ‘Plainsville’ in USGS</li>
<li>Berlin vt is in Washington County, FIPS 023, but this is <code>west Berlin</code> in USGS; similarly ‘Hardwick’ is separated as ’ Hardwick Center’, etc</li>
<li>‘Stansbury Park’ is miscapitalized as ‘Stansbury park’ in the USGS dataset</li>
<li>‘Saint Clair Shores’ MI is in Macomb County, FIPS 099, but this is listed as ‘’Saint Clair Haven’ in the USGS dataset</li>
<li>‘DeFuniak Springs’ FL is in Walton County, FIPS 131, but this is listed as ‘De Funiak Springs’ in the USGS dataset</li>
<li>‘Desoto’ TX is in Dallas County, FIPS 113, but this is listed as ‘DeSoto’ in the USGS dataset</li>
<li>‘Allenstown’ NH is in Merrimack County, FIPS 013, but this is listed as ‘Allenstown Elementary School’ in the USGS dataset</li>
<li>Cortlandt Manor NY is in Westchester County, FIPS 119, but this is listed as ‘Van Cortlandtville’ in the USGS dataset</li>
<li>‘Village Of Golf’ FL is in Palm Beach County, FIPS 099, but this is listed as ‘Golf’ in the USGS dataset</li>
<li>entries which may need to be hardcoded (e.g.&nbsp;USGS unlisted entries):
<ul>
<li>Shelby Township is in Oceana County, FIPS 127</li>
<li>Johnston RI is in Providence County, FIPS 007, but this is unlisted in the USGS dataset</li>
<li>Mercerville nj is in Mercer County, FIPS 021, but this is unlisted in the USGS dataset</li>
<li>‘Brownstown Twp’ MI is in Wayne County, FIPS 163, but this is unlisted in the USGS dataset</li>
<li>‘Clinton Twp’ MI is in Macomb County, FIPS 099, but this is unlisted in the USGS dataset</li>
</ul>
</li>
</ul>
<p>We can write a recode of the <code>Prscrbr_City</code> variable from the CDC dataset using <code>campfin</code> package and the <code>expand_abbrev</code> function to fix these issues:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span> <span class="op">&lt;-</span> <span class="fu">expand_abbrev</span><span class="op">(</span></span>
<span>  <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span>,</span>
<span>  <span class="co"># vector of regexes of abbreviations to expand:</span></span>
<span>  abb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"St\\."</span>, <span class="st">"St\\s"</span>, <span class="st">"Mt\\."</span>, <span class="st">"Mt\\s"</span>, <span class="st">"N\\."</span>, <span class="st">"N\\s"</span>, </span>
<span>    <span class="st">"S\\."</span>, <span class="st">"S\\s"</span>, <span class="st">"E\\."</span>, <span class="st">"E\\s"</span>, <span class="st">"W\\."</span>, <span class="st">"W\\s"</span>, </span>
<span>    <span class="st">"Phila\\."</span>, <span class="st">"Phila\\s"</span>, <span class="st">"Phila$"</span>, <span class="st">"Twp\\."</span>, <span class="st">"Twp\\s"</span>, </span>
<span>    <span class="st">"Coeur D Alene"</span>, <span class="st">"\\sD\\s"</span>, <span class="st">"Stansbury Park"</span>, <span class="st">"^Plains$"</span>,</span>
<span>    <span class="st">"DeFuniak Springs"</span>, <span class="st">"Defuniak Springs"</span>, <span class="st">"Desoto"</span>, <span class="st">"Cortlandt Manor"</span>, <span class="st">"Village Of Golf"</span>,</span>
<span>    <span class="st">"Mcmurray"</span></span>
<span>    <span class="op">)</span>,</span>
<span>  <span class="co"># vector of expansions for corresponding regex:</span></span>
<span>  rep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Saint"</span>, <span class="st">"Saint "</span>, <span class="st">"Mount"</span>, <span class="st">"Mount "</span>, <span class="st">"North"</span>, <span class="st">"North "</span>, </span>
<span>    <span class="st">"South"</span>, <span class="st">"South "</span>, <span class="st">"East"</span>, <span class="st">"East "</span>, <span class="st">"West"</span>, <span class="st">"West "</span>, </span>
<span>    <span class="st">"Philadelphia"</span>, <span class="st">"Philadelphia "</span>, <span class="st">"Philadelphia"</span>, <span class="st">"Township"</span>, <span class="st">"Township "</span>, </span>
<span>    <span class="st">"Coeur D'Alene"</span>, <span class="st">" D'"</span>, <span class="st">"Stansbury park"</span>, <span class="st">"Plainsville"</span>, </span>
<span>    <span class="st">"De Funiak Springs"</span>, <span class="st">"De Funiak Springs"</span>, <span class="st">"DeSoto"</span>, <span class="st">"Van Cortlandtville"</span>, <span class="st">"Golf"</span>,</span>
<span>    <span class="st">"McMurray"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Repeating the above process to match on the new <code>city_fixed</code> variable:</p>
<p>first we will collect our previously found county FIPS variables into a single entry:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span> <span class="op">&lt;-</span> <span class="fu">fifelse</span><span class="op">(</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span><span class="op">)</span>,       <span class="co"># test if Prscrbr_County_FIPS is not missint</span></span>
<span>  <span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span>,               <span class="co"># if not missing, value is Prscrbr_County_FIPS</span></span>
<span>  <span class="va">data_fips</span><span class="op">$</span><span class="va">county_numeric</span>,                    <span class="co"># if Prscrbr_County_FIPS is NA, fills in with county_numeric</span></span>
<span>  na <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># test</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span></span>
<span>  <span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span> <span class="op">==</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">county_numeric</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/addmargins.html">addmargins</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>       
         FALSE   TRUE    Sum
  FALSE  30498      0  30498
  TRUE  458572      0 458572
  Sum   489070      0 489070</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_numeric</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/addmargins.html">addmargins</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>       
         FALSE   TRUE    Sum
  FALSE 489070      0 489070
  TRUE    1929  14397  16326
  Sum   490999  14397 505396</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 14397</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb98"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># this shows us that we can safely remove county_numeric:</span></span>
<span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># remove feature_name, USGS_city_name, Prscrbr_County_FIPS:</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">county_numeric</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Matching city_fixed on map_name:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">usgs_short</span>,                                     <span class="co"># the 'right' dataset</span></span>
<span>      by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span></span>
<span>        <span class="va">city_fixed</span> <span class="op">==</span> <span class="va">map_name</span>,                     <span class="co"># these variables must exactly match in both datasets</span></span>
<span>        <span class="va">Prscrbr_State_FIPS</span> <span class="op">==</span> <span class="va">state_numeric</span></span>
<span>        <span class="op">)</span>,</span>
<span>    relationship <span class="op">=</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span>    multiple <span class="op">=</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">feature_name</span><span class="op">)</span>                             <span class="co"># remove feature_name</span></span>
<span></span>
<span><span class="co"># check</span></span>
<span><span class="co"># how many new finds</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 2062</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb101"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># merge new values into county_fips</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span> <span class="op">&lt;-</span> <span class="fu">fifelse</span><span class="op">(</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span><span class="op">)</span>,</span>
<span>  <span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span>,</span>
<span>  <span class="va">data_fips</span><span class="op">$</span><span class="va">county_numeric</span>,</span>
<span>  na <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># how many remain missing</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 12335</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb103"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb105"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># get rid of county_numeric now:</span></span>
<span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">county_numeric</span><span class="op">)</span>                        <span class="co"># remove county_numeric</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>matching city_fixed on feature_name:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb106"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">usgs_short</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>,                              <span class="co"># the 'right' dataset; [-c(2)] removes variable with index 2, map_name</span></span>
<span>      by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span></span>
<span>        <span class="va">city_fixed</span> <span class="op">==</span> <span class="va">feature_name</span>,                 <span class="co"># these variables must exactly match in both datasets</span></span>
<span>        <span class="va">Prscrbr_State_FIPS</span> <span class="op">==</span> <span class="va">state_numeric</span></span>
<span>        <span class="op">)</span>,</span>
<span>    relationship <span class="op">=</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span>    multiple <span class="op">=</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># how many new finds</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 1698</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb108"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># how many remain NA</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 10637</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb110"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># merge new values into county_fips</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span> <span class="op">&lt;-</span> <span class="fu">fifelse</span><span class="op">(</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span><span class="op">)</span>,</span>
<span>  <span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span>,</span>
<span>  <span class="va">data_fips</span><span class="op">$</span><span class="va">county_numeric</span>,</span>
<span>  na <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># verify the merge by checking NA values</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb112"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># remove county_numeric</span></span>
<span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">county_numeric</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Examine the remaining missing county_fips:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb113"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># number of missing :</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 10637</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb115"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># county number of distinct city/state pairs produce missing values</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_FIPS</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">n_distinct</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 700</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb117"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># view some missing entries to get some idea of what's going on:</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># select(Prscrbr_City, Prscrbr_State_Abrvtn, city_fixed) |&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 100 × 28
   Prscrbr_NPI Prscrbr_Last_Org_Name Prscrbr_First_Name Prscrbr_City   
         &lt;dbl&gt; &lt;chr&gt;                 &lt;chr&gt;              &lt;chr&gt;          
 1  1003109216 Dimovski              Nikolas            Shelby Township
 2  1003857178 Felsted               Laura              Berlin         
 3  1003889544 Oakman                Scott              St. Paul       
 4  1003889544 Oakman                Scott              St. Paul       
 5  1003896101 Ong                   Warren             Johnston       
 6  1003966482 Toma                  Cornelius          Mercerville    
 7  1013127893 Moesner               Patricia           Brownstown Twp 
 8  1013972678 Morgan                Sarah              Hardwick       
 9  1013972678 Morgan                Sarah              Hardwick       
10  1013983865 Todd                  Kathleen           Mailtand       
# ℹ 90 more rows
# ℹ 24 more variables: Prscrbr_State_Abrvtn &lt;chr&gt;, Prscrbr_State_FIPS &lt;chr&gt;,
#   Prscrbr_Type &lt;chr&gt;, Prscrbr_Type_Src &lt;chr&gt;, Brnd_Name &lt;chr&gt;,
#   Gnrc_Name &lt;chr&gt;, Tot_Clms &lt;dbl&gt;, Tot_30day_Fills &lt;dbl&gt;,
#   Tot_Day_Suply &lt;dbl&gt;, Tot_Drug_Cst &lt;dbl&gt;, Tot_Benes &lt;dbl&gt;,
#   GE65_Sprsn_Flag &lt;chr&gt;, GE65_Tot_Clms &lt;dbl&gt;, GE65_Tot_30day_Fills &lt;dbl&gt;,
#   GE65_Tot_Drug_Cst &lt;dbl&gt;, GE65_Tot_Day_Suply &lt;dbl&gt;, …</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb119"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">places</span> <span class="op">&lt;-</span> <span class="va">data_fips</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_Abrvtn</span>, <span class="va">city_fixed</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_Abrvtn</span>, <span class="va">city_fixed</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Prscrbr_City', 'Prscrbr_State_Abrvtn'. You
can override using the `.groups` argument.</code></pre>
</div>
</div>
<p>The above output shows common issues with place names between the datasets remain. We can write another recode of the <code>Prscrbr_City</code> variable from the CDC dataset using <code>campfin</code> package and the <code>expand_abbrev</code> function to fix these issues:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb121"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span> <span class="op">&lt;-</span> <span class="fu">expand_abbrev</span><span class="op">(</span></span>
<span>  <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span>,</span>
<span>  abb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Winston Salem"</span> <span class="op">=</span> <span class="st">"Winston-Salem"</span>,</span>
<span>    <span class="st">"Coeur D Alene"</span> <span class="op">=</span> <span class="st">"Coeur D'Alene"</span>,</span>
<span>    <span class="st">"Wilkes Barre"</span> <span class="op">=</span> <span class="st">"Wilkes-Barre"</span>,</span>
<span>    <span class="st">"Fond Du Lac"</span> <span class="op">=</span> <span class="st">"Fond du Lac"</span>,</span>
<span>    <span class="st">"Southold New York"</span> <span class="op">=</span> <span class="st">"Southold"</span>,</span>
<span>    <span class="co"># it will be quicker to manually find each instance where 'Mc' is followed by a lower case letter and add a line to capitalize each letter here:  # NB I'm going in alphabetical order here</span></span>
<span>    <span class="st">"Mcadenville"</span> <span class="op">=</span> <span class="st">"McAdenville"</span>,</span>
<span>    <span class="st">"Mcalester"</span> <span class="op">=</span> <span class="st">"McAlester"</span>,</span>
<span>    <span class="st">"Mcallen"</span> <span class="op">=</span> <span class="st">"McAllen"</span>,</span>
<span>    <span class="st">"Mccall"</span> <span class="op">=</span> <span class="st">"McCall"</span>,</span>
<span>    <span class="st">"Mccaysville"</span> <span class="op">=</span> <span class="st">"McCaysville"</span>,</span>
<span>    <span class="st">"Mcclearly"</span> <span class="op">=</span> <span class="st">"McClearly"</span>,</span>
<span>    <span class="st">"Mccleary"</span> <span class="op">=</span> <span class="st">"McCleary"</span>,</span>
<span>    <span class="st">"Mcclellan"</span> <span class="op">=</span> <span class="st">"McClellan"</span>,</span>
<span>    <span class="st">"Mcclellanville"</span> <span class="op">=</span> <span class="st">"McClellanville"</span>,</span>
<span>    <span class="st">"Mccloud"</span> <span class="op">=</span> <span class="st">"McCloud"</span>,</span>
<span>    <span class="st">"Mccomb"</span> <span class="op">=</span> <span class="st">"McComb"</span>,</span>
<span>    <span class="st">"Mcconnelsville"</span> <span class="op">=</span> <span class="st">"McConnelsville"</span>,</span>
<span>    <span class="st">"Mcconnelsville"</span> <span class="op">=</span> <span class="st">"McConnelsville"</span>,</span>
<span>    <span class="st">"Mccormick"</span> <span class="op">=</span> <span class="st">"McCormick"</span>,</span>
<span>    <span class="st">"Mccrory"</span> <span class="op">=</span> <span class="st">"McCrory"</span>,</span>
<span>    <span class="st">"Mcdonough"</span> <span class="op">=</span> <span class="st">"McDonough"</span>,</span>
<span>    <span class="st">"Mcgrath"</span> <span class="op">=</span> <span class="st">"McGrath"</span>,</span>
<span>    <span class="st">"Mcgregor"</span> <span class="op">=</span> <span class="st">"McGregor"</span>,</span>
<span>    <span class="st">"Mchenry"</span> <span class="op">=</span> <span class="st">"McHenry"</span>,</span>
<span>    <span class="st">"Mckeesport"</span> <span class="op">=</span> <span class="st">"McKeesport"</span>,</span>
<span>    <span class="st">"Mckinleyville"</span> <span class="op">=</span> <span class="st">"McKinleyville"</span>,</span>
<span>    <span class="st">"Mckinney"</span> <span class="op">=</span> <span class="st">"McKinney"</span>,</span>
<span>    <span class="st">"Mclean"</span> <span class="op">=</span> <span class="st">"McLean"</span>,</span>
<span>    <span class="st">"Mcmechen"</span> <span class="op">=</span> <span class="st">"McMechen"</span>,</span>
<span>    <span class="st">"Mcminnville"</span> <span class="op">=</span> <span class="st">"McMinnville"</span>,</span>
<span>    <span class="st">"Mcpherson"</span> <span class="op">=</span> <span class="st">"McPherson"</span>,</span>
<span>    <span class="st">"Mc "</span> <span class="op">=</span> <span class="st">"Mc"</span>,</span>
<span>    <span class="st">"Ft "</span> <span class="op">=</span> <span class="st">"Fort "</span>,</span>
<span>    <span class="st">"Ft. "</span> <span class="op">=</span> <span class="st">"Fort "</span>,</span>
<span>    <span class="st">"O Fallon"</span> <span class="op">=</span> <span class="st">"O'Fallon"</span>,</span>
<span>    <span class="st">"O'fallon"</span> <span class="op">=</span> <span class="st">"O'Fallon"</span>,</span>
<span>    <span class="st">"Hts."</span> <span class="op">=</span> <span class="st">"Heights"</span>,</span>
<span>    <span class="st">"Hts"</span> <span class="op">=</span> <span class="st">"Heights"</span>,</span>
<span>    <span class="st">"Hgts."</span> <span class="op">=</span> <span class="st">"Heights"</span>,</span>
<span>    <span class="st">"Hgts"</span> <span class="op">=</span> <span class="st">"Heights"</span>,</span>
<span>    <span class="st">"Spgs."</span> <span class="op">=</span> <span class="st">"Springs"</span>,</span>
<span>    <span class="st">"Spgs"</span> <span class="op">=</span> <span class="st">"Springs"</span>,</span>
<span>    <span class="st">"St. "</span> <span class="op">=</span> <span class="st">"Saint "</span>,</span>
<span>    <span class="st">"St "</span> <span class="op">=</span> <span class="st">"Saint "</span>,</span>
<span>    <span class="st">"Lavale"</span> <span class="op">=</span> <span class="st">"La Vale"</span>,</span>
<span>    <span class="st">"La Place"</span> <span class="op">=</span> <span class="st">"Laplace"</span>,</span>
<span>    <span class="st">"Hts"</span> <span class="op">=</span> <span class="st">"Heights"</span>,</span>
<span>    <span class="st">"Hts."</span> <span class="op">=</span> <span class="st">"Heights"</span>,</span>
<span>    <span class="st">"Pt "</span> <span class="op">=</span> <span class="st">"Point "</span>,</span>
<span>    <span class="st">"Gt "</span> <span class="op">=</span> <span class="st">"Great "</span>,</span>
<span>    <span class="st">"Pittburgh"</span> <span class="op">=</span> <span class="st">"Pittsburgh"</span>,</span>
<span>    <span class="st">"Coeur D'alene"</span> <span class="op">=</span> <span class="st">"Coeur D'Alene"</span>,</span>
<span>    <span class="st">"Ste Genevieve"</span> <span class="op">=</span> <span class="st">"Sainte Genevieve"</span>,</span>
<span>    <span class="st">"Vero Bch"</span> <span class="op">=</span> <span class="st">"Vero Beach"</span>,</span>
<span>    <span class="st">"Schnectady"</span> <span class="op">=</span> <span class="st">"Schenectady"</span>,</span>
<span>    <span class="st">"Wright Patterson Afb"</span> <span class="op">=</span> <span class="st">"Dayton"</span>,</span>
<span>    <span class="st">"No "</span> <span class="op">=</span> <span class="st">"North "</span>,</span>
<span>    <span class="st">"Bala Cynwyd"</span> <span class="op">=</span> <span class="st">"Bala-Cynwyd"</span>,</span>
<span>    <span class="st">"Deland"</span> <span class="op">=</span> <span class="st">"DeLand"</span>,</span>
<span>    <span class="st">"O "</span> <span class="op">=</span> <span class="st">"O'"</span>,</span>
<span>    <span class="st">"Keesler Afb"</span> <span class="op">=</span> <span class="st">"Biloxi"</span>,</span>
<span>    <span class="st">"Mt. "</span> <span class="op">=</span> <span class="st">"Mount "</span>,</span>
<span>    <span class="st">"Phila."</span> <span class="op">=</span> <span class="st">"Philadelphia"</span>,</span>
<span>    <span class="st">"N. "</span> <span class="op">=</span> <span class="st">"North "</span>,</span>
<span>    <span class="st">"W. "</span> <span class="op">=</span> <span class="st">"West "</span>,</span>
<span>    <span class="st">"La Porte"</span> <span class="op">=</span> <span class="st">"LaPorte"</span>,</span>
<span>    <span class="st">"Defuniak Springs"</span> <span class="op">=</span> <span class="st">"De Funiak Springs"</span>,</span>
<span>    <span class="st">"Pgh"</span> <span class="op">=</span> <span class="st">"Pittsburgh"</span>,</span>
<span>    <span class="st">"Sedro-Wooley"</span> <span class="op">=</span> <span class="st">"Sedro-Woolley"</span>,</span>
<span>    <span class="st">"St.Paul"</span> <span class="op">=</span> <span class="st">"Saint Paul"</span>,</span>
<span>    <span class="st">"St.Clairsville"</span> <span class="op">=</span> <span class="st">"Saint Clairsville"</span>,</span>
<span>    <span class="st">"Land O Lakes"</span> <span class="op">=</span> <span class="st">"Land O' Lakes"</span>,</span>
<span>    <span class="st">"Coeur D' Alene"</span> <span class="op">=</span> <span class="st">"Coeur D'Alene"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># manually set "West Bloomfield" MI `city_fixed` to 'Bloomfield:</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"West Bloomfield"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"MI"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Bloomfield"</span></span>
<span><span class="co"># manually set "Clinton Township" MI, or 'Clinton Twp" MI 'city_fixed' value to 'Macomb': </span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Clinton Township"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"MI"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Macomb"</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Clinton Twp"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"MI"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Macomb"</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Saint Clair Shores"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"MI"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Macomb"</span></span>
<span><span class="co"># manually set Brick NJ `city_fixed` to 'Bricktown':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Brick"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"NJ"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Bricktown"</span></span>
<span><span class="co"># manually set Lutherville MD `city_fixed` to 'Timonium Heights':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Lutherville"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"MD"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Timonium Heights"</span></span>
<span><span class="co"># Cranberry Twp PA manually set to 'Butler':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Cranberry Twp"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"PA"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Butler"</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Cranberry Township"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"PA"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Butler"</span></span>
<span><span class="co"># Voorhees NJ manually set to 'Camden':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Voorhees"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"NJ"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Camden"</span></span>
<span><span class="co"># Berlin VT manually set to 'Berlin Corners':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Berlin"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"VT"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Berlin Corners"</span></span>
<span><span class="co"># sandy UT manually set to 'Salt Lake City':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Sandy"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"UT"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Salt Lake City"</span></span>
<span><span class="co"># Johnston RI manually set to 'Providence':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Johnston"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"RI"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Providence"</span></span>
<span><span class="co"># Dartmouth MA manually set to 'New Bedford':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Dartmouth"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"MA"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"New Bedford"</span></span>
<span><span class="co"># Fort Mohave AZ manually set to 'Mohave Valley':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Fort Mohave"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"AZ"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Mohave Valley"</span></span>
<span><span class="co"># Greenwich CT manually set to 'Stamford':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Greenwich"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"CT"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Stamford"</span></span>
<span><span class="co"># neptune NJ manually set to 'Asbury Park':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Neptune"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"NJ"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Asbury Park"</span></span>
<span><span class="co"># Vestavia Hills AL manually set to 'Birmingham':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Vestavia"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"AL"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Birmingham"</span></span>
<span><span class="co"># Westampton NJ manually set to 'Mount Holly':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Westampton"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"NJ"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Mount Holly"</span></span>
<span><span class="co"># Lagrange GA manually set to 'La Grange':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Lagrange"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"GA"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"La Grange"</span></span>
<span><span class="co"># Carmel CA manually set to 'Monterey':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Carmel"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"CA"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Monterey"</span></span>
<span><span class="co"># West Hills CA manually set to 'Los Angeles':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"West Hills"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"CA"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Los Angeles"</span></span>
<span><span class="co"># Colebrook NH manually set to 'Coos Junction':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Colebrook"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"NH"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Coos Junction"</span></span>
<span><span class="co"># North Huntingdon PA manually set to 'Irwin':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"North Huntingdon"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"PA"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Irwin"</span></span>
<span><span class="co"># King of Prussia PA manually set to 'Montgomery':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"King of Prussia"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"PA"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Montgomery"</span></span>
<span><span class="co"># Kihei HI manually set to 'Maui Meadows':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Kihei"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"HI"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Maui Meadows"</span></span>
<span><span class="co"># Galloway NJ manually set to 'Atlantic City':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Galloway"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"NJ"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Atlantic City"</span></span>
<span><span class="co"># Greenacres FL manually set to 'West Palm Beach':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Greenacres"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"FL"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"West Palm Beach"</span></span>
<span><span class="co"># Kailua Kona HI manually set to 'Kailua':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Kailua Kona"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"HI"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Kailua"</span></span>
<span><span class="co"># Brownstown Twp MI manually set to 'Detroit':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Brownstown Twp"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"MI"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Detroit"</span></span>
<span><span class="co"># Egg Harbor Township NJ manually set to 'Atlantic City':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Egg Harbor Township"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"NJ"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Atlantic City"</span></span>
<span><span class="co"># Castleton NY manually set to 'Albany':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Castleton"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"NY"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Albany"</span></span>
<span><span class="co"># Allenstown NH manually set to 'Concord':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Allenstown"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"NH"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Concord"</span></span>
<span><span class="co"># Wilmington VT manually set to 'Brattleboro':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Wilmington"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"VT"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Brattleboro"</span></span>
<span><span class="co"># Slc UT manually set to 'Salt Lake City':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Slc"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"UT"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Salt Lake City"</span></span>
<span><span class="co"># Ocean NJ manually set to 'Asbury Park':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Ocean"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"NJ"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Asbury Park"</span></span>
<span><span class="co"># Timonium MD manually set to 'Baltimore':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Timonium"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"MD"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Baltimore"</span></span>
<span><span class="co"># Fort Bragg NC manually set to 'Fayetteville':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Fort Bragg"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"NC"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Fayetteville"</span></span>
<span><span class="co"># Rockingham VA manually set to 'Harrisonburg':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Rockingham"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"VA"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Harrisonburg"</span></span>
<span><span class="co"># Lansdowne VA manually set to 'Leesburg':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Lansdowne"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"VA"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Leesburg"</span></span>
<span><span class="co"># Aston PA manually set to 'Philadelphia':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Aston"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"PA"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Philadelphia"</span></span>
<span><span class="co"># Hardwick VT manually set to 'Montpelier':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Hardwick"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"VT"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Montpelier"</span></span>
<span><span class="co"># Sedro Woolley WA manually set to 'Mount Vernon':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Sedro Woolley"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"WA"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Mount Vernon"</span></span>
<span><span class="co"># Howell NJ manually set to 'Trenton':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Howell"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"NJ"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Trenton"</span></span>
<span><span class="co"># Sheffield Village OH manually set to 'Cleveland':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Sheffield Village"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"OH"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Cleveland"</span></span>
<span><span class="co"># Shelby Township MI manually set to 'Detroit':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Shelby Township"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"MI"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Detroit"</span></span>
<span><span class="co"># Brownstown MI manually set to 'Detroit':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Brownstown"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"MI"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Detroit"</span></span>
<span><span class="co"># York ME manually set to 'Portland':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"York"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"ME"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Portland"</span></span>
<span><span class="co"># Feasterville Trevose PA manually set to 'Philadelphia':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Feasterville Trevose"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"PA"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Philadelphia"</span></span>
<span><span class="co"># Sun City Center FL manually set to 'Tampa':</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">[</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="st">"Sun City Center"</span> <span class="op">&amp;</span> <span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_Abrvtn</span> <span class="op">==</span> <span class="st">"FL"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Tampa"</span></span>
<span></span>
<span><span class="co"># convert to lower case:</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html">tolower</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">city_fixed</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># check city_fixed values for any remaining NA FIPS codes:</span></span>
<span><span class="va">places</span> <span class="op">&lt;-</span> <span class="va">data_fips</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_Abrvtn</span>, <span class="va">city_fixed</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_Abrvtn</span>, <span class="va">city_fixed</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Prscrbr_City', 'Prscrbr_State_Abrvtn'. You
can override using the `.groups` argument.</code></pre>
</div>
</div>
<p>Proceeding to match all lower case; first matching city_fixed on map_name:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb123"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">usgs_lower</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span>,                              <span class="co"># the 'right' dataset; [-c(4)] removes variable with index 4, feature_name</span></span>
<span>      by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span></span>
<span>        <span class="va">city_fixed</span> <span class="op">==</span> <span class="va">map_name</span>,                     <span class="co"># these variables must exactly match in both datasets</span></span>
<span>        <span class="va">Prscrbr_State_FIPS</span> <span class="op">==</span> <span class="va">state_numeric</span></span>
<span>        <span class="op">)</span>,</span>
<span>    relationship <span class="op">=</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span>    multiple <span class="op">=</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># how many new finds</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 3142</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb125"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># merge new values into county_fips</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span> <span class="op">&lt;-</span> <span class="fu">fifelse</span><span class="op">(</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span><span class="op">)</span>,</span>
<span>  <span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span>,</span>
<span>  <span class="va">data_fips</span><span class="op">$</span><span class="va">county_numeric</span>,</span>
<span>  na <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 7495</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb127"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb129"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># get rid of county_numeric now:</span></span>
<span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">county_numeric</span><span class="op">)</span>                        <span class="co"># remove county_numeric</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now matching city_fixed on feature_name:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb130"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">usgs_lower</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>,                              <span class="co"># the 'right' dataset; [-c(2)] removes variable with index 2</span></span>
<span>      by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span></span>
<span>        <span class="va">city_fixed</span> <span class="op">==</span> <span class="va">feature_name</span>,</span>
<span>        <span class="va">Prscrbr_State_FIPS</span> <span class="op">==</span> <span class="va">state_numeric</span>         <span class="co"># these variables must exactly match in both datasets</span></span>
<span>        <span class="op">)</span>,</span>
<span>    relationship <span class="op">=</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span>    multiple <span class="op">=</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># how many new finds</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 4224</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb132"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># how many remain NA</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 3271</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb134"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># merge new values into county_fips</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span> <span class="op">&lt;-</span> <span class="fu">fifelse</span><span class="op">(</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span><span class="op">)</span>,</span>
<span>  <span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span>,</span>
<span>  <span class="va">data_fips</span><span class="op">$</span><span class="va">county_numeric</span>,</span>
<span>  na <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># verify the merge by checking NA values</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb136"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># remove county_numeric</span></span>
<span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">county_numeric</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>With fewer than 1% of observations remaining unmatched, we can randomly assign the remaining NA values to one of the counties in <code>Prscrbr_State_FIPS</code>:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb137"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="va">data_fips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">usgs_lower</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span>,                            <span class="co"># the 'right' dataset; [-c(2,4)] removes variable with index 2 &amp; 4</span></span>
<span>      by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span></span>
<span>        <span class="va">Prscrbr_State_FIPS</span> <span class="op">==</span> <span class="va">state_numeric</span>         <span class="co"># these variables must exactly match in both datasets</span></span>
<span>        <span class="op">)</span>,</span>
<span>    relationship <span class="op">=</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span>    multiple <span class="op">=</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># how many new finds</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 3271</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb139"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># mark new finds as randomly assigned</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">random_fips</span> <span class="op">&lt;-</span> <span class="fu">fifelse</span><span class="op">(</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span><span class="op">)</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># how many remain NA</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb141"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># merge new values into county_fips</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span> <span class="op">&lt;-</span> <span class="fu">fifelse</span><span class="op">(</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span><span class="op">)</span>,</span>
<span>  <span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span>,</span>
<span>  <span class="va">data_fips</span><span class="op">$</span><span class="va">county_numeric</span>,</span>
<span>  na <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># verify the merge by checking NA values</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_numeric</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">county_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb143"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># remove county_numeric</span></span>
<span><span class="va">data_fips</span> <span class="op">&lt;-</span> <span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">county_numeric</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Create full FIPS &amp; Cleanup:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb144"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># convert the state and county codes to the full FIPS code; this code yields`NA` if either of the codes are missing:</span></span>
<span><span class="va">data_fips</span><span class="op">$</span><span class="va">fips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">data_fips</span><span class="op">$</span><span class="va">Prscrbr_State_FIPS</span>, <span class="va">data_fips</span><span class="op">$</span><span class="va">county_fips</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># Convert 5-digit FIPS characters to numeric to match the NCHSURC dataset</span></span>
<span></span>
<span><span class="co"># check NA values in the new variable:</span></span>
<span><span class="va">data_fips</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb146"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Cleanup</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">places</span>, <span class="va">usgs_lower</span>, <span class="va">usgs_short</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="matching-to-nchsurc-dataset" class="level4"><h4 class="anchored" data-anchor-id="matching-to-nchsurc-dataset">Matching to NCHSURC Dataset</h4>
<p>We will proceed to match the majority of FIPS codes in the dataset; starting by loading the NCHSURC dataset:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb147"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nchsurc</span> <span class="op">&lt;-</span> <span class="fu">read_excel</span><span class="op">(</span></span>
<span>  <span class="st">"data/NCHSURCodes2013.xlsx"</span>,</span>
<span>  col_names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># rename the FIPS code NCHSURC variables (to make the left_join simpler):</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>fips <span class="op">=</span> <span class="va">`FIPS code`</span>, nchsurc <span class="op">=</span> <span class="va">`2013 code`</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Lookup 2013 NCHSUR code:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb148"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_nchsurc</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span></span>
<span>  <span class="va">data_fips</span>,                            <span class="co"># the 'left' dataset</span></span>
<span>  <span class="va">nchsurc</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">7</span><span class="op">)</span><span class="op">]</span>,                      <span class="co"># the 'right' dataset; columns 1 &amp; 7 are FIPS &amp; NCHSURC</span></span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"fips"</span><span class="op">)</span>,                       <span class="co"># these variables must exactly match in both datasets</span></span>
<span>  relationship <span class="op">=</span> <span class="st">"many-to-one"</span>,         <span class="co"># left_join will not work without specifying this relation</span></span>
<span>  multiple <span class="op">=</span> <span class="st">"any"</span>,                     <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># check NA values in the new variable:</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">nchsurc</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 7041</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb150"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># which states have NA values?</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">nchsurc</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="va">Prscrbr_State_FIPS</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 1
  Prscrbr_State_FIPS
  &lt;chr&gt;             
1 09                
2 02                
3 11                </code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb152"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># How many NA values are there for each state?</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">nchsurc</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="va">Prscrbr_State_FIPS</span>, <span class="va">fips</span>, <span class="va">random_fips</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">fips</span>,<span class="va">random_fips</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'fips'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 3
# Groups:   fips [11]
    fips random_fips     n
   &lt;dbl&gt; &lt;lgl&gt;       &lt;int&gt;
 1  9110 FALSE        2320
 2  9170 FALSE        1555
 3  9140 FALSE         710
 4  9190 FALSE         706
 5  9180 FALSE         574
 6  9130 FALSE         374
 7  9120 FALSE         373
 8  9150 FALSE         194
 9  9160 FALSE         164
10  9150 TRUE           41
11  2063 FALSE          29
12 11000 TRUE            1</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb155"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># view fips = 2063, or 11000:</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">fips</span> <span class="op">==</span> <span class="fl">2063</span><span class="op">|</span><span class="va">fips</span> <span class="op">==</span> <span class="fl">11000</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 31
   Prscrbr_NPI Prscrbr_Last_Org_Name Prscrbr_First_Name Prscrbr_City
         &lt;dbl&gt; &lt;chr&gt;                 &lt;chr&gt;              &lt;chr&gt;       
 1  1639188683 Todd                  Kathleen           Valdez      
 2  1639188683 Todd                  Kathleen           Valdez      
 3  1639188683 Todd                  Kathleen           Valdez      
 4  1639188683 Todd                  Kathleen           Valdez      
 5  1639188683 Todd                  Kathleen           Valdez      
 6  1639188683 Todd                  Kathleen           Valdez      
 7  1639188683 Todd                  Kathleen           Valdez      
 8  1871698852 Spencer               Sarah              Valdez      
 9  1639188683 Todd                  Kathleen           Valdez      
10  1871698852 Spencer               Sarah              Valdez      
# ℹ 20 more rows
# ℹ 27 more variables: Prscrbr_State_Abrvtn &lt;chr&gt;, Prscrbr_State_FIPS &lt;chr&gt;,
#   Prscrbr_Type &lt;chr&gt;, Prscrbr_Type_Src &lt;chr&gt;, Brnd_Name &lt;chr&gt;,
#   Gnrc_Name &lt;chr&gt;, Tot_Clms &lt;dbl&gt;, Tot_30day_Fills &lt;dbl&gt;,
#   Tot_Day_Suply &lt;dbl&gt;, Tot_Drug_Cst &lt;dbl&gt;, Tot_Benes &lt;dbl&gt;,
#   GE65_Sprsn_Flag &lt;chr&gt;, GE65_Tot_Clms &lt;dbl&gt;, GE65_Tot_30day_Fills &lt;dbl&gt;,
#   GE65_Tot_Drug_Cst &lt;dbl&gt;, GE65_Tot_Day_Suply &lt;dbl&gt;, …</code></pre>
</div>
</div>
<p>State FIPS code 09 corresponds to Connecticut; we will address non-CT FIPS first:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb157"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># manually set FIPS 11000 to 11001:</span></span>
<span><span class="va">data_nchsurc</span><span class="op">$</span><span class="va">fips</span><span class="op">[</span><span class="va">data_nchsurc</span><span class="op">$</span><span class="va">fips</span> <span class="op">==</span> <span class="fl">11000</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">11001</span></span>
<span><span class="co"># manually set FIPS 2063 to 2261:</span></span>
<span><span class="va">data_nchsurc</span><span class="op">$</span><span class="va">fips</span><span class="op">[</span><span class="va">data_nchsurc</span><span class="op">$</span><span class="va">fips</span> <span class="op">==</span> <span class="fl">2063</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2261</span></span>
<span><span class="co"># rename the NCHSURC variable:</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">&lt;-</span> <span class="va">data_nchsurc</span> <span class="op">|&gt;</span> <span class="fu">rename</span><span class="op">(</span>nchsurc_old <span class="op">=</span> <span class="va">nchsurc</span><span class="op">)</span></span>
<span><span class="co">#search again over the NCHSURC dataset</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span></span>
<span>  <span class="va">data_nchsurc</span>,                         <span class="co"># the 'left' dataset</span></span>
<span>  <span class="va">nchsurc</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">7</span><span class="op">)</span><span class="op">]</span>,                      <span class="co"># the 'right' dataset; columns 1 &amp; 7 are FIPS &amp; NCHSURC</span></span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"fips"</span><span class="op">)</span>,                       <span class="co"># these variables must exactly match in both datasets</span></span>
<span>  relationship <span class="op">=</span> <span class="st">"many-to-one"</span>,         <span class="co"># left_join will not work without specifying this relation</span></span>
<span>  multiple <span class="op">=</span> <span class="st">"any"</span>,                     <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span><span class="op">)</span>  </span>
<span></span>
<span><span class="co"># Check missing values</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">nchsurc</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 7011</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb159"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># check for missing values in ncshurc_old vs nchsurc:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_nchsurc</span><span class="op">$</span><span class="va">nchsurc_old</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_nchsurc</span><span class="op">$</span><span class="va">nchsurc</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>       
         FALSE   TRUE
  FALSE 498355      0
  TRUE      30   7011</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb161"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># How many NA values are there for each state?</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">nchsurc</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="va">Prscrbr_State_FIPS</span>, <span class="va">fips</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">fips</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">summarise</span><span class="op">(</span>n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
   fips     n
  &lt;dbl&gt; &lt;int&gt;
1  9110  2320
2  9170  1555
3  9140   710
4  9190   706
5  9180   574
6  9130   374
7  9120   373
8  9150   235
9  9160   164</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb163"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># thus we can discard fips_old</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">&lt;-</span> <span class="va">data_nchsurc</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">nchsurc_old</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Apparently <a href="https://www.federalregister.gov/documents/2022/06/06/2022-12063/change-to-county-equivalents-in-the-state-of-connecticut">CT has switched from counties to planning ditricts</a>, and the new codes are in the USGS dataset, but not in the NCHSURC dataset. We will proceed to examine the CT codes, all of which are unmatched:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb164"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">places</span> <span class="op">&lt;-</span> <span class="va">data_nchsurc</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">nchsurc</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_Abrvtn</span>, <span class="va">city_fixed</span>, <span class="va">fips</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">Prscrbr_City</span>, <span class="va">Prscrbr_State_Abrvtn</span>, <span class="va">city_fixed</span>, <span class="va">fips</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Prscrbr_City', 'Prscrbr_State_Abrvtn',
'city_fixed'. You can override using the `.groups` argument.</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb166"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">places</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
# Groups:   Prscrbr_City, Prscrbr_State_Abrvtn, city_fixed [6]
  Prscrbr_City Prscrbr_State_Abrvtn city_fixed  fips     n
  &lt;chr&gt;        &lt;chr&gt;                &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;
1 New Haven    CT                   new haven   9170   859
2 Hartford     CT                   hartford    9110   474
3 Waterbury    CT                   waterbury   9140   305
4 Middletown   CT                   middletown  9130   286
5 New London   CT                   new london  9180   233
6 Danbury      CT                   danbury     9190   227</code></pre>
</div>
</div>
<p>One approach is to make a dataframe with two vectors columns, one column with each city name in CT, and the other column with the corresponding FIPS code. We can find such a table <a href="https://ctstatelibrary.org/cttowns/counties">at the CT State Library</a>; it has been download and saved to /data as ‘ct_towns.ods’:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb168"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># reading CT state library data</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="fu">read_ods</span><span class="op">(</span></span>
<span>  path <span class="op">=</span> <span class="st">"data/ct_towns.ods"</span>,</span>
<span>  col_names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># make a new variable assigning the county FIPS code based on the county; Fairfield = 9001, Hartford = 9003, etc.</span></span>
<span><span class="va">ct_towns</span><span class="op">$</span><span class="va">ct_fips</span> <span class="op">&lt;-</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>  <span class="va">ct_towns</span><span class="op">$</span><span class="va">County</span> <span class="op">==</span> <span class="st">"Fairfield"</span> <span class="op">~</span> <span class="fl">9001</span>,</span>
<span>  <span class="va">ct_towns</span><span class="op">$</span><span class="va">County</span> <span class="op">==</span> <span class="st">"Hartford"</span> <span class="op">~</span> <span class="fl">9003</span>,</span>
<span>  <span class="va">ct_towns</span><span class="op">$</span><span class="va">County</span> <span class="op">==</span> <span class="st">"Litchfield"</span> <span class="op">~</span> <span class="fl">9005</span>,</span>
<span>  <span class="va">ct_towns</span><span class="op">$</span><span class="va">County</span> <span class="op">==</span> <span class="st">"Middlesex"</span> <span class="op">~</span> <span class="fl">9007</span>,</span>
<span>  <span class="va">ct_towns</span><span class="op">$</span><span class="va">County</span> <span class="op">==</span> <span class="st">"New Haven"</span> <span class="op">~</span> <span class="fl">9009</span>,</span>
<span>  <span class="va">ct_towns</span><span class="op">$</span><span class="va">County</span> <span class="op">==</span> <span class="st">"New London"</span> <span class="op">~</span> <span class="fl">9011</span>,</span>
<span>  <span class="va">ct_towns</span><span class="op">$</span><span class="va">County</span> <span class="op">==</span> <span class="st">"Tolland"</span> <span class="op">~</span> <span class="fl">9013</span>,</span>
<span>  <span class="va">ct_towns</span><span class="op">$</span><span class="va">County</span> <span class="op">==</span> <span class="st">"Windham"</span> <span class="op">~</span> <span class="fl">9015</span></span>
<span><span class="op">)</span></span>
<span><span class="va">ct_towns</span><span class="op">$</span><span class="va">state_numeric</span> <span class="op">&lt;-</span> <span class="st">"09"</span></span>
<span></span>
<span><span class="co"># test match ct_towns into 'places' dataset:</span></span>
<span><span class="va">places</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span></span>
<span>  <span class="va">places</span>,                                       <span class="co"># the 'left' dataset</span></span>
<span>  <span class="va">ct_towns</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">6</span><span class="op">)</span><span class="op">]</span>,                           <span class="co"># the 'right' dataset; with Town.name, fips, and state_fips variables</span></span>
<span>  by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span></span>
<span>        <span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="va">Town.name</span>                <span class="co"># these variables must exactly match in both datasets</span></span>
<span>        <span class="op">)</span>,</span>
<span>  relationship <span class="op">=</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span>  multiple <span class="op">=</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span><span class="op">)</span></span>
<span><span class="va">places</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">ct_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 37 × 6
# Groups:   Prscrbr_City, Prscrbr_State_Abrvtn, city_fixed [37]
   Prscrbr_City     Prscrbr_State_Abrvtn city_fixed        fips     n ct_fips
   &lt;chr&gt;            &lt;chr&gt;                &lt;chr&gt;            &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;
 1 Willimantic      CT                   willimantic       9110    48      NA
 2 Mansfield Center CT                   mansfield center  9110    41      NA
 3 Dayville         CT                   dayville          9150    32      NA
 4 Danielson        CT                   danielson         9150    29      NA
 5 Storrs           CT                   storrs            9110    27      NA
 6 Rockville        CT                   rockville         9110    19      NA
 7 Amston           CT                   amston            9110    17      NA
 8 Pawcatuck        CT                   pawcatuck         9180    16      NA
 9 Old Greenwich    CT                   old greenwich     9150    15      NA
10 Mystic           CT                   mystic            9180    14      NA
# ℹ 27 more rows</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb170"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># places |&gt; select(-ct_fips)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can see that the CT State Library data is missing some towns, and that some towns are missing from the NCHSURC dataset. We will manually add these towns to the ct_towns dataset:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb171"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># manually add Willimantic, CT</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Willimantic"</span>, ct_fips <span class="op">=</span> <span class="fl">9015</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Lakeville</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Lakeville"</span>, ct_fips <span class="op">=</span> <span class="fl">9005</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Terryville</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Terryville"</span>, ct_fips <span class="op">=</span> <span class="fl">9003</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Turrington</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Turrington"</span>, ct_fips <span class="op">=</span> <span class="fl">9005</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Moodus</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Moodus"</span>, ct_fips <span class="op">=</span> <span class="fl">9007</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Oakdale</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Oakdale"</span>, ct_fips <span class="op">=</span> <span class="fl">9011</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Plantsville</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Plantsville"</span>, ct_fips <span class="op">=</span> <span class="fl">9003</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Sandy Hook    </span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Sandy Hook"</span>, ct_fips <span class="op">=</span> <span class="fl">9001</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># East Berlin   </span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"East Berlin"</span>, ct_fips <span class="op">=</span> <span class="fl">9003</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Jewett City   </span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Jewett City"</span>, ct_fips <span class="op">=</span> <span class="fl">9011</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Kensington</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Kensington"</span>, ct_fips <span class="op">=</span> <span class="fl">9003</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># S Woodstock   </span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"S Woodstock"</span>, ct_fips <span class="op">=</span> <span class="fl">9015</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Riverside</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Riverside"</span>, ct_fips <span class="op">=</span> <span class="fl">9001</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Wauregan</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Wauregan"</span>, ct_fips <span class="op">=</span> <span class="fl">9015</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Vernon Rockville  </span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Vernon Rockville"</span>, ct_fips <span class="op">=</span> <span class="fl">9013</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Abington</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Abington"</span>, ct_fips <span class="op">=</span> <span class="fl">9015</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Gales Ferry   </span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Gales Ferry"</span>, ct_fips <span class="op">=</span> <span class="fl">9011</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Mansfield Center  CT  06250   Tolland 09013</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Mansfield Center"</span>, ct_fips <span class="op">=</span> <span class="fl">9013</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Dayville</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Dayville"</span>, ct_fips <span class="op">=</span> <span class="fl">9015</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Danielson</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Danielson"</span>, ct_fips <span class="op">=</span> <span class="fl">9015</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Storrs</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Storrs"</span>, ct_fips <span class="op">=</span> <span class="fl">9013</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Rockville</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Rockville"</span>, ct_fips <span class="op">=</span> <span class="fl">9013</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Amston</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Amston"</span>, ct_fips <span class="op">=</span> <span class="fl">9007</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Pawcatuck</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Pawcatuck"</span>, ct_fips <span class="op">=</span> <span class="fl">9011</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Old Greenwich </span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Old Greenwich"</span>, ct_fips <span class="op">=</span> <span class="fl">9001</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Mystic</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Mystic"</span>, ct_fips <span class="op">=</span> <span class="fl">9011</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Milldale</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Milldale"</span>, ct_fips <span class="op">=</span> <span class="fl">9009</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Niantic</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Niantic"</span>, ct_fips <span class="op">=</span> <span class="fl">9011</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Pomfret Center    </span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Pomfret Center"</span>, ct_fips <span class="op">=</span> <span class="fl">9015</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Quinebaug </span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Quinebaug"</span>, ct_fips <span class="op">=</span> <span class="fl">9015</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Stafford Springs  </span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Stafford Springs"</span>, ct_fips <span class="op">=</span> <span class="fl">9013</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Winsted</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Winsted"</span>, ct_fips <span class="op">=</span> <span class="fl">9005</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Higganum</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Higganum"</span>, ct_fips <span class="op">=</span> <span class="fl">9007</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Uncasville</span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Uncasville"</span>, ct_fips <span class="op">=</span> <span class="fl">9011</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># Cos Cob   </span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"Cos Cob"</span>, ct_fips <span class="op">=</span> <span class="fl">9001</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># W Hartford    </span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"W Hartford"</span>, ct_fips <span class="op">=</span> <span class="fl">9003</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span>
<span><span class="co"># West Redding  </span></span>
<span><span class="va">ct_towns</span> <span class="op">&lt;-</span> <span class="va">ct_towns</span> <span class="op">|&gt;</span> <span class="fu">add_row</span><span class="op">(</span>Town.name <span class="op">=</span> <span class="st">"West Redding"</span>, ct_fips <span class="op">=</span> <span class="fl">9001</span>, state_numeric <span class="op">=</span> <span class="st">"09"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>After adding the codes for the missing towns, we can join the two datasets together, and test for any remaining unmatched:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb172"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># match the FIPS code to the city name in `data_nchsurc`:</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">data_nchsurc</span>,                                   <span class="co"># the 'left' dataset</span></span>
<span>    <span class="va">ct_towns</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">6</span>,<span class="fl">7</span><span class="op">)</span><span class="op">]</span>,                             <span class="co"># the 'right' dataset; with Town.name, ct_fips, and state_numeric variables</span></span>
<span>      by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span></span>
<span>        <span class="va">Prscrbr_City</span> <span class="op">==</span> <span class="va">Town.name</span>,                  <span class="co"># these variables must exactly match in both datasets</span></span>
<span>        <span class="va">Prscrbr_State_FIPS</span> <span class="op">==</span> <span class="va">state_numeric</span>         <span class="co"># these variables must exactly match in both datasets</span></span>
<span>        <span class="op">)</span>,</span>
<span>    relationship <span class="op">=</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span>    multiple <span class="op">=</span> <span class="st">"any"</span>,                               <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Test</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Prscrbr_State_FIPS</span> <span class="op">==</span> <span class="st">"09"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">ct_fips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb174"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># fold ct_fips into fips variable</span></span>
<span><span class="va">data_nchsurc</span><span class="op">$</span><span class="va">fips</span> <span class="op">&lt;-</span> <span class="fu">fifelse</span><span class="op">(</span></span>
<span>  <span class="va">data_nchsurc</span><span class="op">$</span><span class="va">Prscrbr_State_FIPS</span> <span class="op">==</span> <span class="st">"09"</span>,     <span class="co"># if state_numeric is CT</span></span>
<span>  <span class="va">data_nchsurc</span><span class="op">$</span><span class="va">ct_fips</span>,                       <span class="co"># if not missing, value is county_fips</span></span>
<span>  <span class="va">data_nchsurc</span><span class="op">$</span><span class="va">fips</span>,                    <span class="co"># if Prscrbr_County_FIPS is NA, fills in with county_numeric</span></span>
<span>  na <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb175"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># lookup NCHSURC for CT entries</span></span>
<span><span class="co"># first rename the old NCHSURC variable to protect it:</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">&lt;-</span> <span class="va">data_nchsurc</span> <span class="op">|&gt;</span> <span class="fu">rename</span><span class="op">(</span>nchsurc_old <span class="op">=</span> <span class="va">nchsurc</span><span class="op">)</span></span>
<span><span class="co">#search again over the NCHSURC dataset</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span></span>
<span>  <span class="va">data_nchsurc</span>,                         <span class="co"># the 'left' dataset</span></span>
<span>  <span class="va">nchsurc</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">7</span><span class="op">)</span><span class="op">]</span>,                      <span class="co"># the 'right' dataset; columns 1 &amp; 7 are FIPS &amp; NCHSURC</span></span>
<span>  by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span></span>
<span>    <span class="va">ct_fips</span> <span class="op">==</span> <span class="va">fips</span>,                    <span class="co"># these variables must exactly match in both datasets</span></span>
<span>  <span class="op">)</span>,</span>
<span>  relationship <span class="op">=</span> <span class="st">"many-to-one"</span>,         <span class="co"># left_join will not work without specifying this relation</span></span>
<span>  multiple <span class="op">=</span> <span class="st">"any"</span>,                     <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span><span class="op">)</span>  </span>
<span></span>
<span><span class="co"># Test</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Prscrbr_State_FIPS</span> <span class="op">==</span> <span class="st">"09"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">nchsurc</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb177"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_nchsurc</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">nchsurc</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">nchsurc_old</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb179"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Fold in the new NCHSURC variable</span></span>
<span><span class="va">data_nchsurc</span><span class="op">$</span><span class="va">nchsurc</span> <span class="op">&lt;-</span> <span class="fu">fifelse</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data_nchsurc</span><span class="op">$</span><span class="va">nchsurc</span><span class="op">)</span>,                       <span class="co"># if nchsurc is NA</span></span>
<span>  <span class="va">data_nchsurc</span><span class="op">$</span><span class="va">nchsurc_old</span>,                          <span class="co"># use the old nchsurc variable</span></span>
<span>  <span class="va">data_nchsurc</span><span class="op">$</span><span class="va">nchsurc</span>,                              <span class="co"># if not missing, value is nchsurc</span></span>
<span>  na <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># test missing</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">nchsurc</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
<p>Cleanup</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb181"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># cleanup</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">ct_towns</span>, <span class="va">places</span>, <span class="va">nchsurc</span><span class="op">)</span></span>
<span><span class="co"># remove unused variables</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">&lt;-</span> <span class="va">data_nchsurc</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">nchsurc_old</span>, <span class="op">-</span><span class="va">ct_fips</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Set Urban/Rural Classification</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb182"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># view values of nchsurc$nchsurc</span></span>
<span><span class="va">data_nchsurc</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">nchsurc</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarise</span><span class="op">(</span>n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  nchsurc      n
    &lt;dbl&gt;  &lt;int&gt;
1       1 142375
2       3 121763
3       2 108668
4       4  57946
5       5  48043
6       6  26601</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb184"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># set urban/rural classification</span></span>
<span><span class="va">data_nchsurc</span><span class="op">$</span><span class="va">ur</span> <span class="op">&lt;-</span> <span class="fu">fifelse</span><span class="op">(</span></span>
<span>  <span class="va">data_nchsurc</span><span class="op">$</span><span class="va">nchsurc</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"5"</span>, <span class="st">"6"</span><span class="op">)</span>,     <span class="co"># if nchsurc is rural                    </span></span>
<span>  <span class="st">"rural"</span>,                                   <span class="co"># then rural</span></span>
<span>  <span class="st">"urban"</span>,                                   <span class="co"># else urban</span></span>
<span>  na <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="alternate-intensive-approach" class="level3"><h3 class="anchored" data-anchor-id="alternate-intensive-approach">Alternate Intensive Approach</h3>
<p>Within this section we will use the dataset created above, find latitude and longitude coordinates for each city/state combination to which an observation corresponds, then convert the coordinates to county FIPS code, and then lookup the rural-urbal classification from the FIPS code. Breaking down the specifics of each step, we have:</p>
<ul>
<li>Finding the coordinates: we will use the <code>geocode()</code> function from the <code>ggmap</code> package to find the coordinates for each city/state combination. The function will return a dataframe with the coordinates for each city/state combination, and will also return a status code indicating whether the coordinates were found successfully. We will use the status code to filter out any entries for which the coordinates were not found.</li>
<li>Convert coordinates to FIPS using one of several methods:</li>
<li>
<code>coords_to_fips()</code>from <a href="https://cran.r-project.org/web/packages/fipio/index.html">fipio</a>
</li>
<li>Look into:</li>
<li>Use the <code>fips()</code> function from the <code>USAboundaries</code> package to convert the coordinates to FIPS code. This function uses the <code>sf</code> package to find the FIPS code for the county in which the coordinates are located. This method is the most straightforward, but it is also the slowest.</li>
<li>Use the <code>fips()</code> function from the <code>tigris</code> package to convert the coordinates to FIPS code. This function uses the <code>sf</code> package to find the FIPS code for the county in which the coordinates are located. This method is faster than the <code>USAboundaries</code> method, but it is still relatively slow.</li>
<li>Use the <code>fips()</code> function from the <code>MazamaSpatialUtils</code> package to convert the coordinates to FIPS code. This function uses a lookup table to find the FIPS code for the county in which the coordinates are located. This method is the fastest, but it is also the least accurate. The lookup table is based on the 2010 census, so it will not include any counties that were created after 2010. This method will also not work for any coordinates that are outside of the US.</li>
<li>Lookup rural-urban clssification: For this step we can use CDC’s <a href="https://www.cdc.gov/nchs/data_access/urban_rural.htm">2013 Urban-Rural Classification Scheme for Counties</a>; specifically the <a href="https://www.cdc.gov/nchs/data/data_acces_files/NCHSURCodes2013.xlsx">NCHSurbruralcodes Spreadsheet</a> which contains the FIPS codes and rural-urban classifications for each county in the US.</li>
</ul>
<p>The data can be plotted according to FIPS code using <code>ggplot2</code> or <code>MazamaSpatialPlots</code> packages.</p>
</section></section><section id="provider-type" class="level2"><h2 class="anchored" data-anchor-id="provider-type">Provider Type</h2>
<p>Overview of provider types</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb185"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_nchsurc</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">Prscrbr_Type</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 142 × 2
   Prscrbr_Type                              n
   &lt;chr&gt;                                 &lt;int&gt;
 1 Family Practice                      121171
 2 Internal Medicine                     86597
 3 Nurse Practitioner                    68912
 4 Psychiatry                            46797
 5 Physician Assistant                   30662
 6 Anesthesiology                        23420
 7 Physical Medicine and Rehabilitation  21173
 8 Pain Management                       18414
 9 Interventional Pain Management        16163
10 Psychiatry &amp; Neurology                 8243
# ℹ 132 more rows</code></pre>
</div>
</div>
<p>Further exploration of provider types:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb187"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_nchsurc</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_oud"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">Prscrbr_Type</span>, <span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>      n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span>, </span>
<span>      Supply_yr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">Tot_Day_Suply</span><span class="op">)</span><span class="op">/</span><span class="fl">365</span>, digits<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>      Supply_per_Provider_yr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">Supply_yr</span><span class="op">/</span><span class="va">n</span>, digits<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">year</span>, <span class="fu">desc</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># select only the top 10 entries of each year</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">slice_max</span><span class="op">(</span><span class="va">n</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Prscrbr_Type'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 90 × 5
# Groups:   year [9]
   Prscrbr_Type                      year     n Supply_yr Supply_per_Provider_yr
   &lt;chr&gt;                            &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;                  &lt;dbl&gt;
 1 Family Practice                   2013  2558     7992.                    3.1
 2 Psychiatry                        2013  2446     7248.                    3  
 3 Internal Medicine                 2013  1690     5724.                    3.4
 4 Psychiatry &amp; Neurology            2013   398      946.                    2.4
 5 Anesthesiology                    2013   329      952.                    2.9
 6 General Practice                  2013   325     1098.                    3.4
 7 Physical Medicine and Rehabilit…  2013   310      935.                    3  
 8 Emergency Medicine                2013   273     1076.                    3.9
 9 Interventional Pain Management    2013   239      653.                    2.7
10 Addiction Medicine                2013   179      808.                    4.5
# ℹ 80 more rows</code></pre>
</div>
</div>
<p>Specify the provider type simplified variable</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb190"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_provider</span> <span class="op">&lt;-</span> <span class="va">data_nchsurc</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu">mutate</span><span class="op">(</span></span>
<span>     type <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>       <span class="va">Prscrbr_Type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Physician Assistant"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"PA"</span>,</span>
<span>       <span class="va">Prscrbr_Type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Nurse Practitioner"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"NP"</span>,</span>
<span>       <span class="va">Prscrbr_Type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Pharmacist"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"RPh"</span>,</span>
<span>       <span class="va">Prscrbr_Type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Family Practice"</span>, <span class="st">"Internal Medicine"</span>, <span class="st">"Family Medicine"</span>, <span class="st">"General Practice"</span>, <span class="st">"Geriatric Medicine"</span>, <span class="st">"Preventive Medicine"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"FP/IM"</span>,</span>
<span>       <span class="va">Prscrbr_Type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Anesthesiology"</span>, <span class="st">"Pain Management   "</span>, <span class="st">"Interventional Pain Management"</span>, <span class="st">"Pain Medicine"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Pain"</span>,</span>
<span>       <span class="va">Prscrbr_Type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Psychiatry"</span>, <span class="st">"Psychiatry &amp; Neurology"</span>, <span class="st">"Neuropsychiatry"</span>, <span class="st">"Addiction Medicine"</span>, <span class="st">"Counselor"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Psych"</span>,</span>
<span>       .default <span class="op">=</span> <span class="st">"Other"</span></span>
<span>     <span class="op">)</span></span>
<span>   <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="final-dataset" class="level1"><h1>Final dataset</h1>
<p>Create final dataset, save datasets, and cleanup:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb191"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data_provider</span></span>
<span><span class="co"># save the final dataset by itself</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  file <span class="op">=</span> <span class="st">"dataset/data.RData"</span>,</span>
<span>  compress <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  compression_level <span class="op">=</span> <span class="fl">9</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># save intermediate datasets</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span></span>
<span>  <span class="va">data_tx</span>,</span>
<span>  file <span class="op">=</span> <span class="st">"dataset/data_tx.RData"</span>,</span>
<span>  compress <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  compression_level <span class="op">=</span> <span class="fl">9</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span></span>
<span>  <span class="va">data_provider</span>,</span>
<span>  file <span class="op">=</span> <span class="st">"dataset/data_provider.RData"</span>,</span>
<span>  compress <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  compression_level <span class="op">=</span> <span class="fl">9</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span></span>
<span>  <span class="va">data_nchsurc</span>,</span>
<span>  file <span class="op">=</span> <span class="st">"dataset/data_nchsurc.RData"</span>,</span>
<span>  compress <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  compression_level <span class="op">=</span> <span class="fl">9</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span></span>
<span>  <span class="va">data_fips</span>,</span>
<span>  file <span class="op">=</span> <span class="st">"dataset/data_fips.RData"</span>,</span>
<span>  compress <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  compression_level <span class="op">=</span> <span class="fl">9</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># cleanup</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">data_tx</span>, <span class="va">data_provider</span>, <span class="va">data_nchsurc</span>, <span class="va">data_fips</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="other-thoughts" class="level1"><h1>Other Thoughts</h1>
<p>Indication for OUD use (vs pain or EtOH use disorder) is a potential source of error when classifying prescriptions in the <code>tx</code> variable. Consider future methods to potentially validate OUD vs pain treatment designations (as time allows):</p>
<ul>
<li>Classify prescriptions as OUD vs pain vs EtOH use disorder based on KNN of names of other drugs prescribed by the provider</li>
<li>Query <a href="https://open.fda.gov/apis/drug/ndc/how-to-use-the-endpoint/">FDA NDC DB</a> for NPIs associated with the values of <code>Brnd_Name</code> and <code>Gnrc_Name</code> which were matched above, then search those NDCs for the indication for use on DailyMed</li>
<li>Check DEA X waver for prescriber’s NPI</li>
<li>Check prescriber’s buprenorphine panel limit vs count of buprenorphine prescribed</li>
<li>Check prescriber’s place of work in NPI DB</li>
<li>interrogate/validate CMS’s method for translating a drug’s NDC into a drug’s brand and generic names</li>
</ul>
<p>Translation from NDC to a drug’s brand/generic names likely simplifies many analyses, but could be a significant source of bias for our analysis.</p>
</section><section id="session-info" class="level1"><h1>Session Info</h1>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb192"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.2 (2023-10-31)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 22.04.3 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0 
LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

time zone: America/Vancouver
tzcode source: system (glibc)

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] campfin_1.0.11    readODS_2.1.0     readxl_1.4.3      data.table_1.14.8
 [5] lubridate_1.9.3   forcats_1.0.0     stringr_1.5.1     dplyr_1.1.4      
 [9] purrr_1.0.2       readr_2.1.4       tidyr_1.3.0       tibble_3.2.1     
[13] ggplot2_3.4.4     tidyverse_2.0.0  

loaded via a namespace (and not attached):
 [1] utf8_1.2.4        generics_0.1.3    stringi_1.8.2     hms_1.1.3        
 [5] digest_0.6.33     magrittr_2.0.3    evaluate_0.23     grid_4.3.2       
 [9] timechange_0.2.0  fastmap_1.1.1     cellranger_1.1.0  jsonlite_1.8.7   
[13] zip_2.3.0         httr_1.4.7        fansi_1.0.5       scales_1.3.0     
[17] stringdist_0.9.10 cli_3.6.1         crayon_1.5.2      rlang_1.1.2      
[21] bit64_4.0.5       munsell_0.5.0     withr_2.5.2       yaml_2.3.7       
[25] tools_4.3.2       parallel_4.3.2    tzdb_0.4.0        colorspace_2.1-0 
[29] vctrs_0.6.4       R6_2.5.1          lifecycle_1.0.4   bit_4.0.5        
[33] fs_1.6.3          htmlwidgets_1.6.3 vroom_1.6.4       pkgconfig_2.0.3  
[37] pillar_1.9.0      gtable_0.3.4      glue_1.6.2        xfun_0.41        
[41] tidyselect_1.2.0  rstudioapi_0.15.0 knitr_1.45        htmltools_0.5.7  
[45] rmarkdown_2.25    compiler_4.3.2   </code></pre>
</div>
</div>
<!-- -->

</section></main><!-- /main column --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb194" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Dataset"</span></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Matthew Hoctor, PharmD"</span></span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "`r format(Sys.time(), '%d %B, %Y')`"</span></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a><span class="co">quarto::html_document:</span></span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a><span class="co">  theme: cerulean</span></span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a><span class="co">  highlight: github</span></span>
<span id="cb194-9"><a href="#cb194-9" aria-hidden="true" tabindex="-1"></a><span class="co">  </span></span>
<span id="cb194-10"><a href="#cb194-10" aria-hidden="true" tabindex="-1"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb194-11"><a href="#cb194-11" aria-hidden="true" tabindex="-1"></a><span class="an">toc-depth:</span><span class="co"> 4</span></span>
<span id="cb194-12"><a href="#cb194-12" aria-hidden="true" tabindex="-1"></a><span class="an">toc-location:</span><span class="co"> left</span></span>
<span id="cb194-13"><a href="#cb194-13" aria-hidden="true" tabindex="-1"></a><span class="an">toc-title:</span><span class="co"> Contents</span></span>
<span id="cb194-14"><a href="#cb194-14" aria-hidden="true" tabindex="-1"></a><span class="co">  </span></span>
<span id="cb194-15"><a href="#cb194-15" aria-hidden="true" tabindex="-1"></a><span class="an">code-fold:</span><span class="co"> show</span></span>
<span id="cb194-16"><a href="#cb194-16" aria-hidden="true" tabindex="-1"></a><span class="an">code-overflow:</span><span class="co"> wrap</span></span>
<span id="cb194-17"><a href="#cb194-17" aria-hidden="true" tabindex="-1"></a><span class="an">code-tools:</span><span class="co"> true</span></span>
<span id="cb194-18"><a href="#cb194-18" aria-hidden="true" tabindex="-1"></a><span class="an">code-link:</span><span class="co"> true</span></span>
<span id="cb194-19"><a href="#cb194-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-20"><a href="#cb194-20" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> source</span></span>
<span id="cb194-21"><a href="#cb194-21" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb194-22"><a href="#cb194-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-23"><a href="#cb194-23" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include = FALSE}</span></span>
<span id="cb194-24"><a href="#cb194-24" aria-hidden="true" tabindex="-1"></a><span class="co"># load libraries:</span></span>
<span id="cb194-25"><a href="#cb194-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb194-26"><a href="#cb194-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb194-27"><a href="#cb194-27" aria-hidden="true" tabindex="-1"></a><span class="co"># library(lubridate)</span></span>
<span id="cb194-28"><a href="#cb194-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb194-29"><a href="#cb194-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readODS)</span>
<span id="cb194-30"><a href="#cb194-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(campfin)</span>
<span id="cb194-31"><a href="#cb194-31" aria-hidden="true" tabindex="-1"></a><span class="co"># library(httr2)        #using bash curl instead</span></span>
<span id="cb194-32"><a href="#cb194-32" aria-hidden="true" tabindex="-1"></a><span class="co"># library(curl)         #using bash curl instead</span></span>
<span id="cb194-33"><a href="#cb194-33" aria-hidden="true" tabindex="-1"></a><span class="co"># library(jsonlite)     #fromJSON and other json functions</span></span>
<span id="cb194-34"><a href="#cb194-34" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-35"><a href="#cb194-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-36"><a href="#cb194-36" aria-hidden="true" tabindex="-1"></a><span class="fu"># Overview</span></span>
<span id="cb194-37"><a href="#cb194-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-38"><a href="#cb194-38" aria-hidden="true" tabindex="-1"></a>We seek to understand the impact of the Comprehensive Addiction and Recovery Act (CARA) of 2016 on patterns of buprenorphine prescribing practices by examining medicare part D data. This exploratory analysis will download and compile medicare part D data before and after the legislation for years 2013-2021, and will examine variables of interest including buprenorphine Rx, methadone Rx, naltrexone Rx, prescriber type, cost to the patient, cost to Medicare, rural vs urban, and more.</span>
<span id="cb194-39"><a href="#cb194-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-40"><a href="#cb194-40" aria-hidden="true" tabindex="-1"></a><span class="fu"># Downloading Medicare Part D Data</span></span>
<span id="cb194-41"><a href="#cb194-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-42"><a href="#cb194-42" aria-hidden="true" tabindex="-1"></a>This analysis does not require individual-patient-level data, and thus does not require the Research Identifiable Files (RIFs) or Limited Data Set (LDS) files; non-identifiable files will be used instead. Datasets from 2013-2021 from the <span class="co">[</span><span class="ot">Medicare Part D Prescribers - by Provider and Drug</span><span class="co">](https://data.cms.gov/provider-summary-by-type-of-service/medicare-part-d-prescribers/medicare-part-d-prescribers-by-provider-and-drug)</span> dataset was downloaded and moved to the <span class="in">`data`</span> folder of the project (<span class="co">[</span><span class="ot">data dict</span><span class="co">](https://data.cms.gov/resources/medicare-part-d-prescribers-by-provider-and-drug-data-dictionary)</span>). It may be necessary to add info from the <span class="co">[</span><span class="ot">Medicare Part D Prescribers - by Provider</span><span class="co">](https://data.cms.gov/provider-summary-by-type-of-service/medicare-part-d-prescribers/medicare-part-d-prescribers-by-provider)</span> dataset if more provider info is needed; it may be interesting to look at <span class="co">[</span><span class="ot">Medicare Part D Prescribers - by Geography and Drug Data Dictionary</span><span class="co">](https://data.cms.gov/provider-summary-by-type-of-service/medicare-part-d-prescribers/medicare-part-d-prescribers-by-geography-and-drug)</span> (<span class="co">[</span><span class="ot">data dict</span><span class="co">](https://data.cms.gov/resources/medicare-part-d-prescribers-by-geography-and-drug-data-dictionary)</span>) later.</span>
<span id="cb194-43"><a href="#cb194-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-44"><a href="#cb194-44" aria-hidden="true" tabindex="-1"></a>See the <span class="co">[</span><span class="ot">data download</span><span class="co">](https://matthew-hoctor.github.io/Buprenorphine_Rx/data_download.html)</span> page for specifics.</span>
<span id="cb194-45"><a href="#cb194-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-46"><a href="#cb194-46" aria-hidden="true" tabindex="-1"></a>NB manually downloading datasets from data.cms.gov only seems to work when the ancillary files are not downloaded as well.</span>
<span id="cb194-47"><a href="#cb194-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-48"><a href="#cb194-48" aria-hidden="true" tabindex="-1"></a><span class="fu"># Importing &amp; Merging Data</span></span>
<span id="cb194-49"><a href="#cb194-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-50"><a href="#cb194-50" aria-hidden="true" tabindex="-1"></a>We will begin with the 2021 data while the rest of the datasets download.</span>
<span id="cb194-51"><a href="#cb194-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-52"><a href="#cb194-52" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2021 Test Run</span></span>
<span id="cb194-53"><a href="#cb194-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-54"><a href="#cb194-54" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dataset</span></span>
<span id="cb194-55"><a href="#cb194-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-56"><a href="#cb194-56" aria-hidden="true" tabindex="-1"></a>Test read of manually downloaded 2021 data:</span>
<span id="cb194-57"><a href="#cb194-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-60"><a href="#cb194-60" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-61"><a href="#cb194-61" aria-hidden="true" tabindex="-1"></a>data_2021 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/2021.csv"</span>)</span>
<span id="cb194-62"><a href="#cb194-62" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-63"><a href="#cb194-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-64"><a href="#cb194-64" aria-hidden="true" tabindex="-1"></a>Check:</span>
<span id="cb194-65"><a href="#cb194-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-68"><a href="#cb194-68" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-69"><a href="#cb194-69" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(data_2021)</span>
<span id="cb194-70"><a href="#cb194-70" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data_2021)</span>
<span id="cb194-71"><a href="#cb194-71" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-72"><a href="#cb194-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-73"><a href="#cb194-73" aria-hidden="true" tabindex="-1"></a>This confirms that the data is in the correct format and that the data download was successful.  We can now create the variables of interest.  Assign <span class="in">`year`</span> variable to 2021 data and create the main dataset, <span class="in">`data`</span>:</span>
<span id="cb194-74"><a href="#cb194-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-77"><a href="#cb194-77" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-78"><a href="#cb194-78" aria-hidden="true" tabindex="-1"></a>data_2021<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="dv">2021</span></span>
<span id="cb194-79"><a href="#cb194-79" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-80"><a href="#cb194-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-81"><a href="#cb194-81" aria-hidden="true" tabindex="-1"></a><span class="fu">### Treatment Variables</span></span>
<span id="cb194-82"><a href="#cb194-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-83"><a href="#cb194-83" aria-hidden="true" tabindex="-1"></a>The variable for medication assisted treatment (MAT) is <span class="in">`MAT`</span>, which will be a polytomous variable with the following levels: <span class="in">`bup`</span> for buprenorphine, <span class="in">`met`</span> for methadone, and <span class="in">`nal`</span> for naltrexone.</span>
<span id="cb194-84"><a href="#cb194-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-85"><a href="#cb194-85" aria-hidden="true" tabindex="-1"></a>The following R code chunk uses the <span class="in">`stringr`</span> package to find all values of the <span class="in">`Gnrc_Name`</span> variable that contain the string "buprenorphine" and assigns the value <span class="in">`bup`</span> to the <span class="in">`MAT_generic`</span> variable for those rows:</span>
<span id="cb194-86"><a href="#cb194-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-89"><a href="#cb194-89" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-90"><a href="#cb194-90" aria-hidden="true" tabindex="-1"></a>data_2021<span class="sc">$</span>MAT_generic <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb194-91"><a href="#cb194-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_detect</span>(data_2021<span class="sc">$</span>Gnrc_Name, <span class="fu">regex</span>(<span class="st">"bupre"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb194-92"><a href="#cb194-92" aria-hidden="true" tabindex="-1"></a>  <span class="st">"bup"</span>, </span>
<span id="cb194-93"><a href="#cb194-93" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NA</span>)</span>
<span id="cb194-94"><a href="#cb194-94" aria-hidden="true" tabindex="-1"></a><span class="co"># to test the variable encoding we will table all of the values of `Gnrc_Name which were matched above:</span></span>
<span id="cb194-95"><a href="#cb194-95" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Gnrc_Name[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"bup"</span>])</span>
<span id="cb194-96"><a href="#cb194-96" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Brnd_Name[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"bup"</span>])</span>
<span id="cb194-97"><a href="#cb194-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-98"><a href="#cb194-98" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Brnd_Name[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"bup"</span>], data_2021<span class="sc">$</span>Gnrc_Name[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"bup"</span>])<span class="sc">|&gt;</span></span>
<span id="cb194-99"><a href="#cb194-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add a row for totals</span></span>
<span id="cb194-100"><a href="#cb194-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addmargins</span>(<span class="at">margin =</span> <span class="dv">1</span>)</span>
<span id="cb194-101"><a href="#cb194-101" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-102"><a href="#cb194-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-103"><a href="#cb194-103" aria-hidden="true" tabindex="-1"></a>We also want to search for brand names of buprenorphine products.  The following R code chunk uses the <span class="in">`stringr`</span> package to find all values of the <span class="in">`Brnd_Name`</span> variable that contain the strings matching any of the brand names of buprenorphine products and assigns the value <span class="in">`bup`</span> to the <span class="in">`MAT_brand`</span> variable for those rows:</span>
<span id="cb194-104"><a href="#cb194-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-107"><a href="#cb194-107" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-108"><a href="#cb194-108" aria-hidden="true" tabindex="-1"></a>bup_brands <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Belbuca"</span>, <span class="st">"Bunavail"</span>, <span class="st">"Buprenex"</span>, <span class="st">"Buprenorphine"</span>, <span class="st">"Butrans"</span>, <span class="st">"Probuphine"</span>, <span class="st">"Sublocade"</span>, <span class="st">"Suboxone"</span>, <span class="st">"Subutex"</span>, <span class="st">"Zubsolv"</span>)</span>
<span id="cb194-109"><a href="#cb194-109" aria-hidden="true" tabindex="-1"></a><span class="co">#next we will need to concatinate the strings in the `bup_brands` vector into a single string separated by the `|` character, which is the regex "or" operator:</span></span>
<span id="cb194-110"><a href="#cb194-110" aria-hidden="true" tabindex="-1"></a>bup_brands_pattern <span class="ot">&lt;-</span> <span class="fu">paste</span>(bup_brands, <span class="at">collapse =</span> <span class="st">"|"</span>)</span>
<span id="cb194-111"><a href="#cb194-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-112"><a href="#cb194-112" aria-hidden="true" tabindex="-1"></a>data_2021<span class="sc">$</span>MAT_brand <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb194-113"><a href="#cb194-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_detect</span>(data_2021<span class="sc">$</span>Brnd_Name, <span class="fu">regex</span>(bup_brands_pattern, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb194-114"><a href="#cb194-114" aria-hidden="true" tabindex="-1"></a>  <span class="st">"bup"</span>, </span>
<span id="cb194-115"><a href="#cb194-115" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NA</span>)</span>
<span id="cb194-116"><a href="#cb194-116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-117"><a href="#cb194-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-118"><a href="#cb194-118" aria-hidden="true" tabindex="-1"></a>To validate the encoding of the <span class="in">`MAT_brand`</span> variable, we will table all of the values of <span class="in">`Brnd_Name`</span> which were matched above, and table all of the entries where <span class="in">`MAT_brand`</span> was matched vs entries where <span class="in">`MAT_generic`</span> was matched:</span>
<span id="cb194-119"><a href="#cb194-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-122"><a href="#cb194-122" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-123"><a href="#cb194-123" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Brnd_Name[data_2021<span class="sc">$</span>MAT_brand <span class="sc">==</span> <span class="st">"bup"</span>])</span>
<span id="cb194-124"><a href="#cb194-124" aria-hidden="true" tabindex="-1"></a><span class="co">#this produces an identical table to the one above</span></span>
<span id="cb194-125"><a href="#cb194-125" aria-hidden="true" tabindex="-1"></a><span class="co">#as an extra precaution we will cross-tabulate the two variables:</span></span>
<span id="cb194-126"><a href="#cb194-126" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Brnd_Name[data_2021<span class="sc">$</span>MAT_brand <span class="sc">==</span> <span class="st">"bup"</span>], data_2021<span class="sc">$</span>Brnd_Name[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"bup"</span>])</span>
<span id="cb194-127"><a href="#cb194-127" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-128"><a href="#cb194-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-129"><a href="#cb194-129" aria-hidden="true" tabindex="-1"></a>We will now sort each observation according to treatment intention, and assign values to the <span class="in">`tx`</span> variable.  Entries in which buprenorphine was used to treat OUD will be assigned <span class="in">`bup_oud`</span>, entries in which buprenorphine was used to treat pain will be assigned <span class="in">`bup_pain`</span>.  Products indicated for OUD include Sublocade, Brixadi (not available during the years studied), all forms of Buprenorphine Hcl/Naloxone Hcl (Suboxone, Zubsolv, Bunavail, Cassipa, and generic), and Buprenorphine HCl (sublingual, NB that that certain NDCs of this product are reported only as 'Buprenorphine' for the brand and generic names); whereas products indicated for pain include Belbuca (buprenorphine HCl buccal), Buprenex, Butrans, Probuphine (implant, discontinued), generic buprenorphine HCl (parenteral), and generic buprenorphine transdermal patches.  Thus, in the <span class="in">`Brnd_Name`</span> vs <span class="in">`Gnrc_Name`</span> cross-tabulation above, we see that two entries are possibly ambiguous, those in which both variables have the value <span class="in">`Buprenorphine`</span> (which could be generic buprenorphine transdermal patches <span class="co">[</span><span class="ot">pain</span><span class="co">]</span> or buprenorphine HCl sublingual tablets <span class="co">[</span><span class="ot">OUD</span><span class="co">]</span>), and those in which both variables have the variable <span class="in">`Buprenorphine HCl`</span> (which could be parenteral buprenorphine HCl <span class="co">[</span><span class="ot">pain</span><span class="co">]</span>, or buprenorphine HCl sublingual tablets <span class="co">[</span><span class="ot">OUD</span><span class="co">]</span>).  Given that usage of buprenorphine for pain is not common practice in the U.S., we will assume that these ambiguous entries are for OUD, and will generate the <span class="in">`tx`</span> variable by recoding the <span class="in">`Brnd_Name`</span> variable:</span>
<span id="cb194-130"><a href="#cb194-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-133"><a href="#cb194-133" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-134"><a href="#cb194-134" aria-hidden="true" tabindex="-1"></a><span class="co"># using the tidyverse standard function case_when:</span></span>
<span id="cb194-135"><a href="#cb194-135" aria-hidden="true" tabindex="-1"></a>data_2021<span class="sc">$</span>tx <span class="ot">&lt;-</span> <span class="fu">case_match</span>(</span>
<span id="cb194-136"><a href="#cb194-136" aria-hidden="true" tabindex="-1"></a>  data_2021<span class="sc">$</span>Brnd_Name,</span>
<span id="cb194-137"><a href="#cb194-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"Bunavail"</span>, <span class="st">"Buprenorphine"</span>, <span class="st">"Buprenorphine Hcl"</span>, <span class="st">"Buprenorphine-Naloxone"</span>, <span class="st">"Sublocade"</span>, <span class="st">"Suboxone"</span>, <span class="st">"Subutex"</span>, <span class="st">"Zubsolv"</span>) <span class="sc">~</span> <span class="st">"bup_oud"</span>,</span>
<span id="cb194-138"><a href="#cb194-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"Belbuca"</span>, <span class="st">"Buprenex"</span>, <span class="st">"Butrans"</span>, <span class="st">"Probuphine"</span>) <span class="sc">~</span> <span class="st">"bup_pain"</span>,</span>
<span id="cb194-139"><a href="#cb194-139" aria-hidden="true" tabindex="-1"></a>  <span class="at">.default =</span> <span class="cn">NA</span></span>
<span id="cb194-140"><a href="#cb194-140" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-141"><a href="#cb194-141" aria-hidden="true" tabindex="-1"></a><span class="co"># validate encoding by cross tabulating `tx` vs `Brnd_Name`:</span></span>
<span id="cb194-142"><a href="#cb194-142" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Brnd_Name[data_2021<span class="sc">$</span>MAT_brand <span class="sc">==</span> <span class="st">"bup"</span>], data_2021<span class="sc">$</span>tx[data_2021<span class="sc">$</span>MAT_brand <span class="sc">==</span> <span class="st">"bup"</span>]) <span class="sc">|&gt;</span></span>
<span id="cb194-143"><a href="#cb194-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add a row for totals for bup_oud and bup_pain:</span></span>
<span id="cb194-144"><a href="#cb194-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addmargins</span>(<span class="at">margin =</span> <span class="dv">1</span>)</span>
<span id="cb194-145"><a href="#cb194-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-146"><a href="#cb194-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-147"><a href="#cb194-147" aria-hidden="true" tabindex="-1"></a>We can now repeat this process for methadone:</span>
<span id="cb194-148"><a href="#cb194-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-151"><a href="#cb194-151" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-152"><a href="#cb194-152" aria-hidden="true" tabindex="-1"></a>data_2021<span class="sc">$</span>MAT_generic <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb194-153"><a href="#cb194-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_detect</span>(data_2021<span class="sc">$</span>Gnrc_Name, <span class="fu">regex</span>(<span class="st">"methad"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb194-154"><a href="#cb194-154" aria-hidden="true" tabindex="-1"></a>  <span class="st">"met"</span>, </span>
<span id="cb194-155"><a href="#cb194-155" aria-hidden="true" tabindex="-1"></a>  data_2021<span class="sc">$</span>MAT_generic)</span>
<span id="cb194-156"><a href="#cb194-156" aria-hidden="true" tabindex="-1"></a><span class="co"># to test the variable encoding we will table all of the values of `Gnrc_Name which were matched above:</span></span>
<span id="cb194-157"><a href="#cb194-157" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Gnrc_Name[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"met"</span>])</span>
<span id="cb194-158"><a href="#cb194-158" aria-hidden="true" tabindex="-1"></a><span class="co"># table `Brnd_Name`:</span></span>
<span id="cb194-159"><a href="#cb194-159" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Brnd_Name[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"met"</span>])</span>
<span id="cb194-160"><a href="#cb194-160" aria-hidden="true" tabindex="-1"></a><span class="co"># as above with buprenorphine we will construct a vector of methadone brand names:</span></span>
<span id="cb194-161"><a href="#cb194-161" aria-hidden="true" tabindex="-1"></a>met_brands <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Dolophine"</span>, <span class="st">"Methadone"</span>, <span class="st">"Methadose"</span>)  <span class="co">#NB "Methadone Diskets", "Methadone Intensol" will match with "Methadone"</span></span>
<span id="cb194-162"><a href="#cb194-162" aria-hidden="true" tabindex="-1"></a><span class="co"># and construct a regex pattern:</span></span>
<span id="cb194-163"><a href="#cb194-163" aria-hidden="true" tabindex="-1"></a>met_brands_pattern <span class="ot">&lt;-</span> <span class="fu">paste</span>(met_brands, <span class="at">collapse =</span> <span class="st">"|"</span>)</span>
<span id="cb194-164"><a href="#cb194-164" aria-hidden="true" tabindex="-1"></a><span class="co"># and assign the `met` value to the `MAT_brand` variable:</span></span>
<span id="cb194-165"><a href="#cb194-165" aria-hidden="true" tabindex="-1"></a>data_2021<span class="sc">$</span>MAT_brand <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb194-166"><a href="#cb194-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_detect</span>(</span>
<span id="cb194-167"><a href="#cb194-167" aria-hidden="true" tabindex="-1"></a>    data_2021<span class="sc">$</span>Brnd_Name, </span>
<span id="cb194-168"><a href="#cb194-168" aria-hidden="true" tabindex="-1"></a>    <span class="fu">regex</span>(met_brands_pattern, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb194-169"><a href="#cb194-169" aria-hidden="true" tabindex="-1"></a>    <span class="st">"met"</span>, </span>
<span id="cb194-170"><a href="#cb194-170" aria-hidden="true" tabindex="-1"></a>    data_2021<span class="sc">$</span>MAT_brand)</span>
<span id="cb194-171"><a href="#cb194-171" aria-hidden="true" tabindex="-1"></a><span class="co"># validate:</span></span>
<span id="cb194-172"><a href="#cb194-172" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Brnd_Name[data_2021<span class="sc">$</span>MAT_brand <span class="sc">==</span> <span class="st">"met"</span>])</span>
<span id="cb194-173"><a href="#cb194-173" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Brnd_Name[data_2021<span class="sc">$</span>MAT_brand <span class="sc">==</span> <span class="st">"met"</span>], data_2021<span class="sc">$</span>Gnrc_Name[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"met"</span>])</span>
<span id="cb194-174"><a href="#cb194-174" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-175"><a href="#cb194-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-176"><a href="#cb194-176" aria-hidden="true" tabindex="-1"></a>We will now sort each observation according to treatment intention, and assign values to the <span class="in">`tx`</span> variable.  Entries in which methadone was used to treat OUD will be assigned <span class="in">`met_oud`</span>, entries in which methadone was used to treat pain will be assigned <span class="in">`met_pain`</span>.  Products indicated for OUD include Dolophine (methadone HCl oral concentrate), Methadone HCl (oral concentrate, oral solution, oral tablet), Methadose (oral concentrate, oral solution, oral tablet), and generic methadone HCl (oral concentrate, oral solution, oral tablet); whereas products indicated for pain include generic methadone HCl (parenteral), Dolophine and Methadone Intensol.  Thus, in the <span class="in">`Brnd_Name`</span> vs <span class="in">`Gnrc_Name`</span> cross-tabulation above, we see that two entries are possibly ambiguous, those in which both variables have the value <span class="in">`Methadone HCl`</span> (which could be parenteral methadone HCl <span class="co">[</span><span class="ot">pain</span><span class="co">]</span>, or methadone HCl oral concentrate, oral solution, Dolophine, or oral tablet <span class="co">[</span><span class="ot">OUD</span><span class="co">]</span>).  Given that usage of methadone for pain is not common practice in the U.S., we will assume that these ambiguous entries are for OUD, and will generate the <span class="in">`tx`</span> variable by recoding the <span class="in">`Brnd_Name`</span> variable:</span>
<span id="cb194-177"><a href="#cb194-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-180"><a href="#cb194-180" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-181"><a href="#cb194-181" aria-hidden="true" tabindex="-1"></a>data_2021<span class="sc">$</span>tx <span class="ot">&lt;-</span> <span class="fu">case_match</span>(</span>
<span id="cb194-182"><a href="#cb194-182" aria-hidden="true" tabindex="-1"></a>  data_2021<span class="sc">$</span>Brnd_Name,</span>
<span id="cb194-183"><a href="#cb194-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"Methadone Hcl"</span>, <span class="st">"Methadose"</span>) <span class="sc">~</span> <span class="st">"met_oud"</span>,</span>
<span id="cb194-184"><a href="#cb194-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"Dolophine"</span>, <span class="st">"Methadone Diskets"</span>, <span class="st">"Methadone Intensol"</span>) <span class="sc">~</span> <span class="st">"met_pain"</span>,</span>
<span id="cb194-185"><a href="#cb194-185" aria-hidden="true" tabindex="-1"></a>  <span class="at">.default =</span> data_2021<span class="sc">$</span>tx</span>
<span id="cb194-186"><a href="#cb194-186" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-187"><a href="#cb194-187" aria-hidden="true" tabindex="-1"></a><span class="co"># validate by tabling `tx` against `Brnd_Name` for entries where MAT_generic == "met":</span></span>
<span id="cb194-188"><a href="#cb194-188" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Brnd_Name[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"met"</span>], data_2021<span class="sc">$</span>tx[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"met"</span>])</span>
<span id="cb194-189"><a href="#cb194-189" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-190"><a href="#cb194-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-191"><a href="#cb194-191" aria-hidden="true" tabindex="-1"></a>Repeating for naltrexone:</span>
<span id="cb194-192"><a href="#cb194-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-195"><a href="#cb194-195" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-196"><a href="#cb194-196" aria-hidden="true" tabindex="-1"></a>data_2021<span class="sc">$</span>MAT_generic <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb194-197"><a href="#cb194-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_detect</span>(data_2021<span class="sc">$</span>Gnrc_Name, <span class="fu">regex</span>(<span class="st">"naltrex"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)) </span>
<span id="cb194-198"><a href="#cb194-198" aria-hidden="true" tabindex="-1"></a>  <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_detect</span>(data_2021<span class="sc">$</span>Gnrc_Name, <span class="fu">regex</span>(<span class="st">"Methylnaltrexone"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>))  <span class="co"># filter out methylnaltrexone</span></span>
<span id="cb194-199"><a href="#cb194-199" aria-hidden="true" tabindex="-1"></a>  <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_detect</span>(data_2021<span class="sc">$</span>Gnrc_Name, <span class="fu">regex</span>(<span class="st">"Bupropion"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)),        <span class="co"># filter out Contrave</span></span>
<span id="cb194-200"><a href="#cb194-200" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nal"</span>, </span>
<span id="cb194-201"><a href="#cb194-201" aria-hidden="true" tabindex="-1"></a>  data_2021<span class="sc">$</span>MAT_generic)</span>
<span id="cb194-202"><a href="#cb194-202" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-203"><a href="#cb194-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-204"><a href="#cb194-204" aria-hidden="true" tabindex="-1"></a>Testing the above encoding:</span>
<span id="cb194-205"><a href="#cb194-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-208"><a href="#cb194-208" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-209"><a href="#cb194-209" aria-hidden="true" tabindex="-1"></a><span class="co"># to test the variable encoding we will table all of the values of `Gnrc_Name which were matched above:</span></span>
<span id="cb194-210"><a href="#cb194-210" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Gnrc_Name[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"nal"</span>])</span>
<span id="cb194-211"><a href="#cb194-211" aria-hidden="true" tabindex="-1"></a><span class="co"># and table the brand names:</span></span>
<span id="cb194-212"><a href="#cb194-212" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Brnd_Name[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"nal"</span>])</span>
<span id="cb194-213"><a href="#cb194-213" aria-hidden="true" tabindex="-1"></a><span class="co"># crosstabulate</span></span>
<span id="cb194-214"><a href="#cb194-214" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Brnd_Name[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"nal"</span>], data_2021<span class="sc">$</span>Gnrc_Name[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"nal"</span>])</span>
<span id="cb194-215"><a href="#cb194-215" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-216"><a href="#cb194-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-217"><a href="#cb194-217" aria-hidden="true" tabindex="-1"></a>Checking against brand names:</span>
<span id="cb194-218"><a href="#cb194-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-221"><a href="#cb194-221" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-222"><a href="#cb194-222" aria-hidden="true" tabindex="-1"></a><span class="co">#as above with buprenorphine we will construct a vector of naltrexone brand names:</span></span>
<span id="cb194-223"><a href="#cb194-223" aria-hidden="true" tabindex="-1"></a>nal_brands <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Depade"</span>, <span class="st">"Naltrexone"</span>, <span class="st">"Revia"</span>, <span class="st">"Vivitrol"</span>)</span>
<span id="cb194-224"><a href="#cb194-224" aria-hidden="true" tabindex="-1"></a><span class="co"># and construct a regex pattern:</span></span>
<span id="cb194-225"><a href="#cb194-225" aria-hidden="true" tabindex="-1"></a>nal_brands_pattern <span class="ot">&lt;-</span> <span class="fu">paste</span>(nal_brands, <span class="at">collapse =</span> <span class="st">"|"</span>)</span>
<span id="cb194-226"><a href="#cb194-226" aria-hidden="true" tabindex="-1"></a><span class="co"># and assign the `nal` value to the `MAT_brand` variable:</span></span>
<span id="cb194-227"><a href="#cb194-227" aria-hidden="true" tabindex="-1"></a>data_2021<span class="sc">$</span>MAT_brand <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb194-228"><a href="#cb194-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_detect</span>(</span>
<span id="cb194-229"><a href="#cb194-229" aria-hidden="true" tabindex="-1"></a>    data_2021<span class="sc">$</span>Brnd_Name, </span>
<span id="cb194-230"><a href="#cb194-230" aria-hidden="true" tabindex="-1"></a>    <span class="fu">regex</span>(nal_brands_pattern, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb194-231"><a href="#cb194-231" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nal"</span>, </span>
<span id="cb194-232"><a href="#cb194-232" aria-hidden="true" tabindex="-1"></a>    data_2021<span class="sc">$</span>MAT_brand</span>
<span id="cb194-233"><a href="#cb194-233" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb194-234"><a href="#cb194-234" aria-hidden="true" tabindex="-1"></a><span class="co"># validate:</span></span>
<span id="cb194-235"><a href="#cb194-235" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Brnd_Name[data_2021<span class="sc">$</span>MAT_brand <span class="sc">==</span> <span class="st">"nal"</span>])</span>
<span id="cb194-236"><a href="#cb194-236" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Brnd_Name[data_2021<span class="sc">$</span>MAT_brand <span class="sc">==</span> <span class="st">"nal"</span>], data_2021<span class="sc">$</span>Gnrc_Name[data_2021<span class="sc">$</span>MAT_brand <span class="sc">==</span> <span class="st">"nal"</span>])</span>
<span id="cb194-237"><a href="#cb194-237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-238"><a href="#cb194-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-239"><a href="#cb194-239" aria-hidden="true" tabindex="-1"></a>Unfortunately there is no way to distinguish between naltrexone for OUD and naltrexone for alcohol use disorder (AUD) using the current dataset.  We will assume that all naltrexone prescriptions are for OUD, and will generate the <span class="in">`tx`</span> variable by recoding the <span class="in">`Brnd_Name`</span> variable:</span>
<span id="cb194-240"><a href="#cb194-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-243"><a href="#cb194-243" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-244"><a href="#cb194-244" aria-hidden="true" tabindex="-1"></a>data_2021<span class="sc">$</span>tx <span class="ot">&lt;-</span> <span class="fu">case_match</span>(</span>
<span id="cb194-245"><a href="#cb194-245" aria-hidden="true" tabindex="-1"></a>  data_2021<span class="sc">$</span>Brnd_Name,</span>
<span id="cb194-246"><a href="#cb194-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"Depade"</span>, <span class="st">"Naltrexone"</span>, <span class="st">"Revia"</span>, <span class="st">"Vivitrol"</span>, <span class="st">"Naltrexone Hcl"</span>, <span class="st">"Naltrexone Microspheres"</span>) <span class="sc">~</span> <span class="st">"nal_oud"</span>,</span>
<span id="cb194-247"><a href="#cb194-247" aria-hidden="true" tabindex="-1"></a>  <span class="at">.default =</span> data_2021<span class="sc">$</span>tx</span>
<span id="cb194-248"><a href="#cb194-248" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-249"><a href="#cb194-249" aria-hidden="true" tabindex="-1"></a><span class="co"># validate by tabling `tx` against `Brnd_Name` for entries where MAT_generic == "nal":</span></span>
<span id="cb194-250"><a href="#cb194-250" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Brnd_Name[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"nal"</span>], data_2021<span class="sc">$</span>tx[data_2021<span class="sc">$</span>MAT_generic <span class="sc">==</span> <span class="st">"nal"</span>])</span>
<span id="cb194-251"><a href="#cb194-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-252"><a href="#cb194-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-253"><a href="#cb194-253" aria-hidden="true" tabindex="-1"></a>As a summary of the <span class="in">`tx`</span> variable, we will tabulate the number of entries for each treatment intention:</span>
<span id="cb194-254"><a href="#cb194-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-257"><a href="#cb194-257" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-258"><a href="#cb194-258" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021<span class="sc">$</span>Brnd_Name[<span class="sc">!</span><span class="fu">is.na</span>(data_2021<span class="sc">$</span>MAT_generic)],</span>
<span id="cb194-259"><a href="#cb194-259" aria-hidden="true" tabindex="-1"></a>      data_2021<span class="sc">$</span>tx[<span class="sc">!</span><span class="fu">is.na</span>(data_2021<span class="sc">$</span>MAT_generic)]) <span class="sc">|&gt;</span></span>
<span id="cb194-260"><a href="#cb194-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addmargins</span>(<span class="at">margin =</span> <span class="dv">1</span>)</span>
<span id="cb194-261"><a href="#cb194-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-262"><a href="#cb194-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-263"><a href="#cb194-263" aria-hidden="true" tabindex="-1"></a>Lastly we will create a new dataset to work with using only entries corresponding to the three MAT drugs:</span>
<span id="cb194-264"><a href="#cb194-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-267"><a href="#cb194-267" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-268"><a href="#cb194-268" aria-hidden="true" tabindex="-1"></a>data_2021_tx <span class="ot">&lt;-</span> data_2021[<span class="sc">!</span><span class="fu">is.na</span>(data_2021<span class="sc">$</span>tx), ]</span>
<span id="cb194-269"><a href="#cb194-269" aria-hidden="true" tabindex="-1"></a><span class="co">#verify the new dataset by tabulating tx vs brand names as above:</span></span>
<span id="cb194-270"><a href="#cb194-270" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_2021_tx<span class="sc">$</span>Brnd_Name, data_2021_tx<span class="sc">$</span>tx) <span class="sc">|&gt;</span></span>
<span id="cb194-271"><a href="#cb194-271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addmargins</span>(<span class="at">margin =</span> <span class="dv">1</span>)</span>
<span id="cb194-272"><a href="#cb194-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-273"><a href="#cb194-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-274"><a href="#cb194-274" aria-hidden="true" tabindex="-1"></a><span class="fu">## Treatment Variable</span></span>
<span id="cb194-275"><a href="#cb194-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-276"><a href="#cb194-276" aria-hidden="true" tabindex="-1"></a><span class="fu">### Treatment Function</span></span>
<span id="cb194-277"><a href="#cb194-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-278"><a href="#cb194-278" aria-hidden="true" tabindex="-1"></a>We will now create a function to generate the treatment variable, <span class="in">`tx`</span> for each year of data.  For this function we will use the <span class="in">`dataset`</span> argument to refer to the dataset to be processed, and <span class="in">`data`</span> to refer to the data to be returned.  We will generate the <span class="in">`tx`</span> variable, and will also generate <span class="in">`MAT_generic~ and `</span>MAT_brand<span class="in">` to serve as a check on the `</span>tx` variable.  The dataset returned will only include entries for which any of these three variables are not NA:</span>
<span id="cb194-279"><a href="#cb194-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-282"><a href="#cb194-282" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-283"><a href="#cb194-283" aria-hidden="true" tabindex="-1"></a><span class="co"># create a function to process the data:</span></span>
<span id="cb194-284"><a href="#cb194-284" aria-hidden="true" tabindex="-1"></a>treatment <span class="ot">&lt;-</span> <span class="cf">function</span>(data_year, <span class="at">bup_brands_pattern =</span> <span class="cn">NULL</span>, <span class="at">met_brands_pattern =</span> <span class="cn">NULL</span>, <span class="at">nal_brands_pattern =</span> <span class="cn">NULL</span>) {</span>
<span id="cb194-285"><a href="#cb194-285" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create the MAT_generic variable for buprenorphine:</span></span>
<span id="cb194-286"><a href="#cb194-286" aria-hidden="true" tabindex="-1"></a>  data_year<span class="sc">$</span>MAT_generic <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb194-287"><a href="#cb194-287" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(</span>
<span id="cb194-288"><a href="#cb194-288" aria-hidden="true" tabindex="-1"></a>      data_year<span class="sc">$</span>Gnrc_Name, </span>
<span id="cb194-289"><a href="#cb194-289" aria-hidden="true" tabindex="-1"></a>      <span class="fu">regex</span>(<span class="st">"bupre"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb194-290"><a href="#cb194-290" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bup"</span>, </span>
<span id="cb194-291"><a href="#cb194-291" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NA</span>)</span>
<span id="cb194-292"><a href="#cb194-292" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb194-293"><a href="#cb194-293" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create the MAT_brand variable for buprenorphine:</span></span>
<span id="cb194-294"><a href="#cb194-294" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if `bup_brands_pattern` not supplied as an argument, starting by creating a vector of buprenorphine brand names and concatinating to regex:</span></span>
<span id="cb194-295"><a href="#cb194-295" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(bup_brands_pattern)) {</span>
<span id="cb194-296"><a href="#cb194-296" aria-hidden="true" tabindex="-1"></a>    bup_brands <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Belbuca"</span>, <span class="st">"Bunavail"</span>, <span class="st">"Buprenex"</span>, <span class="st">"Buprenorphine"</span>, <span class="st">"Butrans"</span>, <span class="st">"Probuphine"</span>, <span class="st">"Sublocade"</span>, <span class="st">"Suboxone"</span>, <span class="st">"Subutex"</span>, <span class="st">"Zubsolv"</span>)</span>
<span id="cb194-297"><a href="#cb194-297" aria-hidden="true" tabindex="-1"></a>    bup_brands_pattern <span class="ot">&lt;-</span> <span class="fu">paste</span>(bup_brands, <span class="at">collapse =</span> <span class="st">"|"</span>)</span>
<span id="cb194-298"><a href="#cb194-298" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb194-299"><a href="#cb194-299" aria-hidden="true" tabindex="-1"></a>  <span class="co"># assign the MAT_brand value based on the regex:</span></span>
<span id="cb194-300"><a href="#cb194-300" aria-hidden="true" tabindex="-1"></a>  data_year<span class="sc">$</span>MAT_brand <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb194-301"><a href="#cb194-301" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(</span>
<span id="cb194-302"><a href="#cb194-302" aria-hidden="true" tabindex="-1"></a>      data_year<span class="sc">$</span>Brnd_Name, </span>
<span id="cb194-303"><a href="#cb194-303" aria-hidden="true" tabindex="-1"></a>      <span class="fu">regex</span>(bup_brands_pattern, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb194-304"><a href="#cb194-304" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bup"</span>, </span>
<span id="cb194-305"><a href="#cb194-305" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NA</span>)</span>
<span id="cb194-306"><a href="#cb194-306" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb194-307"><a href="#cb194-307" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create the MAT_generic variable for methadone:</span></span>
<span id="cb194-308"><a href="#cb194-308" aria-hidden="true" tabindex="-1"></a>  data_year<span class="sc">$</span>MAT_generic <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb194-309"><a href="#cb194-309" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(</span>
<span id="cb194-310"><a href="#cb194-310" aria-hidden="true" tabindex="-1"></a>      data_year<span class="sc">$</span>Gnrc_Name, </span>
<span id="cb194-311"><a href="#cb194-311" aria-hidden="true" tabindex="-1"></a>      <span class="fu">regex</span>(<span class="st">"methad"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb194-312"><a href="#cb194-312" aria-hidden="true" tabindex="-1"></a>    <span class="st">"met"</span>, </span>
<span id="cb194-313"><a href="#cb194-313" aria-hidden="true" tabindex="-1"></a>    data_year<span class="sc">$</span>MAT_generic)</span>
<span id="cb194-314"><a href="#cb194-314" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb194-315"><a href="#cb194-315" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create the MAT_brand variable for methadone:</span></span>
<span id="cb194-316"><a href="#cb194-316" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if `met_brands_pattern` not supplied as an argument, starting by creating a vector of methadone brand names and concatinating to regex:</span></span>
<span id="cb194-317"><a href="#cb194-317" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(met_brands_pattern)) {</span>
<span id="cb194-318"><a href="#cb194-318" aria-hidden="true" tabindex="-1"></a>    met_brands <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Dolophine"</span>, <span class="st">"Methadone"</span>, <span class="st">"Methadose"</span>, <span class="st">"Diskets"</span>)</span>
<span id="cb194-319"><a href="#cb194-319" aria-hidden="true" tabindex="-1"></a>    met_brands_pattern <span class="ot">&lt;-</span> <span class="fu">paste</span>(met_brands, <span class="at">collapse =</span> <span class="st">"|"</span>)</span>
<span id="cb194-320"><a href="#cb194-320" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb194-321"><a href="#cb194-321" aria-hidden="true" tabindex="-1"></a>  <span class="co"># assign the MAT_brand value:</span></span>
<span id="cb194-322"><a href="#cb194-322" aria-hidden="true" tabindex="-1"></a>  data_year<span class="sc">$</span>MAT_brand <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb194-323"><a href="#cb194-323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(</span>
<span id="cb194-324"><a href="#cb194-324" aria-hidden="true" tabindex="-1"></a>      data_year<span class="sc">$</span>Brnd_Name, </span>
<span id="cb194-325"><a href="#cb194-325" aria-hidden="true" tabindex="-1"></a>      <span class="fu">regex</span>(met_brands_pattern, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb194-326"><a href="#cb194-326" aria-hidden="true" tabindex="-1"></a>    <span class="st">"met"</span>, </span>
<span id="cb194-327"><a href="#cb194-327" aria-hidden="true" tabindex="-1"></a>    data_year<span class="sc">$</span>MAT_brand)</span>
<span id="cb194-328"><a href="#cb194-328" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb194-329"><a href="#cb194-329" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create the MAT_generic variable for naltrexone:</span></span>
<span id="cb194-330"><a href="#cb194-330" aria-hidden="true" tabindex="-1"></a>  data_year<span class="sc">$</span>MAT_generic <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb194-331"><a href="#cb194-331" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(</span>
<span id="cb194-332"><a href="#cb194-332" aria-hidden="true" tabindex="-1"></a>      data_year<span class="sc">$</span>Gnrc_Name, </span>
<span id="cb194-333"><a href="#cb194-333" aria-hidden="true" tabindex="-1"></a>      <span class="fu">regex</span>(<span class="st">"naltrex"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>))</span>
<span id="cb194-334"><a href="#cb194-334" aria-hidden="true" tabindex="-1"></a>      <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_detect</span>(data_year<span class="sc">$</span>Gnrc_Name, <span class="fu">regex</span>(<span class="st">"Methylnaltrexone"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>))  <span class="co"># filter out methylnaltrexone</span></span>
<span id="cb194-335"><a href="#cb194-335" aria-hidden="true" tabindex="-1"></a>      <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_detect</span>(data_year<span class="sc">$</span>Gnrc_Name, <span class="fu">regex</span>(<span class="st">"Bupropion"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>))         <span class="co"># filter out Contrave</span></span>
<span id="cb194-336"><a href="#cb194-336" aria-hidden="true" tabindex="-1"></a>      <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_detect</span>(data_year<span class="sc">$</span>Brnd_Name, <span class="fu">regex</span>(<span class="st">"Embeda"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)),           <span class="co"># filter out Embeda</span></span>
<span id="cb194-337"><a href="#cb194-337" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nal"</span>, </span>
<span id="cb194-338"><a href="#cb194-338" aria-hidden="true" tabindex="-1"></a>    data_year<span class="sc">$</span>MAT_generic)</span>
<span id="cb194-339"><a href="#cb194-339" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb194-340"><a href="#cb194-340" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create the MAT_brand variable for naltrexone:</span></span>
<span id="cb194-341"><a href="#cb194-341" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if `nal_brands_pattern` not supplied as an argument, starting by creating a vector of naltrexone brand names and concatinating to regex:</span></span>
<span id="cb194-342"><a href="#cb194-342" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(nal_brands_pattern)) {</span>
<span id="cb194-343"><a href="#cb194-343" aria-hidden="true" tabindex="-1"></a>    nal_brands <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Depade"</span>, <span class="st">"Naltrexone"</span>, <span class="st">"Revia"</span>, <span class="st">"Vivitrol"</span>)</span>
<span id="cb194-344"><a href="#cb194-344" aria-hidden="true" tabindex="-1"></a>    nal_brands_pattern <span class="ot">&lt;-</span> <span class="fu">paste</span>(nal_brands, <span class="at">collapse =</span> <span class="st">"|"</span>)</span>
<span id="cb194-345"><a href="#cb194-345" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb194-346"><a href="#cb194-346" aria-hidden="true" tabindex="-1"></a>  <span class="co"># assign the MAT_brand value:</span></span>
<span id="cb194-347"><a href="#cb194-347" aria-hidden="true" tabindex="-1"></a>  data_year<span class="sc">$</span>MAT_brand <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb194-348"><a href="#cb194-348" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(</span>
<span id="cb194-349"><a href="#cb194-349" aria-hidden="true" tabindex="-1"></a>      data_year<span class="sc">$</span>Brnd_Name, </span>
<span id="cb194-350"><a href="#cb194-350" aria-hidden="true" tabindex="-1"></a>      <span class="fu">regex</span>(nal_brands_pattern, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb194-351"><a href="#cb194-351" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nal"</span>, </span>
<span id="cb194-352"><a href="#cb194-352" aria-hidden="true" tabindex="-1"></a>    data_year<span class="sc">$</span>MAT_brand)</span>
<span id="cb194-353"><a href="#cb194-353" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb194-354"><a href="#cb194-354" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create the tx variable using `case_match` as above:</span></span>
<span id="cb194-355"><a href="#cb194-355" aria-hidden="true" tabindex="-1"></a>data_year<span class="sc">$</span>tx <span class="ot">&lt;-</span> <span class="fu">case_match</span>(</span>
<span id="cb194-356"><a href="#cb194-356" aria-hidden="true" tabindex="-1"></a>  data_year<span class="sc">$</span>Brnd_Name,</span>
<span id="cb194-357"><a href="#cb194-357" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"Bunavail"</span>, <span class="st">"Buprenorphine"</span>, <span class="st">"Buprenorphine Hcl"</span>, <span class="st">"Buprenorphine-Naloxone"</span>, <span class="st">"Sublocade"</span>, <span class="st">"Suboxone"</span>, <span class="st">"Subutex"</span>, <span class="st">"Zubsolv"</span>) <span class="sc">~</span> <span class="st">"bup_oud"</span>,</span>
<span id="cb194-358"><a href="#cb194-358" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"Belbuca"</span>, <span class="st">"Buprenex"</span>, <span class="st">"Butrans"</span>, <span class="st">"Probuphine"</span>) <span class="sc">~</span> <span class="st">"bup_pain"</span>,</span>
<span id="cb194-359"><a href="#cb194-359" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"Methadone Hcl"</span>, <span class="st">"Methadose"</span>, <span class="st">"Dolophine Hcl"</span>, <span class="st">"Diskets"</span>) <span class="sc">~</span> <span class="st">"met_oud"</span>,</span>
<span id="cb194-360"><a href="#cb194-360" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"Methadone Diskets"</span>, <span class="st">"Methadone Intensol"</span>) <span class="sc">~</span> <span class="st">"met_pain"</span>,</span>
<span id="cb194-361"><a href="#cb194-361" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"Depade"</span>, <span class="st">"Naltrexone"</span>, <span class="st">"Revia"</span>, <span class="st">"Vivitrol"</span>, <span class="st">"Naltrexone Hcl"</span>, <span class="st">"Naltrexone Microspheres"</span>) <span class="sc">~</span> <span class="st">"nal_oud"</span>,</span>
<span id="cb194-362"><a href="#cb194-362" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> <span class="cn">NA</span></span>
<span id="cb194-363"><a href="#cb194-363" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-364"><a href="#cb194-364" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb194-365"><a href="#cb194-365" aria-hidden="true" tabindex="-1"></a><span class="co"># return the dataset limited to observations with a value in at least one of the MAT variables or the tx variable:</span></span>
<span id="cb194-366"><a href="#cb194-366" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data_year[<span class="sc">!</span><span class="fu">is.na</span>(data_year<span class="sc">$</span>MAT_generic) <span class="sc">|</span> <span class="sc">!</span><span class="fu">is.na</span>(data_year<span class="sc">$</span>MAT_brand) <span class="sc">|</span> <span class="sc">!</span><span class="fu">is.na</span>(data_year<span class="sc">$</span>tx), ])</span>
<span id="cb194-367"><a href="#cb194-367" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb194-368"><a href="#cb194-368" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-369"><a href="#cb194-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-370"><a href="#cb194-370" aria-hidden="true" tabindex="-1"></a>To test the function we will use the 2013 data:</span>
<span id="cb194-371"><a href="#cb194-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-374"><a href="#cb194-374" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-375"><a href="#cb194-375" aria-hidden="true" tabindex="-1"></a><span class="do">##| cache: true</span></span>
<span id="cb194-376"><a href="#cb194-376" aria-hidden="true" tabindex="-1"></a><span class="co"># load the 2013 data:</span></span>
<span id="cb194-377"><a href="#cb194-377" aria-hidden="true" tabindex="-1"></a>data_2013 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/2013.csv"</span>)</span>
<span id="cb194-378"><a href="#cb194-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-379"><a href="#cb194-379" aria-hidden="true" tabindex="-1"></a>data_tx <span class="ot">&lt;-</span> <span class="fu">treatment</span>(data_2013)</span>
<span id="cb194-380"><a href="#cb194-380" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-381"><a href="#cb194-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-384"><a href="#cb194-384" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-385"><a href="#cb194-385" aria-hidden="true" tabindex="-1"></a><span class="co">#verify the new dataset by tabulating tx vs brand names as above:</span></span>
<span id="cb194-386"><a href="#cb194-386" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_tx<span class="sc">$</span>Brnd_Name[<span class="sc">!</span><span class="fu">is.na</span>(data_tx<span class="sc">$</span>MAT_generic)], data_tx<span class="sc">$</span>tx[<span class="sc">!</span><span class="fu">is.na</span>(data_tx<span class="sc">$</span>MAT_generic)])</span>
<span id="cb194-387"><a href="#cb194-387" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-388"><a href="#cb194-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-389"><a href="#cb194-389" aria-hidden="true" tabindex="-1"></a>We can now iteratively apply the function to each year of data:</span>
<span id="cb194-390"><a href="#cb194-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-393"><a href="#cb194-393" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-394"><a href="#cb194-394" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb194-395"><a href="#cb194-395" aria-hidden="true" tabindex="-1"></a><span class="co"># create data_tx as an empty dataset:</span></span>
<span id="cb194-396"><a href="#cb194-396" aria-hidden="true" tabindex="-1"></a>data_tx <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb194-397"><a href="#cb194-397" aria-hidden="true" tabindex="-1"></a><span class="co"># iterate over years 2013-2021:</span></span>
<span id="cb194-398"><a href="#cb194-398" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (year <span class="cf">in</span> <span class="dv">2013</span><span class="sc">:</span><span class="dv">2021</span>) {</span>
<span id="cb194-399"><a href="#cb194-399" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the data:</span></span>
<span id="cb194-400"><a href="#cb194-400" aria-hidden="true" tabindex="-1"></a>  data_year <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb194-401"><a href="#cb194-401" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">"data/"</span>, year, <span class="st">".csv"</span>),</span>
<span id="cb194-402"><a href="#cb194-402" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_col_types =</span> <span class="cn">FALSE</span>,</span>
<span id="cb194-403"><a href="#cb194-403" aria-hidden="true" tabindex="-1"></a>    <span class="at">progress =</span> <span class="cn">TRUE</span></span>
<span id="cb194-404"><a href="#cb194-404" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb194-405"><a href="#cb194-405" aria-hidden="true" tabindex="-1"></a>  <span class="co"># apply the treatment function:</span></span>
<span id="cb194-406"><a href="#cb194-406" aria-hidden="true" tabindex="-1"></a>  data_year <span class="ot">&lt;-</span> <span class="fu">treatment</span>(data_year)</span>
<span id="cb194-407"><a href="#cb194-407" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set the `year` variable:</span></span>
<span id="cb194-408"><a href="#cb194-408" aria-hidden="true" tabindex="-1"></a>  data_year<span class="sc">$</span>year <span class="ot">&lt;-</span> year</span>
<span id="cb194-409"><a href="#cb194-409" aria-hidden="true" tabindex="-1"></a>  <span class="co"># append the data to the `data_tx` dataset:</span></span>
<span id="cb194-410"><a href="#cb194-410" aria-hidden="true" tabindex="-1"></a>  data_tx <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data_tx, data_year)</span>
<span id="cb194-411"><a href="#cb194-411" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb194-412"><a href="#cb194-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-413"><a href="#cb194-413" aria-hidden="true" tabindex="-1"></a><span class="co"># cleanup</span></span>
<span id="cb194-414"><a href="#cb194-414" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(data_year, year)</span>
<span id="cb194-415"><a href="#cb194-415" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-416"><a href="#cb194-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-417"><a href="#cb194-417" aria-hidden="true" tabindex="-1"></a><span class="fu">### Validate</span></span>
<span id="cb194-418"><a href="#cb194-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-419"><a href="#cb194-419" aria-hidden="true" tabindex="-1"></a>We can now validate the new dataset by tabulating <span class="in">`tx`</span> vs <span class="in">`brand names`</span> variables as above:</span>
<span id="cb194-420"><a href="#cb194-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-423"><a href="#cb194-423" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-424"><a href="#cb194-424" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_tx<span class="sc">$</span>Brnd_Name[<span class="sc">!</span><span class="fu">is.na</span>(data_tx<span class="sc">$</span>MAT_generic)], data_tx<span class="sc">$</span>tx[<span class="sc">!</span><span class="fu">is.na</span>(data_tx<span class="sc">$</span>MAT_generic)]) <span class="sc">|&gt;</span></span>
<span id="cb194-425"><a href="#cb194-425" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add row for totals:</span></span>
<span id="cb194-426"><a href="#cb194-426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addmargins</span>(<span class="at">margin =</span> <span class="dv">1</span>) </span>
<span id="cb194-427"><a href="#cb194-427" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-428"><a href="#cb194-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-429"><a href="#cb194-429" aria-hidden="true" tabindex="-1"></a>We can see that three lines correspond to null values for the MAT variables, "Diskets" (a methadone OUD product), "Dolophine Hcl" (a methadone product indicated for OUD or pain), and "Embeda" (a morphine/naltrexone product).  We will now count the number of observations with NA values for one or more of the MAT variables or the tx variable:</span>
<span id="cb194-430"><a href="#cb194-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-433"><a href="#cb194-433" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-434"><a href="#cb194-434" aria-hidden="true" tabindex="-1"></a><span class="co"># filter to observations with NA values for one or more of the MAT variables or the tx variable:</span></span>
<span id="cb194-435"><a href="#cb194-435" aria-hidden="true" tabindex="-1"></a>data_tx <span class="sc">|&gt;</span></span>
<span id="cb194-436"><a href="#cb194-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(MAT_generic) <span class="sc">|</span> <span class="fu">is.na</span>(MAT_brand) <span class="sc">|</span> <span class="fu">is.na</span>(tx)) <span class="sc">|&gt;</span></span>
<span id="cb194-437"><a href="#cb194-437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span>
<span id="cb194-438"><a href="#cb194-438" aria-hidden="true" tabindex="-1"></a><span class="co"># filter to observations with NA values for generic:</span></span>
<span id="cb194-439"><a href="#cb194-439" aria-hidden="true" tabindex="-1"></a>data_tx <span class="sc">|&gt;</span></span>
<span id="cb194-440"><a href="#cb194-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(MAT_generic)) <span class="sc">|&gt;</span></span>
<span id="cb194-441"><a href="#cb194-441" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span>
<span id="cb194-442"><a href="#cb194-442" aria-hidden="true" tabindex="-1"></a><span class="co"># filter to observations with NA values for brand:</span></span>
<span id="cb194-443"><a href="#cb194-443" aria-hidden="true" tabindex="-1"></a>data_tx <span class="sc">|&gt;</span></span>
<span id="cb194-444"><a href="#cb194-444" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(MAT_brand)) <span class="sc">|&gt;</span></span>
<span id="cb194-445"><a href="#cb194-445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span>
<span id="cb194-446"><a href="#cb194-446" aria-hidden="true" tabindex="-1"></a><span class="co"># filter to observations with NA values for tx:</span></span>
<span id="cb194-447"><a href="#cb194-447" aria-hidden="true" tabindex="-1"></a>data_tx <span class="sc">|&gt;</span></span>
<span id="cb194-448"><a href="#cb194-448" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(tx)) <span class="sc">|&gt;</span></span>
<span id="cb194-449"><a href="#cb194-449" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span>
<span id="cb194-450"><a href="#cb194-450" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-451"><a href="#cb194-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-452"><a href="#cb194-452" aria-hidden="true" tabindex="-1"></a>A little bit of cleanup:</span>
<span id="cb194-453"><a href="#cb194-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-456"><a href="#cb194-456" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-457"><a href="#cb194-457" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(treatment)</span>
<span id="cb194-458"><a href="#cb194-458" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-459"><a href="#cb194-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-460"><a href="#cb194-460" aria-hidden="true" tabindex="-1"></a><span class="fu">## Rural vs Urban</span></span>
<span id="cb194-461"><a href="#cb194-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-462"><a href="#cb194-462" aria-hidden="true" tabindex="-1"></a><span class="fu">### Using USGS Data</span></span>
<span id="cb194-463"><a href="#cb194-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-464"><a href="#cb194-464" aria-hidden="true" tabindex="-1"></a><span class="fu">#### USGS Classification Overview</span></span>
<span id="cb194-465"><a href="#cb194-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-466"><a href="#cb194-466" aria-hidden="true" tabindex="-1"></a>Using the USGS Populated Places dataset, we will attempt to convert the city/state data from the dataset into the CDC's 2013 Urban-Rural Classification using the following steps:</span>
<span id="cb194-467"><a href="#cb194-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-468"><a href="#cb194-468" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>The USGS dataset (which can be found as a text file within their Geographic Names Information System (GNIS) <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.usgs.gov/us-board-on-geographic-names/download-gnis-data)</span>) contains several variables including the state name/FIPS, the 'map name' (which is often the city name), and the county name/FIPS.  The first step will be to lookup the city/state in this dataset and retrieve the full FIPS.</span>
<span id="cb194-469"><a href="#cb194-469" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Lookup rural-urban clssification: For this step we can use the FIPS code to lookup the CDC's <span class="co">[</span><span class="ot">2013 Urban-Rural Classification Scheme for Counties</span><span class="co">](https://www.cdc.gov/nchs/data_access/urban_rural.htm)</span>; specifically using the <span class="co">[</span><span class="ot">NCHSurbruralcodes Spreadsheet</span><span class="co">](https://www.cdc.gov/nchs/data/data_acces_files/NCHSURCodes2013.xlsx)</span> which contains the FIPS codes and rural-urban classifications for each county in the US.</span>
<span id="cb194-470"><a href="#cb194-470" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb194-471"><a href="#cb194-471" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Prepping the USGS Dataset</span></span>
<span id="cb194-472"><a href="#cb194-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-475"><a href="#cb194-475" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-476"><a href="#cb194-476" aria-hidden="true" tabindex="-1"></a><span class="co"># load the USGS Populated Places dataset:</span></span>
<span id="cb194-477"><a href="#cb194-477" aria-hidden="true" tabindex="-1"></a>usgs <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(</span>
<span id="cb194-478"><a href="#cb194-478" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data/PopulatedPlaces_National.txt"</span>,</span>
<span id="cb194-479"><a href="#cb194-479" aria-hidden="true" tabindex="-1"></a>  <span class="at">delim =</span> <span class="st">"|"</span>, <span class="co"># the file is pipe-delimited</span></span>
<span id="cb194-480"><a href="#cb194-480" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_names =</span> <span class="cn">TRUE</span></span>
<span id="cb194-481"><a href="#cb194-481" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-482"><a href="#cb194-482" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-483"><a href="#cb194-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-484"><a href="#cb194-484" aria-hidden="true" tabindex="-1"></a>Creating a 'short' dataset to hopefully speed up the lookup process:</span>
<span id="cb194-485"><a href="#cb194-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-488"><a href="#cb194-488" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-489"><a href="#cb194-489" aria-hidden="true" tabindex="-1"></a>usgs_short <span class="ot">&lt;-</span> usgs <span class="sc">|&gt;</span></span>
<span id="cb194-490"><a href="#cb194-490" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state_numeric, map_name, county_numeric, feature_name) <span class="sc">|&gt;</span></span>
<span id="cb194-491"><a href="#cb194-491" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb194-492"><a href="#cb194-492" aria-hidden="true" tabindex="-1"></a><span class="co"># test</span></span>
<span id="cb194-493"><a href="#cb194-493" aria-hidden="true" tabindex="-1"></a><span class="fu">n_distinct</span>(usgs_short)</span>
<span id="cb194-494"><a href="#cb194-494" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-495"><a href="#cb194-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-496"><a href="#cb194-496" aria-hidden="true" tabindex="-1"></a>Creating a 'lower' dataset with capitalization may find some straggling entries:</span>
<span id="cb194-497"><a href="#cb194-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-500"><a href="#cb194-500" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-501"><a href="#cb194-501" aria-hidden="true" tabindex="-1"></a>usgs_lower <span class="ot">&lt;-</span> usgs <span class="sc">|&gt;</span> </span>
<span id="cb194-502"><a href="#cb194-502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state_numeric, map_name, county_numeric, feature_name) <span class="sc">|&gt;</span></span>
<span id="cb194-503"><a href="#cb194-503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span>                                     <span class="co"># remove duplicate rows</span></span>
<span id="cb194-504"><a href="#cb194-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb194-505"><a href="#cb194-505" aria-hidden="true" tabindex="-1"></a>    <span class="at">map_name =</span> <span class="fu">str_to_lower</span>(map_name),              <span class="co"># convert map_name to lower case</span></span>
<span id="cb194-506"><a href="#cb194-506" aria-hidden="true" tabindex="-1"></a>    <span class="at">feature_name =</span> <span class="fu">str_to_lower</span>(feature_name)       <span class="co"># convert feature_name to lower case</span></span>
<span id="cb194-507"><a href="#cb194-507" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb194-508"><a href="#cb194-508" aria-hidden="true" tabindex="-1"></a><span class="co"># test</span></span>
<span id="cb194-509"><a href="#cb194-509" aria-hidden="true" tabindex="-1"></a><span class="fu">n_distinct</span>(usgs_lower)</span>
<span id="cb194-510"><a href="#cb194-510" aria-hidden="true" tabindex="-1"></a><span class="co"># cleanup</span></span>
<span id="cb194-511"><a href="#cb194-511" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(usgs)</span>
<span id="cb194-512"><a href="#cb194-512" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-513"><a href="#cb194-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-514"><a href="#cb194-514" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Searching USGS dataset with left_join</span></span>
<span id="cb194-515"><a href="#cb194-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-516"><a href="#cb194-516" aria-hidden="true" tabindex="-1"></a>The following code will find the county FIPS code from the USGS dataset; NB entries from Puerto Rico, Virgin Islands, and Guam are filtered out in this step, as are any entries with a military mail code or a missing address:</span>
<span id="cb194-517"><a href="#cb194-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-520"><a href="#cb194-520" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-521"><a href="#cb194-521" aria-hidden="true" tabindex="-1"></a><span class="co"># `left_join` the USGS dataset into the `data_tx` to add `Prscrbr_County_FIPS`; matching on state and city:</span></span>
<span id="cb194-522"><a href="#cb194-522" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> data_tx <span class="sc">|&gt;</span></span>
<span id="cb194-523"><a href="#cb194-523" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter out Puerto Rico, Virgin Islands, and Guam; these are not in NCHSUR  (codes 66, 72, 78):</span></span>
<span id="cb194-524"><a href="#cb194-524" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Prscrbr_State_FIPS <span class="sc">!=</span> <span class="st">"66"</span> <span class="sc">&amp;</span> Prscrbr_State_FIPS <span class="sc">!=</span> <span class="st">"72"</span> <span class="sc">&amp;</span> Prscrbr_State_FIPS <span class="sc">!=</span> <span class="st">"78"</span>) <span class="sc">|&gt;</span></span>
<span id="cb194-525"><a href="#cb194-525" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter out military mail codes (codes AA, AE, AP); other codes (ZZ, XX):</span></span>
<span id="cb194-526"><a href="#cb194-526" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(Prscrbr_State_Abrvtn, <span class="st">"AA"</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_detect</span>(Prscrbr_State_Abrvtn, <span class="st">"AE"</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_detect</span>(Prscrbr_State_Abrvtn, <span class="st">"AP"</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_detect</span>(Prscrbr_State_Abrvtn, <span class="st">"ZZ"</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_detect</span>(Prscrbr_State_Abrvtn, <span class="st">"XX"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb194-527"><a href="#cb194-527" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter out missing state fips:</span></span>
<span id="cb194-528"><a href="#cb194-528" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Prscrbr_State_FIPS)) <span class="sc">|&gt;</span></span>
<span id="cb194-529"><a href="#cb194-529" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb194-530"><a href="#cb194-530" aria-hidden="true" tabindex="-1"></a>      usgs_short[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">4</span>)],                              <span class="co"># the 'right' dataset; [-c(4)] removes variable with index 4, feature_name</span></span>
<span id="cb194-531"><a href="#cb194-531" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb194-532"><a href="#cb194-532" aria-hidden="true" tabindex="-1"></a>        Prscrbr_State_FIPS <span class="sc">==</span> state_numeric,</span>
<span id="cb194-533"><a href="#cb194-533" aria-hidden="true" tabindex="-1"></a>        Prscrbr_City <span class="sc">==</span> map_name</span>
<span id="cb194-534"><a href="#cb194-534" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb194-535"><a href="#cb194-535" aria-hidden="true" tabindex="-1"></a>      <span class="at">relationship =</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span id="cb194-536"><a href="#cb194-536" aria-hidden="true" tabindex="-1"></a>      <span class="at">multiple =</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span id="cb194-537"><a href="#cb194-537" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb194-538"><a href="#cb194-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-539"><a href="#cb194-539" aria-hidden="true" tabindex="-1"></a><span class="co"># Verification:</span></span>
<span id="cb194-540"><a href="#cb194-540" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(data_fips)</span>
<span id="cb194-541"><a href="#cb194-541" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(data_tx)<span class="sc">-</span><span class="fu">nrow</span>(data_fips)</span>
<span id="cb194-542"><a href="#cb194-542" aria-hidden="true" tabindex="-1"></a><span class="co"># how many missing lines</span></span>
<span id="cb194-543"><a href="#cb194-543" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(county_numeric)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-544"><a href="#cb194-544" aria-hidden="true" tabindex="-1"></a><span class="co"># how many unique combinations of city/state are missing:</span></span>
<span id="cb194-545"><a href="#cb194-545" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(county_numeric)) <span class="sc">|&gt;</span> </span>
<span id="cb194-546"><a href="#cb194-546" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Prscrbr_City, Prscrbr_State_FIPS) <span class="sc">|&gt;</span> <span class="fu">n_distinct</span>()</span>
<span id="cb194-547"><a href="#cb194-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-548"><a href="#cb194-548" aria-hidden="true" tabindex="-1"></a><span class="co"># store county FIPS in new variable for next merge:</span></span>
<span id="cb194-549"><a href="#cb194-549" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>county_fips <span class="ot">&lt;-</span> data_fips<span class="sc">$</span>county_numeric</span>
<span id="cb194-550"><a href="#cb194-550" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-551"><a href="#cb194-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-552"><a href="#cb194-552" aria-hidden="true" tabindex="-1"></a>We can try matching the <span class="in">`Prscrbr_City`</span> to the <span class="in">`feature_name`</span> variable in the USGS dataset:</span>
<span id="cb194-553"><a href="#cb194-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-556"><a href="#cb194-556" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-557"><a href="#cb194-557" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> data_fips <span class="sc">|&gt;</span></span>
<span id="cb194-558"><a href="#cb194-558" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>county_numeric) <span class="sc">|&gt;</span>                        <span class="co"># remove county_numeric to prevent naming collision</span></span>
<span id="cb194-559"><a href="#cb194-559" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb194-560"><a href="#cb194-560" aria-hidden="true" tabindex="-1"></a>    usgs_short[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">2</span>)],                              <span class="co"># the 'right' dataset; [-c(2)] removes variable with index 2, map_name</span></span>
<span id="cb194-561"><a href="#cb194-561" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb194-562"><a href="#cb194-562" aria-hidden="true" tabindex="-1"></a>        Prscrbr_State_FIPS <span class="sc">==</span> state_numeric,</span>
<span id="cb194-563"><a href="#cb194-563" aria-hidden="true" tabindex="-1"></a>        Prscrbr_City <span class="sc">==</span> feature_name</span>
<span id="cb194-564"><a href="#cb194-564" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb194-565"><a href="#cb194-565" aria-hidden="true" tabindex="-1"></a>    <span class="at">relationship =</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span id="cb194-566"><a href="#cb194-566" aria-hidden="true" tabindex="-1"></a>    <span class="at">multiple =</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span id="cb194-567"><a href="#cb194-567" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb194-568"><a href="#cb194-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-569"><a href="#cb194-569" aria-hidden="true" tabindex="-1"></a><span class="co"># number of missing:</span></span>
<span id="cb194-570"><a href="#cb194-570" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span>  <span class="fu">filter</span>(<span class="fu">is.na</span>(county_numeric)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-571"><a href="#cb194-571" aria-hidden="true" tabindex="-1"></a><span class="co"># number missing for both:</span></span>
<span id="cb194-572"><a href="#cb194-572" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span></span>
<span id="cb194-573"><a href="#cb194-573" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(county_fips) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_numeric)) <span class="sc">|&gt;</span></span>
<span id="cb194-574"><a href="#cb194-574" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Prscrbr_City, Prscrbr_State_FIPS) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-575"><a href="#cb194-575" aria-hidden="true" tabindex="-1"></a><span class="co"># county number of distinct city/state pairs produce missing values</span></span>
<span id="cb194-576"><a href="#cb194-576" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span></span>
<span id="cb194-577"><a href="#cb194-577" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(county_fips) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_numeric)) <span class="sc">|&gt;</span></span>
<span id="cb194-578"><a href="#cb194-578" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Prscrbr_City, Prscrbr_State_FIPS) <span class="sc">|&gt;</span> <span class="fu">n_distinct</span>()</span>
<span id="cb194-579"><a href="#cb194-579" aria-hidden="true" tabindex="-1"></a><span class="co"># view some missing entries to get some idea of what's going on:</span></span>
<span id="cb194-580"><a href="#cb194-580" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span></span>
<span id="cb194-581"><a href="#cb194-581" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(county_numeric)) <span class="sc">|&gt;</span>  </span>
<span id="cb194-582"><a href="#cb194-582" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Prscrbr_NPI, Prscrbr_City, Prscrbr_State_Abrvtn) <span class="sc">|&gt;</span></span>
<span id="cb194-583"><a href="#cb194-583" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="at">n =</span> <span class="dv">100</span>)</span>
<span id="cb194-584"><a href="#cb194-584" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-585"><a href="#cb194-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-586"><a href="#cb194-586" aria-hidden="true" tabindex="-1"></a>The above output shows common issues with place names between the datasets:</span>
<span id="cb194-587"><a href="#cb194-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-588"><a href="#cb194-588" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>apostrophes are missing in the CDC dataset, but not USGS</span>
<span id="cb194-589"><a href="#cb194-589" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>'saint', 'Mt', 'N', 'Ft.' are all abbreviated in CDC, but not USGS; similarly 'Phila.' is 'Philadelphia' in USGS</span>
<span id="cb194-590"><a href="#cb194-590" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>'plains' PA corresponds to 'Plainsville' in USGS</span>
<span id="cb194-591"><a href="#cb194-591" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Berlin vt is in Washington County, FIPS 023, but this is <span class="in">`west Berlin`</span> in USGS; similarly 'Hardwick' is separated as ' Hardwick Center', etc</span>
<span id="cb194-592"><a href="#cb194-592" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>'Stansbury Park' is miscapitalized as 'Stansbury park' in the USGS dataset</span>
<span id="cb194-593"><a href="#cb194-593" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>'Saint Clair Shores' MI is in Macomb County, FIPS 099, but this is listed as ''Saint Clair Haven' in the USGS dataset</span>
<span id="cb194-594"><a href="#cb194-594" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>'DeFuniak Springs' FL is in Walton County, FIPS 131, but this is listed as 'De Funiak Springs' in the USGS dataset</span>
<span id="cb194-595"><a href="#cb194-595" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>'Desoto' TX is in Dallas County, FIPS 113, but this is listed as 'DeSoto' in the USGS dataset</span>
<span id="cb194-596"><a href="#cb194-596" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>'Allenstown' NH is in Merrimack County, FIPS 013, but this is listed as 'Allenstown Elementary School' in the USGS dataset</span>
<span id="cb194-597"><a href="#cb194-597" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Cortlandt Manor NY is in Westchester County, FIPS 119, but this is listed as 'Van Cortlandtville' in the USGS dataset</span>
<span id="cb194-598"><a href="#cb194-598" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>'Village Of Golf' FL is in Palm Beach County, FIPS 099, but this is listed as 'Golf' in the USGS dataset</span>
<span id="cb194-599"><a href="#cb194-599" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>entries which may need to be hardcoded (e.g. USGS unlisted entries):</span>
<span id="cb194-600"><a href="#cb194-600" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Shelby Township is in Oceana County, FIPS 127</span>
<span id="cb194-601"><a href="#cb194-601" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Johnston RI is in Providence County, FIPS 007, but this is unlisted in the USGS dataset</span>
<span id="cb194-602"><a href="#cb194-602" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Mercerville nj is in Mercer County, FIPS 021, but this is unlisted in the USGS dataset</span>
<span id="cb194-603"><a href="#cb194-603" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>'Brownstown Twp' MI is in Wayne County, FIPS 163, but this is unlisted in the USGS dataset</span>
<span id="cb194-604"><a href="#cb194-604" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>'Clinton Twp' MI is in Macomb County, FIPS 099, but this is unlisted in the USGS dataset</span>
<span id="cb194-605"><a href="#cb194-605" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb194-606"><a href="#cb194-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-607"><a href="#cb194-607" aria-hidden="true" tabindex="-1"></a>We can write a recode of the <span class="in">`Prscrbr_City`</span> variable from the CDC dataset using <span class="in">`campfin`</span> package and the <span class="in">`expand_abbrev`</span> function to fix these issues:</span>
<span id="cb194-608"><a href="#cb194-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-611"><a href="#cb194-611" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-612"><a href="#cb194-612" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed <span class="ot">&lt;-</span> <span class="fu">expand_abbrev</span>(</span>
<span id="cb194-613"><a href="#cb194-613" aria-hidden="true" tabindex="-1"></a>  data_fips<span class="sc">$</span>Prscrbr_City,</span>
<span id="cb194-614"><a href="#cb194-614" aria-hidden="true" tabindex="-1"></a>  <span class="co"># vector of regexes of abbreviations to expand:</span></span>
<span id="cb194-615"><a href="#cb194-615" aria-hidden="true" tabindex="-1"></a>  <span class="at">abb =</span> <span class="fu">c</span>(</span>
<span id="cb194-616"><a href="#cb194-616" aria-hidden="true" tabindex="-1"></a>    <span class="st">"St</span><span class="sc">\\</span><span class="st">."</span>, <span class="st">"St</span><span class="sc">\\</span><span class="st">s"</span>, <span class="st">"Mt</span><span class="sc">\\</span><span class="st">."</span>, <span class="st">"Mt</span><span class="sc">\\</span><span class="st">s"</span>, <span class="st">"N</span><span class="sc">\\</span><span class="st">."</span>, <span class="st">"N</span><span class="sc">\\</span><span class="st">s"</span>, </span>
<span id="cb194-617"><a href="#cb194-617" aria-hidden="true" tabindex="-1"></a>    <span class="st">"S</span><span class="sc">\\</span><span class="st">."</span>, <span class="st">"S</span><span class="sc">\\</span><span class="st">s"</span>, <span class="st">"E</span><span class="sc">\\</span><span class="st">."</span>, <span class="st">"E</span><span class="sc">\\</span><span class="st">s"</span>, <span class="st">"W</span><span class="sc">\\</span><span class="st">."</span>, <span class="st">"W</span><span class="sc">\\</span><span class="st">s"</span>, </span>
<span id="cb194-618"><a href="#cb194-618" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Phila</span><span class="sc">\\</span><span class="st">."</span>, <span class="st">"Phila</span><span class="sc">\\</span><span class="st">s"</span>, <span class="st">"Phila$"</span>, <span class="st">"Twp</span><span class="sc">\\</span><span class="st">."</span>, <span class="st">"Twp</span><span class="sc">\\</span><span class="st">s"</span>, </span>
<span id="cb194-619"><a href="#cb194-619" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Coeur D Alene"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">sD</span><span class="sc">\\</span><span class="st">s"</span>, <span class="st">"Stansbury Park"</span>, <span class="st">"^Plains$"</span>,</span>
<span id="cb194-620"><a href="#cb194-620" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DeFuniak Springs"</span>, <span class="st">"Defuniak Springs"</span>, <span class="st">"Desoto"</span>, <span class="st">"Cortlandt Manor"</span>, <span class="st">"Village Of Golf"</span>,</span>
<span id="cb194-621"><a href="#cb194-621" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mcmurray"</span></span>
<span id="cb194-622"><a href="#cb194-622" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb194-623"><a href="#cb194-623" aria-hidden="true" tabindex="-1"></a>  <span class="co"># vector of expansions for corresponding regex:</span></span>
<span id="cb194-624"><a href="#cb194-624" aria-hidden="true" tabindex="-1"></a>  <span class="at">rep =</span> <span class="fu">c</span>(</span>
<span id="cb194-625"><a href="#cb194-625" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Saint"</span>, <span class="st">"Saint "</span>, <span class="st">"Mount"</span>, <span class="st">"Mount "</span>, <span class="st">"North"</span>, <span class="st">"North "</span>, </span>
<span id="cb194-626"><a href="#cb194-626" aria-hidden="true" tabindex="-1"></a>    <span class="st">"South"</span>, <span class="st">"South "</span>, <span class="st">"East"</span>, <span class="st">"East "</span>, <span class="st">"West"</span>, <span class="st">"West "</span>, </span>
<span id="cb194-627"><a href="#cb194-627" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Philadelphia"</span>, <span class="st">"Philadelphia "</span>, <span class="st">"Philadelphia"</span>, <span class="st">"Township"</span>, <span class="st">"Township "</span>, </span>
<span id="cb194-628"><a href="#cb194-628" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Coeur D'Alene"</span>, <span class="st">" D'"</span>, <span class="st">"Stansbury park"</span>, <span class="st">"Plainsville"</span>, </span>
<span id="cb194-629"><a href="#cb194-629" aria-hidden="true" tabindex="-1"></a>    <span class="st">"De Funiak Springs"</span>, <span class="st">"De Funiak Springs"</span>, <span class="st">"DeSoto"</span>, <span class="st">"Van Cortlandtville"</span>, <span class="st">"Golf"</span>,</span>
<span id="cb194-630"><a href="#cb194-630" aria-hidden="true" tabindex="-1"></a>    <span class="st">"McMurray"</span></span>
<span id="cb194-631"><a href="#cb194-631" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb194-632"><a href="#cb194-632" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb194-633"><a href="#cb194-633" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-634"><a href="#cb194-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-635"><a href="#cb194-635" aria-hidden="true" tabindex="-1"></a>Repeating the above process to match on the new <span class="in">`city_fixed`</span> variable:</span>
<span id="cb194-636"><a href="#cb194-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-637"><a href="#cb194-637" aria-hidden="true" tabindex="-1"></a>first we will collect our previously found county FIPS variables into a single entry:</span>
<span id="cb194-638"><a href="#cb194-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-641"><a href="#cb194-641" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-642"><a href="#cb194-642" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>county_fips <span class="ot">&lt;-</span> <span class="fu">fifelse</span>(</span>
<span id="cb194-643"><a href="#cb194-643" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">is.na</span>(data_fips<span class="sc">$</span>county_fips),       <span class="co"># test if Prscrbr_County_FIPS is not missint</span></span>
<span id="cb194-644"><a href="#cb194-644" aria-hidden="true" tabindex="-1"></a>  data_fips<span class="sc">$</span>county_fips,               <span class="co"># if not missing, value is Prscrbr_County_FIPS</span></span>
<span id="cb194-645"><a href="#cb194-645" aria-hidden="true" tabindex="-1"></a>  data_fips<span class="sc">$</span>county_numeric,                    <span class="co"># if Prscrbr_County_FIPS is NA, fills in with county_numeric</span></span>
<span id="cb194-646"><a href="#cb194-646" aria-hidden="true" tabindex="-1"></a>  <span class="at">na =</span> <span class="cn">NA</span></span>
<span id="cb194-647"><a href="#cb194-647" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-648"><a href="#cb194-648" aria-hidden="true" tabindex="-1"></a><span class="co"># test</span></span>
<span id="cb194-649"><a href="#cb194-649" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(</span>
<span id="cb194-650"><a href="#cb194-650" aria-hidden="true" tabindex="-1"></a>  data_fips<span class="sc">$</span>county_fips <span class="sc">==</span> data_fips<span class="sc">$</span>county_numeric,</span>
<span id="cb194-651"><a href="#cb194-651" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.na</span>(data_fips<span class="sc">$</span>county_fips)</span>
<span id="cb194-652"><a href="#cb194-652" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> <span class="fu">addmargins</span>()</span>
<span id="cb194-653"><a href="#cb194-653" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(</span>
<span id="cb194-654"><a href="#cb194-654" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.na</span>(data_fips<span class="sc">$</span>county_numeric),</span>
<span id="cb194-655"><a href="#cb194-655" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.na</span>(data_fips<span class="sc">$</span>county_fips)</span>
<span id="cb194-656"><a href="#cb194-656" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> <span class="fu">addmargins</span>()</span>
<span id="cb194-657"><a href="#cb194-657" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span></span>
<span id="cb194-658"><a href="#cb194-658" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span></span>
<span id="cb194-659"><a href="#cb194-659" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span>
<span id="cb194-660"><a href="#cb194-660" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span></span>
<span id="cb194-661"><a href="#cb194-661" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span></span>
<span id="cb194-662"><a href="#cb194-662" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span>
<span id="cb194-663"><a href="#cb194-663" aria-hidden="true" tabindex="-1"></a><span class="co"># this shows us that we can safely remove county_numeric:</span></span>
<span id="cb194-664"><a href="#cb194-664" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> data_fips <span class="sc">|&gt;</span></span>
<span id="cb194-665"><a href="#cb194-665" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove feature_name, USGS_city_name, Prscrbr_County_FIPS:</span></span>
<span id="cb194-666"><a href="#cb194-666" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>county_numeric)</span>
<span id="cb194-667"><a href="#cb194-667" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-668"><a href="#cb194-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-669"><a href="#cb194-669" aria-hidden="true" tabindex="-1"></a>Matching city_fixed on map_name:</span>
<span id="cb194-670"><a href="#cb194-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-673"><a href="#cb194-673" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-674"><a href="#cb194-674" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> data_fips <span class="sc">|&gt;</span></span>
<span id="cb194-675"><a href="#cb194-675" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb194-676"><a href="#cb194-676" aria-hidden="true" tabindex="-1"></a>    usgs_short,                                     <span class="co"># the 'right' dataset</span></span>
<span id="cb194-677"><a href="#cb194-677" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb194-678"><a href="#cb194-678" aria-hidden="true" tabindex="-1"></a>        city_fixed <span class="sc">==</span> map_name,                     <span class="co"># these variables must exactly match in both datasets</span></span>
<span id="cb194-679"><a href="#cb194-679" aria-hidden="true" tabindex="-1"></a>        Prscrbr_State_FIPS <span class="sc">==</span> state_numeric</span>
<span id="cb194-680"><a href="#cb194-680" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb194-681"><a href="#cb194-681" aria-hidden="true" tabindex="-1"></a>    <span class="at">relationship =</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span id="cb194-682"><a href="#cb194-682" aria-hidden="true" tabindex="-1"></a>    <span class="at">multiple =</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span id="cb194-683"><a href="#cb194-683" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb194-684"><a href="#cb194-684" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>feature_name)                             <span class="co"># remove feature_name</span></span>
<span id="cb194-685"><a href="#cb194-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-686"><a href="#cb194-686" aria-hidden="true" tabindex="-1"></a><span class="co"># check</span></span>
<span id="cb194-687"><a href="#cb194-687" aria-hidden="true" tabindex="-1"></a><span class="co"># how many new finds</span></span>
<span id="cb194-688"><a href="#cb194-688" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span></span>
<span id="cb194-689"><a href="#cb194-689" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span></span>
<span id="cb194-690"><a href="#cb194-690" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span>
<span id="cb194-691"><a href="#cb194-691" aria-hidden="true" tabindex="-1"></a><span class="co"># merge new values into county_fips</span></span>
<span id="cb194-692"><a href="#cb194-692" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>county_fips <span class="ot">&lt;-</span> <span class="fu">fifelse</span>(</span>
<span id="cb194-693"><a href="#cb194-693" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">is.na</span>(data_fips<span class="sc">$</span>county_fips),</span>
<span id="cb194-694"><a href="#cb194-694" aria-hidden="true" tabindex="-1"></a>  data_fips<span class="sc">$</span>county_fips,</span>
<span id="cb194-695"><a href="#cb194-695" aria-hidden="true" tabindex="-1"></a>  data_fips<span class="sc">$</span>county_numeric,</span>
<span id="cb194-696"><a href="#cb194-696" aria-hidden="true" tabindex="-1"></a>  <span class="at">na =</span> <span class="cn">NA</span></span>
<span id="cb194-697"><a href="#cb194-697" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-698"><a href="#cb194-698" aria-hidden="true" tabindex="-1"></a><span class="co"># how many remain missing</span></span>
<span id="cb194-699"><a href="#cb194-699" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-700"><a href="#cb194-700" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-701"><a href="#cb194-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-702"><a href="#cb194-702" aria-hidden="true" tabindex="-1"></a><span class="co"># get rid of county_numeric now:</span></span>
<span id="cb194-703"><a href="#cb194-703" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> data_fips <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>county_numeric)                        <span class="co"># remove county_numeric</span></span>
<span id="cb194-704"><a href="#cb194-704" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-705"><a href="#cb194-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-706"><a href="#cb194-706" aria-hidden="true" tabindex="-1"></a>matching city_fixed on feature_name:</span>
<span id="cb194-707"><a href="#cb194-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-710"><a href="#cb194-710" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-711"><a href="#cb194-711" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> data_fips <span class="sc">|&gt;</span></span>
<span id="cb194-712"><a href="#cb194-712" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb194-713"><a href="#cb194-713" aria-hidden="true" tabindex="-1"></a>    usgs_short[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">2</span>)],                              <span class="co"># the 'right' dataset; [-c(2)] removes variable with index 2, map_name</span></span>
<span id="cb194-714"><a href="#cb194-714" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb194-715"><a href="#cb194-715" aria-hidden="true" tabindex="-1"></a>        city_fixed <span class="sc">==</span> feature_name,                 <span class="co"># these variables must exactly match in both datasets</span></span>
<span id="cb194-716"><a href="#cb194-716" aria-hidden="true" tabindex="-1"></a>        Prscrbr_State_FIPS <span class="sc">==</span> state_numeric</span>
<span id="cb194-717"><a href="#cb194-717" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb194-718"><a href="#cb194-718" aria-hidden="true" tabindex="-1"></a>    <span class="at">relationship =</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span id="cb194-719"><a href="#cb194-719" aria-hidden="true" tabindex="-1"></a>    <span class="at">multiple =</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span id="cb194-720"><a href="#cb194-720" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb194-721"><a href="#cb194-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-722"><a href="#cb194-722" aria-hidden="true" tabindex="-1"></a><span class="co"># how many new finds</span></span>
<span id="cb194-723"><a href="#cb194-723" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-724"><a href="#cb194-724" aria-hidden="true" tabindex="-1"></a><span class="co"># how many remain NA</span></span>
<span id="cb194-725"><a href="#cb194-725" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-726"><a href="#cb194-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-727"><a href="#cb194-727" aria-hidden="true" tabindex="-1"></a><span class="co"># merge new values into county_fips</span></span>
<span id="cb194-728"><a href="#cb194-728" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>county_fips <span class="ot">&lt;-</span> <span class="fu">fifelse</span>(</span>
<span id="cb194-729"><a href="#cb194-729" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">is.na</span>(data_fips<span class="sc">$</span>county_fips),</span>
<span id="cb194-730"><a href="#cb194-730" aria-hidden="true" tabindex="-1"></a>  data_fips<span class="sc">$</span>county_fips,</span>
<span id="cb194-731"><a href="#cb194-731" aria-hidden="true" tabindex="-1"></a>  data_fips<span class="sc">$</span>county_numeric,</span>
<span id="cb194-732"><a href="#cb194-732" aria-hidden="true" tabindex="-1"></a>  <span class="at">na =</span> <span class="cn">NA</span></span>
<span id="cb194-733"><a href="#cb194-733" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-734"><a href="#cb194-734" aria-hidden="true" tabindex="-1"></a><span class="co"># verify the merge by checking NA values</span></span>
<span id="cb194-735"><a href="#cb194-735" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-736"><a href="#cb194-736" aria-hidden="true" tabindex="-1"></a><span class="co"># remove county_numeric</span></span>
<span id="cb194-737"><a href="#cb194-737" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> data_fips <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>county_numeric)</span>
<span id="cb194-738"><a href="#cb194-738" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-739"><a href="#cb194-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-740"><a href="#cb194-740" aria-hidden="true" tabindex="-1"></a>Examine the remaining missing county_fips:</span>
<span id="cb194-741"><a href="#cb194-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-744"><a href="#cb194-744" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-745"><a href="#cb194-745" aria-hidden="true" tabindex="-1"></a><span class="co"># number of missing :</span></span>
<span id="cb194-746"><a href="#cb194-746" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-747"><a href="#cb194-747" aria-hidden="true" tabindex="-1"></a><span class="co"># county number of distinct city/state pairs produce missing values</span></span>
<span id="cb194-748"><a href="#cb194-748" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span></span>
<span id="cb194-749"><a href="#cb194-749" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span></span>
<span id="cb194-750"><a href="#cb194-750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Prscrbr_City, Prscrbr_State_FIPS) <span class="sc">|&gt;</span></span>
<span id="cb194-751"><a href="#cb194-751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">n_distinct</span>()</span>
<span id="cb194-752"><a href="#cb194-752" aria-hidden="true" tabindex="-1"></a><span class="co"># view some missing entries to get some idea of what's going on:</span></span>
<span id="cb194-753"><a href="#cb194-753" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> </span>
<span id="cb194-754"><a href="#cb194-754" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span></span>
<span id="cb194-755"><a href="#cb194-755" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select(Prscrbr_City, Prscrbr_State_Abrvtn, city_fixed) |&gt;</span></span>
<span id="cb194-756"><a href="#cb194-756" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="at">n =</span> <span class="dv">100</span>)</span>
<span id="cb194-757"><a href="#cb194-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-758"><a href="#cb194-758" aria-hidden="true" tabindex="-1"></a>places <span class="ot">&lt;-</span> data_fips <span class="sc">|&gt;</span> </span>
<span id="cb194-759"><a href="#cb194-759" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span></span>
<span id="cb194-760"><a href="#cb194-760" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Prscrbr_City, Prscrbr_State_Abrvtn, city_fixed) <span class="sc">|&gt;</span></span>
<span id="cb194-761"><a href="#cb194-761" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Prscrbr_City, Prscrbr_State_Abrvtn, city_fixed) <span class="sc">|&gt;</span></span>
<span id="cb194-762"><a href="#cb194-762" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>())</span>
<span id="cb194-763"><a href="#cb194-763" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-764"><a href="#cb194-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-765"><a href="#cb194-765" aria-hidden="true" tabindex="-1"></a>The above output shows common issues with place names between the datasets remain.  We can write another recode of the <span class="in">`Prscrbr_City`</span> variable from the CDC dataset using <span class="in">`campfin`</span> package and the <span class="in">`expand_abbrev`</span> function to fix these issues:</span>
<span id="cb194-766"><a href="#cb194-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-769"><a href="#cb194-769" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-770"><a href="#cb194-770" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed <span class="ot">&lt;-</span> <span class="fu">expand_abbrev</span>(</span>
<span id="cb194-771"><a href="#cb194-771" aria-hidden="true" tabindex="-1"></a>  data_fips<span class="sc">$</span>Prscrbr_City,</span>
<span id="cb194-772"><a href="#cb194-772" aria-hidden="true" tabindex="-1"></a>  <span class="at">abb =</span> <span class="fu">c</span>(</span>
<span id="cb194-773"><a href="#cb194-773" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Winston Salem"</span> <span class="ot">=</span> <span class="st">"Winston-Salem"</span>,</span>
<span id="cb194-774"><a href="#cb194-774" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Coeur D Alene"</span> <span class="ot">=</span> <span class="st">"Coeur D'Alene"</span>,</span>
<span id="cb194-775"><a href="#cb194-775" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Wilkes Barre"</span> <span class="ot">=</span> <span class="st">"Wilkes-Barre"</span>,</span>
<span id="cb194-776"><a href="#cb194-776" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fond Du Lac"</span> <span class="ot">=</span> <span class="st">"Fond du Lac"</span>,</span>
<span id="cb194-777"><a href="#cb194-777" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Southold New York"</span> <span class="ot">=</span> <span class="st">"Southold"</span>,</span>
<span id="cb194-778"><a href="#cb194-778" aria-hidden="true" tabindex="-1"></a>    <span class="co"># it will be quicker to manually find each instance where 'Mc' is followed by a lower case letter and add a line to capitalize each letter here:  # NB I'm going in alphabetical order here</span></span>
<span id="cb194-779"><a href="#cb194-779" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mcadenville"</span> <span class="ot">=</span> <span class="st">"McAdenville"</span>,</span>
<span id="cb194-780"><a href="#cb194-780" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mcalester"</span> <span class="ot">=</span> <span class="st">"McAlester"</span>,</span>
<span id="cb194-781"><a href="#cb194-781" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mcallen"</span> <span class="ot">=</span> <span class="st">"McAllen"</span>,</span>
<span id="cb194-782"><a href="#cb194-782" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mccall"</span> <span class="ot">=</span> <span class="st">"McCall"</span>,</span>
<span id="cb194-783"><a href="#cb194-783" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mccaysville"</span> <span class="ot">=</span> <span class="st">"McCaysville"</span>,</span>
<span id="cb194-784"><a href="#cb194-784" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mcclearly"</span> <span class="ot">=</span> <span class="st">"McClearly"</span>,</span>
<span id="cb194-785"><a href="#cb194-785" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mccleary"</span> <span class="ot">=</span> <span class="st">"McCleary"</span>,</span>
<span id="cb194-786"><a href="#cb194-786" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mcclellan"</span> <span class="ot">=</span> <span class="st">"McClellan"</span>,</span>
<span id="cb194-787"><a href="#cb194-787" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mcclellanville"</span> <span class="ot">=</span> <span class="st">"McClellanville"</span>,</span>
<span id="cb194-788"><a href="#cb194-788" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mccloud"</span> <span class="ot">=</span> <span class="st">"McCloud"</span>,</span>
<span id="cb194-789"><a href="#cb194-789" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mccomb"</span> <span class="ot">=</span> <span class="st">"McComb"</span>,</span>
<span id="cb194-790"><a href="#cb194-790" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mcconnelsville"</span> <span class="ot">=</span> <span class="st">"McConnelsville"</span>,</span>
<span id="cb194-791"><a href="#cb194-791" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mcconnelsville"</span> <span class="ot">=</span> <span class="st">"McConnelsville"</span>,</span>
<span id="cb194-792"><a href="#cb194-792" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mccormick"</span> <span class="ot">=</span> <span class="st">"McCormick"</span>,</span>
<span id="cb194-793"><a href="#cb194-793" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mccrory"</span> <span class="ot">=</span> <span class="st">"McCrory"</span>,</span>
<span id="cb194-794"><a href="#cb194-794" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mcdonough"</span> <span class="ot">=</span> <span class="st">"McDonough"</span>,</span>
<span id="cb194-795"><a href="#cb194-795" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mcgrath"</span> <span class="ot">=</span> <span class="st">"McGrath"</span>,</span>
<span id="cb194-796"><a href="#cb194-796" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mcgregor"</span> <span class="ot">=</span> <span class="st">"McGregor"</span>,</span>
<span id="cb194-797"><a href="#cb194-797" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mchenry"</span> <span class="ot">=</span> <span class="st">"McHenry"</span>,</span>
<span id="cb194-798"><a href="#cb194-798" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mckeesport"</span> <span class="ot">=</span> <span class="st">"McKeesport"</span>,</span>
<span id="cb194-799"><a href="#cb194-799" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mckinleyville"</span> <span class="ot">=</span> <span class="st">"McKinleyville"</span>,</span>
<span id="cb194-800"><a href="#cb194-800" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mckinney"</span> <span class="ot">=</span> <span class="st">"McKinney"</span>,</span>
<span id="cb194-801"><a href="#cb194-801" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mclean"</span> <span class="ot">=</span> <span class="st">"McLean"</span>,</span>
<span id="cb194-802"><a href="#cb194-802" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mcmechen"</span> <span class="ot">=</span> <span class="st">"McMechen"</span>,</span>
<span id="cb194-803"><a href="#cb194-803" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mcminnville"</span> <span class="ot">=</span> <span class="st">"McMinnville"</span>,</span>
<span id="cb194-804"><a href="#cb194-804" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mcpherson"</span> <span class="ot">=</span> <span class="st">"McPherson"</span>,</span>
<span id="cb194-805"><a href="#cb194-805" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mc "</span> <span class="ot">=</span> <span class="st">"Mc"</span>,</span>
<span id="cb194-806"><a href="#cb194-806" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Ft "</span> <span class="ot">=</span> <span class="st">"Fort "</span>,</span>
<span id="cb194-807"><a href="#cb194-807" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Ft. "</span> <span class="ot">=</span> <span class="st">"Fort "</span>,</span>
<span id="cb194-808"><a href="#cb194-808" aria-hidden="true" tabindex="-1"></a>    <span class="st">"O Fallon"</span> <span class="ot">=</span> <span class="st">"O'Fallon"</span>,</span>
<span id="cb194-809"><a href="#cb194-809" aria-hidden="true" tabindex="-1"></a>    <span class="st">"O'fallon"</span> <span class="ot">=</span> <span class="st">"O'Fallon"</span>,</span>
<span id="cb194-810"><a href="#cb194-810" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hts."</span> <span class="ot">=</span> <span class="st">"Heights"</span>,</span>
<span id="cb194-811"><a href="#cb194-811" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hts"</span> <span class="ot">=</span> <span class="st">"Heights"</span>,</span>
<span id="cb194-812"><a href="#cb194-812" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hgts."</span> <span class="ot">=</span> <span class="st">"Heights"</span>,</span>
<span id="cb194-813"><a href="#cb194-813" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hgts"</span> <span class="ot">=</span> <span class="st">"Heights"</span>,</span>
<span id="cb194-814"><a href="#cb194-814" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Spgs."</span> <span class="ot">=</span> <span class="st">"Springs"</span>,</span>
<span id="cb194-815"><a href="#cb194-815" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Spgs"</span> <span class="ot">=</span> <span class="st">"Springs"</span>,</span>
<span id="cb194-816"><a href="#cb194-816" aria-hidden="true" tabindex="-1"></a>    <span class="st">"St. "</span> <span class="ot">=</span> <span class="st">"Saint "</span>,</span>
<span id="cb194-817"><a href="#cb194-817" aria-hidden="true" tabindex="-1"></a>    <span class="st">"St "</span> <span class="ot">=</span> <span class="st">"Saint "</span>,</span>
<span id="cb194-818"><a href="#cb194-818" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Lavale"</span> <span class="ot">=</span> <span class="st">"La Vale"</span>,</span>
<span id="cb194-819"><a href="#cb194-819" aria-hidden="true" tabindex="-1"></a>    <span class="st">"La Place"</span> <span class="ot">=</span> <span class="st">"Laplace"</span>,</span>
<span id="cb194-820"><a href="#cb194-820" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hts"</span> <span class="ot">=</span> <span class="st">"Heights"</span>,</span>
<span id="cb194-821"><a href="#cb194-821" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hts."</span> <span class="ot">=</span> <span class="st">"Heights"</span>,</span>
<span id="cb194-822"><a href="#cb194-822" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pt "</span> <span class="ot">=</span> <span class="st">"Point "</span>,</span>
<span id="cb194-823"><a href="#cb194-823" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Gt "</span> <span class="ot">=</span> <span class="st">"Great "</span>,</span>
<span id="cb194-824"><a href="#cb194-824" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pittburgh"</span> <span class="ot">=</span> <span class="st">"Pittsburgh"</span>,</span>
<span id="cb194-825"><a href="#cb194-825" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Coeur D'alene"</span> <span class="ot">=</span> <span class="st">"Coeur D'Alene"</span>,</span>
<span id="cb194-826"><a href="#cb194-826" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Ste Genevieve"</span> <span class="ot">=</span> <span class="st">"Sainte Genevieve"</span>,</span>
<span id="cb194-827"><a href="#cb194-827" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Vero Bch"</span> <span class="ot">=</span> <span class="st">"Vero Beach"</span>,</span>
<span id="cb194-828"><a href="#cb194-828" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Schnectady"</span> <span class="ot">=</span> <span class="st">"Schenectady"</span>,</span>
<span id="cb194-829"><a href="#cb194-829" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Wright Patterson Afb"</span> <span class="ot">=</span> <span class="st">"Dayton"</span>,</span>
<span id="cb194-830"><a href="#cb194-830" aria-hidden="true" tabindex="-1"></a>    <span class="st">"No "</span> <span class="ot">=</span> <span class="st">"North "</span>,</span>
<span id="cb194-831"><a href="#cb194-831" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bala Cynwyd"</span> <span class="ot">=</span> <span class="st">"Bala-Cynwyd"</span>,</span>
<span id="cb194-832"><a href="#cb194-832" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Deland"</span> <span class="ot">=</span> <span class="st">"DeLand"</span>,</span>
<span id="cb194-833"><a href="#cb194-833" aria-hidden="true" tabindex="-1"></a>    <span class="st">"O "</span> <span class="ot">=</span> <span class="st">"O'"</span>,</span>
<span id="cb194-834"><a href="#cb194-834" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Keesler Afb"</span> <span class="ot">=</span> <span class="st">"Biloxi"</span>,</span>
<span id="cb194-835"><a href="#cb194-835" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mt. "</span> <span class="ot">=</span> <span class="st">"Mount "</span>,</span>
<span id="cb194-836"><a href="#cb194-836" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Phila."</span> <span class="ot">=</span> <span class="st">"Philadelphia"</span>,</span>
<span id="cb194-837"><a href="#cb194-837" aria-hidden="true" tabindex="-1"></a>    <span class="st">"N. "</span> <span class="ot">=</span> <span class="st">"North "</span>,</span>
<span id="cb194-838"><a href="#cb194-838" aria-hidden="true" tabindex="-1"></a>    <span class="st">"W. "</span> <span class="ot">=</span> <span class="st">"West "</span>,</span>
<span id="cb194-839"><a href="#cb194-839" aria-hidden="true" tabindex="-1"></a>    <span class="st">"La Porte"</span> <span class="ot">=</span> <span class="st">"LaPorte"</span>,</span>
<span id="cb194-840"><a href="#cb194-840" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Defuniak Springs"</span> <span class="ot">=</span> <span class="st">"De Funiak Springs"</span>,</span>
<span id="cb194-841"><a href="#cb194-841" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pgh"</span> <span class="ot">=</span> <span class="st">"Pittsburgh"</span>,</span>
<span id="cb194-842"><a href="#cb194-842" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sedro-Wooley"</span> <span class="ot">=</span> <span class="st">"Sedro-Woolley"</span>,</span>
<span id="cb194-843"><a href="#cb194-843" aria-hidden="true" tabindex="-1"></a>    <span class="st">"St.Paul"</span> <span class="ot">=</span> <span class="st">"Saint Paul"</span>,</span>
<span id="cb194-844"><a href="#cb194-844" aria-hidden="true" tabindex="-1"></a>    <span class="st">"St.Clairsville"</span> <span class="ot">=</span> <span class="st">"Saint Clairsville"</span>,</span>
<span id="cb194-845"><a href="#cb194-845" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Land O Lakes"</span> <span class="ot">=</span> <span class="st">"Land O' Lakes"</span>,</span>
<span id="cb194-846"><a href="#cb194-846" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Coeur D' Alene"</span> <span class="ot">=</span> <span class="st">"Coeur D'Alene"</span></span>
<span id="cb194-847"><a href="#cb194-847" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb194-848"><a href="#cb194-848" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb194-849"><a href="#cb194-849" aria-hidden="true" tabindex="-1"></a><span class="co"># manually set "West Bloomfield" MI `city_fixed` to 'Bloomfield:</span></span>
<span id="cb194-850"><a href="#cb194-850" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"West Bloomfield"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"MI"</span>] <span class="ot">&lt;-</span> <span class="st">"Bloomfield"</span></span>
<span id="cb194-851"><a href="#cb194-851" aria-hidden="true" tabindex="-1"></a><span class="co"># manually set "Clinton Township" MI, or 'Clinton Twp" MI 'city_fixed' value to 'Macomb': </span></span>
<span id="cb194-852"><a href="#cb194-852" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Clinton Township"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"MI"</span>] <span class="ot">&lt;-</span> <span class="st">"Macomb"</span></span>
<span id="cb194-853"><a href="#cb194-853" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Clinton Twp"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"MI"</span>] <span class="ot">&lt;-</span> <span class="st">"Macomb"</span></span>
<span id="cb194-854"><a href="#cb194-854" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Saint Clair Shores"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"MI"</span>] <span class="ot">&lt;-</span> <span class="st">"Macomb"</span></span>
<span id="cb194-855"><a href="#cb194-855" aria-hidden="true" tabindex="-1"></a><span class="co"># manually set Brick NJ `city_fixed` to 'Bricktown':</span></span>
<span id="cb194-856"><a href="#cb194-856" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Brick"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"NJ"</span>] <span class="ot">&lt;-</span> <span class="st">"Bricktown"</span></span>
<span id="cb194-857"><a href="#cb194-857" aria-hidden="true" tabindex="-1"></a><span class="co"># manually set Lutherville MD `city_fixed` to 'Timonium Heights':</span></span>
<span id="cb194-858"><a href="#cb194-858" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Lutherville"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"MD"</span>] <span class="ot">&lt;-</span> <span class="st">"Timonium Heights"</span></span>
<span id="cb194-859"><a href="#cb194-859" aria-hidden="true" tabindex="-1"></a><span class="co"># Cranberry Twp PA manually set to 'Butler':</span></span>
<span id="cb194-860"><a href="#cb194-860" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Cranberry Twp"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"PA"</span>] <span class="ot">&lt;-</span> <span class="st">"Butler"</span></span>
<span id="cb194-861"><a href="#cb194-861" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Cranberry Township"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"PA"</span>] <span class="ot">&lt;-</span> <span class="st">"Butler"</span></span>
<span id="cb194-862"><a href="#cb194-862" aria-hidden="true" tabindex="-1"></a><span class="co"># Voorhees NJ manually set to 'Camden':</span></span>
<span id="cb194-863"><a href="#cb194-863" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Voorhees"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"NJ"</span>] <span class="ot">&lt;-</span> <span class="st">"Camden"</span></span>
<span id="cb194-864"><a href="#cb194-864" aria-hidden="true" tabindex="-1"></a><span class="co"># Berlin VT manually set to 'Berlin Corners':</span></span>
<span id="cb194-865"><a href="#cb194-865" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Berlin"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"VT"</span>] <span class="ot">&lt;-</span> <span class="st">"Berlin Corners"</span></span>
<span id="cb194-866"><a href="#cb194-866" aria-hidden="true" tabindex="-1"></a><span class="co"># sandy UT manually set to 'Salt Lake City':</span></span>
<span id="cb194-867"><a href="#cb194-867" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Sandy"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"UT"</span>] <span class="ot">&lt;-</span> <span class="st">"Salt Lake City"</span></span>
<span id="cb194-868"><a href="#cb194-868" aria-hidden="true" tabindex="-1"></a><span class="co"># Johnston RI manually set to 'Providence':</span></span>
<span id="cb194-869"><a href="#cb194-869" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Johnston"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"RI"</span>] <span class="ot">&lt;-</span> <span class="st">"Providence"</span></span>
<span id="cb194-870"><a href="#cb194-870" aria-hidden="true" tabindex="-1"></a><span class="co"># Dartmouth MA manually set to 'New Bedford':</span></span>
<span id="cb194-871"><a href="#cb194-871" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Dartmouth"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"MA"</span>] <span class="ot">&lt;-</span> <span class="st">"New Bedford"</span></span>
<span id="cb194-872"><a href="#cb194-872" aria-hidden="true" tabindex="-1"></a><span class="co"># Fort Mohave AZ manually set to 'Mohave Valley':</span></span>
<span id="cb194-873"><a href="#cb194-873" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Fort Mohave"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"AZ"</span>] <span class="ot">&lt;-</span> <span class="st">"Mohave Valley"</span></span>
<span id="cb194-874"><a href="#cb194-874" aria-hidden="true" tabindex="-1"></a><span class="co"># Greenwich CT manually set to 'Stamford':</span></span>
<span id="cb194-875"><a href="#cb194-875" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Greenwich"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"CT"</span>] <span class="ot">&lt;-</span> <span class="st">"Stamford"</span></span>
<span id="cb194-876"><a href="#cb194-876" aria-hidden="true" tabindex="-1"></a><span class="co"># neptune NJ manually set to 'Asbury Park':</span></span>
<span id="cb194-877"><a href="#cb194-877" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Neptune"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"NJ"</span>] <span class="ot">&lt;-</span> <span class="st">"Asbury Park"</span></span>
<span id="cb194-878"><a href="#cb194-878" aria-hidden="true" tabindex="-1"></a><span class="co"># Vestavia Hills AL manually set to 'Birmingham':</span></span>
<span id="cb194-879"><a href="#cb194-879" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Vestavia"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"AL"</span>] <span class="ot">&lt;-</span> <span class="st">"Birmingham"</span></span>
<span id="cb194-880"><a href="#cb194-880" aria-hidden="true" tabindex="-1"></a><span class="co"># Westampton NJ manually set to 'Mount Holly':</span></span>
<span id="cb194-881"><a href="#cb194-881" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Westampton"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"NJ"</span>] <span class="ot">&lt;-</span> <span class="st">"Mount Holly"</span></span>
<span id="cb194-882"><a href="#cb194-882" aria-hidden="true" tabindex="-1"></a><span class="co"># Lagrange GA manually set to 'La Grange':</span></span>
<span id="cb194-883"><a href="#cb194-883" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Lagrange"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"GA"</span>] <span class="ot">&lt;-</span> <span class="st">"La Grange"</span></span>
<span id="cb194-884"><a href="#cb194-884" aria-hidden="true" tabindex="-1"></a><span class="co"># Carmel CA manually set to 'Monterey':</span></span>
<span id="cb194-885"><a href="#cb194-885" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Carmel"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"CA"</span>] <span class="ot">&lt;-</span> <span class="st">"Monterey"</span></span>
<span id="cb194-886"><a href="#cb194-886" aria-hidden="true" tabindex="-1"></a><span class="co"># West Hills CA manually set to 'Los Angeles':</span></span>
<span id="cb194-887"><a href="#cb194-887" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"West Hills"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"CA"</span>] <span class="ot">&lt;-</span> <span class="st">"Los Angeles"</span></span>
<span id="cb194-888"><a href="#cb194-888" aria-hidden="true" tabindex="-1"></a><span class="co"># Colebrook NH manually set to 'Coos Junction':</span></span>
<span id="cb194-889"><a href="#cb194-889" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Colebrook"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"NH"</span>] <span class="ot">&lt;-</span> <span class="st">"Coos Junction"</span></span>
<span id="cb194-890"><a href="#cb194-890" aria-hidden="true" tabindex="-1"></a><span class="co"># North Huntingdon PA manually set to 'Irwin':</span></span>
<span id="cb194-891"><a href="#cb194-891" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"North Huntingdon"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"PA"</span>] <span class="ot">&lt;-</span> <span class="st">"Irwin"</span></span>
<span id="cb194-892"><a href="#cb194-892" aria-hidden="true" tabindex="-1"></a><span class="co"># King of Prussia PA manually set to 'Montgomery':</span></span>
<span id="cb194-893"><a href="#cb194-893" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"King of Prussia"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"PA"</span>] <span class="ot">&lt;-</span> <span class="st">"Montgomery"</span></span>
<span id="cb194-894"><a href="#cb194-894" aria-hidden="true" tabindex="-1"></a><span class="co"># Kihei HI manually set to 'Maui Meadows':</span></span>
<span id="cb194-895"><a href="#cb194-895" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Kihei"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"HI"</span>] <span class="ot">&lt;-</span> <span class="st">"Maui Meadows"</span></span>
<span id="cb194-896"><a href="#cb194-896" aria-hidden="true" tabindex="-1"></a><span class="co"># Galloway NJ manually set to 'Atlantic City':</span></span>
<span id="cb194-897"><a href="#cb194-897" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Galloway"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"NJ"</span>] <span class="ot">&lt;-</span> <span class="st">"Atlantic City"</span></span>
<span id="cb194-898"><a href="#cb194-898" aria-hidden="true" tabindex="-1"></a><span class="co"># Greenacres FL manually set to 'West Palm Beach':</span></span>
<span id="cb194-899"><a href="#cb194-899" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Greenacres"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"FL"</span>] <span class="ot">&lt;-</span> <span class="st">"West Palm Beach"</span></span>
<span id="cb194-900"><a href="#cb194-900" aria-hidden="true" tabindex="-1"></a><span class="co"># Kailua Kona HI manually set to 'Kailua':</span></span>
<span id="cb194-901"><a href="#cb194-901" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Kailua Kona"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"HI"</span>] <span class="ot">&lt;-</span> <span class="st">"Kailua"</span></span>
<span id="cb194-902"><a href="#cb194-902" aria-hidden="true" tabindex="-1"></a><span class="co"># Brownstown Twp MI manually set to 'Detroit':</span></span>
<span id="cb194-903"><a href="#cb194-903" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Brownstown Twp"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"MI"</span>] <span class="ot">&lt;-</span> <span class="st">"Detroit"</span></span>
<span id="cb194-904"><a href="#cb194-904" aria-hidden="true" tabindex="-1"></a><span class="co"># Egg Harbor Township NJ manually set to 'Atlantic City':</span></span>
<span id="cb194-905"><a href="#cb194-905" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Egg Harbor Township"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"NJ"</span>] <span class="ot">&lt;-</span> <span class="st">"Atlantic City"</span></span>
<span id="cb194-906"><a href="#cb194-906" aria-hidden="true" tabindex="-1"></a><span class="co"># Castleton NY manually set to 'Albany':</span></span>
<span id="cb194-907"><a href="#cb194-907" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Castleton"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"NY"</span>] <span class="ot">&lt;-</span> <span class="st">"Albany"</span></span>
<span id="cb194-908"><a href="#cb194-908" aria-hidden="true" tabindex="-1"></a><span class="co"># Allenstown NH manually set to 'Concord':</span></span>
<span id="cb194-909"><a href="#cb194-909" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Allenstown"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"NH"</span>] <span class="ot">&lt;-</span> <span class="st">"Concord"</span></span>
<span id="cb194-910"><a href="#cb194-910" aria-hidden="true" tabindex="-1"></a><span class="co"># Wilmington VT manually set to 'Brattleboro':</span></span>
<span id="cb194-911"><a href="#cb194-911" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Wilmington"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"VT"</span>] <span class="ot">&lt;-</span> <span class="st">"Brattleboro"</span></span>
<span id="cb194-912"><a href="#cb194-912" aria-hidden="true" tabindex="-1"></a><span class="co"># Slc UT manually set to 'Salt Lake City':</span></span>
<span id="cb194-913"><a href="#cb194-913" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Slc"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"UT"</span>] <span class="ot">&lt;-</span> <span class="st">"Salt Lake City"</span></span>
<span id="cb194-914"><a href="#cb194-914" aria-hidden="true" tabindex="-1"></a><span class="co"># Ocean NJ manually set to 'Asbury Park':</span></span>
<span id="cb194-915"><a href="#cb194-915" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Ocean"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"NJ"</span>] <span class="ot">&lt;-</span> <span class="st">"Asbury Park"</span></span>
<span id="cb194-916"><a href="#cb194-916" aria-hidden="true" tabindex="-1"></a><span class="co"># Timonium MD manually set to 'Baltimore':</span></span>
<span id="cb194-917"><a href="#cb194-917" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Timonium"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"MD"</span>] <span class="ot">&lt;-</span> <span class="st">"Baltimore"</span></span>
<span id="cb194-918"><a href="#cb194-918" aria-hidden="true" tabindex="-1"></a><span class="co"># Fort Bragg NC manually set to 'Fayetteville':</span></span>
<span id="cb194-919"><a href="#cb194-919" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Fort Bragg"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"NC"</span>] <span class="ot">&lt;-</span> <span class="st">"Fayetteville"</span></span>
<span id="cb194-920"><a href="#cb194-920" aria-hidden="true" tabindex="-1"></a><span class="co"># Rockingham VA manually set to 'Harrisonburg':</span></span>
<span id="cb194-921"><a href="#cb194-921" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Rockingham"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"VA"</span>] <span class="ot">&lt;-</span> <span class="st">"Harrisonburg"</span></span>
<span id="cb194-922"><a href="#cb194-922" aria-hidden="true" tabindex="-1"></a><span class="co"># Lansdowne VA manually set to 'Leesburg':</span></span>
<span id="cb194-923"><a href="#cb194-923" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Lansdowne"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"VA"</span>] <span class="ot">&lt;-</span> <span class="st">"Leesburg"</span></span>
<span id="cb194-924"><a href="#cb194-924" aria-hidden="true" tabindex="-1"></a><span class="co"># Aston PA manually set to 'Philadelphia':</span></span>
<span id="cb194-925"><a href="#cb194-925" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Aston"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"PA"</span>] <span class="ot">&lt;-</span> <span class="st">"Philadelphia"</span></span>
<span id="cb194-926"><a href="#cb194-926" aria-hidden="true" tabindex="-1"></a><span class="co"># Hardwick VT manually set to 'Montpelier':</span></span>
<span id="cb194-927"><a href="#cb194-927" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Hardwick"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"VT"</span>] <span class="ot">&lt;-</span> <span class="st">"Montpelier"</span></span>
<span id="cb194-928"><a href="#cb194-928" aria-hidden="true" tabindex="-1"></a><span class="co"># Sedro Woolley WA manually set to 'Mount Vernon':</span></span>
<span id="cb194-929"><a href="#cb194-929" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Sedro Woolley"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"WA"</span>] <span class="ot">&lt;-</span> <span class="st">"Mount Vernon"</span></span>
<span id="cb194-930"><a href="#cb194-930" aria-hidden="true" tabindex="-1"></a><span class="co"># Howell NJ manually set to 'Trenton':</span></span>
<span id="cb194-931"><a href="#cb194-931" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Howell"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"NJ"</span>] <span class="ot">&lt;-</span> <span class="st">"Trenton"</span></span>
<span id="cb194-932"><a href="#cb194-932" aria-hidden="true" tabindex="-1"></a><span class="co"># Sheffield Village OH manually set to 'Cleveland':</span></span>
<span id="cb194-933"><a href="#cb194-933" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Sheffield Village"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"OH"</span>] <span class="ot">&lt;-</span> <span class="st">"Cleveland"</span></span>
<span id="cb194-934"><a href="#cb194-934" aria-hidden="true" tabindex="-1"></a><span class="co"># Shelby Township MI manually set to 'Detroit':</span></span>
<span id="cb194-935"><a href="#cb194-935" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Shelby Township"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"MI"</span>] <span class="ot">&lt;-</span> <span class="st">"Detroit"</span></span>
<span id="cb194-936"><a href="#cb194-936" aria-hidden="true" tabindex="-1"></a><span class="co"># Brownstown MI manually set to 'Detroit':</span></span>
<span id="cb194-937"><a href="#cb194-937" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Brownstown"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"MI"</span>] <span class="ot">&lt;-</span> <span class="st">"Detroit"</span></span>
<span id="cb194-938"><a href="#cb194-938" aria-hidden="true" tabindex="-1"></a><span class="co"># York ME manually set to 'Portland':</span></span>
<span id="cb194-939"><a href="#cb194-939" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"York"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"ME"</span>] <span class="ot">&lt;-</span> <span class="st">"Portland"</span></span>
<span id="cb194-940"><a href="#cb194-940" aria-hidden="true" tabindex="-1"></a><span class="co"># Feasterville Trevose PA manually set to 'Philadelphia':</span></span>
<span id="cb194-941"><a href="#cb194-941" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Feasterville Trevose"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"PA"</span>] <span class="ot">&lt;-</span> <span class="st">"Philadelphia"</span></span>
<span id="cb194-942"><a href="#cb194-942" aria-hidden="true" tabindex="-1"></a><span class="co"># Sun City Center FL manually set to 'Tampa':</span></span>
<span id="cb194-943"><a href="#cb194-943" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed[data_fips<span class="sc">$</span>Prscrbr_City <span class="sc">==</span> <span class="st">"Sun City Center"</span> <span class="sc">&amp;</span> data_fips<span class="sc">$</span>Prscrbr_State_Abrvtn <span class="sc">==</span> <span class="st">"FL"</span>] <span class="ot">&lt;-</span> <span class="st">"Tampa"</span></span>
<span id="cb194-944"><a href="#cb194-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-945"><a href="#cb194-945" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to lower case:</span></span>
<span id="cb194-946"><a href="#cb194-946" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>city_fixed <span class="ot">&lt;-</span> <span class="fu">tolower</span>(data_fips<span class="sc">$</span>city_fixed)</span>
<span id="cb194-947"><a href="#cb194-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-948"><a href="#cb194-948" aria-hidden="true" tabindex="-1"></a><span class="co"># check city_fixed values for any remaining NA FIPS codes:</span></span>
<span id="cb194-949"><a href="#cb194-949" aria-hidden="true" tabindex="-1"></a>places <span class="ot">&lt;-</span> data_fips <span class="sc">|&gt;</span> </span>
<span id="cb194-950"><a href="#cb194-950" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span></span>
<span id="cb194-951"><a href="#cb194-951" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Prscrbr_City, Prscrbr_State_Abrvtn, city_fixed) <span class="sc">|&gt;</span></span>
<span id="cb194-952"><a href="#cb194-952" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Prscrbr_City, Prscrbr_State_Abrvtn, city_fixed) <span class="sc">|&gt;</span></span>
<span id="cb194-953"><a href="#cb194-953" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>())</span>
<span id="cb194-954"><a href="#cb194-954" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-955"><a href="#cb194-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-956"><a href="#cb194-956" aria-hidden="true" tabindex="-1"></a>Proceeding to match all lower case; first matching city_fixed on map_name:</span>
<span id="cb194-957"><a href="#cb194-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-960"><a href="#cb194-960" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-961"><a href="#cb194-961" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> data_fips <span class="sc">|&gt;</span></span>
<span id="cb194-962"><a href="#cb194-962" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb194-963"><a href="#cb194-963" aria-hidden="true" tabindex="-1"></a>    usgs_lower[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">4</span>)],                              <span class="co"># the 'right' dataset; [-c(4)] removes variable with index 4, feature_name</span></span>
<span id="cb194-964"><a href="#cb194-964" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb194-965"><a href="#cb194-965" aria-hidden="true" tabindex="-1"></a>        city_fixed <span class="sc">==</span> map_name,                     <span class="co"># these variables must exactly match in both datasets</span></span>
<span id="cb194-966"><a href="#cb194-966" aria-hidden="true" tabindex="-1"></a>        Prscrbr_State_FIPS <span class="sc">==</span> state_numeric</span>
<span id="cb194-967"><a href="#cb194-967" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb194-968"><a href="#cb194-968" aria-hidden="true" tabindex="-1"></a>    <span class="at">relationship =</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span id="cb194-969"><a href="#cb194-969" aria-hidden="true" tabindex="-1"></a>    <span class="at">multiple =</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span id="cb194-970"><a href="#cb194-970" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb194-971"><a href="#cb194-971" aria-hidden="true" tabindex="-1"></a><span class="co"># how many new finds</span></span>
<span id="cb194-972"><a href="#cb194-972" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-973"><a href="#cb194-973" aria-hidden="true" tabindex="-1"></a><span class="co"># merge new values into county_fips</span></span>
<span id="cb194-974"><a href="#cb194-974" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>county_fips <span class="ot">&lt;-</span> <span class="fu">fifelse</span>(</span>
<span id="cb194-975"><a href="#cb194-975" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">is.na</span>(data_fips<span class="sc">$</span>county_fips),</span>
<span id="cb194-976"><a href="#cb194-976" aria-hidden="true" tabindex="-1"></a>  data_fips<span class="sc">$</span>county_fips,</span>
<span id="cb194-977"><a href="#cb194-977" aria-hidden="true" tabindex="-1"></a>  data_fips<span class="sc">$</span>county_numeric,</span>
<span id="cb194-978"><a href="#cb194-978" aria-hidden="true" tabindex="-1"></a>  <span class="at">na =</span> <span class="cn">NA</span></span>
<span id="cb194-979"><a href="#cb194-979" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-980"><a href="#cb194-980" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-981"><a href="#cb194-981" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-982"><a href="#cb194-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-983"><a href="#cb194-983" aria-hidden="true" tabindex="-1"></a><span class="co"># get rid of county_numeric now:</span></span>
<span id="cb194-984"><a href="#cb194-984" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> data_fips <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>county_numeric)                        <span class="co"># remove county_numeric</span></span>
<span id="cb194-985"><a href="#cb194-985" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-986"><a href="#cb194-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-987"><a href="#cb194-987" aria-hidden="true" tabindex="-1"></a>Now matching city_fixed on feature_name:</span>
<span id="cb194-988"><a href="#cb194-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-991"><a href="#cb194-991" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-992"><a href="#cb194-992" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> data_fips <span class="sc">|&gt;</span></span>
<span id="cb194-993"><a href="#cb194-993" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb194-994"><a href="#cb194-994" aria-hidden="true" tabindex="-1"></a>    usgs_lower[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">2</span>)],                              <span class="co"># the 'right' dataset; [-c(2)] removes variable with index 2</span></span>
<span id="cb194-995"><a href="#cb194-995" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb194-996"><a href="#cb194-996" aria-hidden="true" tabindex="-1"></a>        city_fixed <span class="sc">==</span> feature_name,</span>
<span id="cb194-997"><a href="#cb194-997" aria-hidden="true" tabindex="-1"></a>        Prscrbr_State_FIPS <span class="sc">==</span> state_numeric         <span class="co"># these variables must exactly match in both datasets</span></span>
<span id="cb194-998"><a href="#cb194-998" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb194-999"><a href="#cb194-999" aria-hidden="true" tabindex="-1"></a>    <span class="at">relationship =</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span id="cb194-1000"><a href="#cb194-1000" aria-hidden="true" tabindex="-1"></a>    <span class="at">multiple =</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span id="cb194-1001"><a href="#cb194-1001" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb194-1002"><a href="#cb194-1002" aria-hidden="true" tabindex="-1"></a><span class="co"># how many new finds</span></span>
<span id="cb194-1003"><a href="#cb194-1003" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-1004"><a href="#cb194-1004" aria-hidden="true" tabindex="-1"></a><span class="co"># how many remain NA</span></span>
<span id="cb194-1005"><a href="#cb194-1005" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-1006"><a href="#cb194-1006" aria-hidden="true" tabindex="-1"></a><span class="co"># merge new values into county_fips</span></span>
<span id="cb194-1007"><a href="#cb194-1007" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>county_fips <span class="ot">&lt;-</span> <span class="fu">fifelse</span>(</span>
<span id="cb194-1008"><a href="#cb194-1008" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">is.na</span>(data_fips<span class="sc">$</span>county_fips),</span>
<span id="cb194-1009"><a href="#cb194-1009" aria-hidden="true" tabindex="-1"></a>  data_fips<span class="sc">$</span>county_fips,</span>
<span id="cb194-1010"><a href="#cb194-1010" aria-hidden="true" tabindex="-1"></a>  data_fips<span class="sc">$</span>county_numeric,</span>
<span id="cb194-1011"><a href="#cb194-1011" aria-hidden="true" tabindex="-1"></a>  <span class="at">na =</span> <span class="cn">NA</span></span>
<span id="cb194-1012"><a href="#cb194-1012" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-1013"><a href="#cb194-1013" aria-hidden="true" tabindex="-1"></a><span class="co"># verify the merge by checking NA values</span></span>
<span id="cb194-1014"><a href="#cb194-1014" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-1015"><a href="#cb194-1015" aria-hidden="true" tabindex="-1"></a><span class="co"># remove county_numeric</span></span>
<span id="cb194-1016"><a href="#cb194-1016" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> data_fips <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>county_numeric)</span>
<span id="cb194-1017"><a href="#cb194-1017" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1018"><a href="#cb194-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1019"><a href="#cb194-1019" aria-hidden="true" tabindex="-1"></a>With fewer than 1% of observations remaining unmatched, we can randomly assign the remaining NA values to one of the counties in <span class="in">`Prscrbr_State_FIPS`</span>:</span>
<span id="cb194-1020"><a href="#cb194-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1023"><a href="#cb194-1023" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1024"><a href="#cb194-1024" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> data_fips <span class="sc">|&gt;</span></span>
<span id="cb194-1025"><a href="#cb194-1025" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb194-1026"><a href="#cb194-1026" aria-hidden="true" tabindex="-1"></a>    usgs_lower[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>)],                            <span class="co"># the 'right' dataset; [-c(2,4)] removes variable with index 2 &amp; 4</span></span>
<span id="cb194-1027"><a href="#cb194-1027" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb194-1028"><a href="#cb194-1028" aria-hidden="true" tabindex="-1"></a>        Prscrbr_State_FIPS <span class="sc">==</span> state_numeric         <span class="co"># these variables must exactly match in both datasets</span></span>
<span id="cb194-1029"><a href="#cb194-1029" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb194-1030"><a href="#cb194-1030" aria-hidden="true" tabindex="-1"></a>    <span class="at">relationship =</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span id="cb194-1031"><a href="#cb194-1031" aria-hidden="true" tabindex="-1"></a>    <span class="at">multiple =</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span id="cb194-1032"><a href="#cb194-1032" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb194-1033"><a href="#cb194-1033" aria-hidden="true" tabindex="-1"></a><span class="co"># how many new finds</span></span>
<span id="cb194-1034"><a href="#cb194-1034" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-1035"><a href="#cb194-1035" aria-hidden="true" tabindex="-1"></a><span class="co"># mark new finds as randomly assigned</span></span>
<span id="cb194-1036"><a href="#cb194-1036" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>random_fips <span class="ot">&lt;-</span> <span class="fu">fifelse</span>(</span>
<span id="cb194-1037"><a href="#cb194-1037" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">is.na</span>(data_fips<span class="sc">$</span>county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(data_fips<span class="sc">$</span>county_fips), <span class="cn">TRUE</span>, <span class="cn">FALSE</span></span>
<span id="cb194-1038"><a href="#cb194-1038" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-1039"><a href="#cb194-1039" aria-hidden="true" tabindex="-1"></a><span class="co"># how many remain NA</span></span>
<span id="cb194-1040"><a href="#cb194-1040" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-1041"><a href="#cb194-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1042"><a href="#cb194-1042" aria-hidden="true" tabindex="-1"></a><span class="co"># merge new values into county_fips</span></span>
<span id="cb194-1043"><a href="#cb194-1043" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>county_fips <span class="ot">&lt;-</span> <span class="fu">fifelse</span>(</span>
<span id="cb194-1044"><a href="#cb194-1044" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">is.na</span>(data_fips<span class="sc">$</span>county_fips),</span>
<span id="cb194-1045"><a href="#cb194-1045" aria-hidden="true" tabindex="-1"></a>  data_fips<span class="sc">$</span>county_fips,</span>
<span id="cb194-1046"><a href="#cb194-1046" aria-hidden="true" tabindex="-1"></a>  data_fips<span class="sc">$</span>county_numeric,</span>
<span id="cb194-1047"><a href="#cb194-1047" aria-hidden="true" tabindex="-1"></a>  <span class="at">na =</span> <span class="cn">NA</span></span>
<span id="cb194-1048"><a href="#cb194-1048" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-1049"><a href="#cb194-1049" aria-hidden="true" tabindex="-1"></a><span class="co"># verify the merge by checking NA values</span></span>
<span id="cb194-1050"><a href="#cb194-1050" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(county_numeric) <span class="sc">&amp;</span> <span class="fu">is.na</span>(county_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-1051"><a href="#cb194-1051" aria-hidden="true" tabindex="-1"></a><span class="co"># remove county_numeric</span></span>
<span id="cb194-1052"><a href="#cb194-1052" aria-hidden="true" tabindex="-1"></a>data_fips <span class="ot">&lt;-</span> data_fips <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>county_numeric)</span>
<span id="cb194-1053"><a href="#cb194-1053" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1054"><a href="#cb194-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1055"><a href="#cb194-1055" aria-hidden="true" tabindex="-1"></a>Create full FIPS &amp; Cleanup:</span>
<span id="cb194-1056"><a href="#cb194-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1059"><a href="#cb194-1059" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1060"><a href="#cb194-1060" aria-hidden="true" tabindex="-1"></a><span class="co"># convert the state and county codes to the full FIPS code; this code yields`NA` if either of the codes are missing:</span></span>
<span id="cb194-1061"><a href="#cb194-1061" aria-hidden="true" tabindex="-1"></a>data_fips<span class="sc">$</span>fips <span class="ot">&lt;-</span> <span class="fu">paste0</span>(data_fips<span class="sc">$</span>Prscrbr_State_FIPS, data_fips<span class="sc">$</span>county_fips) <span class="sc">|&gt;</span></span>
<span id="cb194-1062"><a href="#cb194-1062" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.numeric</span>()  <span class="co"># Convert 5-digit FIPS characters to numeric to match the NCHSURC dataset</span></span>
<span id="cb194-1063"><a href="#cb194-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1064"><a href="#cb194-1064" aria-hidden="true" tabindex="-1"></a><span class="co"># check NA values in the new variable:</span></span>
<span id="cb194-1065"><a href="#cb194-1065" aria-hidden="true" tabindex="-1"></a>data_fips <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-1066"><a href="#cb194-1066" aria-hidden="true" tabindex="-1"></a><span class="co"># Cleanup</span></span>
<span id="cb194-1067"><a href="#cb194-1067" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(places, usgs_lower, usgs_short)</span>
<span id="cb194-1068"><a href="#cb194-1068" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1069"><a href="#cb194-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1070"><a href="#cb194-1070" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Matching to NCHSURC Dataset</span></span>
<span id="cb194-1071"><a href="#cb194-1071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1072"><a href="#cb194-1072" aria-hidden="true" tabindex="-1"></a>We will proceed to match the majority of FIPS codes in the dataset; starting by loading the NCHSURC dataset:</span>
<span id="cb194-1073"><a href="#cb194-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1076"><a href="#cb194-1076" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1077"><a href="#cb194-1077" aria-hidden="true" tabindex="-1"></a>nchsurc <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(</span>
<span id="cb194-1078"><a href="#cb194-1078" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data/NCHSURCodes2013.xlsx"</span>,</span>
<span id="cb194-1079"><a href="#cb194-1079" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_names =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb194-1080"><a href="#cb194-1080" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rename the FIPS code NCHSURC variables (to make the left_join simpler):</span></span>
<span id="cb194-1081"><a href="#cb194-1081" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">fips =</span> <span class="st">`</span><span class="at">FIPS code</span><span class="st">`</span>, <span class="at">nchsurc =</span> <span class="st">`</span><span class="at">2013 code</span><span class="st">`</span>)</span>
<span id="cb194-1082"><a href="#cb194-1082" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1083"><a href="#cb194-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1084"><a href="#cb194-1084" aria-hidden="true" tabindex="-1"></a>Lookup 2013 NCHSUR code:</span>
<span id="cb194-1085"><a href="#cb194-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1088"><a href="#cb194-1088" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1089"><a href="#cb194-1089" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb194-1090"><a href="#cb194-1090" aria-hidden="true" tabindex="-1"></a>  data_fips,                            <span class="co"># the 'left' dataset</span></span>
<span id="cb194-1091"><a href="#cb194-1091" aria-hidden="true" tabindex="-1"></a>  nchsurc[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">7</span>)],                      <span class="co"># the 'right' dataset; columns 1 &amp; 7 are FIPS &amp; NCHSURC</span></span>
<span id="cb194-1092"><a href="#cb194-1092" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"fips"</span>),                       <span class="co"># these variables must exactly match in both datasets</span></span>
<span id="cb194-1093"><a href="#cb194-1093" aria-hidden="true" tabindex="-1"></a>  <span class="at">relationship =</span> <span class="st">"many-to-one"</span>,         <span class="co"># left_join will not work without specifying this relation</span></span>
<span id="cb194-1094"><a href="#cb194-1094" aria-hidden="true" tabindex="-1"></a>  <span class="at">multiple =</span> <span class="st">"any"</span>,                     <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span id="cb194-1095"><a href="#cb194-1095" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-1096"><a href="#cb194-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1097"><a href="#cb194-1097" aria-hidden="true" tabindex="-1"></a><span class="co"># check NA values in the new variable:</span></span>
<span id="cb194-1098"><a href="#cb194-1098" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(nchsurc)) <span class="sc">|&gt;</span>  <span class="fu">nrow</span>()</span>
<span id="cb194-1099"><a href="#cb194-1099" aria-hidden="true" tabindex="-1"></a><span class="co"># which states have NA values?</span></span>
<span id="cb194-1100"><a href="#cb194-1100" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(nchsurc)) <span class="sc">|&gt;</span> <span class="fu">select</span>(Prscrbr_State_FIPS) <span class="sc">|&gt;</span> <span class="fu">unique</span>()</span>
<span id="cb194-1101"><a href="#cb194-1101" aria-hidden="true" tabindex="-1"></a><span class="co"># How many NA values are there for each state?</span></span>
<span id="cb194-1102"><a href="#cb194-1102" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(nchsurc)) <span class="sc">|&gt;</span> <span class="fu">select</span>(Prscrbr_State_FIPS, fips, random_fips) <span class="sc">|&gt;</span></span>
<span id="cb194-1103"><a href="#cb194-1103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(fips,random_fips) <span class="sc">|&gt;</span></span>
<span id="cb194-1104"><a href="#cb194-1104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span>
<span id="cb194-1105"><a href="#cb194-1105" aria-hidden="true" tabindex="-1"></a><span class="co"># view fips = 2063, or 11000:</span></span>
<span id="cb194-1106"><a href="#cb194-1106" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="sc">|&gt;</span> <span class="fu">filter</span>(fips <span class="sc">==</span> <span class="dv">2063</span><span class="sc">|</span>fips <span class="sc">==</span> <span class="dv">11000</span>) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="at">n =</span> <span class="dv">100</span>)</span>
<span id="cb194-1107"><a href="#cb194-1107" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1108"><a href="#cb194-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1109"><a href="#cb194-1109" aria-hidden="true" tabindex="-1"></a>State FIPS code 09 corresponds to Connecticut; we will address non-CT FIPS first:</span>
<span id="cb194-1110"><a href="#cb194-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1113"><a href="#cb194-1113" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1114"><a href="#cb194-1114" aria-hidden="true" tabindex="-1"></a><span class="co"># manually set FIPS 11000 to 11001:</span></span>
<span id="cb194-1115"><a href="#cb194-1115" aria-hidden="true" tabindex="-1"></a>data_nchsurc<span class="sc">$</span>fips[data_nchsurc<span class="sc">$</span>fips <span class="sc">==</span> <span class="dv">11000</span>] <span class="ot">&lt;-</span> <span class="dv">11001</span></span>
<span id="cb194-1116"><a href="#cb194-1116" aria-hidden="true" tabindex="-1"></a><span class="co"># manually set FIPS 2063 to 2261:</span></span>
<span id="cb194-1117"><a href="#cb194-1117" aria-hidden="true" tabindex="-1"></a>data_nchsurc<span class="sc">$</span>fips[data_nchsurc<span class="sc">$</span>fips <span class="sc">==</span> <span class="dv">2063</span>] <span class="ot">&lt;-</span> <span class="dv">2261</span></span>
<span id="cb194-1118"><a href="#cb194-1118" aria-hidden="true" tabindex="-1"></a><span class="co"># rename the NCHSURC variable:</span></span>
<span id="cb194-1119"><a href="#cb194-1119" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="ot">&lt;-</span> data_nchsurc <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">nchsurc_old =</span> nchsurc)</span>
<span id="cb194-1120"><a href="#cb194-1120" aria-hidden="true" tabindex="-1"></a><span class="co">#search again over the NCHSURC dataset</span></span>
<span id="cb194-1121"><a href="#cb194-1121" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb194-1122"><a href="#cb194-1122" aria-hidden="true" tabindex="-1"></a>  data_nchsurc,                         <span class="co"># the 'left' dataset</span></span>
<span id="cb194-1123"><a href="#cb194-1123" aria-hidden="true" tabindex="-1"></a>  nchsurc[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">7</span>)],                      <span class="co"># the 'right' dataset; columns 1 &amp; 7 are FIPS &amp; NCHSURC</span></span>
<span id="cb194-1124"><a href="#cb194-1124" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"fips"</span>),                       <span class="co"># these variables must exactly match in both datasets</span></span>
<span id="cb194-1125"><a href="#cb194-1125" aria-hidden="true" tabindex="-1"></a>  <span class="at">relationship =</span> <span class="st">"many-to-one"</span>,         <span class="co"># left_join will not work without specifying this relation</span></span>
<span id="cb194-1126"><a href="#cb194-1126" aria-hidden="true" tabindex="-1"></a>  <span class="at">multiple =</span> <span class="st">"any"</span>,                     <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span id="cb194-1127"><a href="#cb194-1127" aria-hidden="true" tabindex="-1"></a>)  </span>
<span id="cb194-1128"><a href="#cb194-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1129"><a href="#cb194-1129" aria-hidden="true" tabindex="-1"></a><span class="co"># Check missing values</span></span>
<span id="cb194-1130"><a href="#cb194-1130" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(nchsurc)) <span class="sc">|&gt;</span>  <span class="fu">nrow</span>()</span>
<span id="cb194-1131"><a href="#cb194-1131" aria-hidden="true" tabindex="-1"></a><span class="co"># check for missing values in ncshurc_old vs nchsurc:</span></span>
<span id="cb194-1132"><a href="#cb194-1132" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">is.na</span>(data_nchsurc<span class="sc">$</span>nchsurc_old), <span class="fu">is.na</span>(data_nchsurc<span class="sc">$</span>nchsurc))</span>
<span id="cb194-1133"><a href="#cb194-1133" aria-hidden="true" tabindex="-1"></a><span class="co"># How many NA values are there for each state?</span></span>
<span id="cb194-1134"><a href="#cb194-1134" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(nchsurc)) <span class="sc">|&gt;</span> <span class="fu">select</span>(Prscrbr_State_FIPS, fips) <span class="sc">|&gt;</span></span>
<span id="cb194-1135"><a href="#cb194-1135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(fips) <span class="sc">|&gt;</span> <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span>
<span id="cb194-1136"><a href="#cb194-1136" aria-hidden="true" tabindex="-1"></a><span class="co"># thus we can discard fips_old</span></span>
<span id="cb194-1137"><a href="#cb194-1137" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="ot">&lt;-</span> data_nchsurc <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>nchsurc_old)</span>
<span id="cb194-1138"><a href="#cb194-1138" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1139"><a href="#cb194-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1140"><a href="#cb194-1140" aria-hidden="true" tabindex="-1"></a>Apparently <span class="co">[</span><span class="ot">CT has switched from counties to planning ditricts</span><span class="co">](https://www.federalregister.gov/documents/2022/06/06/2022-12063/change-to-county-equivalents-in-the-state-of-connecticut)</span>, and the new codes are in the USGS dataset, but not in the NCHSURC dataset.  We will proceed to examine the CT codes, all of which are unmatched:</span>
<span id="cb194-1141"><a href="#cb194-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1144"><a href="#cb194-1144" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1145"><a href="#cb194-1145" aria-hidden="true" tabindex="-1"></a>places <span class="ot">&lt;-</span> data_nchsurc <span class="sc">|&gt;</span> </span>
<span id="cb194-1146"><a href="#cb194-1146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(nchsurc)) <span class="sc">|&gt;</span></span>
<span id="cb194-1147"><a href="#cb194-1147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Prscrbr_City, Prscrbr_State_Abrvtn, city_fixed, fips) <span class="sc">|&gt;</span></span>
<span id="cb194-1148"><a href="#cb194-1148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Prscrbr_City, Prscrbr_State_Abrvtn, city_fixed, fips) <span class="sc">|&gt;</span></span>
<span id="cb194-1149"><a href="#cb194-1149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span>
<span id="cb194-1150"><a href="#cb194-1150" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(places)</span>
<span id="cb194-1151"><a href="#cb194-1151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1152"><a href="#cb194-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1153"><a href="#cb194-1153" aria-hidden="true" tabindex="-1"></a>One approach is to make a dataframe with two vectors columns, one column with each city name in CT, and the other column with the corresponding FIPS code.  We can find such a table <span class="co">[</span><span class="ot">at the CT State Library</span><span class="co">](https://ctstatelibrary.org/cttowns/counties)</span>; it has been download and saved to /data as 'ct_towns.ods':</span>
<span id="cb194-1154"><a href="#cb194-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1157"><a href="#cb194-1157" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1158"><a href="#cb194-1158" aria-hidden="true" tabindex="-1"></a><span class="co"># reading CT state library data</span></span>
<span id="cb194-1159"><a href="#cb194-1159" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> <span class="fu">read_ods</span>(</span>
<span id="cb194-1160"><a href="#cb194-1160" aria-hidden="true" tabindex="-1"></a>  <span class="at">path =</span> <span class="st">"data/ct_towns.ods"</span>,</span>
<span id="cb194-1161"><a href="#cb194-1161" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb194-1162"><a href="#cb194-1162" aria-hidden="true" tabindex="-1"></a><span class="co"># make a new variable assigning the county FIPS code based on the county; Fairfield = 9001, Hartford = 9003, etc.</span></span>
<span id="cb194-1163"><a href="#cb194-1163" aria-hidden="true" tabindex="-1"></a>ct_towns<span class="sc">$</span>ct_fips <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb194-1164"><a href="#cb194-1164" aria-hidden="true" tabindex="-1"></a>  ct_towns<span class="sc">$</span>County <span class="sc">==</span> <span class="st">"Fairfield"</span> <span class="sc">~</span> <span class="dv">9001</span>,</span>
<span id="cb194-1165"><a href="#cb194-1165" aria-hidden="true" tabindex="-1"></a>  ct_towns<span class="sc">$</span>County <span class="sc">==</span> <span class="st">"Hartford"</span> <span class="sc">~</span> <span class="dv">9003</span>,</span>
<span id="cb194-1166"><a href="#cb194-1166" aria-hidden="true" tabindex="-1"></a>  ct_towns<span class="sc">$</span>County <span class="sc">==</span> <span class="st">"Litchfield"</span> <span class="sc">~</span> <span class="dv">9005</span>,</span>
<span id="cb194-1167"><a href="#cb194-1167" aria-hidden="true" tabindex="-1"></a>  ct_towns<span class="sc">$</span>County <span class="sc">==</span> <span class="st">"Middlesex"</span> <span class="sc">~</span> <span class="dv">9007</span>,</span>
<span id="cb194-1168"><a href="#cb194-1168" aria-hidden="true" tabindex="-1"></a>  ct_towns<span class="sc">$</span>County <span class="sc">==</span> <span class="st">"New Haven"</span> <span class="sc">~</span> <span class="dv">9009</span>,</span>
<span id="cb194-1169"><a href="#cb194-1169" aria-hidden="true" tabindex="-1"></a>  ct_towns<span class="sc">$</span>County <span class="sc">==</span> <span class="st">"New London"</span> <span class="sc">~</span> <span class="dv">9011</span>,</span>
<span id="cb194-1170"><a href="#cb194-1170" aria-hidden="true" tabindex="-1"></a>  ct_towns<span class="sc">$</span>County <span class="sc">==</span> <span class="st">"Tolland"</span> <span class="sc">~</span> <span class="dv">9013</span>,</span>
<span id="cb194-1171"><a href="#cb194-1171" aria-hidden="true" tabindex="-1"></a>  ct_towns<span class="sc">$</span>County <span class="sc">==</span> <span class="st">"Windham"</span> <span class="sc">~</span> <span class="dv">9015</span></span>
<span id="cb194-1172"><a href="#cb194-1172" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-1173"><a href="#cb194-1173" aria-hidden="true" tabindex="-1"></a>ct_towns<span class="sc">$</span>state_numeric <span class="ot">&lt;-</span> <span class="st">"09"</span></span>
<span id="cb194-1174"><a href="#cb194-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1175"><a href="#cb194-1175" aria-hidden="true" tabindex="-1"></a><span class="co"># test match ct_towns into 'places' dataset:</span></span>
<span id="cb194-1176"><a href="#cb194-1176" aria-hidden="true" tabindex="-1"></a>places <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb194-1177"><a href="#cb194-1177" aria-hidden="true" tabindex="-1"></a>  places,                                       <span class="co"># the 'left' dataset</span></span>
<span id="cb194-1178"><a href="#cb194-1178" aria-hidden="true" tabindex="-1"></a>  ct_towns[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">6</span>)],                           <span class="co"># the 'right' dataset; with Town.name, fips, and state_fips variables</span></span>
<span id="cb194-1179"><a href="#cb194-1179" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb194-1180"><a href="#cb194-1180" aria-hidden="true" tabindex="-1"></a>        Prscrbr_City <span class="sc">==</span> Town.name                <span class="co"># these variables must exactly match in both datasets</span></span>
<span id="cb194-1181"><a href="#cb194-1181" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb194-1182"><a href="#cb194-1182" aria-hidden="true" tabindex="-1"></a>  <span class="at">relationship =</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span id="cb194-1183"><a href="#cb194-1183" aria-hidden="true" tabindex="-1"></a>  <span class="at">multiple =</span> <span class="st">"any"</span>,                             <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span id="cb194-1184"><a href="#cb194-1184" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-1185"><a href="#cb194-1185" aria-hidden="true" tabindex="-1"></a>places <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(ct_fips)) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="at">n =</span> <span class="dv">100</span>)</span>
<span id="cb194-1186"><a href="#cb194-1186" aria-hidden="true" tabindex="-1"></a><span class="co"># places |&gt; select(-ct_fips)</span></span>
<span id="cb194-1187"><a href="#cb194-1187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1188"><a href="#cb194-1188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1189"><a href="#cb194-1189" aria-hidden="true" tabindex="-1"></a>We can see that the CT State Library data is missing some towns, and that some towns are missing from the NCHSURC dataset.  We will manually add these towns to the ct_towns dataset:</span>
<span id="cb194-1190"><a href="#cb194-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1193"><a href="#cb194-1193" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1194"><a href="#cb194-1194" aria-hidden="true" tabindex="-1"></a><span class="co"># manually add Willimantic, CT</span></span>
<span id="cb194-1195"><a href="#cb194-1195" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Willimantic"</span>, <span class="at">ct_fips =</span> <span class="dv">9015</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1196"><a href="#cb194-1196" aria-hidden="true" tabindex="-1"></a><span class="co"># Lakeville</span></span>
<span id="cb194-1197"><a href="#cb194-1197" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Lakeville"</span>, <span class="at">ct_fips =</span> <span class="dv">9005</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1198"><a href="#cb194-1198" aria-hidden="true" tabindex="-1"></a><span class="co"># Terryville</span></span>
<span id="cb194-1199"><a href="#cb194-1199" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Terryville"</span>, <span class="at">ct_fips =</span> <span class="dv">9003</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1200"><a href="#cb194-1200" aria-hidden="true" tabindex="-1"></a><span class="co"># Turrington</span></span>
<span id="cb194-1201"><a href="#cb194-1201" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Turrington"</span>, <span class="at">ct_fips =</span> <span class="dv">9005</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1202"><a href="#cb194-1202" aria-hidden="true" tabindex="-1"></a><span class="co"># Moodus</span></span>
<span id="cb194-1203"><a href="#cb194-1203" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Moodus"</span>, <span class="at">ct_fips =</span> <span class="dv">9007</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1204"><a href="#cb194-1204" aria-hidden="true" tabindex="-1"></a><span class="co"># Oakdale</span></span>
<span id="cb194-1205"><a href="#cb194-1205" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Oakdale"</span>, <span class="at">ct_fips =</span> <span class="dv">9011</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1206"><a href="#cb194-1206" aria-hidden="true" tabindex="-1"></a><span class="co"># Plantsville</span></span>
<span id="cb194-1207"><a href="#cb194-1207" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Plantsville"</span>, <span class="at">ct_fips =</span> <span class="dv">9003</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1208"><a href="#cb194-1208" aria-hidden="true" tabindex="-1"></a><span class="co"># Sandy Hook    </span></span>
<span id="cb194-1209"><a href="#cb194-1209" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Sandy Hook"</span>, <span class="at">ct_fips =</span> <span class="dv">9001</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1210"><a href="#cb194-1210" aria-hidden="true" tabindex="-1"></a><span class="co"># East Berlin   </span></span>
<span id="cb194-1211"><a href="#cb194-1211" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"East Berlin"</span>, <span class="at">ct_fips =</span> <span class="dv">9003</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1212"><a href="#cb194-1212" aria-hidden="true" tabindex="-1"></a><span class="co"># Jewett City   </span></span>
<span id="cb194-1213"><a href="#cb194-1213" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Jewett City"</span>, <span class="at">ct_fips =</span> <span class="dv">9011</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1214"><a href="#cb194-1214" aria-hidden="true" tabindex="-1"></a><span class="co"># Kensington</span></span>
<span id="cb194-1215"><a href="#cb194-1215" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Kensington"</span>, <span class="at">ct_fips =</span> <span class="dv">9003</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1216"><a href="#cb194-1216" aria-hidden="true" tabindex="-1"></a><span class="co"># S Woodstock   </span></span>
<span id="cb194-1217"><a href="#cb194-1217" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"S Woodstock"</span>, <span class="at">ct_fips =</span> <span class="dv">9015</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1218"><a href="#cb194-1218" aria-hidden="true" tabindex="-1"></a><span class="co"># Riverside</span></span>
<span id="cb194-1219"><a href="#cb194-1219" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Riverside"</span>, <span class="at">ct_fips =</span> <span class="dv">9001</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1220"><a href="#cb194-1220" aria-hidden="true" tabindex="-1"></a><span class="co"># Wauregan</span></span>
<span id="cb194-1221"><a href="#cb194-1221" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Wauregan"</span>, <span class="at">ct_fips =</span> <span class="dv">9015</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1222"><a href="#cb194-1222" aria-hidden="true" tabindex="-1"></a><span class="co"># Vernon Rockville  </span></span>
<span id="cb194-1223"><a href="#cb194-1223" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Vernon Rockville"</span>, <span class="at">ct_fips =</span> <span class="dv">9013</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1224"><a href="#cb194-1224" aria-hidden="true" tabindex="-1"></a><span class="co"># Abington</span></span>
<span id="cb194-1225"><a href="#cb194-1225" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Abington"</span>, <span class="at">ct_fips =</span> <span class="dv">9015</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1226"><a href="#cb194-1226" aria-hidden="true" tabindex="-1"></a><span class="co"># Gales Ferry   </span></span>
<span id="cb194-1227"><a href="#cb194-1227" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Gales Ferry"</span>, <span class="at">ct_fips =</span> <span class="dv">9011</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1228"><a href="#cb194-1228" aria-hidden="true" tabindex="-1"></a><span class="co"># Mansfield Center  CT  06250   Tolland 09013</span></span>
<span id="cb194-1229"><a href="#cb194-1229" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Mansfield Center"</span>, <span class="at">ct_fips =</span> <span class="dv">9013</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1230"><a href="#cb194-1230" aria-hidden="true" tabindex="-1"></a><span class="co"># Dayville</span></span>
<span id="cb194-1231"><a href="#cb194-1231" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Dayville"</span>, <span class="at">ct_fips =</span> <span class="dv">9015</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1232"><a href="#cb194-1232" aria-hidden="true" tabindex="-1"></a><span class="co"># Danielson</span></span>
<span id="cb194-1233"><a href="#cb194-1233" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Danielson"</span>, <span class="at">ct_fips =</span> <span class="dv">9015</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1234"><a href="#cb194-1234" aria-hidden="true" tabindex="-1"></a><span class="co"># Storrs</span></span>
<span id="cb194-1235"><a href="#cb194-1235" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Storrs"</span>, <span class="at">ct_fips =</span> <span class="dv">9013</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1236"><a href="#cb194-1236" aria-hidden="true" tabindex="-1"></a><span class="co"># Rockville</span></span>
<span id="cb194-1237"><a href="#cb194-1237" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Rockville"</span>, <span class="at">ct_fips =</span> <span class="dv">9013</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1238"><a href="#cb194-1238" aria-hidden="true" tabindex="-1"></a><span class="co"># Amston</span></span>
<span id="cb194-1239"><a href="#cb194-1239" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Amston"</span>, <span class="at">ct_fips =</span> <span class="dv">9007</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1240"><a href="#cb194-1240" aria-hidden="true" tabindex="-1"></a><span class="co"># Pawcatuck</span></span>
<span id="cb194-1241"><a href="#cb194-1241" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Pawcatuck"</span>, <span class="at">ct_fips =</span> <span class="dv">9011</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1242"><a href="#cb194-1242" aria-hidden="true" tabindex="-1"></a><span class="co"># Old Greenwich </span></span>
<span id="cb194-1243"><a href="#cb194-1243" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Old Greenwich"</span>, <span class="at">ct_fips =</span> <span class="dv">9001</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1244"><a href="#cb194-1244" aria-hidden="true" tabindex="-1"></a><span class="co"># Mystic</span></span>
<span id="cb194-1245"><a href="#cb194-1245" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Mystic"</span>, <span class="at">ct_fips =</span> <span class="dv">9011</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1246"><a href="#cb194-1246" aria-hidden="true" tabindex="-1"></a><span class="co"># Milldale</span></span>
<span id="cb194-1247"><a href="#cb194-1247" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Milldale"</span>, <span class="at">ct_fips =</span> <span class="dv">9009</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1248"><a href="#cb194-1248" aria-hidden="true" tabindex="-1"></a><span class="co"># Niantic</span></span>
<span id="cb194-1249"><a href="#cb194-1249" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Niantic"</span>, <span class="at">ct_fips =</span> <span class="dv">9011</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1250"><a href="#cb194-1250" aria-hidden="true" tabindex="-1"></a><span class="co"># Pomfret Center    </span></span>
<span id="cb194-1251"><a href="#cb194-1251" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Pomfret Center"</span>, <span class="at">ct_fips =</span> <span class="dv">9015</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1252"><a href="#cb194-1252" aria-hidden="true" tabindex="-1"></a><span class="co"># Quinebaug </span></span>
<span id="cb194-1253"><a href="#cb194-1253" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Quinebaug"</span>, <span class="at">ct_fips =</span> <span class="dv">9015</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1254"><a href="#cb194-1254" aria-hidden="true" tabindex="-1"></a><span class="co"># Stafford Springs  </span></span>
<span id="cb194-1255"><a href="#cb194-1255" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Stafford Springs"</span>, <span class="at">ct_fips =</span> <span class="dv">9013</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1256"><a href="#cb194-1256" aria-hidden="true" tabindex="-1"></a><span class="co"># Winsted</span></span>
<span id="cb194-1257"><a href="#cb194-1257" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Winsted"</span>, <span class="at">ct_fips =</span> <span class="dv">9005</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1258"><a href="#cb194-1258" aria-hidden="true" tabindex="-1"></a><span class="co"># Higganum</span></span>
<span id="cb194-1259"><a href="#cb194-1259" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Higganum"</span>, <span class="at">ct_fips =</span> <span class="dv">9007</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1260"><a href="#cb194-1260" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncasville</span></span>
<span id="cb194-1261"><a href="#cb194-1261" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Uncasville"</span>, <span class="at">ct_fips =</span> <span class="dv">9011</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1262"><a href="#cb194-1262" aria-hidden="true" tabindex="-1"></a><span class="co"># Cos Cob   </span></span>
<span id="cb194-1263"><a href="#cb194-1263" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"Cos Cob"</span>, <span class="at">ct_fips =</span> <span class="dv">9001</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1264"><a href="#cb194-1264" aria-hidden="true" tabindex="-1"></a><span class="co"># W Hartford    </span></span>
<span id="cb194-1265"><a href="#cb194-1265" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"W Hartford"</span>, <span class="at">ct_fips =</span> <span class="dv">9003</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1266"><a href="#cb194-1266" aria-hidden="true" tabindex="-1"></a><span class="co"># West Redding  </span></span>
<span id="cb194-1267"><a href="#cb194-1267" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="ot">&lt;-</span> ct_towns <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Town.name =</span> <span class="st">"West Redding"</span>, <span class="at">ct_fips =</span> <span class="dv">9001</span>, <span class="at">state_numeric =</span> <span class="st">"09"</span>)</span>
<span id="cb194-1268"><a href="#cb194-1268" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1269"><a href="#cb194-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1270"><a href="#cb194-1270" aria-hidden="true" tabindex="-1"></a>After adding the codes for the missing towns, we can join the two datasets together, and test for any remaining unmatched:</span>
<span id="cb194-1271"><a href="#cb194-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1274"><a href="#cb194-1274" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1275"><a href="#cb194-1275" aria-hidden="true" tabindex="-1"></a><span class="co"># match the FIPS code to the city name in `data_nchsurc`:</span></span>
<span id="cb194-1276"><a href="#cb194-1276" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb194-1277"><a href="#cb194-1277" aria-hidden="true" tabindex="-1"></a>    data_nchsurc,                                   <span class="co"># the 'left' dataset</span></span>
<span id="cb194-1278"><a href="#cb194-1278" aria-hidden="true" tabindex="-1"></a>    ct_towns[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">6</span>,<span class="dv">7</span>)],                             <span class="co"># the 'right' dataset; with Town.name, ct_fips, and state_numeric variables</span></span>
<span id="cb194-1279"><a href="#cb194-1279" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb194-1280"><a href="#cb194-1280" aria-hidden="true" tabindex="-1"></a>        Prscrbr_City <span class="sc">==</span> Town.name,                  <span class="co"># these variables must exactly match in both datasets</span></span>
<span id="cb194-1281"><a href="#cb194-1281" aria-hidden="true" tabindex="-1"></a>        Prscrbr_State_FIPS <span class="sc">==</span> state_numeric         <span class="co"># these variables must exactly match in both datasets</span></span>
<span id="cb194-1282"><a href="#cb194-1282" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb194-1283"><a href="#cb194-1283" aria-hidden="true" tabindex="-1"></a>    <span class="at">relationship =</span> <span class="st">"many-to-one"</span>,                   <span class="co"># left_join will not work without specifying this relation</span></span>
<span id="cb194-1284"><a href="#cb194-1284" aria-hidden="true" tabindex="-1"></a>    <span class="at">multiple =</span> <span class="st">"any"</span>,                               <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span id="cb194-1285"><a href="#cb194-1285" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb194-1286"><a href="#cb194-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1287"><a href="#cb194-1287" aria-hidden="true" tabindex="-1"></a><span class="co"># Test</span></span>
<span id="cb194-1288"><a href="#cb194-1288" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="sc">|&gt;</span> <span class="fu">filter</span>(Prscrbr_State_FIPS <span class="sc">==</span> <span class="st">"09"</span>) <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(ct_fips)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-1289"><a href="#cb194-1289" aria-hidden="true" tabindex="-1"></a><span class="co"># fold ct_fips into fips variable</span></span>
<span id="cb194-1290"><a href="#cb194-1290" aria-hidden="true" tabindex="-1"></a>data_nchsurc<span class="sc">$</span>fips <span class="ot">&lt;-</span> <span class="fu">fifelse</span>(</span>
<span id="cb194-1291"><a href="#cb194-1291" aria-hidden="true" tabindex="-1"></a>  data_nchsurc<span class="sc">$</span>Prscrbr_State_FIPS <span class="sc">==</span> <span class="st">"09"</span>,     <span class="co"># if state_numeric is CT</span></span>
<span id="cb194-1292"><a href="#cb194-1292" aria-hidden="true" tabindex="-1"></a>  data_nchsurc<span class="sc">$</span>ct_fips,                       <span class="co"># if not missing, value is county_fips</span></span>
<span id="cb194-1293"><a href="#cb194-1293" aria-hidden="true" tabindex="-1"></a>  data_nchsurc<span class="sc">$</span>fips,                    <span class="co"># if Prscrbr_County_FIPS is NA, fills in with county_numeric</span></span>
<span id="cb194-1294"><a href="#cb194-1294" aria-hidden="true" tabindex="-1"></a>  <span class="at">na =</span> <span class="cn">NA</span></span>
<span id="cb194-1295"><a href="#cb194-1295" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-1296"><a href="#cb194-1296" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1297"><a href="#cb194-1297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1300"><a href="#cb194-1300" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1301"><a href="#cb194-1301" aria-hidden="true" tabindex="-1"></a><span class="co"># lookup NCHSURC for CT entries</span></span>
<span id="cb194-1302"><a href="#cb194-1302" aria-hidden="true" tabindex="-1"></a><span class="co"># first rename the old NCHSURC variable to protect it:</span></span>
<span id="cb194-1303"><a href="#cb194-1303" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="ot">&lt;-</span> data_nchsurc <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">nchsurc_old =</span> nchsurc)</span>
<span id="cb194-1304"><a href="#cb194-1304" aria-hidden="true" tabindex="-1"></a><span class="co">#search again over the NCHSURC dataset</span></span>
<span id="cb194-1305"><a href="#cb194-1305" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb194-1306"><a href="#cb194-1306" aria-hidden="true" tabindex="-1"></a>  data_nchsurc,                         <span class="co"># the 'left' dataset</span></span>
<span id="cb194-1307"><a href="#cb194-1307" aria-hidden="true" tabindex="-1"></a>  nchsurc[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">7</span>)],                      <span class="co"># the 'right' dataset; columns 1 &amp; 7 are FIPS &amp; NCHSURC</span></span>
<span id="cb194-1308"><a href="#cb194-1308" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb194-1309"><a href="#cb194-1309" aria-hidden="true" tabindex="-1"></a>    ct_fips <span class="sc">==</span> fips,                    <span class="co"># these variables must exactly match in both datasets</span></span>
<span id="cb194-1310"><a href="#cb194-1310" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb194-1311"><a href="#cb194-1311" aria-hidden="true" tabindex="-1"></a>  <span class="at">relationship =</span> <span class="st">"many-to-one"</span>,         <span class="co"># left_join will not work without specifying this relation</span></span>
<span id="cb194-1312"><a href="#cb194-1312" aria-hidden="true" tabindex="-1"></a>  <span class="at">multiple =</span> <span class="st">"any"</span>,                     <span class="co"># randomly returns one of the matching rows in USGS dataset</span></span>
<span id="cb194-1313"><a href="#cb194-1313" aria-hidden="true" tabindex="-1"></a>)  </span>
<span id="cb194-1314"><a href="#cb194-1314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1315"><a href="#cb194-1315" aria-hidden="true" tabindex="-1"></a><span class="co"># Test</span></span>
<span id="cb194-1316"><a href="#cb194-1316" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="sc">|&gt;</span> <span class="fu">filter</span>(Prscrbr_State_FIPS <span class="sc">==</span> <span class="st">"09"</span>) <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(nchsurc)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-1317"><a href="#cb194-1317" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(nchsurc) <span class="sc">&amp;</span> <span class="fu">is.na</span>(nchsurc_old)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-1318"><a href="#cb194-1318" aria-hidden="true" tabindex="-1"></a><span class="co"># Fold in the new NCHSURC variable</span></span>
<span id="cb194-1319"><a href="#cb194-1319" aria-hidden="true" tabindex="-1"></a>data_nchsurc<span class="sc">$</span>nchsurc <span class="ot">&lt;-</span> <span class="fu">fifelse</span>(</span>
<span id="cb194-1320"><a href="#cb194-1320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.na</span>(data_nchsurc<span class="sc">$</span>nchsurc),                       <span class="co"># if nchsurc is NA</span></span>
<span id="cb194-1321"><a href="#cb194-1321" aria-hidden="true" tabindex="-1"></a>  data_nchsurc<span class="sc">$</span>nchsurc_old,                          <span class="co"># use the old nchsurc variable</span></span>
<span id="cb194-1322"><a href="#cb194-1322" aria-hidden="true" tabindex="-1"></a>  data_nchsurc<span class="sc">$</span>nchsurc,                              <span class="co"># if not missing, value is nchsurc</span></span>
<span id="cb194-1323"><a href="#cb194-1323" aria-hidden="true" tabindex="-1"></a>  <span class="at">na =</span> <span class="cn">NA</span></span>
<span id="cb194-1324"><a href="#cb194-1324" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-1325"><a href="#cb194-1325" aria-hidden="true" tabindex="-1"></a><span class="co"># test missing</span></span>
<span id="cb194-1326"><a href="#cb194-1326" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(nchsurc)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb194-1327"><a href="#cb194-1327" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1328"><a href="#cb194-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1329"><a href="#cb194-1329" aria-hidden="true" tabindex="-1"></a>Cleanup</span>
<span id="cb194-1330"><a href="#cb194-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1333"><a href="#cb194-1333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1334"><a href="#cb194-1334" aria-hidden="true" tabindex="-1"></a><span class="co"># cleanup</span></span>
<span id="cb194-1335"><a href="#cb194-1335" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(ct_towns, places, nchsurc)</span>
<span id="cb194-1336"><a href="#cb194-1336" aria-hidden="true" tabindex="-1"></a><span class="co"># remove unused variables</span></span>
<span id="cb194-1337"><a href="#cb194-1337" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="ot">&lt;-</span> data_nchsurc <span class="sc">|&gt;</span> </span>
<span id="cb194-1338"><a href="#cb194-1338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>nchsurc_old, <span class="sc">-</span>ct_fips)</span>
<span id="cb194-1339"><a href="#cb194-1339" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1340"><a href="#cb194-1340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1341"><a href="#cb194-1341" aria-hidden="true" tabindex="-1"></a>Set Urban/Rural Classification</span>
<span id="cb194-1342"><a href="#cb194-1342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1345"><a href="#cb194-1345" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1346"><a href="#cb194-1346" aria-hidden="true" tabindex="-1"></a><span class="co"># view values of nchsurc$nchsurc</span></span>
<span id="cb194-1347"><a href="#cb194-1347" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="sc">|&gt;</span> </span>
<span id="cb194-1348"><a href="#cb194-1348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(nchsurc) <span class="sc">|&gt;</span> </span>
<span id="cb194-1349"><a href="#cb194-1349" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb194-1350"><a href="#cb194-1350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span>
<span id="cb194-1351"><a href="#cb194-1351" aria-hidden="true" tabindex="-1"></a><span class="co"># set urban/rural classification</span></span>
<span id="cb194-1352"><a href="#cb194-1352" aria-hidden="true" tabindex="-1"></a>data_nchsurc<span class="sc">$</span>ur <span class="ot">&lt;-</span> <span class="fu">fifelse</span>(</span>
<span id="cb194-1353"><a href="#cb194-1353" aria-hidden="true" tabindex="-1"></a>  data_nchsurc<span class="sc">$</span>nchsurc <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"5"</span>, <span class="st">"6"</span>),     <span class="co"># if nchsurc is rural                    </span></span>
<span id="cb194-1354"><a href="#cb194-1354" aria-hidden="true" tabindex="-1"></a>  <span class="st">"rural"</span>,                                   <span class="co"># then rural</span></span>
<span id="cb194-1355"><a href="#cb194-1355" aria-hidden="true" tabindex="-1"></a>  <span class="st">"urban"</span>,                                   <span class="co"># else urban</span></span>
<span id="cb194-1356"><a href="#cb194-1356" aria-hidden="true" tabindex="-1"></a>  <span class="at">na =</span> <span class="cn">NA</span></span>
<span id="cb194-1357"><a href="#cb194-1357" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-1358"><a href="#cb194-1358" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1359"><a href="#cb194-1359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1360"><a href="#cb194-1360" aria-hidden="true" tabindex="-1"></a><span class="fu">### Alternate Intensive Approach</span></span>
<span id="cb194-1361"><a href="#cb194-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1362"><a href="#cb194-1362" aria-hidden="true" tabindex="-1"></a>Within this section we will use the dataset created above, find latitude and longitude coordinates for each city/state combination to which an observation corresponds, then convert the coordinates to county FIPS code, and then lookup the rural-urbal classification from the FIPS code. Breaking down the specifics of each step, we have:</span>
<span id="cb194-1363"><a href="#cb194-1363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1364"><a href="#cb194-1364" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Finding the coordinates: we will use the <span class="in">`geocode()`</span> function from the <span class="in">`ggmap`</span> package to find the coordinates for each city/state combination.  The function will return a dataframe with the coordinates for each city/state combination, and will also return a status code indicating whether the coordinates were found successfully.  We will use the status code to filter out any entries for which the coordinates were not found.</span>
<span id="cb194-1365"><a href="#cb194-1365" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Convert coordinates to FIPS using one of several methods:</span>
<span id="cb194-1366"><a href="#cb194-1366" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`coords_to_fips()`</span>from <span class="co">[</span><span class="ot">fipio</span><span class="co">](https://cran.r-project.org/web/packages/fipio/index.html)</span></span>
<span id="cb194-1367"><a href="#cb194-1367" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Look into:</span>
<span id="cb194-1368"><a href="#cb194-1368" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Use the <span class="in">`fips()`</span> function from the <span class="in">`USAboundaries`</span> package to convert the coordinates to FIPS code.  This function uses the <span class="in">`sf`</span> package to find the FIPS code for the county in which the coordinates are located.  This method is the most straightforward, but it is also the slowest.</span>
<span id="cb194-1369"><a href="#cb194-1369" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Use the <span class="in">`fips()`</span> function from the <span class="in">`tigris`</span> package to convert the coordinates to FIPS code.  This function uses the <span class="in">`sf`</span> package to find the FIPS code for the county in which the coordinates are located.  This method is faster than the <span class="in">`USAboundaries`</span> method, but it is still relatively slow.</span>
<span id="cb194-1370"><a href="#cb194-1370" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Use the <span class="in">`fips()`</span> function from the <span class="in">`MazamaSpatialUtils`</span> package to convert the coordinates to FIPS code.  This function uses a lookup table to find the FIPS code for the county in which the coordinates are located.  This method is the fastest, but it is also the least accurate.  The lookup table is based on the 2010 census, so it will not include any counties that were created after 2010.  This method will also not work for any coordinates that are outside of the US.</span>
<span id="cb194-1371"><a href="#cb194-1371" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Lookup rural-urban clssification: For this step we can use CDC's <span class="co">[</span><span class="ot">2013 Urban-Rural Classification Scheme for Counties</span><span class="co">](https://www.cdc.gov/nchs/data_access/urban_rural.htm)</span>; specifically the <span class="co">[</span><span class="ot">NCHSurbruralcodes Spreadsheet</span><span class="co">](https://www.cdc.gov/nchs/data/data_acces_files/NCHSURCodes2013.xlsx)</span> which contains the FIPS codes and rural-urban classifications for each county in the US.</span>
<span id="cb194-1372"><a href="#cb194-1372" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb194-1373"><a href="#cb194-1373" aria-hidden="true" tabindex="-1"></a>The data can be plotted according to FIPS code using <span class="in">`ggplot2`</span> or <span class="in">`MazamaSpatialPlots`</span> packages.</span>
<span id="cb194-1374"><a href="#cb194-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1375"><a href="#cb194-1375" aria-hidden="true" tabindex="-1"></a><span class="fu">## Provider Type</span></span>
<span id="cb194-1376"><a href="#cb194-1376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1377"><a href="#cb194-1377" aria-hidden="true" tabindex="-1"></a>Overview of provider types</span>
<span id="cb194-1378"><a href="#cb194-1378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1381"><a href="#cb194-1381" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1382"><a href="#cb194-1382" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="sc">|&gt;</span> </span>
<span id="cb194-1383"><a href="#cb194-1383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Prscrbr_Type) <span class="sc">|&gt;</span> </span>
<span id="cb194-1384"><a href="#cb194-1384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb194-1385"><a href="#cb194-1385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span>
<span id="cb194-1386"><a href="#cb194-1386" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1387"><a href="#cb194-1387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1388"><a href="#cb194-1388" aria-hidden="true" tabindex="-1"></a>Further exploration of provider types:</span>
<span id="cb194-1389"><a href="#cb194-1389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1392"><a href="#cb194-1392" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1393"><a href="#cb194-1393" aria-hidden="true" tabindex="-1"></a>data_nchsurc <span class="sc">|&gt;</span> </span>
<span id="cb194-1394"><a href="#cb194-1394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tx <span class="sc">==</span> <span class="st">"bup_oud"</span>) <span class="sc">|&gt;</span></span>
<span id="cb194-1395"><a href="#cb194-1395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Prscrbr_Type, year) <span class="sc">|&gt;</span> </span>
<span id="cb194-1396"><a href="#cb194-1396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb194-1397"><a href="#cb194-1397" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">n</span>(), </span>
<span id="cb194-1398"><a href="#cb194-1398" aria-hidden="true" tabindex="-1"></a>      <span class="at">Supply_yr =</span> <span class="fu">round</span>(<span class="fu">sum</span>(Tot_Day_Suply)<span class="sc">/</span><span class="dv">365</span>, <span class="at">digits=</span><span class="dv">1</span>),</span>
<span id="cb194-1399"><a href="#cb194-1399" aria-hidden="true" tabindex="-1"></a>      <span class="at">Supply_per_Provider_yr =</span> <span class="fu">round</span>(Supply_yr<span class="sc">/</span>n, <span class="at">digits=</span><span class="dv">1</span>)</span>
<span id="cb194-1400"><a href="#cb194-1400" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb194-1401"><a href="#cb194-1401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(year, <span class="fu">desc</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb194-1402"><a href="#cb194-1402" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select only the top 10 entries of each year</span></span>
<span id="cb194-1403"><a href="#cb194-1403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb194-1404"><a href="#cb194-1404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(n, <span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb194-1405"><a href="#cb194-1405" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1406"><a href="#cb194-1406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1407"><a href="#cb194-1407" aria-hidden="true" tabindex="-1"></a>Specify the provider type simplified variable</span>
<span id="cb194-1408"><a href="#cb194-1408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1411"><a href="#cb194-1411" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1412"><a href="#cb194-1412" aria-hidden="true" tabindex="-1"></a>data_provider <span class="ot">&lt;-</span> data_nchsurc <span class="sc">|&gt;</span> </span>
<span id="cb194-1413"><a href="#cb194-1413" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(</span>
<span id="cb194-1414"><a href="#cb194-1414" aria-hidden="true" tabindex="-1"></a>     <span class="at">type =</span> <span class="fu">case_when</span>(</span>
<span id="cb194-1415"><a href="#cb194-1415" aria-hidden="true" tabindex="-1"></a>       Prscrbr_Type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Physician Assistant"</span>) <span class="sc">~</span> <span class="st">"PA"</span>,</span>
<span id="cb194-1416"><a href="#cb194-1416" aria-hidden="true" tabindex="-1"></a>       Prscrbr_Type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Nurse Practitioner"</span>) <span class="sc">~</span> <span class="st">"NP"</span>,</span>
<span id="cb194-1417"><a href="#cb194-1417" aria-hidden="true" tabindex="-1"></a>       Prscrbr_Type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Pharmacist"</span>) <span class="sc">~</span> <span class="st">"RPh"</span>,</span>
<span id="cb194-1418"><a href="#cb194-1418" aria-hidden="true" tabindex="-1"></a>       Prscrbr_Type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Family Practice"</span>, <span class="st">"Internal Medicine"</span>, <span class="st">"Family Medicine"</span>, <span class="st">"General Practice"</span>, <span class="st">"Geriatric Medicine"</span>, <span class="st">"Preventive Medicine"</span>) <span class="sc">~</span> <span class="st">"FP/IM"</span>,</span>
<span id="cb194-1419"><a href="#cb194-1419" aria-hidden="true" tabindex="-1"></a>       Prscrbr_Type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Anesthesiology"</span>, <span class="st">"Pain Management   "</span>, <span class="st">"Interventional Pain Management"</span>, <span class="st">"Pain Medicine"</span>) <span class="sc">~</span> <span class="st">"Pain"</span>,</span>
<span id="cb194-1420"><a href="#cb194-1420" aria-hidden="true" tabindex="-1"></a>       Prscrbr_Type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Psychiatry"</span>, <span class="st">"Psychiatry &amp; Neurology"</span>, <span class="st">"Neuropsychiatry"</span>, <span class="st">"Addiction Medicine"</span>, <span class="st">"Counselor"</span>) <span class="sc">~</span> <span class="st">"Psych"</span>,</span>
<span id="cb194-1421"><a href="#cb194-1421" aria-hidden="true" tabindex="-1"></a>       <span class="at">.default =</span> <span class="st">"Other"</span></span>
<span id="cb194-1422"><a href="#cb194-1422" aria-hidden="true" tabindex="-1"></a>     )</span>
<span id="cb194-1423"><a href="#cb194-1423" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb194-1424"><a href="#cb194-1424" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1425"><a href="#cb194-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1426"><a href="#cb194-1426" aria-hidden="true" tabindex="-1"></a><span class="fu"># Final dataset</span></span>
<span id="cb194-1427"><a href="#cb194-1427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1428"><a href="#cb194-1428" aria-hidden="true" tabindex="-1"></a>Create final dataset, save datasets, and cleanup:</span>
<span id="cb194-1429"><a href="#cb194-1429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1432"><a href="#cb194-1432" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1433"><a href="#cb194-1433" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data_provider</span>
<span id="cb194-1434"><a href="#cb194-1434" aria-hidden="true" tabindex="-1"></a><span class="co"># save the final dataset by itself</span></span>
<span id="cb194-1435"><a href="#cb194-1435" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(</span>
<span id="cb194-1436"><a href="#cb194-1436" aria-hidden="true" tabindex="-1"></a>  data,</span>
<span id="cb194-1437"><a href="#cb194-1437" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"dataset/data.RData"</span>,</span>
<span id="cb194-1438"><a href="#cb194-1438" aria-hidden="true" tabindex="-1"></a>  <span class="at">compress =</span> <span class="cn">TRUE</span>,</span>
<span id="cb194-1439"><a href="#cb194-1439" aria-hidden="true" tabindex="-1"></a>  <span class="at">compression_level =</span> <span class="dv">9</span></span>
<span id="cb194-1440"><a href="#cb194-1440" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-1441"><a href="#cb194-1441" aria-hidden="true" tabindex="-1"></a><span class="co"># save intermediate datasets</span></span>
<span id="cb194-1442"><a href="#cb194-1442" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(</span>
<span id="cb194-1443"><a href="#cb194-1443" aria-hidden="true" tabindex="-1"></a>  data_tx,</span>
<span id="cb194-1444"><a href="#cb194-1444" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"dataset/data_tx.RData"</span>,</span>
<span id="cb194-1445"><a href="#cb194-1445" aria-hidden="true" tabindex="-1"></a>  <span class="at">compress =</span> <span class="cn">TRUE</span>,</span>
<span id="cb194-1446"><a href="#cb194-1446" aria-hidden="true" tabindex="-1"></a>  <span class="at">compression_level =</span> <span class="dv">9</span></span>
<span id="cb194-1447"><a href="#cb194-1447" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-1448"><a href="#cb194-1448" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(</span>
<span id="cb194-1449"><a href="#cb194-1449" aria-hidden="true" tabindex="-1"></a>  data_provider,</span>
<span id="cb194-1450"><a href="#cb194-1450" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"dataset/data_provider.RData"</span>,</span>
<span id="cb194-1451"><a href="#cb194-1451" aria-hidden="true" tabindex="-1"></a>  <span class="at">compress =</span> <span class="cn">TRUE</span>,</span>
<span id="cb194-1452"><a href="#cb194-1452" aria-hidden="true" tabindex="-1"></a>  <span class="at">compression_level =</span> <span class="dv">9</span></span>
<span id="cb194-1453"><a href="#cb194-1453" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-1454"><a href="#cb194-1454" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(</span>
<span id="cb194-1455"><a href="#cb194-1455" aria-hidden="true" tabindex="-1"></a>  data_nchsurc,</span>
<span id="cb194-1456"><a href="#cb194-1456" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"dataset/data_nchsurc.RData"</span>,</span>
<span id="cb194-1457"><a href="#cb194-1457" aria-hidden="true" tabindex="-1"></a>  <span class="at">compress =</span> <span class="cn">TRUE</span>,</span>
<span id="cb194-1458"><a href="#cb194-1458" aria-hidden="true" tabindex="-1"></a>  <span class="at">compression_level =</span> <span class="dv">9</span></span>
<span id="cb194-1459"><a href="#cb194-1459" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-1460"><a href="#cb194-1460" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(</span>
<span id="cb194-1461"><a href="#cb194-1461" aria-hidden="true" tabindex="-1"></a>  data_fips,</span>
<span id="cb194-1462"><a href="#cb194-1462" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"dataset/data_fips.RData"</span>,</span>
<span id="cb194-1463"><a href="#cb194-1463" aria-hidden="true" tabindex="-1"></a>  <span class="at">compress =</span> <span class="cn">TRUE</span>,</span>
<span id="cb194-1464"><a href="#cb194-1464" aria-hidden="true" tabindex="-1"></a>  <span class="at">compression_level =</span> <span class="dv">9</span></span>
<span id="cb194-1465"><a href="#cb194-1465" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb194-1466"><a href="#cb194-1466" aria-hidden="true" tabindex="-1"></a><span class="co"># cleanup</span></span>
<span id="cb194-1467"><a href="#cb194-1467" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(data_tx, data_provider, data_nchsurc, data_fips)</span>
<span id="cb194-1468"><a href="#cb194-1468" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb194-1469"><a href="#cb194-1469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1470"><a href="#cb194-1470" aria-hidden="true" tabindex="-1"></a><span class="fu"># Other Thoughts</span></span>
<span id="cb194-1471"><a href="#cb194-1471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1472"><a href="#cb194-1472" aria-hidden="true" tabindex="-1"></a>Indication for OUD use (vs pain or EtOH use disorder) is a potential source of error when classifying prescriptions in the <span class="in">`tx`</span> variable.  Consider future methods to potentially validate OUD vs pain treatment designations (as time allows):</span>
<span id="cb194-1473"><a href="#cb194-1473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1474"><a href="#cb194-1474" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Classify prescriptions as OUD vs pain vs EtOH use disorder based on KNN of names of other drugs prescribed by the provider</span>
<span id="cb194-1475"><a href="#cb194-1475" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Query <span class="co">[</span><span class="ot">FDA NDC DB</span><span class="co">](https://open.fda.gov/apis/drug/ndc/how-to-use-the-endpoint/)</span> for NPIs associated with the values of <span class="in">`Brnd_Name`</span> and <span class="in">`Gnrc_Name`</span> which were matched above, then search those NDCs for the indication for use on DailyMed</span>
<span id="cb194-1476"><a href="#cb194-1476" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Check DEA X waver for prescriber's NPI</span>
<span id="cb194-1477"><a href="#cb194-1477" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Check prescriber's buprenorphine panel limit vs count of buprenorphine prescribed</span>
<span id="cb194-1478"><a href="#cb194-1478" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Check prescriber's place of work in NPI DB</span>
<span id="cb194-1479"><a href="#cb194-1479" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>interrogate/validate CMS's method for translating a drug's NDC into a drug's brand and generic names</span>
<span id="cb194-1480"><a href="#cb194-1480" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb194-1481"><a href="#cb194-1481" aria-hidden="true" tabindex="-1"></a>Translation from NDC to a drug's brand/generic names likely simplifies many analyses, but could be a significant source of bias for our analysis.</span>
<span id="cb194-1482"><a href="#cb194-1482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1483"><a href="#cb194-1483" aria-hidden="true" tabindex="-1"></a><span class="fu"># Session Info</span></span>
<span id="cb194-1484"><a href="#cb194-1484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-1487"><a href="#cb194-1487" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb194-1488"><a href="#cb194-1488" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb194-1489"><a href="#cb194-1489" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>