<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Matthew Hoctor, PharmD">
<meta name="dcterms.date" content="2023-12-07">
<title>Classification of Ambiguous Treatments</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="classification_files/libs/clipboard/clipboard.min.js"></script>
<script src="classification_files/libs/quarto-html/quarto.js"></script>
<script src="classification_files/libs/quarto-html/popper.min.js"></script>
<script src="classification_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="classification_files/libs/quarto-html/anchor.min.js"></script>
<link href="classification_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="classification_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="classification_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="classification_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="classification_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script src="classification_files/libs/htmlwidgets-1.6.3/htmlwidgets.js"></script><script src="classification_files/libs/viz-1.8.2/viz.js"></script><link href="classification_files/libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="classification_files/libs/grViz-binding-1.0.10/grViz.js"></script>
</head>
<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li>
<a href="#classification-of-ambiguous-treatments" id="toc-classification-of-ambiguous-treatments" class="nav-link" data-scroll-target="#classification-of-ambiguous-treatments">Classification of Ambiguous Treatments</a>
  <ul>
<li><a href="#loading-data" id="toc-loading-data" class="nav-link" data-scroll-target="#loading-data">Loading Data</a></li>
  <li>
<a href="#find-classifiers" id="toc-find-classifiers" class="nav-link" data-scroll-target="#find-classifiers">Find Classifiers</a>
  <ul class="collapse">
<li><a href="#prescribing-pattern" id="toc-prescribing-pattern" class="nav-link" data-scroll-target="#prescribing-pattern">Prescribing Pattern</a></li>
  <li><a href="#continuous-predictors" id="toc-continuous-predictors" class="nav-link" data-scroll-target="#continuous-predictors">Continuous Predictors</a></li>
  </ul>
</li>
  <li>
<a href="#xgboost" id="toc-xgboost" class="nav-link" data-scroll-target="#xgboost">XGBoost</a>
  <ul class="collapse">
<li><a href="#dataset-preparation" id="toc-dataset-preparation" class="nav-link" data-scroll-target="#dataset-preparation">Dataset Preparation</a></li>
  <li><a href="#testing-training-prediction-sets" id="toc-testing-training-prediction-sets" class="nav-link" data-scroll-target="#testing-training-prediction-sets">Testing Training &amp; Prediction Sets</a></li>
  <li><a href="#model-fitting" id="toc-model-fitting" class="nav-link" data-scroll-target="#model-fitting">Model Fitting</a></li>
  <li><a href="#confusion-matrix" id="toc-confusion-matrix" class="nav-link" data-scroll-target="#confusion-matrix">Confusion Matrix</a></li>
  </ul>
</li>
  </ul>
</li>
  <li><a href="#prediction-for-bup_ambig" id="toc-prediction-for-bup_ambig" class="nav-link" data-scroll-target="#prediction-for-bup_ambig">Prediction for bup_ambig</a></li>
  <li>
<a href="#examining-predicted-data" id="toc-examining-predicted-data" class="nav-link" data-scroll-target="#examining-predicted-data">Examining Predicted Data</a>
  <ul>
<li><a href="#tabulate-by-nchsurc" id="toc-tabulate-by-nchsurc" class="nav-link" data-scroll-target="#tabulate-by-nchsurc">Tabulate by NCHSURC</a></li>
  <li><a href="#tabulate-by-provider-type" id="toc-tabulate-by-provider-type" class="nav-link" data-scroll-target="#tabulate-by-provider-type">Tabulate by provider type</a></li>
  <li><a href="#tabulate-by-generic-name" id="toc-tabulate-by-generic-name" class="nav-link" data-scroll-target="#tabulate-by-generic-name">Tabulate by generic name</a></li>
  <li><a href="#tabulate-by-days_27" id="toc-tabulate-by-days_27" class="nav-link" data-scroll-target="#tabulate-by-days_27">Tabulate by days_27</a></li>
  <li><a href="#tabulate-by-buprenorphine-hclnaloxone-hcl" id="toc-tabulate-by-buprenorphine-hclnaloxone-hcl" class="nav-link" data-scroll-target="#tabulate-by-buprenorphine-hclnaloxone-hcl">Tabulate by “Buprenorphine Hcl/Naloxone Hcl”</a></li>
  <li><a href="#tabulate-by-year" id="toc-tabulate-by-year" class="nav-link" data-scroll-target="#tabulate-by-year">Tabulate by year</a></li>
  <li><a href="#tabulate-by-nppa-rx-by-year" id="toc-tabulate-by-nppa-rx-by-year" class="nav-link" data-scroll-target="#tabulate-by-nppa-rx-by-year">Tabulate by NP/PA Rx by year</a></li>
  </ul>
</li>
  <li><a href="#cleanup" id="toc-cleanup" class="nav-link" data-scroll-target="#cleanup">Cleanup</a></li>
  <li><a href="#other-thoughts" id="toc-other-thoughts" class="nav-link" data-scroll-target="#other-thoughts">Other Thoughts</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session Info</a></li>
  </ul></nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Classification of Ambiguous Treatments</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Matthew Hoctor, PharmD </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 7, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header><div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># load libraries:</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.4.4     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.0
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># library(FLAME)                  # not suitable for matching on this dataset</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost">xgboost</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'xgboost'

The following object is masked from 'package:dplyr':

    slice</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/">caret</a></span><span class="op">)</span>                    <span class="co">#for confusionMatrix function</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Loading required package: lattice

Attaching package: 'caret'

The following object is masked from 'package:purrr':

    lift</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.fstpackage.org">fst</a></span><span class="op">)</span></span>
<span><span class="co"># library(DiagrammeR)               # for plotting XGBoost trees</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">Ckmeans.1d.dp</span><span class="op">)</span>            <span class="co"># for xgb.ggplot.importance function</span></span>
<span><span class="co"># library(ggplot2)</span></span>
<span><span class="co"># # library(MazamaSpatialUtils)</span></span>
<span><span class="co"># library(MazamaSpatialPlots)</span></span>
<span><span class="co"># library(plotly)</span></span>
<span><span class="co"># library(leaflet)</span></span>
<span><span class="co"># library(data.table)</span></span>
<span><span class="co"># library(lubridate)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="overview" class="level1"><h1>Overview</h1>
<p>We seek to understand the impact of the Comprehensive Addiction and Recovery Act (CARA) of 2016 on patterns of buprenorphine prescribing practices by examining medicare part D data. This exploratory analysis will download and compile medicare part D data before and after the legislation for years 2013-2021, and will examine variables of interest including buprenorphine Rx, methadone Rx, naltrexone Rx, prescriber type, cost to the patient, cost to Medicare, rural vs urban, and more.</p>
<p>Within this section we seek to classify potentially ambiguous entries corresponding to brand names <code>Buprenorphine</code> or <code>Buprenorphine Hcl</code>. There are several methods to consider including logistic regression, however we will attempt to classify these ambiguities according to the Fast Large-scale Almost Matching Exactly (FLAME) algorithm (<a href="https://arxiv.org/abs/1707.06315">described here</a>), as implemented in the <a href="https://cran.r-project.org/web/packages/FLAME/">FLAME package</a>. We can consider matching on several variables:</p>
<ul>
<li>The set of other medications prescribed, and/or specific high-yield medications (e.g.&nbsp;methadone, naltrexone, naloxone, etc.)</li>
<li>Prescriber’s state or county</li>
<li>Prescriber’s NCHSUR classification</li>
<li>Prescriber’s specialty</li>
<li>Unit drug cost; i.e.&nbsp;<code>Tot_Drug_Cost</code> / <code>Tot_Day_Suply</code>
</li>
</ul></section><section id="classification-of-ambiguous-treatments" class="level1"><h1>Classification of Ambiguous Treatments</h1>
<section id="loading-data" class="level2"><h2 class="anchored" data-anchor-id="loading-data">Loading Data</h2>
<p>To uniquely identify each row/observation we will add an <code>id</code> variable. First we will update the treatment variable to reflect ambiguous values (i.e.&nbsp;Brnd_Name is either <code>Buprenorphine</code> or <code>Buprenorphine Hcl</code>), setting the value of <code>tx</code> to <code>bup_ambig</code>:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load saved data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"dataset/data.RData"</span><span class="op">)</span></span>
<span><span class="co"># add/update variables</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># update 'tx' variable</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>tx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Brnd_Name</span> <span class="op">==</span> <span class="st">"Buprenorphine"</span> <span class="op">|</span> <span class="va">Brnd_Name</span> <span class="op">==</span> <span class="st">"Buprenorphine Hcl"</span>, <span class="st">"bup_ambig"</span>, <span class="va">tx</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># add 'id' variable corresponding to rownumber</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># set 'id' as first variable</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">id</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># check: table tx vs brand name for buprenorphine</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">Brnd_Name</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_oud"</span> <span class="op">|</span> <span class="va">data</span><span class="op">$</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_pain"</span> <span class="op">|</span> <span class="va">data</span><span class="op">$</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span><span class="op">]</span>,</span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">tx</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_oud"</span> <span class="op">|</span> <span class="va">data</span><span class="op">$</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_pain"</span> <span class="op">|</span> <span class="va">data</span><span class="op">$</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>                        
                         bup_ambig bup_oud bup_pain
  Belbuca                        0       0    11783
  Bunavail                       0     394        0
  Buprenex                       0       0      182
  Buprenorphine              19200       0        0
  Buprenorphine Hcl          32183       0        0
  Buprenorphine-Naloxone         0   66522        0
  Butrans                        0       0    34586
  Sublocade                      0     396        0
  Suboxone                       0   73461        0
  Zubsolv                        0    9832        0</code></pre>
</div>
</div>
</section><section id="find-classifiers" class="level2"><h2 class="anchored" data-anchor-id="find-classifiers">Find Classifiers</h2>
<section id="prescribing-pattern" class="level3"><h3 class="anchored" data-anchor-id="prescribing-pattern">Prescribing Pattern</h3>
<p>We can now create a dataset of NPI/year pairs corresponding to prescribers who have prescribed buprenorphine that year. We will use this dataset to extract the other drugs prescribed by these prescribers.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">providers</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_oud"</span> <span class="op">|</span> <span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_pain"</span> <span class="op">|</span> <span class="va">data</span><span class="op">$</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Prscrbr_NPI</span>, <span class="va">year</span>, <span class="va">tx</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Count number of NPI/year pairs in the <code>providers</code> dataset which have both tx == “bup_oud” and tx == “bup_pain”; these pairs will be less useful for classification.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">providers</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Prscrbr_NPI</span>, <span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    n_oud <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_oud"</span><span class="op">)</span>,</span>
<span>    n_pain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_pain"</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop_last"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n_oud</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">n_pain</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 6307</code></pre>
</div>
</div>
<p>Pivot the <code>providers</code> dataset to wide format such that each row is a unique NPI/year pair with new columns for each treatment bucket (i.e.&nbsp;<code>bup_oud</code>, <code>bup_pain</code>, <code>bup_ambig</code>):</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">providers_wide</span> <span class="op">&lt;-</span> <span class="va">providers</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span></span>
<span>    id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Prscrbr_NPI</span>, <span class="va">year</span><span class="op">)</span>,</span>
<span>    names_from <span class="op">=</span> <span class="va">tx</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">tx</span>,</span>
<span>    <span class="co"># should the line below be as follows:</span></span>
<span>    <span class="co"># values_fn = function(x) (length(x)/length(x)),</span></span>
<span>    values_fn <span class="op">=</span> <span class="va">length</span>,</span>
<span>    values_fill <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># examine providers with bup_ambig==1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">providers_wide</span><span class="op">$</span><span class="va">bup_ambig</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 48482</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">providers_wide</span><span class="op">$</span><span class="va">bup_ambig</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 105872</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">providers_wide</span><span class="op">$</span><span class="va">bup_ambig</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">providers_wide</span><span class="op">$</span><span class="va">bup_oud</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">providers_wide</span><span class="op">$</span><span class="va">bup_pain</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 2345</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span></span>
<span>  <span class="va">providers_wide</span><span class="op">$</span><span class="va">bup_oud</span><span class="op">[</span><span class="va">providers_wide</span><span class="op">$</span><span class="va">bup_ambig</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>,</span>
<span>  <span class="va">providers_wide</span><span class="op">$</span><span class="va">bup_pain</span><span class="op">[</span><span class="va">providers_wide</span><span class="op">$</span><span class="va">bup_ambig</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>,</span>
<span>  dnn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bup_oud"</span>, <span class="st">"bup_pain"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>       bup_pain
bup_oud     0     1
      0 14640  8007
      1 21873  3962</code></pre>
</div>
</div>
<p>We can now create a new dataset of observations corresponding to NPI/year pairs corresponding to prescribers who have prescribed buprenorphine that year:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create data_classification as an empty dataset:</span></span>
<span><span class="va">data_classification</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># iterate over years 2013-2021:</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">year</span> <span class="kw">in</span> <span class="fl">2013</span><span class="op">:</span><span class="fl">2021</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># load the data:</span></span>
<span>  <span class="va">data_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://www.fstpackage.org/reference/write_fst.html">read_fst</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"data/"</span>, <span class="va">year</span>, <span class="st">".fst"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># select only necessary variables</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Prscrbr_NPI</span>, <span class="va">Brnd_Name</span>, <span class="va">Gnrc_Name</span><span class="op">)</span></span>
<span>  <span class="co"># set the `year` variable:</span></span>
<span>  <span class="va">data_year</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="va">year</span></span>
<span>  </span>
<span>  <span class="co"># inner join with `providers_wide` dataset to restrict to NPI/year combinations from `providers`:</span></span>
<span>  <span class="va">data_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span></span>
<span>      <span class="va">data_year</span>,</span>
<span>      <span class="va">providers_wide</span>, </span>
<span>      by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Prscrbr_NPI"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>      relationship <span class="op">=</span> <span class="st">"many-to-one"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="co"># append the data to the `data_classification` dataset:</span></span>
<span>  <span class="va">data_classification</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">data_classification</span>, <span class="va">data_year</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># cleanup</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">data_year</span>, <span class="va">year</span><span class="op">)</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can now widen the <code>data_classification</code> dataset created above such that each row is a unique NPI/year pair with new columns for the generic names of each drug prescribed. First some numbers:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># count the number of distinct generic names in the dataset</span></span>
<span><span class="va">data_classification</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Gnrc_Name</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 1690</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># count number of distinct NPI/year pairs in the `providers` dataset</span></span>
<span><span class="va">providers</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Prscrbr_NPI</span>, <span class="va">year</span><span class="op">)</span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 154354</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># average number of generic names per NPI/year pair</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_classification</span><span class="op">)</span><span class="op">/</span><span class="fl">154354</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 60.98502</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># summing over bup_oud, bup_pain, and bup_ambig</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data_classification</span><span class="op">$</span><span class="va">bup_oud</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 5474274</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data_classification</span><span class="op">$</span><span class="va">bup_pain</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 3372611</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data_classification</span><span class="op">$</span><span class="va">bup_ambig</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 2871411</code></pre>
</div>
</div>
<p>Looking again at the most frequently prescribed drugs in the dataset, this time breaking it down by bup_pain and bup_oud:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">drug_freq</span> <span class="op">&lt;-</span> <span class="va">data_classification</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># exclude unhelpful observations with oud==1 &amp; pain==1 &amp; ambig==0</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">bup_oud</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">bup_pain</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">bup_ambig</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># exclude observations mapping to bup_ambig, i.e. Brnd_Name is either `Buprenorphine` or `Buprenorphine Hcl`</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">Brnd_Name</span> <span class="op">==</span> <span class="st">"Buprenorphine"</span> <span class="op">|</span> <span class="va">Brnd_Name</span> <span class="op">==</span> <span class="st">"Buprenorphine Hcl"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># compute summary statistics by grouping</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Gnrc_Name</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n_oud <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">bup_oud</span><span class="op">)</span>,</span>
<span>    n_pain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">bup_pain</span><span class="op">)</span>,</span>
<span>    n_ambig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">bup_ambig</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># display top 100</span></span>
<span><span class="va">drug_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 100 × 5
   Gnrc_Name                       n_oud n_pain n_ambig      n
   &lt;chr&gt;                           &lt;int&gt;  &lt;int&gt;   &lt;int&gt;  &lt;int&gt;
 1 Buprenorphine Hcl/Naloxone Hcl 147026   6548   43225 147026
 2 Gabapentin                      72336  42627   42398 123653
 3 Oxycodone Hcl                   51662  60051   48102 119308
 4 Albuterol Sulfate               67063  26808   28373 103325
 5 Bupropion Hcl                   68832  21479   29574  97909
 6 Tramadol Hcl                    42371  47663   38442  97777
 7 Duloxetine Hcl                  55374  35196   33976  97665
 8 Metformin Hcl                   62366  24110   26078  95787
 9 Levothyroxine Sodium            59981  25850   27672  95775
10 Morphine Sulfate                34665  50362   39188  90650
# ℹ 90 more rows</code></pre>
</div>
</div>
<p>Normalize the counts by dividing by the total number of NPI/year pairs in the dataset; then compute a contrast score and weighted contrast score for each drug; the contrast will be the absolute value of the difference between the normalized counts for OUD and pain over the sum of the normalized counts for OUD and pain. The weighted contrast will be the contrast score multiplied by n_ambig:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># calc column totals:</span></span>
<span><span class="va">N_oud</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">drug_freq</span><span class="op">$</span><span class="va">n_oud</span><span class="op">)</span></span>
<span><span class="va">N_pain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">drug_freq</span><span class="op">$</span><span class="va">n_pain</span><span class="op">)</span></span>
<span><span class="va">N_ambig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">drug_freq</span><span class="op">$</span><span class="va">n_ambig</span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">drug_freq</span><span class="op">$</span><span class="va">n</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># mutate columns:</span></span>
<span><span class="va">drug_freq</span> <span class="op">&lt;-</span> <span class="va">drug_freq</span> <span class="op">|&gt;</span> </span>
<span><span class="co"># normalize columns:</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    n_oud <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">signif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">*</span><span class="va">n_oud</span><span class="op">/</span><span class="va">N_oud</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    n_pain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">signif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">*</span><span class="va">n_pain</span><span class="op">/</span><span class="va">N_pain</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    n_ambig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">signif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">*</span><span class="va">n_ambig</span><span class="op">/</span><span class="va">N_ambig</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">signif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">*</span><span class="va">n</span><span class="op">/</span><span class="va">N</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># add contrasts columns for OUD vs pain</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    contrast <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">signif</a></span><span class="op">(</span><span class="op">(</span><span class="va">n_oud</span><span class="op">-</span><span class="va">n_pain</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">n_oud</span><span class="op">+</span><span class="va">n_pain</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    w_contrast <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">signif</a></span><span class="op">(</span><span class="va">n_ambig</span><span class="op">*</span><span class="op">(</span><span class="va">n_oud</span><span class="op">-</span><span class="va">n_pain</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">n_oud</span><span class="op">+</span><span class="va">n_pain</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># display top 100</span></span>
<span><span class="va">drug_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 100 × 7
   Gnrc_Name                      n_oud n_pain n_ambig     n contrast w_contrast
   &lt;chr&gt;                          &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
 1 Buprenorphine Hcl/Naloxone Hcl 27.9    2.06   15.3  16       0.862      13.2 
 2 Morphine Sulfate                6.59  15.9    13.9   9.88   -0.414      -5.75
 3 Oxycodone Hcl                   9.82  18.9    17.1  13      -0.316      -5.41
 4 Tramadol Hcl                    8.05  15      13.6  10.7    -0.302      -4.1 
 5 Diclofenac Sodium               6.16  12.6    10.3   8.47   -0.343      -3.54
 6 Pregabalin                      7.25  12.8    12.7   9.34   -0.277      -3.52
 7 Oxycodone Hcl/Acetaminophen     7.35  13.4    11.5   9.46   -0.292      -3.35
 8 Bupropion Hcl                  13.1    6.77   10.5  10.7     0.319       3.34
 9 Fentanyl                        3.55   9.52    7.28  5.7    -0.457      -3.33
10 Quetiapine Fumarate            11      4.74    7.97  8.45    0.398       3.17
# ℹ 90 more rows</code></pre>
</div>
</div>
<p>Assess the contrasts:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># sum weighted contrast over top 50 entries</span></span>
<span><span class="va">drug_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] -1.83</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># sum absolute value of weighted contrast over top 50 entries</span></span>
<span><span class="va">drug_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 128.85</code></pre>
</div>
</div>
<p>This relatively low value suggests that the top 50 generic names are not more sensitive to OUD or to pain.</p>
<p>Repeating the above analysis for Brand Name:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">brnd_freq</span> <span class="op">&lt;-</span> <span class="va">data_classification</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># exclude unhelpful observations with oud==1 &amp; pain==1 &amp; ambig==0</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">bup_oud</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">bup_pain</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">bup_ambig</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># exclude observations mapping to bup_ambig, i.e. Brnd_Name is either `Buprenorphine` or `Buprenorphine Hcl`</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">Brnd_Name</span> <span class="op">==</span> <span class="st">"Buprenorphine"</span> <span class="op">|</span> <span class="va">Brnd_Name</span> <span class="op">==</span> <span class="st">"Buprenorphine Hcl"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># compute summary statistics by grouping</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Brnd_Name</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n_oud <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">bup_oud</span><span class="op">)</span>,</span>
<span>    n_pain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">bup_pain</span><span class="op">)</span>,</span>
<span>    n_ambig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">bup_ambig</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># calc column totals:</span></span>
<span><span class="va">N_oud</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">brnd_freq</span><span class="op">$</span><span class="va">n_oud</span><span class="op">)</span></span>
<span><span class="va">N_pain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">brnd_freq</span><span class="op">$</span><span class="va">n_pain</span><span class="op">)</span></span>
<span><span class="va">N_ambig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">brnd_freq</span><span class="op">$</span><span class="va">n_ambig</span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">brnd_freq</span><span class="op">$</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="co"># mutate columns:</span></span>
<span><span class="va">brnd_freq</span> <span class="op">&lt;-</span> <span class="va">brnd_freq</span> <span class="op">|&gt;</span> </span>
<span><span class="co"># normalize columns:</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    n_oud <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">signif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">*</span><span class="va">n_oud</span><span class="op">/</span><span class="va">N_oud</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    n_pain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">signif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">*</span><span class="va">n_pain</span><span class="op">/</span><span class="va">N_pain</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    n_ambig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">signif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">*</span><span class="va">n_ambig</span><span class="op">/</span><span class="va">N_ambig</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">signif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">*</span><span class="va">n</span><span class="op">/</span><span class="va">N</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># add contrasts columns for OUD vs pain</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    contrast <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">signif</a></span><span class="op">(</span><span class="op">(</span><span class="va">n_oud</span><span class="op">-</span><span class="va">n_pain</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">n_oud</span><span class="op">+</span><span class="va">n_pain</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    w_contrast <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">signif</a></span><span class="op">(</span><span class="va">n_ambig</span><span class="op">*</span><span class="op">(</span><span class="va">n_oud</span><span class="op">-</span><span class="va">n_pain</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">n_oud</span><span class="op">+</span><span class="va">n_pain</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># display top 100</span></span>
<span><span class="va">brnd_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 100 × 7
   Brnd_Name               n_oud n_pain n_ambig     n contrast w_contrast
   &lt;chr&gt;                   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
 1 Suboxone                13.6   0.853    6.91  7.8     0.882       6.09
 2 Buprenorphine-Naloxone  12.4   0.97     6.91  7.13    0.855       5.91
 3 Fentanyl                 3.42  9.13     7.04  5.5    -0.455      -3.2 
 4 Morphine Sulfate Er      4.3   9.36     8.36  6.15   -0.37       -3.1 
 5 Tizanidine Hcl           5.41 10.2      9.6   7.18   -0.307      -2.95
 6 Tramadol Hcl             7.5  12.2     11.2   9.31   -0.239      -2.67
 7 Oxycodone-Acetaminophen  6.19 10.7      9.96  7.87   -0.267      -2.66
 8 Oxycontin                3.13  7.71     6.23  4.69   -0.423      -2.63
 9 Baclofen                 5.22  9.48     8.86  6.79   -0.29       -2.57
10 Morphine Sulfate         2.16  6.05     5.25  3.51   -0.474      -2.49
# ℹ 90 more rows</code></pre>
</div>
</div>
<p>Assess the contrasts:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># sum weighted contrast over top 50 entries</span></span>
<span><span class="va">brnd_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] -5.36</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># sum absolute value of weighted contrast over top 50 entries</span></span>
<span><span class="va">brnd_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 108.98</code></pre>
</div>
</div>
<p>These values are similar, but have a somewhat lower absolute value. We can assess the top 100 and top 200 brand and generics similarly:</p>
<p>For the generics:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># sum weighted contrast over top 100 entries</span></span>
<span><span class="va">drug_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 17.493</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># sum absolute value of weighted contrast over top 100 entries</span></span>
<span><span class="va">drug_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 172.107</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># sum weighted contrast over top 200 entries</span></span>
<span><span class="va">drug_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 10.998</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># sum absolute value of weighted contrast over top 50 entries</span></span>
<span><span class="va">drug_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 203.344</code></pre>
</div>
</div>
<p>For the brands:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># sum weighted contrast over top 50 entries</span></span>
<span><span class="va">brnd_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 18.738</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># sum absolute value of weighted contrast over top 50 entries</span></span>
<span><span class="va">brnd_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 155.642</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># sum weighted contrast over top 50 entries</span></span>
<span><span class="va">brnd_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 21.603</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># sum absolute value of weighted contrast over top 50 entries</span></span>
<span><span class="va">brnd_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 192.119</code></pre>
</div>
</div>
<p>The top 100 generic drugs seems like a sweet spot; we will use the generic names for classification of ambiguous observations:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">generic_top_100</span> <span class="op">&lt;-</span> <span class="va">drug_freq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w_contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Gnrc_Name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># create new dataset from drug_classification with only top 50 generic names</span></span>
<span><span class="va">gnrc_100_w</span> <span class="op">&lt;-</span> <span class="va">data_classification</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Gnrc_Name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">generic_top_100</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># widen the dataset to create new columns for each of the top drugs</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span></span>
<span>    <span class="co"># including bup_pain, bup_oud, bup_ambig to carry them forward</span></span>
<span>    id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Prscrbr_NPI</span>, <span class="va">year</span>, <span class="va">bup_pain</span>, <span class="va">bup_oud</span>, <span class="va">bup_ambig</span><span class="op">)</span>,</span>
<span>    names_from <span class="op">=</span> <span class="va">Gnrc_Name</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">Gnrc_Name</span>,</span>
<span>    values_fn <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    values_fill <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can now create 100 new variables in the main dataset, <code>data</code>, one for each of the top generic names, which will be 1 if the provider prescribed the medication in the given year, and 0 otherwise; i.e.&nbsp;for each observation in <code>data</code> the NPI/year pair will match with the NPI/year pair in data_classification.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_gnrc_100</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  <span class="va">gnrc_100_w</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Prscrbr_NPI"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>  relationship <span class="op">=</span> <span class="st">"many-to-one"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="continuous-predictors" class="level3"><h3 class="anchored" data-anchor-id="continuous-predictors">Continuous Predictors</h3>
<p>Adding other potential predictors including average drug cost per day, average days supply prescribed with summary statistics for unit cost and average days supply by tx:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_gnrc_100</span><span class="op">$</span><span class="va">unit_cst</span> <span class="op">&lt;-</span> <span class="va">data_gnrc_100</span><span class="op">$</span><span class="va">Tot_Drug_Cst</span><span class="op">/</span><span class="va">data_gnrc_100</span><span class="op">$</span><span class="va">Tot_Day_Suply</span></span>
<span><span class="va">data_gnrc_100</span><span class="op">$</span><span class="va">days_rx</span> <span class="op">&lt;-</span> <span class="va">data_gnrc_100</span><span class="op">$</span><span class="va">Tot_Day_Suply</span><span class="op">/</span><span class="va">data_gnrc_100</span><span class="op">$</span><span class="va">Tot_Clms</span></span>
<span><span class="co"># summary statistics</span></span>
<span><span class="va">data_gnrc_100</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span> <span class="op">|</span> <span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_oud"</span> <span class="op">|</span> <span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_pain"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">tx</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    avg_unit_cst <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">unit_cst</span><span class="op">)</span>,</span>
<span>    IQR_unit_cst <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/IQR.html">IQR</a></span><span class="op">(</span><span class="va">unit_cst</span><span class="op">)</span>,</span>
<span>    avg_days_rx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">days_rx</span><span class="op">)</span>,</span>
<span>    IQR_days_rx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/IQR.html">IQR</a></span><span class="op">(</span><span class="va">days_rx</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  tx        avg_unit_cst IQR_unit_cst avg_days_rx IQR_days_rx
  &lt;chr&gt;            &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
1 bup_ambig         7.05         7.97        25.9       3.20 
2 bup_oud          13.9          8.60        21.9      12.3  
3 bup_pain         16.8          8.22        28.2       0.824</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Summary statistics for 'Buprenorphine Hcl' and 'Buprenorphine' separately</span></span>
<span><span class="va">data_gnrc_100</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Brnd_Name</span> <span class="op">==</span> <span class="st">"Buprenorphine Hcl"</span> <span class="op">|</span> <span class="va">Brnd_Name</span> <span class="op">==</span> <span class="st">"Buprenorphine"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Brnd_Name</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    avg_unit_cst <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">unit_cst</span><span class="op">)</span>,</span>
<span>    IQR_unit_cst <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/IQR.html">IQR</a></span><span class="op">(</span><span class="va">unit_cst</span><span class="op">)</span>,</span>
<span>    avg_days_rx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">days_rx</span><span class="op">)</span>,</span>
<span>    IQR_days_rx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/IQR.html">IQR</a></span><span class="op">(</span><span class="va">days_rx</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  Brnd_Name         avg_unit_cst IQR_unit_cst avg_days_rx IQR_days_rx
  &lt;chr&gt;                    &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
1 Buprenorphine            12.3          4.05        27.8       0.220
2 Buprenorphine Hcl         3.90         2.31        24.7       7.44 </code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># plot histogram days supply by tx</span></span>
<span><span class="va">data_gnrc_100</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span> <span class="op">|</span> <span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_oud"</span> <span class="op">|</span> <span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_pain"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">days_rx</span>, fill <span class="op">=</span> <span class="va">tx</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># scale x axis to 0-45</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">tx</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 289 rows containing non-finite values (`stat_bin()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 6 rows containing missing values (`geom_bar()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="classification_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># plot histogram unit cost by tx</span></span>
<span><span class="va">data_gnrc_100</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span> <span class="op">|</span> <span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_oud"</span> <span class="op">|</span> <span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_pain"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">unit_cst</span>, fill <span class="op">=</span> <span class="va">tx</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># scale x axis to 0-45</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">tx</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 680 rows containing non-finite values (`stat_bin()`).
Removed 6 rows containing missing values (`geom_bar()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="classification_files/figure-html/unnamed-chunk-17-2.png" class="img-fluid" width="672"></p>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># plot histogram unit cost by brnd for all bup_ambig</span></span>
<span><span class="va">data_gnrc_100</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">unit_cst</span>, fill <span class="op">=</span> <span class="va">Brnd_Name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># scale x axis to 0-45</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Brnd_Name</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 7 rows containing non-finite values (`stat_bin()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4 rows containing missing values (`geom_bar()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="classification_files/figure-html/unnamed-chunk-17-3.png" class="img-fluid" width="672"></p>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># plot histogram unit cost by brnd for all bup_oud</span></span>
<span><span class="va">data_gnrc_100</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_oud"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">unit_cst</span>, fill <span class="op">=</span> <span class="va">Brnd_Name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># scale x axis to 0-45</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Brnd_Name</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 492 rows containing non-finite values (`stat_bin()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 8 rows containing missing values (`geom_bar()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="classification_files/figure-html/unnamed-chunk-17-4.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This preliminary analysis of these potential predictors suggests that average unit cost is not likely a good predictor, as the ambiguous entries are all generic and thus tend to be much cheaper; however days supply of 27 days or fewer could potentially be a good predictor. We will include days supply less than or equal to 27 as a new variable and cleanup the rest:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_gnrc_100</span><span class="op">$</span><span class="va">days_27</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>  <span class="va">data_gnrc_100</span><span class="op">$</span><span class="va">days_rx</span> <span class="op">&lt;=</span> <span class="fl">27</span>, </span>
<span>  <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="xgboost" class="level2"><h2 class="anchored" data-anchor-id="xgboost">XGBoost</h2>
<section id="dataset-preparation" class="level3"><h3 class="anchored" data-anchor-id="dataset-preparation">Dataset Preparation</h3>
<p>Prepare a dataset for XGBoost. Using <code>data.matrix</code> and then <code>xgb.DMatrix</code>. Note that for <code>data.matrix</code>, “Logical and factor columns are converted to integers. Character columns are first converted to factors and then to integers.”</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># first filtering to relevant observations and intentionally creating a numeric treatment variable</span></span>
<span><span class="va">data_xgb</span> <span class="op">&lt;-</span> <span class="va">data_gnrc_100</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># filter to only include buprenorphine observations</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span> <span class="op">|</span> <span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_oud"</span> <span class="op">|</span> <span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_pain"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># exclude unhelpful observations with oud==1 &amp; pain==1 &amp; ambig==0</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">bup_oud</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">bup_pain</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">bup_ambig</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># convert tx variable to numeric: bup_oud = 1, bup_pain = 2, bup_ambig = 3</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>tx_num <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_oud"</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>    <span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_pain"</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>    <span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span> <span class="op">~</span> <span class="fl">3</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># table tx vs tx_num to verify encoding</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data_xgb</span><span class="op">$</span><span class="va">tx</span>, <span class="va">data_xgb</span><span class="op">$</span><span class="va">tx_num</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>           
                 1      2      3
  bup_ambig      0      0  51383
  bup_oud   147418      0      0
  bup_pain       0  44119      0</code></pre>
</div>
</div>
<p>Proceeding to remove variables which will not be matched on and then convert to a matrix:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_xgb</span> <span class="op">&lt;-</span> <span class="va">data_xgb</span> <span class="op">|&gt;</span>    <span class="co"># remove variables which will not be matched on (comment out variables to keep)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span></span>
<span>    <span class="op">-</span><span class="va">Prscrbr_NPI</span>,</span>
<span>    <span class="op">-</span><span class="va">Prscrbr_Last_Org_Name</span>, </span>
<span>    <span class="op">-</span><span class="va">Prscrbr_First_Name</span>, </span>
<span>    <span class="op">-</span><span class="va">Prscrbr_City</span>, </span>
<span>    <span class="co"># -Prscrbr_State_Abrvtn, </span></span>
<span>    <span class="op">-</span><span class="va">Prscrbr_State_FIPS</span>, </span>
<span>    <span class="op">-</span><span class="va">Prscrbr_Type</span>, </span>
<span>    <span class="op">-</span><span class="va">Prscrbr_Type_Src</span>, </span>
<span>    <span class="op">-</span><span class="va">Brnd_Name</span>, </span>
<span>    <span class="op">-</span><span class="va">Gnrc_Name</span>, </span>
<span>    <span class="op">-</span><span class="va">Tot_Clms</span>, </span>
<span>    <span class="op">-</span><span class="va">Tot_30day_Fills</span>, </span>
<span>    <span class="op">-</span><span class="va">Tot_Day_Suply</span>, </span>
<span>    <span class="op">-</span><span class="va">Tot_Drug_Cst</span>, </span>
<span>    <span class="op">-</span><span class="va">Tot_Benes</span>, </span>
<span>    <span class="op">-</span><span class="va">GE65_Sprsn_Flag</span>, </span>
<span>    <span class="op">-</span><span class="va">GE65_Tot_Clms</span>, </span>
<span>    <span class="op">-</span><span class="va">GE65_Tot_30day_Fills</span>, </span>
<span>    <span class="op">-</span><span class="va">GE65_Tot_Drug_Cst</span>, </span>
<span>    <span class="op">-</span><span class="va">GE65_Tot_Day_Suply</span>, </span>
<span>    <span class="op">-</span><span class="va">GE65_Bene_Sprsn_Flag</span>, </span>
<span>    <span class="op">-</span><span class="va">GE65_Tot_Benes</span>, </span>
<span>    <span class="op">-</span><span class="va">MAT_generic</span>, </span>
<span>    <span class="op">-</span><span class="va">MAT_brand</span>, </span>
<span>    <span class="op">-</span><span class="va">tx</span>,                   <span class="co"># no longer outcome variable</span></span>
<span>    <span class="co"># -year, </span></span>
<span>    <span class="op">-</span><span class="va">county_fips</span>, </span>
<span>    <span class="co"># -city_fixed, </span></span>
<span>    <span class="op">-</span><span class="va">random_fips</span>, </span>
<span>    <span class="op">-</span><span class="va">fips</span>, </span>
<span>    <span class="co"># -nchsurc, </span></span>
<span>    <span class="op">-</span><span class="va">ur</span>, </span>
<span>    <span class="co"># -type,</span></span>
<span>    <span class="op">-</span><span class="va">bup_pain</span>,</span>
<span>    <span class="op">-</span><span class="va">bup_oud</span>,</span>
<span>    <span class="op">-</span><span class="va">bup_ambig</span>,</span>
<span>    <span class="op">-</span><span class="va">unit_cst</span>,</span>
<span>    <span class="co"># -days_rx,</span></span>
<span>    <span class="op">-</span><span class="va">days_27</span>,</span>
<span>    <span class="co"># -tx_num,                 # outcome variable</span></span>
<span>    <span class="op">-</span><span class="va">id</span></span>
<span>    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="testing-training-prediction-sets" class="level3"><h3 class="anchored" data-anchor-id="testing-training-prediction-sets">Testing Training &amp; Prediction Sets</h3>
<p>Split off the set to be predicted from the testing/training data; and split the remaining data into training/testing sets:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># the data to be predicted</span></span>
<span><span class="va">data_xgb.pred</span> <span class="op">&lt;-</span> <span class="va">data_xgb</span><span class="op">[</span><span class="va">data_xgb</span><span class="op">$</span><span class="va">tx_num</span> <span class="op">==</span> <span class="fl">3</span>,<span class="op">]</span></span>
<span><span class="co"># subset data_xgb to exclude observations to be predicted</span></span>
<span><span class="va">data_xgb</span> <span class="op">&lt;-</span> <span class="va">data_xgb</span><span class="op">[</span><span class="va">data_xgb</span><span class="op">$</span><span class="va">tx_num</span> <span class="op">!=</span> <span class="fl">3</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co">#set the seed with the system time</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#split the data into training and test sets using caret</span></span>
<span><span class="va">trainIndex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/createDataPartition.html">createDataPartition</a></span><span class="op">(</span></span>
<span>  <span class="va">data_xgb</span><span class="op">$</span><span class="va">tx_num</span>, </span>
<span>  p <span class="op">=</span> <span class="fl">.8</span>, </span>
<span>  list <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>  times <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">data_xgb.train</span> <span class="op">&lt;-</span> <span class="va">data_xgb</span><span class="op">[</span> <span class="va">trainIndex</span>,<span class="op">]</span></span>
<span><span class="va">data_xgb.test</span>  <span class="op">&lt;-</span> <span class="va">data_xgb</span><span class="op">[</span><span class="op">-</span><span class="va">trainIndex</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># check sum of rows of the 3 subsets of data_xgb</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_xgb.train</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_xgb.test</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_xgb.pred</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 242920</code></pre>
</div>
</div>
<p>Convert data_xgb ane each of the subsets to <code>xgb.DMatrix</code> datatype; this entails defining the outcome variable, removing it from the dataset, and converting to a matrix via <code><a href="https://rdrr.io/r/base/data.matrix.html">data.matrix()</a></code>:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Training set</span></span>
<span><span class="va">y.train</span> <span class="op">&lt;-</span> <span class="va">data_xgb.train</span><span class="op">$</span><span class="va">tx_num</span><span class="op">-</span><span class="fl">1</span>      <span class="co"># set y.train to tx_num - 1</span></span>
<span><span class="va">DM.data_xgb.train</span> <span class="op">&lt;-</span> <span class="va">data_xgb.train</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">tx_num</span><span class="op">)</span> <span class="op">|&gt;</span>                    <span class="co"># remove tx_num</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html">data.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>                      <span class="co"># convert to matrix</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">y.train</span><span class="op">)</span>          <span class="co"># convert to xgb.DMatrix</span></span>
<span></span>
<span><span class="co"># testing set</span></span>
<span><span class="va">y.test</span> <span class="op">&lt;-</span> <span class="va">data_xgb.test</span><span class="op">$</span><span class="va">tx_num</span><span class="op">-</span><span class="fl">1</span>        <span class="co"># set t.test to tx_num - 1</span></span>
<span><span class="va">DM.data_xgb.test</span> <span class="op">&lt;-</span> <span class="va">data_xgb.test</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">tx_num</span><span class="op">)</span> <span class="op">|&gt;</span>                    <span class="co"># remove tx_num</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html">data.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>                      <span class="co"># convert to matrix</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">y.test</span><span class="op">)</span>           <span class="co"># convert to xgb.DMatrix</span></span>
<span></span>
<span><span class="co"># prediction set</span></span>
<span><span class="va">DM.data_xgb.ambig</span> <span class="op">&lt;-</span> <span class="va">data_xgb.pred</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">tx_num</span><span class="op">)</span> <span class="op">|&gt;</span>                    <span class="co"># remove tx_num</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html">data.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>                      <span class="co"># convert to matrix</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span><span class="op">(</span><span class="op">)</span>                         <span class="co"># convert to xgb.DMatrix</span></span>
<span></span>
<span><span class="co"># full dataset</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">data_xgb</span><span class="op">$</span><span class="va">tx_num</span><span class="op">-</span><span class="fl">1</span>                  <span class="co"># set y to tx_num - 1</span></span>
<span><span class="va">DM.data_xgb</span> <span class="op">&lt;-</span> <span class="va">data_xgb</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">tx_num</span><span class="op">)</span> <span class="op">|&gt;</span>                    <span class="co"># remove tx_num</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html">data.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>                      <span class="co"># convert to matrix</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">y</span><span class="op">)</span>                <span class="co"># convert to xgb.DMatrix</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="model-fitting" class="level3"><h3 class="anchored" data-anchor-id="model-fitting">Model Fitting</h3>
<p>Now we can specify the parameters for the training of model, and run:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># watchlist &lt;- list(</span></span>
<span><span class="co">#   train = DM.data_xgb.train, </span></span>
<span><span class="co">#   test = DM.data_xgb.test)</span></span>
<span><span class="co"># params &lt;- list(</span></span>
<span><span class="co">#   objective = "binary:logistic")</span></span>
<span><span class="va">param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"objective"</span> <span class="op">=</span> <span class="st">"multi:softprob"</span>,</span>
<span>  <span class="st">"num_class"</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">xfit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.cv.html">xgb.cv</a></span><span class="op">(</span></span>
<span>  params <span class="op">=</span> <span class="va">param</span>,</span>
<span>  data <span class="op">=</span> <span class="va">DM.data_xgb</span>,</span>
<span>  nrounds <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  nfold <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  prediction <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  stratified <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  train_folds <span class="op">=</span> <span class="va">trainIndex</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] train-mlogloss:0.693147+0.000000    test-mlogloss:0.693147+0.000000 
[2] train-mlogloss:0.693147+0.000000    test-mlogloss:0.693147+0.000000 
[3] train-mlogloss:0.693147+0.000000    test-mlogloss:0.693147+0.000000 
[4] train-mlogloss:0.693147+0.000000    test-mlogloss:0.693147+0.000000 
[5] train-mlogloss:0.693147+0.000000    test-mlogloss:0.693147+0.000000 
[6] train-mlogloss:0.693147+0.000000    test-mlogloss:0.693147+0.000000 
[7] train-mlogloss:0.693147+0.000000    test-mlogloss:0.693147+0.000000 
[8] train-mlogloss:0.693147+0.000000    test-mlogloss:0.693147+0.000000 
[9] train-mlogloss:0.693147+0.000000    test-mlogloss:0.693147+0.000000 
[10]    train-mlogloss:0.693147+0.000000    test-mlogloss:0.693147+0.000000 </code></pre>
</div>
</div>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">xfit1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>##### xgb.cv 5-folds
 iter train_mlogloss_mean train_mlogloss_std test_mlogloss_mean
    1           0.6931472                  0          0.6931472
    2           0.6931472                  0          0.6931472
    3           0.6931472                  0          0.6931472
    4           0.6931472                  0          0.6931472
    5           0.6931472                  0          0.6931472
    6           0.6931472                  0          0.6931472
    7           0.6931472                  0          0.6931472
    8           0.6931472                  0          0.6931472
    9           0.6931472                  0          0.6931472
   10           0.6931472                  0          0.6931472
 test_mlogloss_std
                 0
                 0
                 0
                 0
                 0
                 0
                 0
                 0
                 0
                 0</code></pre>
</div>
</div>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"objective"</span> <span class="op">=</span> <span class="st">"multi:softprob"</span>,</span>
<span>  <span class="st">"num_class"</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">watchlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  train <span class="op">=</span> <span class="va">DM.data_xgb.train</span>, </span>
<span>  eval <span class="op">=</span> <span class="va">DM.data_xgb.test</span><span class="op">)</span></span>
<span></span>
<span><span class="va">xfit2</span> <span class="op">&lt;-</span> <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost</a></span><span class="op">(</span></span>
<span>  param <span class="op">=</span> <span class="va">param</span>, </span>
<span>  data <span class="op">=</span> <span class="va">DM.data_xgb.train</span>, </span>
<span>  nrounds<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] train-mlogloss:0.451794 
[2] train-mlogloss:0.318554 
[3] train-mlogloss:0.234901 </code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">xfit3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgb.train</a></span><span class="op">(</span></span>
<span>  param <span class="op">=</span> <span class="va">param</span>, </span>
<span>  data <span class="op">=</span> <span class="va">DM.data_xgb.train</span>, </span>
<span>  nrounds<span class="op">=</span><span class="fl">100</span>,</span>
<span>  watchlist <span class="op">=</span> <span class="va">watchlist</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] train-mlogloss:0.451794 eval-mlogloss:0.452048 
[2] train-mlogloss:0.318554 eval-mlogloss:0.318989 
[3] train-mlogloss:0.234901 eval-mlogloss:0.235564 
[4] train-mlogloss:0.178909 eval-mlogloss:0.179784 
[5] train-mlogloss:0.140474 eval-mlogloss:0.141479 
[6] train-mlogloss:0.113291 eval-mlogloss:0.114386 
[7] train-mlogloss:0.093936 eval-mlogloss:0.095247 
[8] train-mlogloss:0.079922 eval-mlogloss:0.081313 
[9] train-mlogloss:0.069755 eval-mlogloss:0.071354 
[10]    train-mlogloss:0.062279 eval-mlogloss:0.064080 
[11]    train-mlogloss:0.056789 eval-mlogloss:0.058660 
[12]    train-mlogloss:0.052647 eval-mlogloss:0.054760 
[13]    train-mlogloss:0.049466 eval-mlogloss:0.051823 
[14]    train-mlogloss:0.047228 eval-mlogloss:0.049773 
[15]    train-mlogloss:0.045321 eval-mlogloss:0.048069 
[16]    train-mlogloss:0.043912 eval-mlogloss:0.046854 
[17]    train-mlogloss:0.042925 eval-mlogloss:0.045998 
[18]    train-mlogloss:0.041936 eval-mlogloss:0.045284 
[19]    train-mlogloss:0.041295 eval-mlogloss:0.044829 
[20]    train-mlogloss:0.040838 eval-mlogloss:0.044514 
[21]    train-mlogloss:0.040345 eval-mlogloss:0.044281 
[22]    train-mlogloss:0.039989 eval-mlogloss:0.044147 
[23]    train-mlogloss:0.039671 eval-mlogloss:0.044077 
[24]    train-mlogloss:0.039376 eval-mlogloss:0.043977 
[25]    train-mlogloss:0.039180 eval-mlogloss:0.043880 
[26]    train-mlogloss:0.039008 eval-mlogloss:0.043835 
[27]    train-mlogloss:0.038813 eval-mlogloss:0.043831 
[28]    train-mlogloss:0.038545 eval-mlogloss:0.043752 
[29]    train-mlogloss:0.037961 eval-mlogloss:0.043564 
[30]    train-mlogloss:0.037574 eval-mlogloss:0.043596 
[31]    train-mlogloss:0.037280 eval-mlogloss:0.043624 
[32]    train-mlogloss:0.036867 eval-mlogloss:0.043697 
[33]    train-mlogloss:0.036452 eval-mlogloss:0.043672 
[34]    train-mlogloss:0.036062 eval-mlogloss:0.043610 
[35]    train-mlogloss:0.035839 eval-mlogloss:0.043650 
[36]    train-mlogloss:0.035412 eval-mlogloss:0.043774 
[37]    train-mlogloss:0.035310 eval-mlogloss:0.043797 
[38]    train-mlogloss:0.035148 eval-mlogloss:0.043794 
[39]    train-mlogloss:0.035010 eval-mlogloss:0.043866 
[40]    train-mlogloss:0.034584 eval-mlogloss:0.043858 
[41]    train-mlogloss:0.034446 eval-mlogloss:0.043857 
[42]    train-mlogloss:0.034389 eval-mlogloss:0.043845 
[43]    train-mlogloss:0.034035 eval-mlogloss:0.043949 
[44]    train-mlogloss:0.033896 eval-mlogloss:0.043921 
[45]    train-mlogloss:0.033555 eval-mlogloss:0.043897 
[46]    train-mlogloss:0.033484 eval-mlogloss:0.043928 
[47]    train-mlogloss:0.033187 eval-mlogloss:0.043820 
[48]    train-mlogloss:0.032889 eval-mlogloss:0.043887 
[49]    train-mlogloss:0.032651 eval-mlogloss:0.043975 
[50]    train-mlogloss:0.032455 eval-mlogloss:0.044047 
[51]    train-mlogloss:0.032366 eval-mlogloss:0.044105 
[52]    train-mlogloss:0.032178 eval-mlogloss:0.044134 
[53]    train-mlogloss:0.031926 eval-mlogloss:0.044256 
[54]    train-mlogloss:0.031590 eval-mlogloss:0.044395 
[55]    train-mlogloss:0.031414 eval-mlogloss:0.044380 
[56]    train-mlogloss:0.031256 eval-mlogloss:0.044407 
[57]    train-mlogloss:0.031189 eval-mlogloss:0.044404 
[58]    train-mlogloss:0.030939 eval-mlogloss:0.044481 
[59]    train-mlogloss:0.030769 eval-mlogloss:0.044478 
[60]    train-mlogloss:0.030503 eval-mlogloss:0.044566 
[61]    train-mlogloss:0.030483 eval-mlogloss:0.044565 
[62]    train-mlogloss:0.030260 eval-mlogloss:0.044662 
[63]    train-mlogloss:0.030057 eval-mlogloss:0.044680 
[64]    train-mlogloss:0.029799 eval-mlogloss:0.044594 
[65]    train-mlogloss:0.029612 eval-mlogloss:0.044735 
[66]    train-mlogloss:0.029497 eval-mlogloss:0.044759 
[67]    train-mlogloss:0.029363 eval-mlogloss:0.044858 
[68]    train-mlogloss:0.029148 eval-mlogloss:0.044943 
[69]    train-mlogloss:0.029084 eval-mlogloss:0.044941 
[70]    train-mlogloss:0.028988 eval-mlogloss:0.044981 
[71]    train-mlogloss:0.028755 eval-mlogloss:0.045040 
[72]    train-mlogloss:0.028613 eval-mlogloss:0.045161 
[73]    train-mlogloss:0.028551 eval-mlogloss:0.045126 
[74]    train-mlogloss:0.028436 eval-mlogloss:0.045169 
[75]    train-mlogloss:0.028232 eval-mlogloss:0.045232 
[76]    train-mlogloss:0.028221 eval-mlogloss:0.045238 
[77]    train-mlogloss:0.028095 eval-mlogloss:0.045238 
[78]    train-mlogloss:0.027988 eval-mlogloss:0.045257 
[79]    train-mlogloss:0.027903 eval-mlogloss:0.045255 
[80]    train-mlogloss:0.027722 eval-mlogloss:0.045203 
[81]    train-mlogloss:0.027507 eval-mlogloss:0.045278 
[82]    train-mlogloss:0.027443 eval-mlogloss:0.045281 
[83]    train-mlogloss:0.027321 eval-mlogloss:0.045301 
[84]    train-mlogloss:0.027127 eval-mlogloss:0.045317 
[85]    train-mlogloss:0.026976 eval-mlogloss:0.045427 
[86]    train-mlogloss:0.026777 eval-mlogloss:0.045488 
[87]    train-mlogloss:0.026626 eval-mlogloss:0.045568 
[88]    train-mlogloss:0.026500 eval-mlogloss:0.045598 
[89]    train-mlogloss:0.026439 eval-mlogloss:0.045632 
[90]    train-mlogloss:0.026262 eval-mlogloss:0.045622 
[91]    train-mlogloss:0.026175 eval-mlogloss:0.045676 
[92]    train-mlogloss:0.026141 eval-mlogloss:0.045721 
[93]    train-mlogloss:0.026004 eval-mlogloss:0.045762 
[94]    train-mlogloss:0.025837 eval-mlogloss:0.045775 
[95]    train-mlogloss:0.025791 eval-mlogloss:0.045773 
[96]    train-mlogloss:0.025628 eval-mlogloss:0.045775 
[97]    train-mlogloss:0.025556 eval-mlogloss:0.045777 
[98]    train-mlogloss:0.025477 eval-mlogloss:0.045797 
[99]    train-mlogloss:0.025406 eval-mlogloss:0.045869 
[100]   train-mlogloss:0.025355 eval-mlogloss:0.045868 </code></pre>
</div>
</div>
<p>Overfitting seems to set in after ~30 iterations, so let’s create another model with 30 iterations:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">xfit4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgb.train</a></span><span class="op">(</span></span>
<span>  param <span class="op">=</span> <span class="va">param</span>, </span>
<span>  data <span class="op">=</span> <span class="va">DM.data_xgb.train</span>, </span>
<span>  nrounds<span class="op">=</span><span class="fl">30</span>,</span>
<span>  watchlist <span class="op">=</span> <span class="va">watchlist</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] train-mlogloss:0.451794 eval-mlogloss:0.452048 
[2] train-mlogloss:0.318554 eval-mlogloss:0.318989 
[3] train-mlogloss:0.234901 eval-mlogloss:0.235564 
[4] train-mlogloss:0.178909 eval-mlogloss:0.179784 
[5] train-mlogloss:0.140474 eval-mlogloss:0.141479 
[6] train-mlogloss:0.113291 eval-mlogloss:0.114386 
[7] train-mlogloss:0.093936 eval-mlogloss:0.095247 
[8] train-mlogloss:0.079922 eval-mlogloss:0.081313 
[9] train-mlogloss:0.069755 eval-mlogloss:0.071354 
[10]    train-mlogloss:0.062279 eval-mlogloss:0.064080 
[11]    train-mlogloss:0.056789 eval-mlogloss:0.058660 
[12]    train-mlogloss:0.052647 eval-mlogloss:0.054760 
[13]    train-mlogloss:0.049466 eval-mlogloss:0.051823 
[14]    train-mlogloss:0.047228 eval-mlogloss:0.049773 
[15]    train-mlogloss:0.045321 eval-mlogloss:0.048069 
[16]    train-mlogloss:0.043912 eval-mlogloss:0.046854 
[17]    train-mlogloss:0.042925 eval-mlogloss:0.045998 
[18]    train-mlogloss:0.041936 eval-mlogloss:0.045284 
[19]    train-mlogloss:0.041295 eval-mlogloss:0.044829 
[20]    train-mlogloss:0.040838 eval-mlogloss:0.044514 
[21]    train-mlogloss:0.040345 eval-mlogloss:0.044281 
[22]    train-mlogloss:0.039989 eval-mlogloss:0.044147 
[23]    train-mlogloss:0.039671 eval-mlogloss:0.044077 
[24]    train-mlogloss:0.039376 eval-mlogloss:0.043977 
[25]    train-mlogloss:0.039180 eval-mlogloss:0.043880 
[26]    train-mlogloss:0.039008 eval-mlogloss:0.043835 
[27]    train-mlogloss:0.038813 eval-mlogloss:0.043831 
[28]    train-mlogloss:0.038545 eval-mlogloss:0.043752 
[29]    train-mlogloss:0.037961 eval-mlogloss:0.043564 
[30]    train-mlogloss:0.037574 eval-mlogloss:0.043596 </code></pre>
</div>
</div>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb98"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">xfit4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>##### xgb.Booster
raw: 175.4 Kb 
call:
  xgb.train(params = param, data = DM.data_xgb.train, nrounds = 30, 
    watchlist = watchlist)
params (as set within xgb.train):
  objective = "multi:softprob", num_class = "2", validate_parameters = "TRUE"
xgb.attributes:
  niter
callbacks:
  cb.print.evaluation(period = print_every_n)
  cb.evaluation.log()
# of features: 106 
niter: 30
nfeatures : 106 
evaluation_log:
    iter train_mlogloss eval_mlogloss
       1     0.45179411     0.4520479
       2     0.31855382     0.3189890
---                                  
      29     0.03796147     0.0435637
      30     0.03757386     0.0435955</code></pre>
</div>
</div>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb100"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.plot.multi.trees.html">xgb.plot.multi.trees</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">xfit4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Column 2 ['No'] of item 2 is missing in item 1. Use fill=TRUE to fill with NA (NULL for list columns), or use.names=FALSE to ignore column names. use.names='check' (default from v1.12.2) emits this message and proceeds as if use.names=FALSE for  backwards compatibility. See news item 5 in v1.12.2 for options to control this message.</code></pre>
</div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-803aa0a26958e6ac60d1" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-803aa0a26958e6ac60d1">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       rankdir = \"LR\"]\n\nnode [color = \"DimGray\",\n      fillcolor = \"beige\",\n      style = \"filled\",\n      shape = \"rectangle\",\n      fontname = \"Helvetica\"]\n\nedge [color = \"DimGray\",\n     arrowsize = \"1.5\",\n     arrowhead = \"vee\",\n     fontname = \"Helvetica\"]\n\n  \"1\" [label = \"Buprenorphine Hcl/Naloxone Hcl (2.3769e+05)\nBuprenorphine (4.8944e+03)\ndays_rx (3.6667e+00)\nFluticasone Propion/Salmeterol (2.4628e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"2\" [label = \"type (  2.9243)\nTramadol Hcl (  8.2579)\nBuprenorphine Hcl/Naloxone Hcl (362.0892)\nBuprenorphine Hcl (803.1737)\nHydrocodone/Acetaminophen ( 12.6801)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"3\" [label = \"Buprenorphine (18081.8119)\nBuprenorphine Hcl/Naloxone Hcl ( 1916.4685)\nBuprenorphine Hcl (  269.3776)\ndays_rx (   18.0180)\nHydrocodone Bitartrate (    2.9521)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"4\" [label = \"Leaf (-1.5000e-08)\nNaltrexone Hcl ( 7.6599e-02)\nPaliperidone Palmitate ( 6.0708e+00)\nClozapine ( 4.7916e+00)\nyear ( 2.3159e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"5\" [label = \"nchsurc (4.8761e+00)\nyear (1.7918e+01)\nPregabalin (3.8187e+00)\nHydrocodone/Acetaminophen (3.1497e+01)\nLeaf (2.1750e-06)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"6\" [label = \"Oxycodone Myristate (382.8843)\nBuprenorphine Hcl ( 79.2943)\nTramadol Hcl ( 10.0791)\nHydrocodone/Acetaminophen (  4.2998)\nBuprenorphine (241.8992)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"7\" [label = \"days_rx (2310.2583)\nBuprenorphine Hcl (  62.1794)\nPregabalin (  47.8363)\nFentanyl (  13.1489)\nHydrocodone/Acetaminophen (   5.1752)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"8\" [label = \"Pregabalin ( 0.56708527)\nyear (13.19810771)\nLeaf (-0.00000006)\nBuprenorphine Hcl/Naloxone Hcl (12.13066482)\nBaclofen (14.16343689)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"9\" [label = \"Prscrbr_State_Abrvtn (1.8421e+01)\nLeaf (3.0000e-08)\nClozapine (6.3113e+00)\nTizanidine Hcl (1.1526e+02)\nMorphine Sulfate (5.0628e+01)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"10\" [label = \"Buprenorphine Hcl ( 1.0938e+02)\nLeaf (-8.8000e-08)\nyear ( 2.6128e+01)\nClozapine ( 2.5736e+00)\nMethocarbamol ( 1.7848e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"11\" [label = \"Buprenorphine Hcl (2.2311e+02)\nMorphine Sulfate (5.8561e+01)\nLeaf (4.5000e-08)\ntype (4.3404e-01)\ndays_rx (1.9023e+01)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"12\" [label = \"days_rx (180.814)\nBuprenorphine Hcl (105.875)\nHydrocodone/Acetaminophen ( 17.023)\nyear ( 50.442)\nMethadone Hcl ( 16.040)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"13\" [label = \"days_rx (627.839)\nBuprenorphine Hcl (324.141)\nTramadol Hcl ( 92.467)\nPregabalin ( 57.518)\nMirtazapine ( 30.387)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"14\" [label = \"Tapentadol Hcl ( 4.9883e+00)\nPrscrbr_State_Abrvtn ( 2.6962e-01)\nLeaf (-8.1000e-08)\nHydromorphone Hcl ( 8.4883e+00)\nOxycodone Hcl/Acetaminophen ( 4.9900e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"15\" [label = \"Leaf (0.0000)\nnchsurc (2.3886)\nBuprenorphine (9.0976)\ncity_fixed (0.7837)\nHydrocodone/Acetaminophen (6.4946)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"16\" [label = \"Leaf (-2.9000e-08)\nPrazosin Hcl ( 2.4379e+00)\nHydrocodone/Acetaminophen ( 9.9830e+00)\nHydromorphone Hcl ( 1.3723e+01)\nTapentadol Hcl ( 1.1135e+01)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"17\" [label = \"Leaf (-1.5000e-08)\nyear ( 9.5350e+01)\nCitalopram Hydrobromide ( 3.1223e+01)\nAlprazolam ( 1.9459e+01)\nBuprenorphine Hcl/Naloxone Hcl ( 1.1585e+01)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"18\" [label = \"Leaf (-1.5000e-08)\nPrazosin Hcl ( 4.8761e-02)\nyear ( 1.3524e-01)\ntype ( 5.3789e-01)\nTramadol Hcl ( 1.1834e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"19\" [label = \"Tizanidine Hcl (101.8598)\nTapentadol Hcl (  4.5293)\nHydrocodone/Acetaminophen ( 15.2714)\nBupropion Hcl (  4.7940)\nClozapine (  1.8332)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"20\" [label = \"Leaf (-2.7756e-17)\nTapentadol Hcl ( 1.2586e+01)\nCyclobenzaprine Hcl ( 1.0167e+01)\nyear ( 4.5620e+00)\nMethylphenidate Hcl ( 3.0322e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"21\" [label = \"days_rx ( 2.9205e+01)\nAlprazolam ( 1.6875e+01)\nCyclobenzaprine Hcl ( 5.5711e+00)\nyear ( 5.1781e+01)\nLeaf (-4.2800e-08)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"22\" [label = \"Buprenorphine Hcl (16.9889)\ncity_fixed (27.2371)\nyear (27.2869)\ndays_rx (59.4854)\nClozapine ( 1.4254)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"23\" [label = \"Atorvastatin Calcium ( 23.5949)\nBuprenorphine Hcl ( 37.9181)\ndays_rx (107.0059)\nyear ( 29.0775)\nHydrocodone Bitartrate (  6.0868)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"24\" [label = \"days_rx (253.431)\nyear (196.000)\nMorphine Sulfate ( 25.352)\nPregabalin ( 26.981)\ncity_fixed ( 22.513)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"25\" [label = \"Buprenorphine Hcl (229.078)\ndays_rx (343.042)\nFluticasone Propion/Salmeterol ( 51.443)\nyear ( 30.496)\nTramadol Hcl ( 17.192)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"26\" [label = \"Hydroxyzine Pamoate ( 2.7222)\nHydrocodone/Acetaminophen ( 2.9145)\nPromethazine Hcl ( 5.3902)\nnchsurc ( 3.4178)\nPregabalin (10.0931)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"27\" [label = \"Leaf (-2.3800e-07)\nZolpidem Tartrate ( 4.9012e+00)\nnchsurc ( 1.0535e+01)\nPaliperidone ( 7.8589e+00)\nPrscrbr_State_Abrvtn ( 2.9462e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"28\" [label = \"Leaf (1.5654e-06)\nHydromorphone Hcl (2.4072e+00)\nHydrocodone/Acetaminophen (5.6155e+00)\nOxycodone Hcl/Acetaminophen (2.6469e+00)\nMirtazapine (3.8974e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"29\" [label = \"Levothyroxine Sodium ( 2.4726e+01)\ndays_rx ( 3.8594e+01)\nLisinopril ( 7.0070e+00)\nCitalopram Hydrobromide ( 1.4189e+01)\nLeaf (-5.3100e-08)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"30\" [label = \"Clonazepam (3.2498)\ndays_rx (7.0006)\nFluticasone Propionate (6.5951)\nPrscrbr_State_Abrvtn (5.7333)\ncity_fixed (5.7471)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"31\" [label = \"Prscrbr_State_Abrvtn (20.2272)\ndays_rx ( 6.9398)\nEscitalopram Oxalate ( 1.9868)\nCyclobenzaprine Hcl ( 5.3153)\nLidocaine ( 2.5693)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"32\" [label = \"Leaf ( 0.0000)\ncity_fixed (13.4268)\ndays_rx (26.4160)\nCarisoprodol ( 8.9413)\nBenztropine Mesylate ( 3.8575)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"33\" [label = \"days_rx (66.4332)\nMethadone Hcl ( 1.8234)\nHydrocodone Bitartrate ( 5.1989)\ncity_fixed (10.0789)\nMetformin Hcl ( 6.6074)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"34\" [label = \"Buprenorphine Hcl (16.8340)\nyear (10.2113)\nPrscrbr_State_Abrvtn (16.8774)\nClozapine ( 1.2356)\nMeloxicam ( 9.2820)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"35\" [label = \"Naloxegol Oxalate ( 4.4176)\nZolpidem Tartrate (19.3114)\nPromethazine Hcl (10.0058)\nAtorvastatin Calcium (13.0693)\nOxcarbazepine ( 9.1826)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"36\" [label = \"year (6.9064e+01)\ndays_rx (1.3941e+02)\nPregabalin (6.8466e+00)\nLeaf (2.8100e-08)\nPramipexole Di-Hcl (2.8682e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"37\" [label = \"Buprenorphine Hcl (147.7543)\nCyclobenzaprine Hcl (  9.7123)\ndays_rx ( 93.9314)\nDiclofenac Sodium (  8.2446)\nHydrocodone/Acetaminophen (  7.6290)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"38\" [label = \"days_rx (473.955)\nPrscrbr_State_Abrvtn ( 37.864)\nNaloxone Hcl ( 14.132)\nDesvenlafaxine Succinate ( 19.310)\nTrazodone Hcl ( 17.366)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"39\" [label = \"Tizanidine Hcl (54.598)\nNaloxone Hcl (34.917)\nClonazepam (24.606)\nBuprenorphine Hcl (42.507)\nDextroamphetamine/Amphetamine (22.715)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"40\" [label = \"Leaf (-7.1553e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"41\" [label = \"Leaf (-7.3704e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"42\" [label = \"Leaf (9.654e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"43\" [label = \"Leaf (2.122e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"44\" [label = \"Leaf (5.02e-08)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"45\" [label = \"Leaf (1.4488e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"46\" [label = \"Leaf (3.962e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"47\" [label = \"Leaf (1.4827e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"48\" [label = \"Leaf (5.4922e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"49\" [label = \"Leaf (1.888e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"50\" [label = \"Leaf (1.1252e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"51\" [label = \"Leaf (-2.8e-09)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"52\" [label = \"Leaf (-2.2157e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"53\" [label = \"Leaf (-7.3332e-08)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"54\" [label = \"Leaf (-6.4032e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"55\" [label = \"Leaf (-1.279e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"56\" [label = \"Leaf (7.391e-08)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"57\" [label = \"Leaf (-8.898e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"58\" [label = \"Leaf (-5.44e-09)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"59\" [label = \"Leaf (-4.3668e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"60\" [label = \"Leaf (2.2059e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"61\" [label = \"Leaf (-1.3296e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"62\" [label = \"Leaf (3.0300e-08)\nOxycodone Hcl/Acetaminophen (3.8280e+00)\nDiclofenac Sodium (1.1948e+01)\ndays_rx (7.7203e+00)\ncity_fixed (1.1203e+01)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"63\" [label = \"Leaf (-2.9000e-08)\nPrscrbr_State_Abrvtn ( 3.5826e+00)\ndays_rx ( 2.2675e+00)\nPropranolol Hcl ( 1.3193e-02)\nOxcarbazepine ( 7.7590e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"64\" [label = \"Leaf (9.546e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"65\" [label = \"Leaf (3.962e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"66\" [label = \"Leaf (-1.2927e-06)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"67\" [label = \"Leaf (-6.9871e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"68\" [label = \"Leaf ( 0.0000)\nOxycodone Hcl/Acetaminophen ( 2.1238)\nButalb/Acetaminophen/Caffeine ( 2.6206)\nDiclofenac Sodium (10.4414)\ncity_fixed ( 1.1330)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"69\" [label = \"Leaf (-7.9100e-09)\nNaloxone Hcl ( 7.4899e+00)\nnchsurc ( 8.3745e+00)\ncity_fixed ( 1.2168e+01)\ndays_rx ( 1.0906e+01)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"70\" [label = \"Leaf (-1.584e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"71\" [label = \"Leaf (-4.582e-08)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"72\" [label = \"Leaf (9.7570e-07)\nyear (1.3305e+00)\nTramadol Hcl (1.1969e+00)\ncity_fixed (5.5786e+00)\nPrscrbr_State_Abrvtn (4.9166e-01)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"73\" [label = \"Hydrocodone/Acetaminophen (4.49357772)\nLeaf (0.00000022)\nSertraline Hcl (0.02620773)\nBuprenorphine Hcl (3.01852339)\ncity_fixed (3.66984272)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"74\" [label = \"Leaf (-1.2010e-07)\nLisinopril ( 7.9142e-01)\nMirtazapine ( 6.6297e-01)\nPrscrbr_State_Abrvtn ( 4.0421e-01)\nZolpidem Tartrate ( 2.0354e-01)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"75\" [label = \"Leaf (1.1720e-07)\nNaltrexone Hcl (3.1093e+00)\nBupropion Hcl (6.8510e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"76\" [label = \"Prazosin Hcl ( 1.5984e-02)\nHydroxyzine Hcl ( 5.8574e-01)\nPrscrbr_State_Abrvtn ( 9.0361e-01)\nLeaf (-5.1030e-07)\nBuprenorphine Hcl ( 4.3305e-01)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"77\" [label = \"Buprenorphine Hcl ( 4.9299e+00)\nLeaf (-4.3180e-07)\nHydroxyzine Hcl ( 4.9415e-01)\nMirtazapine ( 3.5999e-01)\nLisinopril ( 7.0171e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"78\" [label = \"Leaf (4.2090e-07)\ndays_rx (5.1035e-01)\nBuprenorphine Hcl (1.2307e+00)\nyear (8.0452e-01)\ncity_fixed (2.7664e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"79\" [label = \"Leaf (4.8520e-07)\nNaltrexone Hcl (1.5344e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"80\" [label = \"days_rx ( 5.23341)\ncity_fixed ( 0.42219)\nClonazepam ( 7.60317)\nButalb/Acetaminophen/Caffeine (10.95339)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"81\" [label = \"Leaf (-9.8700e-08)\nHydrocodone/Acetaminophen ( 4.2548e+00)\nPrazosin Hcl ( 3.7969e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"82\" [label = \"Hydromorphone Hcl (10.3702)\nyear ( 2.1070)\nTapentadol Hcl ( 3.2290)\ndays_rx (18.6124)\nLorazepam ( 2.0489)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"83\" [label = \"Prscrbr_State_Abrvtn (2.5808e+01)\ndays_rx (1.5856e+01)\nBuspirone Hcl (4.1713e+00)\ncity_fixed (3.2889e+00)\nLeaf (1.2820e-06)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"84\" [label = \"Leaf (5.847e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"85\" [label = \"Leaf (4.595e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"86\" [label = \"Leaf (7.9493e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"87\" [label = \"Leaf (3.5464e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"88\" [label = \"Leaf (2.9062e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"89\" [label = \"Leaf (1.4953e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"90\" [label = \"city_fixed ( 6.2896)\ndays_rx (30.9659)\nyear ( 7.9698)\nFluticasone Propion/Salmeterol ( 9.4902)\nLeaf ( 0.0000)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"91\" [label = \"days_rx (88.4899)\nFluticasone Propionate (23.1232)\ncity_fixed ( 2.6552)\nHydrocodone/Acetaminophen ( 8.4264)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"92\" [label = \"Leaf (3.9202e-06)\nPrscrbr_State_Abrvtn (8.7850e-01)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"93\" [label = \"Leaf (3.9570e-07)\nClonazepam (2.9424e-01)\nClonidine Hcl (1.8400e-01)\nTramadol Hcl (1.7842e+00)\nLidocaine (1.7006e+00)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"94\" [label = \"Leaf (-5.07e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"95\" [label = \"Leaf (-4.747e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"96\" [label = \"Leaf (-2.3988e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"97\" [label = \"Leaf (3.29e-08)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"98\" [label = \"Leaf (-6.37e-08)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"99\" [label = \"Leaf (-2.79e-08)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"100\" [label = \"Leaf (-8.4e-08)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"101\" [label = \"Leaf (-9.171e-08)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"102\" [label = \"Leaf (2.4367e-06)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"103\" [label = \"Leaf (4.794e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"104\" [label = \"Leaf (-4.881e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"105\" [label = \"Leaf (-1.136e-06)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"106\" [label = \"Leaf (3.54e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"107\" [label = \"Leaf (1.139e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"108\" [label = \"Leaf (1.89e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"109\" [label = \"Leaf (1.5e-08)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"110\" [label = \"Leaf (-2.607e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"111\" [label = \"Leaf (-1.8835e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"112\" [label = \"days_rx (1.3155)\nLeaf (0.0000)\nNaltrexone Hcl (1.1208)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"113\" [label = \"Leaf (-1.5830e-07)\ndays_rx ( 2.5887e-01)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"114\" [label = \"Leaf (2.1146e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"115\" [label = \"Leaf (2.221e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"116\" [label = \"days_rx (6.2755)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"117\" [label = \"Hydroxyzine Hcl (5.5049)\nNaproxen (2.1335)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"118\" [label = \"Leaf (3.2853e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"119\" [label = \"Leaf (2.756e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"120\" [label = \"Leaf (4.787e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"121\" [label = \"Leaf (8.142e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"122\" [label = \"Leaf (9.7e-08)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"123\" [label = \"Leaf (4.174e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"124\" [label = \"Leaf (1.5e-08)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"125\" [label = \"Leaf (2.183e-06)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"126\" [label = \"Leaf (-7.91e-09)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"127\" [label = \"Leaf (3.28e-07)\", fillcolor = \"#F5F5DC\", fontcolor = \"#000000\"] \n  \"1\"->\"2\" \n  \"2\"->\"4\" \n  \"3\"->\"6\" \n  \"5\"->\"8\" \n  \"6\"->\"10\" \n  \"7\"->\"12\" \n  \"8\"->\"14\" \n  \"9\"->\"16\" \n  \"10\"->\"18\" \n  \"11\"->\"20\" \n  \"12\"->\"22\" \n  \"13\"->\"24\" \n  \"14\"->\"26\" \n  \"19\"->\"28\" \n  \"21\"->\"30\" \n  \"22\"->\"32\" \n  \"23\"->\"34\" \n  \"24\"->\"36\" \n  \"25\"->\"38\" \n  \"26\"->\"40\" \n  \"29\"->\"42\" \n  \"30\"->\"44\" \n  \"31\"->\"46\" \n  \"33\"->\"48\" \n  \"34\"->\"50\" \n  \"35\"->\"52\" \n  \"36\"->\"54\" \n  \"37\"->\"56\" \n  \"38\"->\"58\" \n  \"39\"->\"60\" \n  \"15\"->\"62\" \n  \"28\"->\"64\" \n  \"32\"->\"66\" \n  \"16\"->\"68\" \n  \"63\"->\"70\" \n  \"4\"->\"72\" \n  \"73\"->\"74\" \n  \"72\"->\"76\" \n  \"76\"->\"78\" \n  \"77\"->\"80\" \n  \"20\"->\"82\" \n  \"80\"->\"84\" \n  \"82\"->\"86\" \n  \"83\"->\"88\" \n  \"17\"->\"90\" \n  \"18\"->\"92\" \n  \"68\"->\"94\" \n  \"69\"->\"96\" \n  \"90\"->\"98\" \n  \"91\"->\"100\" \n  \"93\"->\"102\" \n  \"62\"->\"104\" \n  \"27\"->\"106\" \n  \"92\"->\"108\" \n  \"78\"->\"110\" \n  \"74\"->\"112\" \n  \"112\"->\"114\" \n  \"75\"->\"116\" \n  \"81\"->\"118\" \n  \"116\"->\"120\" \n  \"117\"->\"122\" \n  \"79\"->\"124\" \n  \"113\"->\"126\" \n  \"1\"->\"3\" \n  \"2\"->\"5\" \n  \"3\"->\"7\" \n  \"5\"->\"9\" \n  \"6\"->\"11\" \n  \"7\"->\"13\" \n  \"8\"->\"15\" \n  \"9\"->\"17\" \n  \"10\"->\"19\" \n  \"11\"->\"21\" \n  \"12\"->\"23\" \n  \"13\"->\"25\" \n  \"14\"->\"27\" \n  \"19\"->\"29\" \n  \"21\"->\"31\" \n  \"22\"->\"33\" \n  \"23\"->\"35\" \n  \"24\"->\"37\" \n  \"25\"->\"39\" \n  \"26\"->\"41\" \n  \"29\"->\"43\" \n  \"30\"->\"45\" \n  \"31\"->\"47\" \n  \"33\"->\"49\" \n  \"34\"->\"51\" \n  \"35\"->\"53\" \n  \"36\"->\"55\" \n  \"37\"->\"57\" \n  \"38\"->\"59\" \n  \"39\"->\"61\" \n  \"15\"->\"63\" \n  \"28\"->\"65\" \n  \"32\"->\"67\" \n  \"16\"->\"69\" \n  \"63\"->\"71\" \n  \"4\"->\"73\" \n  \"73\"->\"75\" \n  \"72\"->\"77\" \n  \"76\"->\"79\" \n  \"77\"->\"81\" \n  \"20\"->\"83\" \n  \"80\"->\"85\" \n  \"82\"->\"87\" \n  \"83\"->\"89\" \n  \"17\"->\"91\" \n  \"18\"->\"93\" \n  \"68\"->\"95\" \n  \"69\"->\"97\" \n  \"90\"->\"99\" \n  \"91\"->\"101\" \n  \"93\"->\"103\" \n  \"62\"->\"105\" \n  \"27\"->\"107\" \n  \"92\"->\"109\" \n  \"78\"->\"111\" \n  \"74\"->\"113\" \n  \"112\"->\"115\" \n  \"75\"->\"117\" \n  \"81\"->\"119\" \n  \"116\"->\"121\" \n  \"117\"->\"123\" \n  \"79\"->\"125\" \n  \"113\"->\"127\" \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb102"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span></span>
<span>  <span class="va">xfit4</span>,</span>
<span>  <span class="va">DM.data_xgb.train</span><span class="op">)</span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">pred</span>,ncol<span class="op">=</span><span class="fl">3</span>,byrow<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Warning in matrix(pred, ncol = 3, byrow = T): data length [306460] is not a
sub-multiple or multiple of the number of rows [102154]</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb104"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pclass</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">pred</span>,<span class="fl">1</span>,<span class="va">which.max</span><span class="op">)</span></span>
<span><span class="va">mat4</span> <span class="op">&lt;-</span> <span class="va">data_xgb</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">tx_num</span><span class="op">)</span> <span class="op">|&gt;</span>                  <span class="co"># remove tx_num</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>                       <span class="co"># get column names</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.importance.html">xgb.importance</a></span><span class="op">(</span>                     <span class="co"># get importance matrix</span></span>
<span>    <span class="co"># feature_names = .,                # use column names</span></span>
<span>    model <span class="op">=</span> <span class="va">xfit4</span><span class="op">)</span></span>
<span><span class="co"># old code:</span></span>
<span><span class="co"># mat4 = xgb.importance(</span></span>
<span><span class="co">#   feature_names = colnames(data_xgb[,-c("tx_num")]),   # don't include tx number</span></span>
<span><span class="co">#   model = xfit4)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.plot.importance.html">xgb.ggplot.importance</a></span><span class="op">(</span></span>
<span>  importance_matrix <span class="op">=</span> <span class="va">mat4</span>,</span>
<span>  top_n <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="classification_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Tabulation of proportion of prescribers who prescribed bup_ambig who also prescribed a product with generic name “Buprenorphine Hcl/Naloxone Hcl”:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb105"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_gnrc_100</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">bup_ambig</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Prscrbr_NPI</span>, <span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    n_bup_nal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">Gnrc_Name</span> <span class="op">==</span> <span class="st">"Buprenorphine Hcl/Naloxone Hcl"</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="co"># number of rows where n_bup_nal &gt; 0</span></span>
<span>    n_bup_nal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n_bup_nal</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    <span class="co"># proportion of rows where n_bup_nal &gt; 0</span></span>
<span>    prop_bup_nal <span class="op">=</span> <span class="va">n_bup_nal</span><span class="op">/</span><span class="va">N</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
      N n_bup_nal prop_bup_nal
  &lt;int&gt;     &lt;int&gt;        &lt;dbl&gt;
1 48482     25833        0.533</code></pre>
</div>
</div>
</section><section id="confusion-matrix" class="level3"><h3 class="anchored" data-anchor-id="confusion-matrix">Confusion Matrix</h3>
<p>This suggests that bup/naloxone likely is an important predictor for our ambiguous observations. Now we calculate the confusion matrix for xfit4:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb107"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pred.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span></span>
<span>  <span class="va">xfit4</span>,</span>
<span>  <span class="va">DM.data_xgb.test</span>,</span>
<span>  strict_shape <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span></span>
<span>    <span class="va">pred.test</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span>, </span>
<span>  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bup_oud"</span>, <span class="st">"bup_pain"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>  <span class="va">data_xgb.test</span><span class="op">$</span><span class="va">tx_num</span>,</span>
<span>  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bup_oud"</span>, <span class="st">"bup_pain"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op">(</span></span>
<span>  <span class="va">pred_labels</span>,</span>
<span>  <span class="va">test_labels</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction bup_oud bup_pain
  bup_oud    29258      561
  bup_pain     178     8310
                                          
               Accuracy : 0.9807          
                 95% CI : (0.9793, 0.9821)
    No Information Rate : 0.7684          
    P-Value [Acc &gt; NIR] : &lt; 2.2e-16       
                                          
                  Kappa : 0.945           
                                          
 Mcnemar's Test P-Value : &lt; 2.2e-16       
                                          
            Sensitivity : 0.9940          
            Specificity : 0.9368          
         Pos Pred Value : 0.9812          
         Neg Pred Value : 0.9790          
             Prevalence : 0.7684          
         Detection Rate : 0.7638          
   Detection Prevalence : 0.7784          
      Balanced Accuracy : 0.9654          
                                          
       'Positive' Class : bup_oud         
                                          </code></pre>
</div>
</div>
</section></section></section><section id="prediction-for-bup_ambig" class="level1"><h1>Prediction for bup_ambig</h1>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb109"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># use xfit4 model to predict probabilities</span></span>
<span><span class="va">pred.ambig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span></span>
<span>  <span class="va">xfit4</span>,</span>
<span>  <span class="va">DM.data_xgb.ambig</span>,</span>
<span>  strict_shape <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># convert probabilities to labels</span></span>
<span><span class="va">labels.ambig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">pred.ambig</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span>, </span>
<span>  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bup_oud"</span>, <span class="st">"bup_pain"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># add labels to data_xgb.pred</span></span>
<span><span class="va">data_xgb.pred</span><span class="op">$</span><span class="va">tx_pred</span> <span class="op">&lt;-</span> <span class="va">labels.ambig</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Tabulate some results:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb110"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_xgb.pred</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">tx_pred</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  tx_pred      n
  &lt;fct&gt;    &lt;int&gt;
1 bup_oud  25394
2 bup_pain 25989</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb112"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># summarize by year</span></span>
<span><span class="va">data_xgb.pred</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n_oud <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tx_pred</span> <span class="op">==</span> <span class="st">"bup_oud"</span><span class="op">)</span>,</span>
<span>    n_pain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tx_pred</span> <span class="op">==</span> <span class="st">"bup_pain"</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 4
   year n_oud n_pain     n
  &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt;
1  2013  1210    390  1600
2  2014  1558    493  2051
3  2015  1793    587  2380
4  2016  2051    701  2752
5  2017  2401   1335  3736
6  2018  3076   3566  6642
7  2019  3779   5517  9296
8  2020  4536   6319 10855
9  2021  4990   7081 12071</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb114"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># summarize by prescriber type</span></span>
<span><span class="va">data_xgb.pred</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n_oud <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tx_pred</span> <span class="op">==</span> <span class="st">"bup_oud"</span><span class="op">)</span>,</span>
<span>    n_pain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tx_pred</span> <span class="op">==</span> <span class="st">"bup_pain"</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 4
  type  n_oud n_pain     n
  &lt;chr&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt;
1 FP/IM 10603   6590 17193
2 NP     2579   5256  7835
3 Other  3880   5825  9705
4 PA     1111   3185  4296
5 Pain   1797   3800  5597
6 Psych  5416   1303  6719
7 RPh       8     30    38</code></pre>
</div>
</div>
<p>Merge with original data:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb116"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">Brnd_Name</span> <span class="op">==</span> <span class="st">"Buprenorphine"</span><span class="op">|</span><span class="va">data</span><span class="op">$</span><span class="va">Brnd_Name</span> <span class="op">==</span> <span class="st">"Buprenorphine Hcl"</span><span class="op">]</span></span>
<span><span class="co"># add row id numbers back to data_xgb.pred</span></span>
<span><span class="va">data_xgb.pred</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="va">ids</span></span>
<span><span class="va">data_xgb.pred_minimal</span> <span class="op">&lt;-</span> <span class="va">data_xgb.pred</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">tx_pred</span><span class="op">)</span></span>
<span><span class="co"># merge predicted treatment and bup_pain/bup_oud/Bup_ambig into original dataset</span></span>
<span><span class="va">data_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">data</span>,</span>
<span>    <span class="co"># the first join is with data_xgb.pred_minimal for the predicted treatments</span></span>
<span>    <span class="va">data_xgb.pred_minimal</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span></span>
<span>      <span class="st">"id"</span> <span class="op">==</span> <span class="st">"id"</span><span class="op">)</span>,</span>
<span>    relationship <span class="op">=</span> <span class="st">"one-to-one"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># the second join is with data_gnrc_100 for the bup_pain/bup_oud/Bup_ambig</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">data_gnrc_100</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"bup_pain"</span>, <span class="st">"bup_oud"</span>, <span class="st">"bup_ambig"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span></span>
<span>      <span class="st">"id"</span> <span class="op">==</span> <span class="st">"id"</span><span class="op">)</span>,</span>
<span>    relationship <span class="op">=</span> <span class="st">"one-to-one"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="examining-predicted-data" class="level1"><h1>Examining Predicted Data</h1>
<p>Looking at the predictions in relation to several other important variables including NCHSURC, provider type, generic name of buprenorphine prescribed, and other drugs prescribed:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb117"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># beginning by joining the predicted data with data_gnrc_100</span></span>
<span><span class="va">data_gnrc_100</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>  <span class="va">data_gnrc_100</span>,</span>
<span>  <span class="va">data_xgb.pred_minimal</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span></span>
<span>    <span class="st">"id"</span> <span class="op">==</span> <span class="st">"id"</span><span class="op">)</span>,</span>
<span>  relationship <span class="op">=</span> <span class="st">"one-to-one"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="tabulate-by-nchsurc" class="level2"><h2 class="anchored" data-anchor-id="tabulate-by-nchsurc">Tabulate by NCHSURC</h2>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb118"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># tabulate predicted by NCHSURC</span></span>
<span><span class="va">data_gnrc_100</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">nchsurc</span>, <span class="va">tx_pred</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span></span>
<span>    names_from <span class="op">=</span> <span class="va">tx_pred</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">n</span>,</span>
<span>    values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  nchsurc bup_oud bup_pain
    &lt;dbl&gt;   &lt;int&gt;    &lt;int&gt;
1       1    6907     7323
2       2    5715     5258
3       3    6590     7014
4       4    2840     3246
5       5    2304     2051
6       6    1038     1097</code></pre>
</div>
</div>
</section><section id="tabulate-by-provider-type" class="level2"><h2 class="anchored" data-anchor-id="tabulate-by-provider-type">Tabulate by provider type</h2>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb120"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># tabulate predicted by type</span></span>
<span><span class="va">data_gnrc_100</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">tx_pred</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span></span>
<span>    names_from <span class="op">=</span> <span class="va">tx_pred</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">n</span>,</span>
<span>    values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  type  bup_oud bup_pain
  &lt;chr&gt;   &lt;int&gt;    &lt;int&gt;
1 FP/IM   10603     6590
2 NP       2579     5256
3 Other    3880     5825
4 PA       1111     3185
5 Pain     1797     3800
6 Psych    5416     1303
7 RPh         8       30</code></pre>
</div>
</div>
</section><section id="tabulate-by-generic-name" class="level2"><h2 class="anchored" data-anchor-id="tabulate-by-generic-name">Tabulate by generic name</h2>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb122"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># tabulate predicted by generic name</span></span>
<span><span class="va">data_gnrc_100</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Gnrc_Name</span>, <span class="va">tx_pred</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span></span>
<span>    names_from <span class="op">=</span> <span class="va">tx_pred</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">n</span>,</span>
<span>    values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  Gnrc_Name         bup_oud bup_pain
  &lt;chr&gt;               &lt;int&gt;    &lt;int&gt;
1 Buprenorphine        1643    17557
2 Buprenorphine Hcl   23751     8432</code></pre>
</div>
</div>
</section><section id="tabulate-by-days_27" class="level2"><h2 class="anchored" data-anchor-id="tabulate-by-days_27">Tabulate by days_27</h2>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb124"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># tabulate by days_27</span></span>
<span><span class="va">data_gnrc_100</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">days_27</span>, <span class="va">tx_pred</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span></span>
<span>    names_from <span class="op">=</span> <span class="va">tx_pred</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">n</span>,</span>
<span>    values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  days_27 bup_oud bup_pain
    &lt;dbl&gt;   &lt;int&gt;    &lt;int&gt;
1       0   12286    21234
2       1   13108     4755</code></pre>
</div>
</div>
</section><section id="tabulate-by-buprenorphine-hclnaloxone-hcl" class="level2"><h2 class="anchored" data-anchor-id="tabulate-by-buprenorphine-hclnaloxone-hcl">Tabulate by “Buprenorphine Hcl/Naloxone Hcl”</h2>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb126"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># tabulate by "Buprenorphine Hcl/Naloxone Hcl"</span></span>
<span><span class="va">data_gnrc_100</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">`Buprenorphine Hcl/Naloxone Hcl`</span>, <span class="va">tx_pred</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span></span>
<span>    names_from <span class="op">=</span> <span class="va">tx_pred</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">n</span>,</span>
<span>    values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  `Buprenorphine Hcl/Naloxone Hcl` bup_oud bup_pain
                             &lt;dbl&gt;   &lt;int&gt;    &lt;int&gt;
1                                0      10    23638
2                                1   25384     2351</code></pre>
</div>
</div>
</section><section id="tabulate-by-year" class="level2"><h2 class="anchored" data-anchor-id="tabulate-by-year">Tabulate by year</h2>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb128"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># tabulate by year</span></span>
<span><span class="va">data_gnrc_100</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">tx_pred</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span></span>
<span>    names_from <span class="op">=</span> <span class="va">tx_pred</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">n</span>,</span>
<span>    values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
   year bup_oud bup_pain
  &lt;int&gt;   &lt;int&gt;    &lt;int&gt;
1  2013    1210      390
2  2014    1558      493
3  2015    1793      587
4  2016    2051      701
5  2017    2401     1335
6  2018    3076     3566
7  2019    3779     5517
8  2020    4536     6319
9  2021    4990     7081</code></pre>
</div>
</div>
</section><section id="tabulate-by-nppa-rx-by-year" class="level2"><h2 class="anchored" data-anchor-id="tabulate-by-nppa-rx-by-year">Tabulate by NP/PA Rx by year</h2>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb130"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># tabulate NP/PA Rx by year</span></span>
<span><span class="va">data_gnrc_100</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tx</span> <span class="op">==</span> <span class="st">"bup_ambig"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"NP"</span> <span class="op">|</span> <span class="va">type</span> <span class="op">==</span> <span class="st">"PA"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">tx_pred</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span></span>
<span>    names_from <span class="op">=</span> <span class="va">tx_pred</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">n</span>,</span>
<span>    values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
   year bup_oud bup_pain
  &lt;int&gt;   &lt;int&gt;    &lt;int&gt;
1  2013      18       37
2  2014      24       55
3  2015      31       72
4  2016      32      101
5  2017      81      307
6  2018     316     1050
7  2019     668     1853
8  2020    1090     2271
9  2021    1430     2695</code></pre>
</div>
</div>
</section></section><section id="cleanup" class="level1"><h1>Cleanup</h1>
<p>Save the dataset:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb132"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">data_pred</span>, file <span class="op">=</span> <span class="st">"dataset/data_pred.RData"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Cleanup:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb133"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># rm(brnd_freq, drug_freq, gnrc_100_w, providers, providers_wide, generic_top_100, N, N_ambig, N_oud, N_pain)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb134"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># rm(data_classification, data_gnrc_100, data_xgb, data_xgb.pred, data_xgb.pred_minimal, data_xgb.test, data_xgb.train, M.data_xgb.test, M.data_xgb.train, N, oj, param, params, pred, pred.ambig, pred.test, trainIndex, watchlist, xfit0, xfit1, xfit2, xfit3, DM.data_xgb, DM.data_xgb.ambig, DM.data_xgb.test, DM.data_xgb.train, labels.ambig, pclass, pred_labels, test_labels, y, y.test, y.train)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="other-thoughts" class="level1"><h1>Other Thoughts</h1>
<p><strong>Sensitivity analyses</strong>: - see of the false positives produced by the lower specificity produces any effect on the results - test assumption that providers essentially fall into two groups: those who prescribe buprenorphine for pain and those who prescribe buprenorphine for opioid use disorder</p>
<p>Perhaps the gradient boosting would be improved by:</p>
<ul>
<li>with the 200 top drugs</li>
<li>using continuous measures for the top drugs instead of binary prescribed vs not prescribed; such measures could include:
<ul>
<li>‘Tot_Clms’ (total number of claims)</li>
<li>‘Tot_Day_Sup’ (total days supply)</li>
</ul>
</li>
<li>Using calculated continuous measures
<ul>
<li>average cost</li>
<li>average days supply</li>
</ul>
</li>
<li>Have another go at using the <code>binary:logistic</code> objective, as it should work as well as the <code>multi:softprob</code> objective, as it should work as well as the softprob<br>
</li>
<li>Have another go at cross-validation</li>
</ul>
<p>Future work could include:</p>
<ul>
<li>Gradient boosting with <code>catboost</code> package</li>
</ul></section><section id="session-info" class="level1"><h1>Session Info</h1>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb135"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.2 (2023-10-31)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 22.04.3 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0 
LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

time zone: America/Vancouver
tzcode source: system (glibc)

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] fstcore_0.9.18      Ckmeans.1d.dp_4.3.5 fst_0.9.8          
 [4] caret_6.0-94        lattice_0.22-5      xgboost_1.7.5.1    
 [7] lubridate_1.9.3     forcats_1.0.0       stringr_1.5.1      
[10] dplyr_1.1.4         purrr_1.0.2         readr_2.1.4        
[13] tidyr_1.3.0         tibble_3.2.1        ggplot2_3.4.4      
[16] tidyverse_2.0.0    

loaded via a namespace (and not attached):
 [1] tidyselect_1.2.0     timeDate_4022.108    farver_2.1.1        
 [4] fastmap_1.1.1        pROC_1.18.5          digest_0.6.33       
 [7] rpart_4.1.21         timechange_0.2.0     lifecycle_1.0.4     
[10] ellipsis_0.3.2       survival_3.5-7       magrittr_2.0.3      
[13] compiler_4.3.2       rlang_1.1.2          tools_4.3.2         
[16] utf8_1.2.4           yaml_2.3.7           data.table_1.14.8   
[19] knitr_1.45           labeling_0.4.3       htmlwidgets_1.6.3   
[22] RColorBrewer_1.1-3   plyr_1.8.9           withr_2.5.2         
[25] nnet_7.3-19          grid_4.3.2           stats4_4.3.2        
[28] fansi_1.0.5          e1071_1.7-13         colorspace_2.1-0    
[31] future_1.33.0        globals_0.16.2       scales_1.3.0        
[34] iterators_1.0.14     MASS_7.3-60          cli_3.6.1           
[37] DiagrammeR_1.0.10    rmarkdown_2.25       generics_0.1.3      
[40] rstudioapi_0.15.0    future.apply_1.11.0  reshape2_1.4.4      
[43] tzdb_0.4.0           visNetwork_2.1.2     proxy_0.4-27        
[46] splines_4.3.2        parallel_4.3.2       vctrs_0.6.4         
[49] hardhat_1.3.0        Matrix_1.6-3         jsonlite_1.8.7      
[52] hms_1.1.3            listenv_0.9.0        foreach_1.5.2       
[55] gower_1.0.1          recipes_1.0.8        glue_1.6.2          
[58] parallelly_1.36.0    codetools_0.2-19     stringi_1.8.2       
[61] gtable_0.3.4         munsell_0.5.0        pillar_1.9.0        
[64] htmltools_0.5.7      ipred_0.9-14         lava_1.7.3          
[67] R6_2.5.1             Rdpack_2.6           evaluate_0.23       
[70] rbibutils_2.2.16     class_7.3-22         Rcpp_1.0.11         
[73] nlme_3.1-163         prodlim_2023.08.28   xfun_0.41           
[76] pkgconfig_2.0.3      ModelMetrics_1.2.2.2</code></pre>
</div>
</div>
<!-- -->

</section></main><!-- /main column --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb137" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Classification of Ambiguous Treatments"</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Matthew Hoctor, PharmD"</span></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "`r format(Sys.time(), '%d %B, %Y')`"</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a><span class="co">quarto::html_document:</span></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a><span class="co">  theme: cerulean</span></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a><span class="co">  highlight: github</span></span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a><span class="co">  </span></span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a><span class="an">toc-depth:</span><span class="co"> 4</span></span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a><span class="an">toc-location:</span><span class="co"> left</span></span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a><span class="an">toc-title:</span><span class="co"> Contents</span></span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a><span class="co">  </span></span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a><span class="an">code-fold:</span><span class="co"> show</span></span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a><span class="an">code-overflow:</span><span class="co"> wrap</span></span>
<span id="cb137-17"><a href="#cb137-17" aria-hidden="true" tabindex="-1"></a><span class="an">code-tools:</span><span class="co"> true</span></span>
<span id="cb137-18"><a href="#cb137-18" aria-hidden="true" tabindex="-1"></a><span class="an">code-link:</span><span class="co"> true</span></span>
<span id="cb137-19"><a href="#cb137-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-20"><a href="#cb137-20" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb137-21"><a href="#cb137-21" aria-hidden="true" tabindex="-1"></a><span class="co">  freeze: auto</span></span>
<span id="cb137-22"><a href="#cb137-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-23"><a href="#cb137-23" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> source</span></span>
<span id="cb137-24"><a href="#cb137-24" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb137-25"><a href="#cb137-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-28"><a href="#cb137-28" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-29"><a href="#cb137-29" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb137-30"><a href="#cb137-30" aria-hidden="true" tabindex="-1"></a><span class="co">#| #| output: false</span></span>
<span id="cb137-31"><a href="#cb137-31" aria-hidden="true" tabindex="-1"></a><span class="co"># load libraries:</span></span>
<span id="cb137-32"><a href="#cb137-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb137-33"><a href="#cb137-33" aria-hidden="true" tabindex="-1"></a><span class="co"># library(FLAME)                  # not suitable for matching on this dataset</span></span>
<span id="cb137-34"><a href="#cb137-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span>
<span id="cb137-35"><a href="#cb137-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)                    <span class="co">#for confusionMatrix function</span></span>
<span id="cb137-36"><a href="#cb137-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fst)</span>
<span id="cb137-37"><a href="#cb137-37" aria-hidden="true" tabindex="-1"></a><span class="co"># library(DiagrammeR)               # for plotting XGBoost trees</span></span>
<span id="cb137-38"><a href="#cb137-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Ckmeans<span class="fl">.1</span>d.dp)            <span class="co"># for xgb.ggplot.importance function</span></span>
<span id="cb137-39"><a href="#cb137-39" aria-hidden="true" tabindex="-1"></a><span class="co"># library(ggplot2)</span></span>
<span id="cb137-40"><a href="#cb137-40" aria-hidden="true" tabindex="-1"></a><span class="co"># # library(MazamaSpatialUtils)</span></span>
<span id="cb137-41"><a href="#cb137-41" aria-hidden="true" tabindex="-1"></a><span class="co"># library(MazamaSpatialPlots)</span></span>
<span id="cb137-42"><a href="#cb137-42" aria-hidden="true" tabindex="-1"></a><span class="co"># library(plotly)</span></span>
<span id="cb137-43"><a href="#cb137-43" aria-hidden="true" tabindex="-1"></a><span class="co"># library(leaflet)</span></span>
<span id="cb137-44"><a href="#cb137-44" aria-hidden="true" tabindex="-1"></a><span class="co"># library(data.table)</span></span>
<span id="cb137-45"><a href="#cb137-45" aria-hidden="true" tabindex="-1"></a><span class="co"># library(lubridate)</span></span>
<span id="cb137-46"><a href="#cb137-46" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-47"><a href="#cb137-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-48"><a href="#cb137-48" aria-hidden="true" tabindex="-1"></a><span class="fu"># Overview</span></span>
<span id="cb137-49"><a href="#cb137-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-50"><a href="#cb137-50" aria-hidden="true" tabindex="-1"></a>We seek to understand the impact of the Comprehensive Addiction and Recovery Act (CARA) of 2016 on patterns of buprenorphine prescribing practices by examining medicare part D data. This exploratory analysis will download and compile medicare part D data before and after the legislation for years 2013-2021, and will examine variables of interest including buprenorphine Rx, methadone Rx, naltrexone Rx, prescriber type, cost to the patient, cost to Medicare, rural vs urban, and more.</span>
<span id="cb137-51"><a href="#cb137-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-52"><a href="#cb137-52" aria-hidden="true" tabindex="-1"></a>Within this section we seek to classify potentially ambiguous entries corresponding to brand names <span class="in">`Buprenorphine`</span> or <span class="in">`Buprenorphine Hcl`</span>. There are several methods to consider including logistic regression, however we will attempt to classify these ambiguities according to the Fast Large-scale Almost Matching Exactly (FLAME) algorithm (<span class="co">[</span><span class="ot">described here</span><span class="co">](https://arxiv.org/abs/1707.06315)</span>), as implemented in the <span class="co">[</span><span class="ot">FLAME package</span><span class="co">](https://cran.r-project.org/web/packages/FLAME/)</span>. We can consider matching on several variables:</span>
<span id="cb137-53"><a href="#cb137-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-54"><a href="#cb137-54" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The set of other medications prescribed, and/or specific high-yield medications (e.g. methadone, naltrexone, naloxone, etc.)</span>
<span id="cb137-55"><a href="#cb137-55" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Prescriber's state or county</span>
<span id="cb137-56"><a href="#cb137-56" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Prescriber's NCHSUR classification</span>
<span id="cb137-57"><a href="#cb137-57" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Prescriber's specialty</span>
<span id="cb137-58"><a href="#cb137-58" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Unit drug cost; i.e. <span class="in">`Tot_Drug_Cost`</span> / <span class="in">`Tot_Day_Suply`</span></span>
<span id="cb137-59"><a href="#cb137-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-60"><a href="#cb137-60" aria-hidden="true" tabindex="-1"></a><span class="fu"># Classification of Ambiguous Treatments</span></span>
<span id="cb137-61"><a href="#cb137-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-62"><a href="#cb137-62" aria-hidden="true" tabindex="-1"></a><span class="fu">## Loading Data</span></span>
<span id="cb137-63"><a href="#cb137-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-64"><a href="#cb137-64" aria-hidden="true" tabindex="-1"></a>To uniquely identify each row/observation we will add an <span class="in">`id`</span> variable.  First we will update the treatment variable to reflect ambiguous values (i.e. Brnd_Name is either <span class="in">`Buprenorphine`</span> or <span class="in">`Buprenorphine Hcl`</span>), setting the value of <span class="in">`tx`</span> to <span class="in">`bup_ambig`</span>:</span>
<span id="cb137-65"><a href="#cb137-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-68"><a href="#cb137-68" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-69"><a href="#cb137-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Load saved data</span></span>
<span id="cb137-70"><a href="#cb137-70" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="at">file =</span> <span class="st">"dataset/data.RData"</span>)</span>
<span id="cb137-71"><a href="#cb137-71" aria-hidden="true" tabindex="-1"></a><span class="co"># add/update variables</span></span>
<span id="cb137-72"><a href="#cb137-72" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb137-73"><a href="#cb137-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># update 'tx' variable</span></span>
<span id="cb137-74"><a href="#cb137-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tx =</span> <span class="fu">ifelse</span>(Brnd_Name <span class="sc">==</span> <span class="st">"Buprenorphine"</span> <span class="sc">|</span> Brnd_Name <span class="sc">==</span> <span class="st">"Buprenorphine Hcl"</span>, <span class="st">"bup_ambig"</span>, tx)) <span class="sc">|&gt;</span></span>
<span id="cb137-75"><a href="#cb137-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add 'id' variable corresponding to rownumber</span></span>
<span id="cb137-76"><a href="#cb137-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb137-77"><a href="#cb137-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set 'id' as first variable</span></span>
<span id="cb137-78"><a href="#cb137-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(id, <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb137-79"><a href="#cb137-79" aria-hidden="true" tabindex="-1"></a><span class="co"># check: table tx vs brand name for buprenorphine</span></span>
<span id="cb137-80"><a href="#cb137-80" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(</span>
<span id="cb137-81"><a href="#cb137-81" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>Brnd_Name[data<span class="sc">$</span>tx <span class="sc">==</span> <span class="st">"bup_oud"</span> <span class="sc">|</span> data<span class="sc">$</span>tx <span class="sc">==</span> <span class="st">"bup_pain"</span> <span class="sc">|</span> data<span class="sc">$</span>tx <span class="sc">==</span> <span class="st">"bup_ambig"</span>],</span>
<span id="cb137-82"><a href="#cb137-82" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>tx[data<span class="sc">$</span>tx <span class="sc">==</span> <span class="st">"bup_oud"</span> <span class="sc">|</span> data<span class="sc">$</span>tx <span class="sc">==</span> <span class="st">"bup_pain"</span> <span class="sc">|</span> data<span class="sc">$</span>tx <span class="sc">==</span> <span class="st">"bup_ambig"</span>]</span>
<span id="cb137-83"><a href="#cb137-83" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb137-84"><a href="#cb137-84" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-85"><a href="#cb137-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-86"><a href="#cb137-86" aria-hidden="true" tabindex="-1"></a><span class="fu">## Find Classifiers</span></span>
<span id="cb137-87"><a href="#cb137-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-88"><a href="#cb137-88" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prescribing Pattern</span></span>
<span id="cb137-89"><a href="#cb137-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-90"><a href="#cb137-90" aria-hidden="true" tabindex="-1"></a>We can now create a dataset of NPI/year pairs corresponding to prescribers who have prescribed buprenorphine that year. We will use this dataset to extract the other drugs prescribed by these prescribers.</span>
<span id="cb137-91"><a href="#cb137-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-94"><a href="#cb137-94" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-95"><a href="#cb137-95" aria-hidden="true" tabindex="-1"></a>providers <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb137-96"><a href="#cb137-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tx <span class="sc">==</span> <span class="st">"bup_oud"</span> <span class="sc">|</span> tx <span class="sc">==</span> <span class="st">"bup_pain"</span> <span class="sc">|</span> data<span class="sc">$</span>tx <span class="sc">==</span> <span class="st">"bup_ambig"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-97"><a href="#cb137-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Prscrbr_NPI, year, tx) <span class="sc">|&gt;</span></span>
<span id="cb137-98"><a href="#cb137-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb137-99"><a href="#cb137-99" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-100"><a href="#cb137-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-101"><a href="#cb137-101" aria-hidden="true" tabindex="-1"></a>Count number of NPI/year pairs in the <span class="in">`providers`</span> dataset which have both tx == "bup_oud" and tx == "bup_pain"; these pairs will be less useful for classification.</span>
<span id="cb137-102"><a href="#cb137-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-105"><a href="#cb137-105" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-106"><a href="#cb137-106" aria-hidden="true" tabindex="-1"></a>providers <span class="sc">|&gt;</span> </span>
<span id="cb137-107"><a href="#cb137-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Prscrbr_NPI, year) <span class="sc">|&gt;</span> </span>
<span id="cb137-108"><a href="#cb137-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-109"><a href="#cb137-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb137-110"><a href="#cb137-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_oud =</span> <span class="fu">sum</span>(tx <span class="sc">==</span> <span class="st">"bup_oud"</span>),</span>
<span id="cb137-111"><a href="#cb137-111" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pain =</span> <span class="fu">sum</span>(tx <span class="sc">==</span> <span class="st">"bup_pain"</span>),</span>
<span id="cb137-112"><a href="#cb137-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop_last"</span></span>
<span id="cb137-113"><a href="#cb137-113" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb137-114"><a href="#cb137-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_oud <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> n_pain <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-115"><a href="#cb137-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span>
<span id="cb137-116"><a href="#cb137-116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-117"><a href="#cb137-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-118"><a href="#cb137-118" aria-hidden="true" tabindex="-1"></a>Pivot the <span class="in">`providers`</span> dataset to wide format such that each row is a unique NPI/year pair with new columns for each treatment bucket (i.e. <span class="in">`bup_oud`</span>, <span class="in">`bup_pain`</span>, <span class="in">`bup_ambig`</span>):</span>
<span id="cb137-119"><a href="#cb137-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-122"><a href="#cb137-122" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-123"><a href="#cb137-123" aria-hidden="true" tabindex="-1"></a>providers_wide <span class="ot">&lt;-</span> providers <span class="sc">|&gt;</span></span>
<span id="cb137-124"><a href="#cb137-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb137-125"><a href="#cb137-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> <span class="fu">c</span>(Prscrbr_NPI, year),</span>
<span id="cb137-126"><a href="#cb137-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> tx,</span>
<span id="cb137-127"><a href="#cb137-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> tx,</span>
<span id="cb137-128"><a href="#cb137-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># should the line below be as follows:</span></span>
<span id="cb137-129"><a href="#cb137-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># values_fn = function(x) (length(x)/length(x)),</span></span>
<span id="cb137-130"><a href="#cb137-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fn =</span> length,</span>
<span id="cb137-131"><a href="#cb137-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="dv">0</span></span>
<span id="cb137-132"><a href="#cb137-132" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb137-133"><a href="#cb137-133" aria-hidden="true" tabindex="-1"></a><span class="co"># examine providers with bup_ambig==1</span></span>
<span id="cb137-134"><a href="#cb137-134" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(providers_wide<span class="sc">$</span>bup_ambig <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb137-135"><a href="#cb137-135" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(providers_wide<span class="sc">$</span>bup_ambig <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb137-136"><a href="#cb137-136" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(providers_wide<span class="sc">$</span>bup_ambig <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> providers_wide<span class="sc">$</span>bup_oud <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> providers_wide<span class="sc">$</span>bup_pain <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb137-137"><a href="#cb137-137" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(</span>
<span id="cb137-138"><a href="#cb137-138" aria-hidden="true" tabindex="-1"></a>  providers_wide<span class="sc">$</span>bup_oud[providers_wide<span class="sc">$</span>bup_ambig <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb137-139"><a href="#cb137-139" aria-hidden="true" tabindex="-1"></a>  providers_wide<span class="sc">$</span>bup_pain[providers_wide<span class="sc">$</span>bup_ambig <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb137-140"><a href="#cb137-140" aria-hidden="true" tabindex="-1"></a>  <span class="at">dnn =</span> <span class="fu">c</span>(<span class="st">"bup_oud"</span>, <span class="st">"bup_pain"</span>)</span>
<span id="cb137-141"><a href="#cb137-141" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb137-142"><a href="#cb137-142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-143"><a href="#cb137-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-144"><a href="#cb137-144" aria-hidden="true" tabindex="-1"></a>We can now create a new dataset of observations corresponding to NPI/year pairs corresponding to prescribers who have prescribed buprenorphine that year:</span>
<span id="cb137-145"><a href="#cb137-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-148"><a href="#cb137-148" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-149"><a href="#cb137-149" aria-hidden="true" tabindex="-1"></a><span class="co"># create data_classification as an empty dataset:</span></span>
<span id="cb137-150"><a href="#cb137-150" aria-hidden="true" tabindex="-1"></a>data_classification <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb137-151"><a href="#cb137-151" aria-hidden="true" tabindex="-1"></a><span class="co"># iterate over years 2013-2021:</span></span>
<span id="cb137-152"><a href="#cb137-152" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (year <span class="cf">in</span> <span class="dv">2013</span><span class="sc">:</span><span class="dv">2021</span>) {</span>
<span id="cb137-153"><a href="#cb137-153" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the data:</span></span>
<span id="cb137-154"><a href="#cb137-154" aria-hidden="true" tabindex="-1"></a>  data_year <span class="ot">&lt;-</span> <span class="fu">read_fst</span>(</span>
<span id="cb137-155"><a href="#cb137-155" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">"data/"</span>, year, <span class="st">".fst"</span>)</span>
<span id="cb137-156"><a href="#cb137-156" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb137-157"><a href="#cb137-157" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select only necessary variables</span></span>
<span id="cb137-158"><a href="#cb137-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Prscrbr_NPI, Brnd_Name, Gnrc_Name)</span>
<span id="cb137-159"><a href="#cb137-159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set the `year` variable:</span></span>
<span id="cb137-160"><a href="#cb137-160" aria-hidden="true" tabindex="-1"></a>  data_year<span class="sc">$</span>year <span class="ot">&lt;-</span> year</span>
<span id="cb137-161"><a href="#cb137-161" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-162"><a href="#cb137-162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># inner join with `providers_wide` dataset to restrict to NPI/year combinations from `providers`:</span></span>
<span id="cb137-163"><a href="#cb137-163" aria-hidden="true" tabindex="-1"></a>  data_year <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(</span>
<span id="cb137-164"><a href="#cb137-164" aria-hidden="true" tabindex="-1"></a>      data_year,</span>
<span id="cb137-165"><a href="#cb137-165" aria-hidden="true" tabindex="-1"></a>      providers_wide, </span>
<span id="cb137-166"><a href="#cb137-166" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Prscrbr_NPI"</span>, <span class="st">"year"</span>),</span>
<span id="cb137-167"><a href="#cb137-167" aria-hidden="true" tabindex="-1"></a>      <span class="at">relationship =</span> <span class="st">"many-to-one"</span></span>
<span id="cb137-168"><a href="#cb137-168" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb137-169"><a href="#cb137-169" aria-hidden="true" tabindex="-1"></a>  <span class="co"># append the data to the `data_classification` dataset:</span></span>
<span id="cb137-170"><a href="#cb137-170" aria-hidden="true" tabindex="-1"></a>  data_classification <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data_classification, data_year)</span>
<span id="cb137-171"><a href="#cb137-171" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb137-172"><a href="#cb137-172" aria-hidden="true" tabindex="-1"></a><span class="co"># cleanup</span></span>
<span id="cb137-173"><a href="#cb137-173" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(data_year, year)  </span>
<span id="cb137-174"><a href="#cb137-174" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-175"><a href="#cb137-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-176"><a href="#cb137-176" aria-hidden="true" tabindex="-1"></a>We can now widen the <span class="in">`data_classification`</span> dataset created above such that each row is a unique NPI/year pair with new columns for the generic names of each drug prescribed. First some numbers:</span>
<span id="cb137-177"><a href="#cb137-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-180"><a href="#cb137-180" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-181"><a href="#cb137-181" aria-hidden="true" tabindex="-1"></a><span class="co"># count the number of distinct generic names in the dataset</span></span>
<span id="cb137-182"><a href="#cb137-182" aria-hidden="true" tabindex="-1"></a>data_classification <span class="sc">|&gt;</span> <span class="fu">select</span>(Gnrc_Name) <span class="sc">|&gt;</span> <span class="fu">n_distinct</span>()</span>
<span id="cb137-183"><a href="#cb137-183" aria-hidden="true" tabindex="-1"></a><span class="co"># count number of distinct NPI/year pairs in the `providers` dataset</span></span>
<span id="cb137-184"><a href="#cb137-184" aria-hidden="true" tabindex="-1"></a>providers <span class="sc">|&gt;</span> <span class="fu">select</span>(Prscrbr_NPI, year)  <span class="sc">|&gt;</span> <span class="fu">n_distinct</span>()</span>
<span id="cb137-185"><a href="#cb137-185" aria-hidden="true" tabindex="-1"></a><span class="co"># average number of generic names per NPI/year pair</span></span>
<span id="cb137-186"><a href="#cb137-186" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(data_classification)<span class="sc">/</span><span class="dv">154354</span></span>
<span id="cb137-187"><a href="#cb137-187" aria-hidden="true" tabindex="-1"></a><span class="co"># summing over bup_oud, bup_pain, and bup_ambig</span></span>
<span id="cb137-188"><a href="#cb137-188" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(data_classification<span class="sc">$</span>bup_oud)</span>
<span id="cb137-189"><a href="#cb137-189" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(data_classification<span class="sc">$</span>bup_pain)</span>
<span id="cb137-190"><a href="#cb137-190" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(data_classification<span class="sc">$</span>bup_ambig)</span>
<span id="cb137-191"><a href="#cb137-191" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-192"><a href="#cb137-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-193"><a href="#cb137-193" aria-hidden="true" tabindex="-1"></a>Looking again at the most frequently prescribed drugs in the dataset, this time breaking it down by bup_pain and bup_oud:</span>
<span id="cb137-194"><a href="#cb137-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-197"><a href="#cb137-197" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-198"><a href="#cb137-198" aria-hidden="true" tabindex="-1"></a>drug_freq <span class="ot">&lt;-</span> data_classification <span class="sc">|&gt;</span> </span>
<span id="cb137-199"><a href="#cb137-199" aria-hidden="true" tabindex="-1"></a>  <span class="co"># exclude unhelpful observations with oud==1 &amp; pain==1 &amp; ambig==0</span></span>
<span id="cb137-200"><a href="#cb137-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(bup_oud <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> bup_pain <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> bup_ambig <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb137-201"><a href="#cb137-201" aria-hidden="true" tabindex="-1"></a>  <span class="co"># exclude observations mapping to bup_ambig, i.e. Brnd_Name is either `Buprenorphine` or `Buprenorphine Hcl`</span></span>
<span id="cb137-202"><a href="#cb137-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(Brnd_Name <span class="sc">==</span> <span class="st">"Buprenorphine"</span> <span class="sc">|</span> Brnd_Name <span class="sc">==</span> <span class="st">"Buprenorphine Hcl"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb137-203"><a href="#cb137-203" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute summary statistics by grouping</span></span>
<span id="cb137-204"><a href="#cb137-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Gnrc_Name) <span class="sc">|&gt;</span> </span>
<span id="cb137-205"><a href="#cb137-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-206"><a href="#cb137-206" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_oud =</span> <span class="fu">sum</span>(bup_oud),</span>
<span id="cb137-207"><a href="#cb137-207" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pain =</span> <span class="fu">sum</span>(bup_pain),</span>
<span id="cb137-208"><a href="#cb137-208" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_ambig =</span> <span class="fu">sum</span>(bup_ambig),</span>
<span id="cb137-209"><a href="#cb137-209" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>()</span>
<span id="cb137-210"><a href="#cb137-210" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb137-211"><a href="#cb137-211" aria-hidden="true" tabindex="-1"></a><span class="co"># display top 100</span></span>
<span id="cb137-212"><a href="#cb137-212" aria-hidden="true" tabindex="-1"></a>drug_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-213"><a href="#cb137-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">|&gt;</span> </span>
<span id="cb137-214"><a href="#cb137-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">100</span>)</span>
<span id="cb137-215"><a href="#cb137-215" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-216"><a href="#cb137-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-217"><a href="#cb137-217" aria-hidden="true" tabindex="-1"></a>Normalize the counts by dividing by the total number of NPI/year pairs in the dataset; then compute a contrast score and weighted contrast score for each drug; the contrast will be the absolute value of the difference between the normalized counts for OUD and pain over the sum of the normalized counts for OUD and pain. The weighted contrast will be the contrast score multiplied by n_ambig:</span>
<span id="cb137-218"><a href="#cb137-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-221"><a href="#cb137-221" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-222"><a href="#cb137-222" aria-hidden="true" tabindex="-1"></a><span class="co"># calc column totals:</span></span>
<span id="cb137-223"><a href="#cb137-223" aria-hidden="true" tabindex="-1"></a>N_oud <span class="ot">&lt;-</span> <span class="fu">sum</span>(drug_freq<span class="sc">$</span>n_oud)</span>
<span id="cb137-224"><a href="#cb137-224" aria-hidden="true" tabindex="-1"></a>N_pain <span class="ot">&lt;-</span> <span class="fu">sum</span>(drug_freq<span class="sc">$</span>n_pain)</span>
<span id="cb137-225"><a href="#cb137-225" aria-hidden="true" tabindex="-1"></a>N_ambig <span class="ot">&lt;-</span> <span class="fu">sum</span>(drug_freq<span class="sc">$</span>n_ambig)</span>
<span id="cb137-226"><a href="#cb137-226" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">sum</span>(drug_freq<span class="sc">$</span>n)</span>
<span id="cb137-227"><a href="#cb137-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-228"><a href="#cb137-228" aria-hidden="true" tabindex="-1"></a><span class="co"># mutate columns:</span></span>
<span id="cb137-229"><a href="#cb137-229" aria-hidden="true" tabindex="-1"></a>drug_freq <span class="ot">&lt;-</span> drug_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-230"><a href="#cb137-230" aria-hidden="true" tabindex="-1"></a><span class="co"># normalize columns:</span></span>
<span id="cb137-231"><a href="#cb137-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb137-232"><a href="#cb137-232" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_oud =</span> <span class="fu">signif</span>(<span class="dv">1000</span><span class="sc">*</span>n_oud<span class="sc">/</span>N_oud, <span class="dv">3</span>),</span>
<span id="cb137-233"><a href="#cb137-233" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pain =</span> <span class="fu">signif</span>(<span class="dv">1000</span><span class="sc">*</span>n_pain<span class="sc">/</span>N_pain, <span class="dv">3</span>),</span>
<span id="cb137-234"><a href="#cb137-234" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_ambig =</span> <span class="fu">signif</span>(<span class="dv">1000</span><span class="sc">*</span>n_ambig<span class="sc">/</span>N_ambig, <span class="dv">3</span>),</span>
<span id="cb137-235"><a href="#cb137-235" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">signif</span>(<span class="dv">1000</span><span class="sc">*</span>n<span class="sc">/</span>N, <span class="dv">3</span>)</span>
<span id="cb137-236"><a href="#cb137-236" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb137-237"><a href="#cb137-237" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add contrasts columns for OUD vs pain</span></span>
<span id="cb137-238"><a href="#cb137-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb137-239"><a href="#cb137-239" aria-hidden="true" tabindex="-1"></a>    <span class="at">contrast =</span> <span class="fu">signif</span>((n_oud<span class="sc">-</span>n_pain)<span class="sc">/</span>(n_oud<span class="sc">+</span>n_pain), <span class="dv">3</span>),</span>
<span id="cb137-240"><a href="#cb137-240" aria-hidden="true" tabindex="-1"></a>    <span class="at">w_contrast =</span> <span class="fu">signif</span>(n_ambig<span class="sc">*</span>(n_oud<span class="sc">-</span>n_pain)<span class="sc">/</span>(n_oud<span class="sc">+</span>n_pain), <span class="dv">3</span>)</span>
<span id="cb137-241"><a href="#cb137-241" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb137-242"><a href="#cb137-242" aria-hidden="true" tabindex="-1"></a><span class="co"># display top 100</span></span>
<span id="cb137-243"><a href="#cb137-243" aria-hidden="true" tabindex="-1"></a>drug_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-244"><a href="#cb137-244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(w_contrast))) <span class="sc">|&gt;</span> </span>
<span id="cb137-245"><a href="#cb137-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">100</span>)</span>
<span id="cb137-246"><a href="#cb137-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-247"><a href="#cb137-247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-248"><a href="#cb137-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-249"><a href="#cb137-249" aria-hidden="true" tabindex="-1"></a>Assess the contrasts:</span>
<span id="cb137-250"><a href="#cb137-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-253"><a href="#cb137-253" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-254"><a href="#cb137-254" aria-hidden="true" tabindex="-1"></a><span class="co"># sum weighted contrast over top 50 entries</span></span>
<span id="cb137-255"><a href="#cb137-255" aria-hidden="true" tabindex="-1"></a>drug_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-256"><a href="#cb137-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(w_contrast))) <span class="sc">|&gt;</span> </span>
<span id="cb137-257"><a href="#cb137-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-258"><a href="#cb137-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(w_contrast) <span class="sc">|&gt;</span></span>
<span id="cb137-259"><a href="#cb137-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span>
<span id="cb137-260"><a href="#cb137-260" aria-hidden="true" tabindex="-1"></a><span class="co"># sum absolute value of weighted contrast over top 50 entries</span></span>
<span id="cb137-261"><a href="#cb137-261" aria-hidden="true" tabindex="-1"></a>drug_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-262"><a href="#cb137-262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(w_contrast))) <span class="sc">|&gt;</span> </span>
<span id="cb137-263"><a href="#cb137-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-264"><a href="#cb137-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(w_contrast) <span class="sc">|&gt;</span></span>
<span id="cb137-265"><a href="#cb137-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abs</span>() <span class="sc">|&gt;</span></span>
<span id="cb137-266"><a href="#cb137-266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span>
<span id="cb137-267"><a href="#cb137-267" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-268"><a href="#cb137-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-269"><a href="#cb137-269" aria-hidden="true" tabindex="-1"></a>This relatively low value suggests that the top 50 generic names are not more sensitive to OUD or to pain.</span>
<span id="cb137-270"><a href="#cb137-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-271"><a href="#cb137-271" aria-hidden="true" tabindex="-1"></a>Repeating the above analysis for Brand Name:</span>
<span id="cb137-272"><a href="#cb137-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-275"><a href="#cb137-275" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-276"><a href="#cb137-276" aria-hidden="true" tabindex="-1"></a>brnd_freq <span class="ot">&lt;-</span> data_classification <span class="sc">|&gt;</span> </span>
<span id="cb137-277"><a href="#cb137-277" aria-hidden="true" tabindex="-1"></a>  <span class="co"># exclude unhelpful observations with oud==1 &amp; pain==1 &amp; ambig==0</span></span>
<span id="cb137-278"><a href="#cb137-278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(bup_oud <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> bup_pain <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> bup_ambig <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb137-279"><a href="#cb137-279" aria-hidden="true" tabindex="-1"></a>  <span class="co"># exclude observations mapping to bup_ambig, i.e. Brnd_Name is either `Buprenorphine` or `Buprenorphine Hcl`</span></span>
<span id="cb137-280"><a href="#cb137-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(Brnd_Name <span class="sc">==</span> <span class="st">"Buprenorphine"</span> <span class="sc">|</span> Brnd_Name <span class="sc">==</span> <span class="st">"Buprenorphine Hcl"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb137-281"><a href="#cb137-281" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute summary statistics by grouping</span></span>
<span id="cb137-282"><a href="#cb137-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Brnd_Name) <span class="sc">|&gt;</span> </span>
<span id="cb137-283"><a href="#cb137-283" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-284"><a href="#cb137-284" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_oud =</span> <span class="fu">sum</span>(bup_oud),</span>
<span id="cb137-285"><a href="#cb137-285" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pain =</span> <span class="fu">sum</span>(bup_pain),</span>
<span id="cb137-286"><a href="#cb137-286" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_ambig =</span> <span class="fu">sum</span>(bup_ambig),</span>
<span id="cb137-287"><a href="#cb137-287" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>()</span>
<span id="cb137-288"><a href="#cb137-288" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb137-289"><a href="#cb137-289" aria-hidden="true" tabindex="-1"></a><span class="co"># calc column totals:</span></span>
<span id="cb137-290"><a href="#cb137-290" aria-hidden="true" tabindex="-1"></a>N_oud <span class="ot">&lt;-</span> <span class="fu">sum</span>(brnd_freq<span class="sc">$</span>n_oud)</span>
<span id="cb137-291"><a href="#cb137-291" aria-hidden="true" tabindex="-1"></a>N_pain <span class="ot">&lt;-</span> <span class="fu">sum</span>(brnd_freq<span class="sc">$</span>n_pain)</span>
<span id="cb137-292"><a href="#cb137-292" aria-hidden="true" tabindex="-1"></a>N_ambig <span class="ot">&lt;-</span> <span class="fu">sum</span>(brnd_freq<span class="sc">$</span>n_ambig)</span>
<span id="cb137-293"><a href="#cb137-293" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">sum</span>(brnd_freq<span class="sc">$</span>n)</span>
<span id="cb137-294"><a href="#cb137-294" aria-hidden="true" tabindex="-1"></a><span class="co"># mutate columns:</span></span>
<span id="cb137-295"><a href="#cb137-295" aria-hidden="true" tabindex="-1"></a>brnd_freq <span class="ot">&lt;-</span> brnd_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-296"><a href="#cb137-296" aria-hidden="true" tabindex="-1"></a><span class="co"># normalize columns:</span></span>
<span id="cb137-297"><a href="#cb137-297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb137-298"><a href="#cb137-298" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_oud =</span> <span class="fu">signif</span>(<span class="dv">1000</span><span class="sc">*</span>n_oud<span class="sc">/</span>N_oud, <span class="dv">3</span>),</span>
<span id="cb137-299"><a href="#cb137-299" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pain =</span> <span class="fu">signif</span>(<span class="dv">1000</span><span class="sc">*</span>n_pain<span class="sc">/</span>N_pain, <span class="dv">3</span>),</span>
<span id="cb137-300"><a href="#cb137-300" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_ambig =</span> <span class="fu">signif</span>(<span class="dv">1000</span><span class="sc">*</span>n_ambig<span class="sc">/</span>N_ambig, <span class="dv">3</span>),</span>
<span id="cb137-301"><a href="#cb137-301" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">signif</span>(<span class="dv">1000</span><span class="sc">*</span>n<span class="sc">/</span>N, <span class="dv">3</span>)</span>
<span id="cb137-302"><a href="#cb137-302" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb137-303"><a href="#cb137-303" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add contrasts columns for OUD vs pain</span></span>
<span id="cb137-304"><a href="#cb137-304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb137-305"><a href="#cb137-305" aria-hidden="true" tabindex="-1"></a>    <span class="at">contrast =</span> <span class="fu">signif</span>((n_oud<span class="sc">-</span>n_pain)<span class="sc">/</span>(n_oud<span class="sc">+</span>n_pain), <span class="dv">3</span>),</span>
<span id="cb137-306"><a href="#cb137-306" aria-hidden="true" tabindex="-1"></a>    <span class="at">w_contrast =</span> <span class="fu">signif</span>(n_ambig<span class="sc">*</span>(n_oud<span class="sc">-</span>n_pain)<span class="sc">/</span>(n_oud<span class="sc">+</span>n_pain), <span class="dv">3</span>)</span>
<span id="cb137-307"><a href="#cb137-307" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb137-308"><a href="#cb137-308" aria-hidden="true" tabindex="-1"></a><span class="co"># display top 100</span></span>
<span id="cb137-309"><a href="#cb137-309" aria-hidden="true" tabindex="-1"></a>brnd_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-310"><a href="#cb137-310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(w_contrast))) <span class="sc">|&gt;</span> </span>
<span id="cb137-311"><a href="#cb137-311" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">100</span>)</span>
<span id="cb137-312"><a href="#cb137-312" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-313"><a href="#cb137-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-314"><a href="#cb137-314" aria-hidden="true" tabindex="-1"></a>Assess the contrasts:</span>
<span id="cb137-315"><a href="#cb137-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-318"><a href="#cb137-318" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-319"><a href="#cb137-319" aria-hidden="true" tabindex="-1"></a><span class="co"># sum weighted contrast over top 50 entries</span></span>
<span id="cb137-320"><a href="#cb137-320" aria-hidden="true" tabindex="-1"></a>brnd_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-321"><a href="#cb137-321" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(w_contrast))) <span class="sc">|&gt;</span> </span>
<span id="cb137-322"><a href="#cb137-322" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-323"><a href="#cb137-323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(w_contrast) <span class="sc">|&gt;</span></span>
<span id="cb137-324"><a href="#cb137-324" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span>
<span id="cb137-325"><a href="#cb137-325" aria-hidden="true" tabindex="-1"></a><span class="co"># sum absolute value of weighted contrast over top 50 entries</span></span>
<span id="cb137-326"><a href="#cb137-326" aria-hidden="true" tabindex="-1"></a>brnd_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-327"><a href="#cb137-327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(w_contrast))) <span class="sc">|&gt;</span> </span>
<span id="cb137-328"><a href="#cb137-328" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-329"><a href="#cb137-329" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(w_contrast) <span class="sc">|&gt;</span></span>
<span id="cb137-330"><a href="#cb137-330" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abs</span>() <span class="sc">|&gt;</span></span>
<span id="cb137-331"><a href="#cb137-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span>
<span id="cb137-332"><a href="#cb137-332" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-333"><a href="#cb137-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-334"><a href="#cb137-334" aria-hidden="true" tabindex="-1"></a>These values are similar, but have a somewhat lower absolute value. We can assess the top 100 and top 200 brand and generics similarly:</span>
<span id="cb137-335"><a href="#cb137-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-336"><a href="#cb137-336" aria-hidden="true" tabindex="-1"></a>For the generics:</span>
<span id="cb137-337"><a href="#cb137-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-340"><a href="#cb137-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-341"><a href="#cb137-341" aria-hidden="true" tabindex="-1"></a><span class="co"># sum weighted contrast over top 100 entries</span></span>
<span id="cb137-342"><a href="#cb137-342" aria-hidden="true" tabindex="-1"></a>drug_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-343"><a href="#cb137-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(w_contrast))) <span class="sc">|&gt;</span> </span>
<span id="cb137-344"><a href="#cb137-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-345"><a href="#cb137-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(w_contrast) <span class="sc">|&gt;</span></span>
<span id="cb137-346"><a href="#cb137-346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span>
<span id="cb137-347"><a href="#cb137-347" aria-hidden="true" tabindex="-1"></a><span class="co"># sum absolute value of weighted contrast over top 100 entries</span></span>
<span id="cb137-348"><a href="#cb137-348" aria-hidden="true" tabindex="-1"></a>drug_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-349"><a href="#cb137-349" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(w_contrast))) <span class="sc">|&gt;</span> </span>
<span id="cb137-350"><a href="#cb137-350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-351"><a href="#cb137-351" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(w_contrast) <span class="sc">|&gt;</span></span>
<span id="cb137-352"><a href="#cb137-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abs</span>() <span class="sc">|&gt;</span></span>
<span id="cb137-353"><a href="#cb137-353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span>
<span id="cb137-354"><a href="#cb137-354" aria-hidden="true" tabindex="-1"></a><span class="co"># sum weighted contrast over top 200 entries</span></span>
<span id="cb137-355"><a href="#cb137-355" aria-hidden="true" tabindex="-1"></a>drug_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-356"><a href="#cb137-356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(w_contrast))) <span class="sc">|&gt;</span> </span>
<span id="cb137-357"><a href="#cb137-357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">200</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-358"><a href="#cb137-358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(w_contrast) <span class="sc">|&gt;</span></span>
<span id="cb137-359"><a href="#cb137-359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span>
<span id="cb137-360"><a href="#cb137-360" aria-hidden="true" tabindex="-1"></a><span class="co"># sum absolute value of weighted contrast over top 50 entries</span></span>
<span id="cb137-361"><a href="#cb137-361" aria-hidden="true" tabindex="-1"></a>drug_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-362"><a href="#cb137-362" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(w_contrast))) <span class="sc">|&gt;</span> </span>
<span id="cb137-363"><a href="#cb137-363" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">200</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-364"><a href="#cb137-364" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(w_contrast) <span class="sc">|&gt;</span></span>
<span id="cb137-365"><a href="#cb137-365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abs</span>() <span class="sc">|&gt;</span></span>
<span id="cb137-366"><a href="#cb137-366" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span>
<span id="cb137-367"><a href="#cb137-367" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-368"><a href="#cb137-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-369"><a href="#cb137-369" aria-hidden="true" tabindex="-1"></a>For the brands:</span>
<span id="cb137-370"><a href="#cb137-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-373"><a href="#cb137-373" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-374"><a href="#cb137-374" aria-hidden="true" tabindex="-1"></a><span class="co"># sum weighted contrast over top 50 entries</span></span>
<span id="cb137-375"><a href="#cb137-375" aria-hidden="true" tabindex="-1"></a>brnd_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-376"><a href="#cb137-376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(w_contrast))) <span class="sc">|&gt;</span> </span>
<span id="cb137-377"><a href="#cb137-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-378"><a href="#cb137-378" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(w_contrast) <span class="sc">|&gt;</span></span>
<span id="cb137-379"><a href="#cb137-379" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span>
<span id="cb137-380"><a href="#cb137-380" aria-hidden="true" tabindex="-1"></a><span class="co"># sum absolute value of weighted contrast over top 50 entries</span></span>
<span id="cb137-381"><a href="#cb137-381" aria-hidden="true" tabindex="-1"></a>brnd_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-382"><a href="#cb137-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(w_contrast))) <span class="sc">|&gt;</span> </span>
<span id="cb137-383"><a href="#cb137-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-384"><a href="#cb137-384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(w_contrast) <span class="sc">|&gt;</span></span>
<span id="cb137-385"><a href="#cb137-385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abs</span>() <span class="sc">|&gt;</span></span>
<span id="cb137-386"><a href="#cb137-386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span>
<span id="cb137-387"><a href="#cb137-387" aria-hidden="true" tabindex="-1"></a><span class="co"># sum weighted contrast over top 50 entries</span></span>
<span id="cb137-388"><a href="#cb137-388" aria-hidden="true" tabindex="-1"></a>brnd_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-389"><a href="#cb137-389" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(w_contrast))) <span class="sc">|&gt;</span> </span>
<span id="cb137-390"><a href="#cb137-390" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">200</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-391"><a href="#cb137-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(w_contrast) <span class="sc">|&gt;</span></span>
<span id="cb137-392"><a href="#cb137-392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span>
<span id="cb137-393"><a href="#cb137-393" aria-hidden="true" tabindex="-1"></a><span class="co"># sum absolute value of weighted contrast over top 50 entries</span></span>
<span id="cb137-394"><a href="#cb137-394" aria-hidden="true" tabindex="-1"></a>brnd_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-395"><a href="#cb137-395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(w_contrast))) <span class="sc">|&gt;</span> </span>
<span id="cb137-396"><a href="#cb137-396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">200</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-397"><a href="#cb137-397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(w_contrast) <span class="sc">|&gt;</span></span>
<span id="cb137-398"><a href="#cb137-398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abs</span>() <span class="sc">|&gt;</span></span>
<span id="cb137-399"><a href="#cb137-399" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span>
<span id="cb137-400"><a href="#cb137-400" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-401"><a href="#cb137-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-402"><a href="#cb137-402" aria-hidden="true" tabindex="-1"></a>The top 100 generic drugs seems like a sweet spot; we will use the generic names for classification of ambiguous observations:</span>
<span id="cb137-403"><a href="#cb137-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-406"><a href="#cb137-406" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-407"><a href="#cb137-407" aria-hidden="true" tabindex="-1"></a>generic_top_100 <span class="ot">&lt;-</span> drug_freq <span class="sc">|&gt;</span> </span>
<span id="cb137-408"><a href="#cb137-408" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(w_contrast))) <span class="sc">|&gt;</span> </span>
<span id="cb137-409"><a href="#cb137-409" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-410"><a href="#cb137-410" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Gnrc_Name) <span class="sc">|&gt;</span></span>
<span id="cb137-411"><a href="#cb137-411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>()</span>
<span id="cb137-412"><a href="#cb137-412" aria-hidden="true" tabindex="-1"></a><span class="co"># create new dataset from drug_classification with only top 50 generic names</span></span>
<span id="cb137-413"><a href="#cb137-413" aria-hidden="true" tabindex="-1"></a>gnrc_100_w <span class="ot">&lt;-</span> data_classification <span class="sc">|&gt;</span> </span>
<span id="cb137-414"><a href="#cb137-414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Gnrc_Name <span class="sc">%in%</span> generic_top_100) <span class="sc">|&gt;</span></span>
<span id="cb137-415"><a href="#cb137-415" aria-hidden="true" tabindex="-1"></a>  <span class="co"># widen the dataset to create new columns for each of the top drugs</span></span>
<span id="cb137-416"><a href="#cb137-416" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb137-417"><a href="#cb137-417" aria-hidden="true" tabindex="-1"></a>    <span class="co"># including bup_pain, bup_oud, bup_ambig to carry them forward</span></span>
<span id="cb137-418"><a href="#cb137-418" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> <span class="fu">c</span>(Prscrbr_NPI, year, bup_pain, bup_oud, bup_ambig),</span>
<span id="cb137-419"><a href="#cb137-419" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> Gnrc_Name,</span>
<span id="cb137-420"><a href="#cb137-420" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> Gnrc_Name,</span>
<span id="cb137-421"><a href="#cb137-421" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fn =</span> <span class="cf">function</span>(x) (<span class="fu">length</span>(x)<span class="sc">/</span><span class="fu">length</span>(x)),</span>
<span id="cb137-422"><a href="#cb137-422" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="dv">0</span></span>
<span id="cb137-423"><a href="#cb137-423" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb137-424"><a href="#cb137-424" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-425"><a href="#cb137-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-426"><a href="#cb137-426" aria-hidden="true" tabindex="-1"></a>We can now create 100 new variables in the main dataset, <span class="in">`data`</span>, one for each of the top generic names, which will be 1 if the provider prescribed the medication in the given year, and 0 otherwise; i.e. for each observation in <span class="in">`data`</span> the NPI/year pair will match with the NPI/year pair in data_classification.</span>
<span id="cb137-427"><a href="#cb137-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-430"><a href="#cb137-430" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-431"><a href="#cb137-431" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb137-432"><a href="#cb137-432" aria-hidden="true" tabindex="-1"></a>  data,</span>
<span id="cb137-433"><a href="#cb137-433" aria-hidden="true" tabindex="-1"></a>  gnrc_100_w,</span>
<span id="cb137-434"><a href="#cb137-434" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Prscrbr_NPI"</span>, <span class="st">"year"</span>),</span>
<span id="cb137-435"><a href="#cb137-435" aria-hidden="true" tabindex="-1"></a>  <span class="at">relationship =</span> <span class="st">"many-to-one"</span></span>
<span id="cb137-436"><a href="#cb137-436" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb137-437"><a href="#cb137-437" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-438"><a href="#cb137-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-439"><a href="#cb137-439" aria-hidden="true" tabindex="-1"></a><span class="fu">### Continuous Predictors</span></span>
<span id="cb137-440"><a href="#cb137-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-441"><a href="#cb137-441" aria-hidden="true" tabindex="-1"></a>Adding other potential predictors including average drug cost per day, average days supply prescribed with summary statistics for unit cost and average days supply by tx:</span>
<span id="cb137-442"><a href="#cb137-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-445"><a href="#cb137-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-446"><a href="#cb137-446" aria-hidden="true" tabindex="-1"></a>data_gnrc_100<span class="sc">$</span>unit_cst <span class="ot">&lt;-</span> data_gnrc_100<span class="sc">$</span>Tot_Drug_Cst<span class="sc">/</span>data_gnrc_100<span class="sc">$</span>Tot_Day_Suply</span>
<span id="cb137-447"><a href="#cb137-447" aria-hidden="true" tabindex="-1"></a>data_gnrc_100<span class="sc">$</span>days_rx <span class="ot">&lt;-</span> data_gnrc_100<span class="sc">$</span>Tot_Day_Suply<span class="sc">/</span>data_gnrc_100<span class="sc">$</span>Tot_Clms</span>
<span id="cb137-448"><a href="#cb137-448" aria-hidden="true" tabindex="-1"></a><span class="co"># summary statistics</span></span>
<span id="cb137-449"><a href="#cb137-449" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="sc">|&gt;</span> </span>
<span id="cb137-450"><a href="#cb137-450" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tx <span class="sc">==</span> <span class="st">"bup_ambig"</span> <span class="sc">|</span> tx <span class="sc">==</span> <span class="st">"bup_oud"</span> <span class="sc">|</span> tx <span class="sc">==</span> <span class="st">"bup_pain"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-451"><a href="#cb137-451" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(tx) <span class="sc">|&gt;</span> </span>
<span id="cb137-452"><a href="#cb137-452" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-453"><a href="#cb137-453" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_unit_cst =</span> <span class="fu">mean</span>(unit_cst),</span>
<span id="cb137-454"><a href="#cb137-454" aria-hidden="true" tabindex="-1"></a>    <span class="at">IQR_unit_cst =</span> <span class="fu">IQR</span>(unit_cst),</span>
<span id="cb137-455"><a href="#cb137-455" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_days_rx =</span> <span class="fu">mean</span>(days_rx),</span>
<span id="cb137-456"><a href="#cb137-456" aria-hidden="true" tabindex="-1"></a>    <span class="at">IQR_days_rx =</span> <span class="fu">IQR</span>(days_rx)</span>
<span id="cb137-457"><a href="#cb137-457" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb137-458"><a href="#cb137-458" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics for 'Buprenorphine Hcl' and 'Buprenorphine' separately</span></span>
<span id="cb137-459"><a href="#cb137-459" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="sc">|&gt;</span> </span>
<span id="cb137-460"><a href="#cb137-460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Brnd_Name <span class="sc">==</span> <span class="st">"Buprenorphine Hcl"</span> <span class="sc">|</span> Brnd_Name <span class="sc">==</span> <span class="st">"Buprenorphine"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-461"><a href="#cb137-461" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Brnd_Name) <span class="sc">|&gt;</span> </span>
<span id="cb137-462"><a href="#cb137-462" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-463"><a href="#cb137-463" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_unit_cst =</span> <span class="fu">mean</span>(unit_cst),</span>
<span id="cb137-464"><a href="#cb137-464" aria-hidden="true" tabindex="-1"></a>    <span class="at">IQR_unit_cst =</span> <span class="fu">IQR</span>(unit_cst),</span>
<span id="cb137-465"><a href="#cb137-465" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_days_rx =</span> <span class="fu">mean</span>(days_rx),</span>
<span id="cb137-466"><a href="#cb137-466" aria-hidden="true" tabindex="-1"></a>    <span class="at">IQR_days_rx =</span> <span class="fu">IQR</span>(days_rx)</span>
<span id="cb137-467"><a href="#cb137-467" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb137-468"><a href="#cb137-468" aria-hidden="true" tabindex="-1"></a><span class="co"># plot histogram days supply by tx</span></span>
<span id="cb137-469"><a href="#cb137-469" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="sc">|&gt;</span> </span>
<span id="cb137-470"><a href="#cb137-470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tx <span class="sc">==</span> <span class="st">"bup_ambig"</span> <span class="sc">|</span> tx <span class="sc">==</span> <span class="st">"bup_oud"</span> <span class="sc">|</span> tx <span class="sc">==</span> <span class="st">"bup_pain"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-471"><a href="#cb137-471" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> days_rx, <span class="at">fill =</span> tx)) <span class="sc">+</span></span>
<span id="cb137-472"><a href="#cb137-472" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb137-473"><a href="#cb137-473" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale x axis to 0-45</span></span>
<span id="cb137-474"><a href="#cb137-474" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">45</span>)) <span class="sc">+</span></span>
<span id="cb137-475"><a href="#cb137-475" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>tx, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb137-476"><a href="#cb137-476" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb137-477"><a href="#cb137-477" aria-hidden="true" tabindex="-1"></a><span class="co"># plot histogram unit cost by tx</span></span>
<span id="cb137-478"><a href="#cb137-478" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="sc">|&gt;</span> </span>
<span id="cb137-479"><a href="#cb137-479" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tx <span class="sc">==</span> <span class="st">"bup_ambig"</span> <span class="sc">|</span> tx <span class="sc">==</span> <span class="st">"bup_oud"</span> <span class="sc">|</span> tx <span class="sc">==</span> <span class="st">"bup_pain"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-480"><a href="#cb137-480" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> unit_cst, <span class="at">fill =</span> tx)) <span class="sc">+</span></span>
<span id="cb137-481"><a href="#cb137-481" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb137-482"><a href="#cb137-482" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale x axis to 0-45</span></span>
<span id="cb137-483"><a href="#cb137-483" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">45</span>)) <span class="sc">+</span></span>
<span id="cb137-484"><a href="#cb137-484" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>tx, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb137-485"><a href="#cb137-485" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb137-486"><a href="#cb137-486" aria-hidden="true" tabindex="-1"></a><span class="co"># plot histogram unit cost by brnd for all bup_ambig</span></span>
<span id="cb137-487"><a href="#cb137-487" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="sc">|&gt;</span> </span>
<span id="cb137-488"><a href="#cb137-488" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tx <span class="sc">==</span> <span class="st">"bup_ambig"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-489"><a href="#cb137-489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> unit_cst, <span class="at">fill =</span> Brnd_Name)) <span class="sc">+</span></span>
<span id="cb137-490"><a href="#cb137-490" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb137-491"><a href="#cb137-491" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale x axis to 0-45</span></span>
<span id="cb137-492"><a href="#cb137-492" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">45</span>)) <span class="sc">+</span></span>
<span id="cb137-493"><a href="#cb137-493" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Brnd_Name, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb137-494"><a href="#cb137-494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb137-495"><a href="#cb137-495" aria-hidden="true" tabindex="-1"></a><span class="co"># plot histogram unit cost by brnd for all bup_oud</span></span>
<span id="cb137-496"><a href="#cb137-496" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="sc">|&gt;</span> </span>
<span id="cb137-497"><a href="#cb137-497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tx <span class="sc">==</span> <span class="st">"bup_oud"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-498"><a href="#cb137-498" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> unit_cst, <span class="at">fill =</span> Brnd_Name)) <span class="sc">+</span></span>
<span id="cb137-499"><a href="#cb137-499" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb137-500"><a href="#cb137-500" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale x axis to 0-45</span></span>
<span id="cb137-501"><a href="#cb137-501" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">45</span>)) <span class="sc">+</span></span>
<span id="cb137-502"><a href="#cb137-502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Brnd_Name, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb137-503"><a href="#cb137-503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb137-504"><a href="#cb137-504" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-505"><a href="#cb137-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-506"><a href="#cb137-506" aria-hidden="true" tabindex="-1"></a>This preliminary analysis of these potential predictors suggests that average unit cost is not likely a good predictor, as the ambiguous entries are all generic and thus tend to be much cheaper; however days supply of 27 days or fewer could potentially be a good predictor. We will include days supply less than or equal to 27 as a new variable and cleanup the rest:</span>
<span id="cb137-507"><a href="#cb137-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-510"><a href="#cb137-510" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-511"><a href="#cb137-511" aria-hidden="true" tabindex="-1"></a>data_gnrc_100<span class="sc">$</span>days_27 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb137-512"><a href="#cb137-512" aria-hidden="true" tabindex="-1"></a>  data_gnrc_100<span class="sc">$</span>days_rx <span class="sc">&lt;=</span> <span class="dv">27</span>, </span>
<span id="cb137-513"><a href="#cb137-513" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb137-514"><a href="#cb137-514" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-515"><a href="#cb137-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-516"><a href="#cb137-516" aria-hidden="true" tabindex="-1"></a><span class="fu">## XGBoost</span></span>
<span id="cb137-517"><a href="#cb137-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-518"><a href="#cb137-518" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dataset Preparation</span></span>
<span id="cb137-519"><a href="#cb137-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-520"><a href="#cb137-520" aria-hidden="true" tabindex="-1"></a>Prepare a dataset for XGBoost. Using <span class="in">`data.matrix`</span> and then <span class="in">`xgb.DMatrix`</span>. Note that for <span class="in">`data.matrix`</span>, "Logical and factor columns are converted to integers. Character columns are first converted to factors and then to integers."</span>
<span id="cb137-521"><a href="#cb137-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-524"><a href="#cb137-524" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-525"><a href="#cb137-525" aria-hidden="true" tabindex="-1"></a><span class="co"># first filtering to relevant observations and intentionally creating a numeric treatment variable</span></span>
<span id="cb137-526"><a href="#cb137-526" aria-hidden="true" tabindex="-1"></a>data_xgb <span class="ot">&lt;-</span> data_gnrc_100 <span class="sc">|&gt;</span> </span>
<span id="cb137-527"><a href="#cb137-527" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter to only include buprenorphine observations</span></span>
<span id="cb137-528"><a href="#cb137-528" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tx <span class="sc">==</span> <span class="st">"bup_ambig"</span> <span class="sc">|</span> tx <span class="sc">==</span> <span class="st">"bup_oud"</span> <span class="sc">|</span> tx <span class="sc">==</span> <span class="st">"bup_pain"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-529"><a href="#cb137-529" aria-hidden="true" tabindex="-1"></a>  <span class="co"># exclude unhelpful observations with oud==1 &amp; pain==1 &amp; ambig==0</span></span>
<span id="cb137-530"><a href="#cb137-530" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(bup_oud <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> bup_pain <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> bup_ambig <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb137-531"><a href="#cb137-531" aria-hidden="true" tabindex="-1"></a>  <span class="co"># convert tx variable to numeric: bup_oud = 1, bup_pain = 2, bup_ambig = 3</span></span>
<span id="cb137-532"><a href="#cb137-532" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tx_num =</span> <span class="fu">case_when</span>(</span>
<span id="cb137-533"><a href="#cb137-533" aria-hidden="true" tabindex="-1"></a>    tx <span class="sc">==</span> <span class="st">"bup_oud"</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb137-534"><a href="#cb137-534" aria-hidden="true" tabindex="-1"></a>    tx <span class="sc">==</span> <span class="st">"bup_pain"</span> <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb137-535"><a href="#cb137-535" aria-hidden="true" tabindex="-1"></a>    tx <span class="sc">==</span> <span class="st">"bup_ambig"</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb137-536"><a href="#cb137-536" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb137-537"><a href="#cb137-537" aria-hidden="true" tabindex="-1"></a><span class="co"># table tx vs tx_num to verify encoding</span></span>
<span id="cb137-538"><a href="#cb137-538" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data_xgb<span class="sc">$</span>tx, data_xgb<span class="sc">$</span>tx_num)</span>
<span id="cb137-539"><a href="#cb137-539" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-540"><a href="#cb137-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-541"><a href="#cb137-541" aria-hidden="true" tabindex="-1"></a>Proceeding to remove variables which will not be matched on and then convert to a matrix:</span>
<span id="cb137-542"><a href="#cb137-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-545"><a href="#cb137-545" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-546"><a href="#cb137-546" aria-hidden="true" tabindex="-1"></a>data_xgb <span class="ot">&lt;-</span> data_xgb <span class="sc">|&gt;</span>    <span class="co"># remove variables which will not be matched on (comment out variables to keep)</span></span>
<span id="cb137-547"><a href="#cb137-547" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb137-548"><a href="#cb137-548" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>Prscrbr_NPI,</span>
<span id="cb137-549"><a href="#cb137-549" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>Prscrbr_Last_Org_Name, </span>
<span id="cb137-550"><a href="#cb137-550" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>Prscrbr_First_Name, </span>
<span id="cb137-551"><a href="#cb137-551" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>Prscrbr_City, </span>
<span id="cb137-552"><a href="#cb137-552" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -Prscrbr_State_Abrvtn, </span></span>
<span id="cb137-553"><a href="#cb137-553" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>Prscrbr_State_FIPS, </span>
<span id="cb137-554"><a href="#cb137-554" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>Prscrbr_Type, </span>
<span id="cb137-555"><a href="#cb137-555" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>Prscrbr_Type_Src, </span>
<span id="cb137-556"><a href="#cb137-556" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>Brnd_Name, </span>
<span id="cb137-557"><a href="#cb137-557" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>Gnrc_Name, </span>
<span id="cb137-558"><a href="#cb137-558" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>Tot_Clms, </span>
<span id="cb137-559"><a href="#cb137-559" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>Tot_30day_Fills, </span>
<span id="cb137-560"><a href="#cb137-560" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>Tot_Day_Suply, </span>
<span id="cb137-561"><a href="#cb137-561" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>Tot_Drug_Cst, </span>
<span id="cb137-562"><a href="#cb137-562" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>Tot_Benes, </span>
<span id="cb137-563"><a href="#cb137-563" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>GE65_Sprsn_Flag, </span>
<span id="cb137-564"><a href="#cb137-564" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>GE65_Tot_Clms, </span>
<span id="cb137-565"><a href="#cb137-565" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>GE65_Tot_30day_Fills, </span>
<span id="cb137-566"><a href="#cb137-566" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>GE65_Tot_Drug_Cst, </span>
<span id="cb137-567"><a href="#cb137-567" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>GE65_Tot_Day_Suply, </span>
<span id="cb137-568"><a href="#cb137-568" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>GE65_Bene_Sprsn_Flag, </span>
<span id="cb137-569"><a href="#cb137-569" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>GE65_Tot_Benes, </span>
<span id="cb137-570"><a href="#cb137-570" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>MAT_generic, </span>
<span id="cb137-571"><a href="#cb137-571" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>MAT_brand, </span>
<span id="cb137-572"><a href="#cb137-572" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>tx,                   <span class="co"># no longer outcome variable</span></span>
<span id="cb137-573"><a href="#cb137-573" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -year, </span></span>
<span id="cb137-574"><a href="#cb137-574" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>county_fips, </span>
<span id="cb137-575"><a href="#cb137-575" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -city_fixed, </span></span>
<span id="cb137-576"><a href="#cb137-576" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>random_fips, </span>
<span id="cb137-577"><a href="#cb137-577" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>fips, </span>
<span id="cb137-578"><a href="#cb137-578" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -nchsurc, </span></span>
<span id="cb137-579"><a href="#cb137-579" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>ur, </span>
<span id="cb137-580"><a href="#cb137-580" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -type,</span></span>
<span id="cb137-581"><a href="#cb137-581" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>bup_pain,</span>
<span id="cb137-582"><a href="#cb137-582" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>bup_oud,</span>
<span id="cb137-583"><a href="#cb137-583" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>bup_ambig,</span>
<span id="cb137-584"><a href="#cb137-584" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>unit_cst,</span>
<span id="cb137-585"><a href="#cb137-585" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -days_rx,</span></span>
<span id="cb137-586"><a href="#cb137-586" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>days_27,</span>
<span id="cb137-587"><a href="#cb137-587" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -tx_num,                 # outcome variable</span></span>
<span id="cb137-588"><a href="#cb137-588" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>id</span>
<span id="cb137-589"><a href="#cb137-589" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb137-590"><a href="#cb137-590" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-591"><a href="#cb137-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-592"><a href="#cb137-592" aria-hidden="true" tabindex="-1"></a><span class="fu">### Testing Training &amp; Prediction Sets</span></span>
<span id="cb137-593"><a href="#cb137-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-594"><a href="#cb137-594" aria-hidden="true" tabindex="-1"></a>Split off the set to be predicted from the testing/training data; and split the remaining data into training/testing sets:</span>
<span id="cb137-595"><a href="#cb137-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-598"><a href="#cb137-598" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-599"><a href="#cb137-599" aria-hidden="true" tabindex="-1"></a><span class="co"># the data to be predicted</span></span>
<span id="cb137-600"><a href="#cb137-600" aria-hidden="true" tabindex="-1"></a>data_xgb.pred <span class="ot">&lt;-</span> data_xgb[data_xgb<span class="sc">$</span>tx_num <span class="sc">==</span> <span class="dv">3</span>,]</span>
<span id="cb137-601"><a href="#cb137-601" aria-hidden="true" tabindex="-1"></a><span class="co"># subset data_xgb to exclude observations to be predicted</span></span>
<span id="cb137-602"><a href="#cb137-602" aria-hidden="true" tabindex="-1"></a>data_xgb <span class="ot">&lt;-</span> data_xgb[data_xgb<span class="sc">$</span>tx_num <span class="sc">!=</span> <span class="dv">3</span>,]</span>
<span id="cb137-603"><a href="#cb137-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-604"><a href="#cb137-604" aria-hidden="true" tabindex="-1"></a><span class="co">#set the seed with the system time</span></span>
<span id="cb137-605"><a href="#cb137-605" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="fu">Sys.time</span>())</span>
<span id="cb137-606"><a href="#cb137-606" aria-hidden="true" tabindex="-1"></a><span class="co">#split the data into training and test sets using caret</span></span>
<span id="cb137-607"><a href="#cb137-607" aria-hidden="true" tabindex="-1"></a>trainIndex <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(</span>
<span id="cb137-608"><a href="#cb137-608" aria-hidden="true" tabindex="-1"></a>  data_xgb<span class="sc">$</span>tx_num, </span>
<span id="cb137-609"><a href="#cb137-609" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> .<span class="dv">8</span>, </span>
<span id="cb137-610"><a href="#cb137-610" aria-hidden="true" tabindex="-1"></a>  <span class="at">list =</span> <span class="cn">FALSE</span>, </span>
<span id="cb137-611"><a href="#cb137-611" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">1</span>)</span>
<span id="cb137-612"><a href="#cb137-612" aria-hidden="true" tabindex="-1"></a>data_xgb.train <span class="ot">&lt;-</span> data_xgb[ trainIndex,]</span>
<span id="cb137-613"><a href="#cb137-613" aria-hidden="true" tabindex="-1"></a>data_xgb.test  <span class="ot">&lt;-</span> data_xgb[<span class="sc">-</span>trainIndex,]</span>
<span id="cb137-614"><a href="#cb137-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-615"><a href="#cb137-615" aria-hidden="true" tabindex="-1"></a><span class="co"># check sum of rows of the 3 subsets of data_xgb</span></span>
<span id="cb137-616"><a href="#cb137-616" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(data_xgb.train)<span class="sc">+</span><span class="fu">nrow</span>(data_xgb.test)<span class="sc">+</span><span class="fu">nrow</span>(data_xgb.pred)</span>
<span id="cb137-617"><a href="#cb137-617" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-618"><a href="#cb137-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-619"><a href="#cb137-619" aria-hidden="true" tabindex="-1"></a>Convert data_xgb ane each of the subsets to <span class="in">`xgb.DMatrix`</span> datatype; this entails defining the outcome variable, removing it from the dataset, and converting to a matrix via <span class="in">`data.matrix()`</span>:</span>
<span id="cb137-620"><a href="#cb137-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-623"><a href="#cb137-623" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-624"><a href="#cb137-624" aria-hidden="true" tabindex="-1"></a><span class="co"># Training set</span></span>
<span id="cb137-625"><a href="#cb137-625" aria-hidden="true" tabindex="-1"></a>y.train <span class="ot">&lt;-</span> data_xgb.train<span class="sc">$</span>tx_num<span class="dv">-1</span>      <span class="co"># set y.train to tx_num - 1</span></span>
<span id="cb137-626"><a href="#cb137-626" aria-hidden="true" tabindex="-1"></a>DM.data_xgb.train <span class="ot">&lt;-</span> data_xgb.train <span class="sc">|&gt;</span>  </span>
<span id="cb137-627"><a href="#cb137-627" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>tx_num) <span class="sc">|&gt;</span>                    <span class="co"># remove tx_num</span></span>
<span id="cb137-628"><a href="#cb137-628" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.matrix</span>() <span class="sc">|&gt;</span>                      <span class="co"># convert to matrix</span></span>
<span id="cb137-629"><a href="#cb137-629" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xgb.DMatrix</span>(<span class="at">label =</span> y.train)          <span class="co"># convert to xgb.DMatrix</span></span>
<span id="cb137-630"><a href="#cb137-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-631"><a href="#cb137-631" aria-hidden="true" tabindex="-1"></a><span class="co"># testing set</span></span>
<span id="cb137-632"><a href="#cb137-632" aria-hidden="true" tabindex="-1"></a>y.test <span class="ot">&lt;-</span> data_xgb.test<span class="sc">$</span>tx_num<span class="dv">-1</span>        <span class="co"># set t.test to tx_num - 1</span></span>
<span id="cb137-633"><a href="#cb137-633" aria-hidden="true" tabindex="-1"></a>DM.data_xgb.test <span class="ot">&lt;-</span> data_xgb.test <span class="sc">|&gt;</span></span>
<span id="cb137-634"><a href="#cb137-634" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>tx_num) <span class="sc">|&gt;</span>                    <span class="co"># remove tx_num</span></span>
<span id="cb137-635"><a href="#cb137-635" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.matrix</span>() <span class="sc">|&gt;</span>                      <span class="co"># convert to matrix</span></span>
<span id="cb137-636"><a href="#cb137-636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xgb.DMatrix</span>(<span class="at">label =</span> y.test)           <span class="co"># convert to xgb.DMatrix</span></span>
<span id="cb137-637"><a href="#cb137-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-638"><a href="#cb137-638" aria-hidden="true" tabindex="-1"></a><span class="co"># prediction set</span></span>
<span id="cb137-639"><a href="#cb137-639" aria-hidden="true" tabindex="-1"></a>DM.data_xgb.ambig <span class="ot">&lt;-</span> data_xgb.pred <span class="sc">|&gt;</span></span>
<span id="cb137-640"><a href="#cb137-640" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>tx_num) <span class="sc">|&gt;</span>                    <span class="co"># remove tx_num</span></span>
<span id="cb137-641"><a href="#cb137-641" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.matrix</span>() <span class="sc">|&gt;</span>                      <span class="co"># convert to matrix</span></span>
<span id="cb137-642"><a href="#cb137-642" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xgb.DMatrix</span>()                         <span class="co"># convert to xgb.DMatrix</span></span>
<span id="cb137-643"><a href="#cb137-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-644"><a href="#cb137-644" aria-hidden="true" tabindex="-1"></a><span class="co"># full dataset</span></span>
<span id="cb137-645"><a href="#cb137-645" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> data_xgb<span class="sc">$</span>tx_num<span class="dv">-1</span>                  <span class="co"># set y to tx_num - 1</span></span>
<span id="cb137-646"><a href="#cb137-646" aria-hidden="true" tabindex="-1"></a>DM.data_xgb <span class="ot">&lt;-</span> data_xgb <span class="sc">|&gt;</span></span>
<span id="cb137-647"><a href="#cb137-647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>tx_num) <span class="sc">|&gt;</span>                    <span class="co"># remove tx_num</span></span>
<span id="cb137-648"><a href="#cb137-648" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.matrix</span>() <span class="sc">|&gt;</span>                      <span class="co"># convert to matrix</span></span>
<span id="cb137-649"><a href="#cb137-649" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xgb.DMatrix</span>(<span class="at">label =</span> y)                <span class="co"># convert to xgb.DMatrix</span></span>
<span id="cb137-650"><a href="#cb137-650" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-651"><a href="#cb137-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-652"><a href="#cb137-652" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model Fitting</span></span>
<span id="cb137-653"><a href="#cb137-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-654"><a href="#cb137-654" aria-hidden="true" tabindex="-1"></a>Now we can specify the parameters for the training of model, and run:</span>
<span id="cb137-655"><a href="#cb137-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-658"><a href="#cb137-658" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-659"><a href="#cb137-659" aria-hidden="true" tabindex="-1"></a><span class="co"># watchlist &lt;- list(</span></span>
<span id="cb137-660"><a href="#cb137-660" aria-hidden="true" tabindex="-1"></a><span class="co">#   train = DM.data_xgb.train, </span></span>
<span id="cb137-661"><a href="#cb137-661" aria-hidden="true" tabindex="-1"></a><span class="co">#   test = DM.data_xgb.test)</span></span>
<span id="cb137-662"><a href="#cb137-662" aria-hidden="true" tabindex="-1"></a><span class="co"># params &lt;- list(</span></span>
<span id="cb137-663"><a href="#cb137-663" aria-hidden="true" tabindex="-1"></a><span class="co">#   objective = "binary:logistic")</span></span>
<span id="cb137-664"><a href="#cb137-664" aria-hidden="true" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb137-665"><a href="#cb137-665" aria-hidden="true" tabindex="-1"></a>  <span class="st">"objective"</span> <span class="ot">=</span> <span class="st">"multi:softprob"</span>,</span>
<span id="cb137-666"><a href="#cb137-666" aria-hidden="true" tabindex="-1"></a>  <span class="st">"num_class"</span> <span class="ot">=</span> <span class="dv">2</span>)</span>
<span id="cb137-667"><a href="#cb137-667" aria-hidden="true" tabindex="-1"></a>xfit1 <span class="ot">&lt;-</span> <span class="fu">xgb.cv</span>(</span>
<span id="cb137-668"><a href="#cb137-668" aria-hidden="true" tabindex="-1"></a>  <span class="at">params =</span> param,</span>
<span id="cb137-669"><a href="#cb137-669" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> DM.data_xgb,</span>
<span id="cb137-670"><a href="#cb137-670" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrounds =</span> <span class="dv">10</span>,</span>
<span id="cb137-671"><a href="#cb137-671" aria-hidden="true" tabindex="-1"></a>  <span class="at">nfold =</span> <span class="dv">5</span>,</span>
<span id="cb137-672"><a href="#cb137-672" aria-hidden="true" tabindex="-1"></a>  <span class="at">prediction =</span> <span class="cn">TRUE</span>,</span>
<span id="cb137-673"><a href="#cb137-673" aria-hidden="true" tabindex="-1"></a>  <span class="at">stratified =</span> <span class="cn">TRUE</span>,</span>
<span id="cb137-674"><a href="#cb137-674" aria-hidden="true" tabindex="-1"></a>  <span class="at">train_folds =</span> trainIndex,</span>
<span id="cb137-675"><a href="#cb137-675" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb137-676"><a href="#cb137-676" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb137-677"><a href="#cb137-677" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-678"><a href="#cb137-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-681"><a href="#cb137-681" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-682"><a href="#cb137-682" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(xfit1)</span>
<span id="cb137-683"><a href="#cb137-683" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-684"><a href="#cb137-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-687"><a href="#cb137-687" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-688"><a href="#cb137-688" aria-hidden="true" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb137-689"><a href="#cb137-689" aria-hidden="true" tabindex="-1"></a>  <span class="st">"objective"</span> <span class="ot">=</span> <span class="st">"multi:softprob"</span>,</span>
<span id="cb137-690"><a href="#cb137-690" aria-hidden="true" tabindex="-1"></a>  <span class="st">"num_class"</span> <span class="ot">=</span> <span class="dv">2</span>)</span>
<span id="cb137-691"><a href="#cb137-691" aria-hidden="true" tabindex="-1"></a>watchlist <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb137-692"><a href="#cb137-692" aria-hidden="true" tabindex="-1"></a>  <span class="at">train =</span> DM.data_xgb.train, </span>
<span id="cb137-693"><a href="#cb137-693" aria-hidden="true" tabindex="-1"></a>  <span class="at">eval =</span> DM.data_xgb.test)</span>
<span id="cb137-694"><a href="#cb137-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-695"><a href="#cb137-695" aria-hidden="true" tabindex="-1"></a>xfit2 <span class="ot">&lt;-</span> xgboost<span class="sc">::</span><span class="fu">xgboost</span>(</span>
<span id="cb137-696"><a href="#cb137-696" aria-hidden="true" tabindex="-1"></a>  <span class="at">param =</span> param, </span>
<span id="cb137-697"><a href="#cb137-697" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> DM.data_xgb.train, </span>
<span id="cb137-698"><a href="#cb137-698" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrounds=</span><span class="dv">3</span>)</span>
<span id="cb137-699"><a href="#cb137-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-700"><a href="#cb137-700" aria-hidden="true" tabindex="-1"></a>xfit3 <span class="ot">&lt;-</span> <span class="fu">xgb.train</span>(</span>
<span id="cb137-701"><a href="#cb137-701" aria-hidden="true" tabindex="-1"></a>  <span class="at">param =</span> param, </span>
<span id="cb137-702"><a href="#cb137-702" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> DM.data_xgb.train, </span>
<span id="cb137-703"><a href="#cb137-703" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrounds=</span><span class="dv">100</span>,</span>
<span id="cb137-704"><a href="#cb137-704" aria-hidden="true" tabindex="-1"></a>  <span class="at">watchlist =</span> watchlist)</span>
<span id="cb137-705"><a href="#cb137-705" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-706"><a href="#cb137-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-707"><a href="#cb137-707" aria-hidden="true" tabindex="-1"></a>Overfitting seems to set in after \~30 iterations, so let's create another model with 30 iterations:</span>
<span id="cb137-708"><a href="#cb137-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-711"><a href="#cb137-711" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-712"><a href="#cb137-712" aria-hidden="true" tabindex="-1"></a>xfit4 <span class="ot">&lt;-</span> <span class="fu">xgb.train</span>(</span>
<span id="cb137-713"><a href="#cb137-713" aria-hidden="true" tabindex="-1"></a>  <span class="at">param =</span> param, </span>
<span id="cb137-714"><a href="#cb137-714" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> DM.data_xgb.train, </span>
<span id="cb137-715"><a href="#cb137-715" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrounds=</span><span class="dv">30</span>,</span>
<span id="cb137-716"><a href="#cb137-716" aria-hidden="true" tabindex="-1"></a>  <span class="at">watchlist =</span> watchlist)</span>
<span id="cb137-717"><a href="#cb137-717" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-718"><a href="#cb137-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-721"><a href="#cb137-721" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-722"><a href="#cb137-722" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(xfit4)</span>
<span id="cb137-723"><a href="#cb137-723" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-724"><a href="#cb137-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-727"><a href="#cb137-727" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-728"><a href="#cb137-728" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.plot.multi.trees</span>(<span class="at">model =</span> xfit4)</span>
<span id="cb137-729"><a href="#cb137-729" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-730"><a href="#cb137-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-733"><a href="#cb137-733" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-734"><a href="#cb137-734" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> <span class="fu">predict</span>(</span>
<span id="cb137-735"><a href="#cb137-735" aria-hidden="true" tabindex="-1"></a>  xfit4,</span>
<span id="cb137-736"><a href="#cb137-736" aria-hidden="true" tabindex="-1"></a>  DM.data_xgb.train)</span>
<span id="cb137-737"><a href="#cb137-737" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> <span class="fu">matrix</span>(pred,<span class="at">ncol=</span><span class="dv">3</span>,<span class="at">byrow=</span>T)</span>
<span id="cb137-738"><a href="#cb137-738" aria-hidden="true" tabindex="-1"></a>pclass <span class="ot">=</span> <span class="fu">apply</span>(pred,<span class="dv">1</span>,which.max)</span>
<span id="cb137-739"><a href="#cb137-739" aria-hidden="true" tabindex="-1"></a>mat4 <span class="ot">&lt;-</span> data_xgb <span class="sc">|&gt;</span></span>
<span id="cb137-740"><a href="#cb137-740" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>tx_num) <span class="sc">|&gt;</span>                  <span class="co"># remove tx_num</span></span>
<span id="cb137-741"><a href="#cb137-741" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>() <span class="sc">|&gt;</span>                       <span class="co"># get column names</span></span>
<span id="cb137-742"><a href="#cb137-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xgb.importance</span>(                     <span class="co"># get importance matrix</span></span>
<span id="cb137-743"><a href="#cb137-743" aria-hidden="true" tabindex="-1"></a>    <span class="co"># feature_names = .,                # use column names</span></span>
<span id="cb137-744"><a href="#cb137-744" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> xfit4)</span>
<span id="cb137-745"><a href="#cb137-745" aria-hidden="true" tabindex="-1"></a><span class="co"># old code:</span></span>
<span id="cb137-746"><a href="#cb137-746" aria-hidden="true" tabindex="-1"></a><span class="co"># mat4 = xgb.importance(</span></span>
<span id="cb137-747"><a href="#cb137-747" aria-hidden="true" tabindex="-1"></a><span class="co">#   feature_names = colnames(data_xgb[,-c("tx_num")]),   # don't include tx number</span></span>
<span id="cb137-748"><a href="#cb137-748" aria-hidden="true" tabindex="-1"></a><span class="co">#   model = xfit4)</span></span>
<span id="cb137-749"><a href="#cb137-749" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.ggplot.importance</span>(</span>
<span id="cb137-750"><a href="#cb137-750" aria-hidden="true" tabindex="-1"></a>  <span class="at">importance_matrix =</span> mat4,</span>
<span id="cb137-751"><a href="#cb137-751" aria-hidden="true" tabindex="-1"></a>  <span class="at">top_n =</span> <span class="dv">20</span>)</span>
<span id="cb137-752"><a href="#cb137-752" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-753"><a href="#cb137-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-754"><a href="#cb137-754" aria-hidden="true" tabindex="-1"></a>Tabulation of proportion of prescribers who prescribed bup_ambig who also prescribed a product with generic name "Buprenorphine Hcl/Naloxone Hcl":</span>
<span id="cb137-755"><a href="#cb137-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-758"><a href="#cb137-758" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-759"><a href="#cb137-759" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="sc">|&gt;</span></span>
<span id="cb137-760"><a href="#cb137-760" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(bup_ambig <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-761"><a href="#cb137-761" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Prscrbr_NPI, year) <span class="sc">|&gt;</span></span>
<span id="cb137-762"><a href="#cb137-762" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-763"><a href="#cb137-763" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb137-764"><a href="#cb137-764" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_bup_nal =</span> <span class="fu">sum</span>(Gnrc_Name <span class="sc">==</span> <span class="st">"Buprenorphine Hcl/Naloxone Hcl"</span>),</span>
<span id="cb137-765"><a href="#cb137-765" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-766"><a href="#cb137-766" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-767"><a href="#cb137-767" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb137-768"><a href="#cb137-768" aria-hidden="true" tabindex="-1"></a>    <span class="co"># number of rows where n_bup_nal &gt; 0</span></span>
<span id="cb137-769"><a href="#cb137-769" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_bup_nal =</span> <span class="fu">sum</span>(n_bup_nal <span class="sc">&gt;</span> <span class="dv">0</span>),</span>
<span id="cb137-770"><a href="#cb137-770" aria-hidden="true" tabindex="-1"></a>    <span class="co"># proportion of rows where n_bup_nal &gt; 0</span></span>
<span id="cb137-771"><a href="#cb137-771" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop_bup_nal =</span> n_bup_nal<span class="sc">/</span>N)</span>
<span id="cb137-772"><a href="#cb137-772" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-773"><a href="#cb137-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-774"><a href="#cb137-774" aria-hidden="true" tabindex="-1"></a><span class="fu">### Confusion Matrix</span></span>
<span id="cb137-775"><a href="#cb137-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-776"><a href="#cb137-776" aria-hidden="true" tabindex="-1"></a>This suggests that bup/naloxone likely is an important predictor for our ambiguous observations. Now we calculate the confusion matrix for xfit4:</span>
<span id="cb137-777"><a href="#cb137-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-780"><a href="#cb137-780" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-781"><a href="#cb137-781" aria-hidden="true" tabindex="-1"></a>pred.test <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb137-782"><a href="#cb137-782" aria-hidden="true" tabindex="-1"></a>  xfit4,</span>
<span id="cb137-783"><a href="#cb137-783" aria-hidden="true" tabindex="-1"></a>  DM.data_xgb.test,</span>
<span id="cb137-784"><a href="#cb137-784" aria-hidden="true" tabindex="-1"></a>  <span class="at">strict_shape =</span> <span class="cn">TRUE</span>)</span>
<span id="cb137-785"><a href="#cb137-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-786"><a href="#cb137-786" aria-hidden="true" tabindex="-1"></a>pred_labels <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb137-787"><a href="#cb137-787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(</span>
<span id="cb137-788"><a href="#cb137-788" aria-hidden="true" tabindex="-1"></a>    pred.test[<span class="dv">2</span>,])<span class="sc">+</span><span class="dv">1</span>, </span>
<span id="cb137-789"><a href="#cb137-789" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"bup_oud"</span>, <span class="st">"bup_pain"</span>))</span>
<span id="cb137-790"><a href="#cb137-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-791"><a href="#cb137-791" aria-hidden="true" tabindex="-1"></a>test_labels <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb137-792"><a href="#cb137-792" aria-hidden="true" tabindex="-1"></a>  data_xgb.test<span class="sc">$</span>tx_num,</span>
<span id="cb137-793"><a href="#cb137-793" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"bup_oud"</span>, <span class="st">"bup_pain"</span>))</span>
<span id="cb137-794"><a href="#cb137-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-795"><a href="#cb137-795" aria-hidden="true" tabindex="-1"></a><span class="fu">confusionMatrix</span>(</span>
<span id="cb137-796"><a href="#cb137-796" aria-hidden="true" tabindex="-1"></a>  pred_labels,</span>
<span id="cb137-797"><a href="#cb137-797" aria-hidden="true" tabindex="-1"></a>  test_labels</span>
<span id="cb137-798"><a href="#cb137-798" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb137-799"><a href="#cb137-799" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-800"><a href="#cb137-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-801"><a href="#cb137-801" aria-hidden="true" tabindex="-1"></a><span class="fu"># Prediction for bup_ambig</span></span>
<span id="cb137-802"><a href="#cb137-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-805"><a href="#cb137-805" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-806"><a href="#cb137-806" aria-hidden="true" tabindex="-1"></a><span class="co"># use xfit4 model to predict probabilities</span></span>
<span id="cb137-807"><a href="#cb137-807" aria-hidden="true" tabindex="-1"></a>pred.ambig <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb137-808"><a href="#cb137-808" aria-hidden="true" tabindex="-1"></a>  xfit4,</span>
<span id="cb137-809"><a href="#cb137-809" aria-hidden="true" tabindex="-1"></a>  DM.data_xgb.ambig,</span>
<span id="cb137-810"><a href="#cb137-810" aria-hidden="true" tabindex="-1"></a>  <span class="at">strict_shape =</span> <span class="cn">TRUE</span>)</span>
<span id="cb137-811"><a href="#cb137-811" aria-hidden="true" tabindex="-1"></a><span class="co"># convert probabilities to labels</span></span>
<span id="cb137-812"><a href="#cb137-812" aria-hidden="true" tabindex="-1"></a>labels.ambig <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb137-813"><a href="#cb137-813" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(pred.ambig[<span class="dv">2</span>,])<span class="sc">+</span><span class="dv">1</span>, </span>
<span id="cb137-814"><a href="#cb137-814" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"bup_oud"</span>, <span class="st">"bup_pain"</span>))</span>
<span id="cb137-815"><a href="#cb137-815" aria-hidden="true" tabindex="-1"></a><span class="co"># add labels to data_xgb.pred</span></span>
<span id="cb137-816"><a href="#cb137-816" aria-hidden="true" tabindex="-1"></a>data_xgb.pred<span class="sc">$</span>tx_pred <span class="ot">&lt;-</span> labels.ambig</span>
<span id="cb137-817"><a href="#cb137-817" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-818"><a href="#cb137-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-819"><a href="#cb137-819" aria-hidden="true" tabindex="-1"></a>Tabulate some results:</span>
<span id="cb137-820"><a href="#cb137-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-823"><a href="#cb137-823" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-824"><a href="#cb137-824" aria-hidden="true" tabindex="-1"></a>data_xgb.pred <span class="sc">|&gt;</span></span>
<span id="cb137-825"><a href="#cb137-825" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(tx_pred) <span class="sc">|&gt;</span></span>
<span id="cb137-826"><a href="#cb137-826" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-827"><a href="#cb137-827" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb137-828"><a href="#cb137-828" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb137-829"><a href="#cb137-829" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize by year</span></span>
<span id="cb137-830"><a href="#cb137-830" aria-hidden="true" tabindex="-1"></a>data_xgb.pred <span class="sc">|&gt;</span></span>
<span id="cb137-831"><a href="#cb137-831" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb137-832"><a href="#cb137-832" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-833"><a href="#cb137-833" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_oud =</span> <span class="fu">sum</span>(tx_pred <span class="sc">==</span> <span class="st">"bup_oud"</span>),</span>
<span id="cb137-834"><a href="#cb137-834" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pain =</span> <span class="fu">sum</span>(tx_pred <span class="sc">==</span> <span class="st">"bup_pain"</span>),</span>
<span id="cb137-835"><a href="#cb137-835" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb137-836"><a href="#cb137-836" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb137-837"><a href="#cb137-837" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize by prescriber type</span></span>
<span id="cb137-838"><a href="#cb137-838" aria-hidden="true" tabindex="-1"></a>data_xgb.pred <span class="sc">|&gt;</span></span>
<span id="cb137-839"><a href="#cb137-839" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(type) <span class="sc">|&gt;</span></span>
<span id="cb137-840"><a href="#cb137-840" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-841"><a href="#cb137-841" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_oud =</span> <span class="fu">sum</span>(tx_pred <span class="sc">==</span> <span class="st">"bup_oud"</span>),</span>
<span id="cb137-842"><a href="#cb137-842" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pain =</span> <span class="fu">sum</span>(tx_pred <span class="sc">==</span> <span class="st">"bup_pain"</span>),</span>
<span id="cb137-843"><a href="#cb137-843" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb137-844"><a href="#cb137-844" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb137-845"><a href="#cb137-845" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-846"><a href="#cb137-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-847"><a href="#cb137-847" aria-hidden="true" tabindex="-1"></a>Merge with original data:</span>
<span id="cb137-848"><a href="#cb137-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-851"><a href="#cb137-851" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-852"><a href="#cb137-852" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> data<span class="sc">$</span>id[data<span class="sc">$</span>Brnd_Name <span class="sc">==</span> <span class="st">"Buprenorphine"</span><span class="sc">|</span>data<span class="sc">$</span>Brnd_Name <span class="sc">==</span> <span class="st">"Buprenorphine Hcl"</span>]</span>
<span id="cb137-853"><a href="#cb137-853" aria-hidden="true" tabindex="-1"></a><span class="co"># add row id numbers back to data_xgb.pred</span></span>
<span id="cb137-854"><a href="#cb137-854" aria-hidden="true" tabindex="-1"></a>data_xgb.pred<span class="sc">$</span>id <span class="ot">&lt;-</span> ids</span>
<span id="cb137-855"><a href="#cb137-855" aria-hidden="true" tabindex="-1"></a>data_xgb.pred_minimal <span class="ot">&lt;-</span> data_xgb.pred <span class="sc">|&gt;</span></span>
<span id="cb137-856"><a href="#cb137-856" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, tx_pred)</span>
<span id="cb137-857"><a href="#cb137-857" aria-hidden="true" tabindex="-1"></a><span class="co"># merge predicted treatment and bup_pain/bup_oud/Bup_ambig into original dataset</span></span>
<span id="cb137-858"><a href="#cb137-858" aria-hidden="true" tabindex="-1"></a>data_pred <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb137-859"><a href="#cb137-859" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb137-860"><a href="#cb137-860" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the first join is with data_xgb.pred_minimal for the predicted treatments</span></span>
<span id="cb137-861"><a href="#cb137-861" aria-hidden="true" tabindex="-1"></a>    data_xgb.pred_minimal,</span>
<span id="cb137-862"><a href="#cb137-862" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb137-863"><a href="#cb137-863" aria-hidden="true" tabindex="-1"></a>      <span class="st">"id"</span> <span class="sc">==</span> <span class="st">"id"</span>),</span>
<span id="cb137-864"><a href="#cb137-864" aria-hidden="true" tabindex="-1"></a>    <span class="at">relationship =</span> <span class="st">"one-to-one"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-865"><a href="#cb137-865" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the second join is with data_gnrc_100 for the bup_pain/bup_oud/Bup_ambig</span></span>
<span id="cb137-866"><a href="#cb137-866" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb137-867"><a href="#cb137-867" aria-hidden="true" tabindex="-1"></a>    data_gnrc_100[<span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"bup_pain"</span>, <span class="st">"bup_oud"</span>, <span class="st">"bup_ambig"</span>)],</span>
<span id="cb137-868"><a href="#cb137-868" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb137-869"><a href="#cb137-869" aria-hidden="true" tabindex="-1"></a>      <span class="st">"id"</span> <span class="sc">==</span> <span class="st">"id"</span>),</span>
<span id="cb137-870"><a href="#cb137-870" aria-hidden="true" tabindex="-1"></a>    <span class="at">relationship =</span> <span class="st">"one-to-one"</span>)</span>
<span id="cb137-871"><a href="#cb137-871" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-872"><a href="#cb137-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-873"><a href="#cb137-873" aria-hidden="true" tabindex="-1"></a><span class="fu"># Examining Predicted Data</span></span>
<span id="cb137-874"><a href="#cb137-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-875"><a href="#cb137-875" aria-hidden="true" tabindex="-1"></a>Looking at the predictions in relation to several other important variables including NCHSURC, provider type, generic name of buprenorphine prescribed, and other drugs prescribed:</span>
<span id="cb137-876"><a href="#cb137-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-879"><a href="#cb137-879" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-880"><a href="#cb137-880" aria-hidden="true" tabindex="-1"></a><span class="co"># beginning by joining the predicted data with data_gnrc_100</span></span>
<span id="cb137-881"><a href="#cb137-881" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb137-882"><a href="#cb137-882" aria-hidden="true" tabindex="-1"></a>  data_gnrc_100,</span>
<span id="cb137-883"><a href="#cb137-883" aria-hidden="true" tabindex="-1"></a>  data_xgb.pred_minimal,</span>
<span id="cb137-884"><a href="#cb137-884" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb137-885"><a href="#cb137-885" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span> <span class="sc">==</span> <span class="st">"id"</span>),</span>
<span id="cb137-886"><a href="#cb137-886" aria-hidden="true" tabindex="-1"></a>  <span class="at">relationship =</span> <span class="st">"one-to-one"</span>)</span>
<span id="cb137-887"><a href="#cb137-887" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-888"><a href="#cb137-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-889"><a href="#cb137-889" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tabulate by NCHSURC</span></span>
<span id="cb137-890"><a href="#cb137-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-893"><a href="#cb137-893" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-894"><a href="#cb137-894" aria-hidden="true" tabindex="-1"></a><span class="co"># tabulate predicted by NCHSURC</span></span>
<span id="cb137-895"><a href="#cb137-895" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="sc">|&gt;</span></span>
<span id="cb137-896"><a href="#cb137-896" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tx <span class="sc">==</span> <span class="st">"bup_ambig"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-897"><a href="#cb137-897" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(nchsurc, tx_pred) <span class="sc">|&gt;</span></span>
<span id="cb137-898"><a href="#cb137-898" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-899"><a href="#cb137-899" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb137-900"><a href="#cb137-900" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-901"><a href="#cb137-901" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb137-902"><a href="#cb137-902" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> tx_pred,</span>
<span id="cb137-903"><a href="#cb137-903" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> n,</span>
<span id="cb137-904"><a href="#cb137-904" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb137-905"><a href="#cb137-905" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-906"><a href="#cb137-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-907"><a href="#cb137-907" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tabulate by provider type</span></span>
<span id="cb137-908"><a href="#cb137-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-911"><a href="#cb137-911" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-912"><a href="#cb137-912" aria-hidden="true" tabindex="-1"></a><span class="co"># tabulate predicted by type</span></span>
<span id="cb137-913"><a href="#cb137-913" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="sc">|&gt;</span></span>
<span id="cb137-914"><a href="#cb137-914" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tx <span class="sc">==</span> <span class="st">"bup_ambig"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-915"><a href="#cb137-915" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(type, tx_pred) <span class="sc">|&gt;</span></span>
<span id="cb137-916"><a href="#cb137-916" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-917"><a href="#cb137-917" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb137-918"><a href="#cb137-918" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-919"><a href="#cb137-919" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb137-920"><a href="#cb137-920" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> tx_pred,</span>
<span id="cb137-921"><a href="#cb137-921" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> n,</span>
<span id="cb137-922"><a href="#cb137-922" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb137-923"><a href="#cb137-923" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-924"><a href="#cb137-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-925"><a href="#cb137-925" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tabulate by generic name</span></span>
<span id="cb137-926"><a href="#cb137-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-929"><a href="#cb137-929" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-930"><a href="#cb137-930" aria-hidden="true" tabindex="-1"></a><span class="co"># tabulate predicted by generic name</span></span>
<span id="cb137-931"><a href="#cb137-931" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="sc">|&gt;</span></span>
<span id="cb137-932"><a href="#cb137-932" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tx <span class="sc">==</span> <span class="st">"bup_ambig"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-933"><a href="#cb137-933" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Gnrc_Name, tx_pred) <span class="sc">|&gt;</span></span>
<span id="cb137-934"><a href="#cb137-934" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-935"><a href="#cb137-935" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb137-936"><a href="#cb137-936" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-937"><a href="#cb137-937" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb137-938"><a href="#cb137-938" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> tx_pred,</span>
<span id="cb137-939"><a href="#cb137-939" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> n,</span>
<span id="cb137-940"><a href="#cb137-940" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb137-941"><a href="#cb137-941" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-942"><a href="#cb137-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-943"><a href="#cb137-943" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tabulate by days_27</span></span>
<span id="cb137-944"><a href="#cb137-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-947"><a href="#cb137-947" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-948"><a href="#cb137-948" aria-hidden="true" tabindex="-1"></a><span class="co"># tabulate by days_27</span></span>
<span id="cb137-949"><a href="#cb137-949" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="sc">|&gt;</span></span>
<span id="cb137-950"><a href="#cb137-950" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tx <span class="sc">==</span> <span class="st">"bup_ambig"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-951"><a href="#cb137-951" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(days_27, tx_pred) <span class="sc">|&gt;</span></span>
<span id="cb137-952"><a href="#cb137-952" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-953"><a href="#cb137-953" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb137-954"><a href="#cb137-954" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-955"><a href="#cb137-955" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb137-956"><a href="#cb137-956" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> tx_pred,</span>
<span id="cb137-957"><a href="#cb137-957" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> n,</span>
<span id="cb137-958"><a href="#cb137-958" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb137-959"><a href="#cb137-959" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-960"><a href="#cb137-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-961"><a href="#cb137-961" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tabulate by "Buprenorphine Hcl/Naloxone Hcl"</span></span>
<span id="cb137-962"><a href="#cb137-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-965"><a href="#cb137-965" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-966"><a href="#cb137-966" aria-hidden="true" tabindex="-1"></a><span class="co"># tabulate by "Buprenorphine Hcl/Naloxone Hcl"</span></span>
<span id="cb137-967"><a href="#cb137-967" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="sc">|&gt;</span></span>
<span id="cb137-968"><a href="#cb137-968" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tx <span class="sc">==</span> <span class="st">"bup_ambig"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-969"><a href="#cb137-969" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="st">`</span><span class="at">Buprenorphine Hcl/Naloxone Hcl</span><span class="st">`</span>, tx_pred) <span class="sc">|&gt;</span></span>
<span id="cb137-970"><a href="#cb137-970" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-971"><a href="#cb137-971" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb137-972"><a href="#cb137-972" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-973"><a href="#cb137-973" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb137-974"><a href="#cb137-974" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> tx_pred,</span>
<span id="cb137-975"><a href="#cb137-975" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> n,</span>
<span id="cb137-976"><a href="#cb137-976" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb137-977"><a href="#cb137-977" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-978"><a href="#cb137-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-979"><a href="#cb137-979" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tabulate by year</span></span>
<span id="cb137-980"><a href="#cb137-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-983"><a href="#cb137-983" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-984"><a href="#cb137-984" aria-hidden="true" tabindex="-1"></a><span class="co"># tabulate by year</span></span>
<span id="cb137-985"><a href="#cb137-985" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="sc">|&gt;</span></span>
<span id="cb137-986"><a href="#cb137-986" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tx <span class="sc">==</span> <span class="st">"bup_ambig"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-987"><a href="#cb137-987" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, tx_pred) <span class="sc">|&gt;</span></span>
<span id="cb137-988"><a href="#cb137-988" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-989"><a href="#cb137-989" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb137-990"><a href="#cb137-990" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-991"><a href="#cb137-991" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb137-992"><a href="#cb137-992" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> tx_pred,</span>
<span id="cb137-993"><a href="#cb137-993" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> n,</span>
<span id="cb137-994"><a href="#cb137-994" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb137-995"><a href="#cb137-995" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-996"><a href="#cb137-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-997"><a href="#cb137-997" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tabulate by NP/PA Rx by year</span></span>
<span id="cb137-998"><a href="#cb137-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-1001"><a href="#cb137-1001" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-1002"><a href="#cb137-1002" aria-hidden="true" tabindex="-1"></a><span class="co"># tabulate NP/PA Rx by year</span></span>
<span id="cb137-1003"><a href="#cb137-1003" aria-hidden="true" tabindex="-1"></a>data_gnrc_100 <span class="sc">|&gt;</span></span>
<span id="cb137-1004"><a href="#cb137-1004" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tx <span class="sc">==</span> <span class="st">"bup_ambig"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-1005"><a href="#cb137-1005" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"NP"</span> <span class="sc">|</span> type <span class="sc">==</span> <span class="st">"PA"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-1006"><a href="#cb137-1006" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, tx_pred) <span class="sc">|&gt;</span></span>
<span id="cb137-1007"><a href="#cb137-1007" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb137-1008"><a href="#cb137-1008" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb137-1009"><a href="#cb137-1009" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb137-1010"><a href="#cb137-1010" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb137-1011"><a href="#cb137-1011" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> tx_pred,</span>
<span id="cb137-1012"><a href="#cb137-1012" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> n,</span>
<span id="cb137-1013"><a href="#cb137-1013" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb137-1014"><a href="#cb137-1014" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-1015"><a href="#cb137-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-1016"><a href="#cb137-1016" aria-hidden="true" tabindex="-1"></a><span class="fu"># Cleanup</span></span>
<span id="cb137-1017"><a href="#cb137-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-1018"><a href="#cb137-1018" aria-hidden="true" tabindex="-1"></a>Save the dataset:</span>
<span id="cb137-1019"><a href="#cb137-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-1022"><a href="#cb137-1022" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-1023"><a href="#cb137-1023" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(data_pred, <span class="at">file =</span> <span class="st">"dataset/data_pred.RData"</span>)</span>
<span id="cb137-1024"><a href="#cb137-1024" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-1025"><a href="#cb137-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-1026"><a href="#cb137-1026" aria-hidden="true" tabindex="-1"></a>Cleanup:</span>
<span id="cb137-1027"><a href="#cb137-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-1030"><a href="#cb137-1030" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-1031"><a href="#cb137-1031" aria-hidden="true" tabindex="-1"></a><span class="co"># rm(brnd_freq, drug_freq, gnrc_100_w, providers, providers_wide, generic_top_100, N, N_ambig, N_oud, N_pain)</span></span>
<span id="cb137-1032"><a href="#cb137-1032" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-1033"><a href="#cb137-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-1036"><a href="#cb137-1036" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-1037"><a href="#cb137-1037" aria-hidden="true" tabindex="-1"></a><span class="co"># rm(data_classification, data_gnrc_100, data_xgb, data_xgb.pred, data_xgb.pred_minimal, data_xgb.test, data_xgb.train, M.data_xgb.test, M.data_xgb.train, N, oj, param, params, pred, pred.ambig, pred.test, trainIndex, watchlist, xfit0, xfit1, xfit2, xfit3, DM.data_xgb, DM.data_xgb.ambig, DM.data_xgb.test, DM.data_xgb.train, labels.ambig, pclass, pred_labels, test_labels, y, y.test, y.train)</span></span>
<span id="cb137-1038"><a href="#cb137-1038" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb137-1039"><a href="#cb137-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-1040"><a href="#cb137-1040" aria-hidden="true" tabindex="-1"></a><span class="fu"># Other Thoughts</span></span>
<span id="cb137-1041"><a href="#cb137-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-1042"><a href="#cb137-1042" aria-hidden="true" tabindex="-1"></a>**Sensitivity analyses**:</span>
<span id="cb137-1043"><a href="#cb137-1043" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>see of the false positives produced by the lower specificity produces any effect on the results</span>
<span id="cb137-1044"><a href="#cb137-1044" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>test assumption that providers essentially fall into two groups: those who prescribe buprenorphine for pain and those who prescribe buprenorphine for opioid use disorder</span>
<span id="cb137-1045"><a href="#cb137-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-1046"><a href="#cb137-1046" aria-hidden="true" tabindex="-1"></a>Perhaps the gradient boosting would be improved by:</span>
<span id="cb137-1047"><a href="#cb137-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-1048"><a href="#cb137-1048" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>with the 200 top drugs</span>
<span id="cb137-1049"><a href="#cb137-1049" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>using continuous measures for the top drugs instead of binary prescribed vs not prescribed; such measures could include:</span>
<span id="cb137-1050"><a href="#cb137-1050" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>'Tot_Clms' (total number of claims)</span>
<span id="cb137-1051"><a href="#cb137-1051" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>'Tot_Day_Sup' (total days supply)</span>
<span id="cb137-1052"><a href="#cb137-1052" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Using calculated continuous measures</span>
<span id="cb137-1053"><a href="#cb137-1053" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>average cost</span>
<span id="cb137-1054"><a href="#cb137-1054" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>average days supply</span>
<span id="cb137-1055"><a href="#cb137-1055" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Have another go at using the <span class="in">`binary:logistic`</span> objective, as it should work as well as the <span class="in">`multi:softprob`</span> objective, as it should work as well as the softprob    </span>
<span id="cb137-1056"><a href="#cb137-1056" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Have another go at cross-validation</span>
<span id="cb137-1057"><a href="#cb137-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-1058"><a href="#cb137-1058" aria-hidden="true" tabindex="-1"></a>Future work could include:</span>
<span id="cb137-1059"><a href="#cb137-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-1060"><a href="#cb137-1060" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Gradient boosting with <span class="in">`catboost`</span> package</span>
<span id="cb137-1061"><a href="#cb137-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-1062"><a href="#cb137-1062" aria-hidden="true" tabindex="-1"></a><span class="fu"># Session Info</span></span>
<span id="cb137-1063"><a href="#cb137-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-1066"><a href="#cb137-1066" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb137-1067"><a href="#cb137-1067" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb137-1068"><a href="#cb137-1068" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>